{# ======================================================================
  device_class/binary.jinja
  Purpose: Style arbitrary binary sensors (no device_class) by `app`.
  Semantics:
    - state 'on'  -> "active" row
    - state 'off' -> "inactive" row
    - unavailable/unknown -> "unavailable" row
  Options:
    - levels (dict) optional: override/extend default levels per app
    - friendly_name / name: usual naming override
====================================================================== #}

{% set lookup_unit = none %}

{# Default app library; override/extend per-entity via options.levels #}
{% set levels = {
    "default": [
        {
            "min_value": none,
            "default_desc": "Unavailable",
            "short_desc": "N/A",
            "long_desc": "Sensor unavailable",
            "icon": "mdi:close-circle",
            "color": "disabled",
            "full_desc": "This binary sensor is not reporting.",
        },
        {
            "min_value": 0,
            "default_desc": "Inactive",
            "short_desc": "Off",
            "long_desc": "Inactive state",
            "icon": "mdi:checkbox-blank-circle-outline",
            "color": "#9ca3af",
            "full_desc": "No condition present.",
        },
        {
            "min_value": 1,
            "default_desc": "Active",
            "short_desc": "On",
            "long_desc": "Active state",
            "icon": "mdi:checkbox-marked-circle",
            "color": "#22c55e",
            "full_desc": "Condition is present.",
        }
    ],
    "alarm": [
        {
            "min_value": none,
            "default_desc": "Unavailable",
            "short_desc": "N/A",
            "long_desc": "Alarm status unavailable",
            "icon": "mdi:close-circle",
            "color": "disabled",
            "full_desc": "No data.",
        },
        {
            "min_value": 0,
            "default_desc": "Clear",
            "short_desc": "Clear",
            "long_desc": "No alarm active",
            "icon": "mdi:shield-check",
            "color": "#10b981",
            "full_desc": "System nominal.",
        },
        {
            "min_value": 1,
            "default_desc": "Alarm",
            "short_desc": "Alarm",
            "long_desc": "Alarm condition",
            "icon": "mdi:alarm-light",
            "color": "#dc2626",
            "full_desc": "Immediate attention required.",
        }
    ],
    "occupied": [
        {
            "min_value": none,
            "default_desc": "Unavailable",
            "short_desc": "N/A",
            "long_desc": "Occupancy unavailable",
            "icon": "mdi:close-circle",
            "color": "disabled",
            "full_desc": "No data.",
        },
        {
            "min_value": 0,
            "default_desc": "Vacant",
            "short_desc": "Vacant",
            "long_desc": "No motion",
            "icon": "mdi:home-outline",
            "color": "#9ca3af",
            "full_desc": "No one detected.",
        },
        {
            "min_value": 1,
            "default_desc": "Occupied",
            "short_desc": "Occ",
            "long_desc": "Motion detected",
            "icon": "mdi:home-account",
            "color": "#22c55e",
            "full_desc": "Presence detected.",
        }
    ],
    "online": [
        {
            "min_value": none,
            "default_desc": "Unavailable",
            "short_desc": "N/A",
            "long_desc": "Status unknown",
            "icon": "mdi:close-circle",
            "color": "disabled",
            "full_desc": "No data.",
        },
        {
            "min_value": 0,
            "default_desc": "Down",
            "short_desc": "Down",
            "long_desc": "Disconnected",
            "icon": "mdi:lan-disconnect",
            "color": "#dc2626",
            "full_desc": "Not reachable.",
        },
        {
            "min_value": 1,
            "default_desc": "Up",
            "short_desc": "Up",
            "long_desc": "Connected",
            "icon": "mdi:lan-connect",
            "color": "#22c55e",
            "full_desc": "Reachable and responsive.",
        }
    ],
    "sunny": [
        {
            "min_value": none,
            "default_desc": "Unavailable",
            "short_desc": "N/A",
            "long_desc": "Status unknown",
            "icon": "mdi:close-circle",
            "color": "disabled",
            "full_desc": "No data.",
        },
        {
            "min_value": 0,
            "default_desc": "Not sunny",
            "short_desc": "NotSun",
            "long_desc": "Not sunny outside",
            "icon": "mdi:weather-cloudy",
            "color": "grey",
            "full_desc": "Sun not detected (cloudy, dark, or night)."
        },
        {
            "min_value": 1,
            "default_desc": "Sunny outside",
            "short_desc": "Sunny",
            "long_desc": "It is currently sunny outside",
            "icon": "mdi:white-balance-sunny",
            "color": "yellow",
            "full_desc": "Bright, sunny conditions detected."
        }
    ],
    "rainy": [
        {
            "min_value": none,
            "default_desc": "Unavailable",
            "short_desc": "N/A",
            "long_desc": "Status unknown",
            "icon": "mdi:close-circle",
            "color": "disabled",
            "full_desc": "No data.",
        },
        {
            "min_value": 0,
            "default_desc": "Not raining",
            "short_desc": "Dry",
            "long_desc": "Not raining",
            "icon": "mdi:weather-sunny",
            "color": "green",
            "full_desc": "No rainfall at present."
        },
        {
            "min_value": 1,
            "default_desc": "Rainy",
            "short_desc": "Raining",
            "long_desc": "It is currently raining",
            "icon": "mdi:weather-rainy",
            "color": "blue",
            "full_desc": "Rain detected outside."
        }
    ],
    "dark_outside": [
        {
            "min_value": none,
            "default_desc": "Unavailable",
            "short_desc": "N/A",
            "long_desc": "Status unknown",
            "icon": "mdi:close-circle",
            "color": "disabled",
            "full_desc": "No data.",
        },
        {
            "min_value": 0,
            "default_desc": "Not dark outside",
            "short_desc": "Light",
            "long_desc": "It is light outside",
            "icon": "mdi:lightbulb-outline",
            "color": "disabled",
            "full_desc": "Daylight or sufficient natural light outside."
        },
        {
            "min_value": 1,
            "default_desc": "Dark outside",
            "short_desc": "Dark",
            "long_desc": "Darkness detected outdoors",
            "icon": "mdi:weather-night",
            "color": "indigo",
            "full_desc": "Low light conditions outside (nighttime or heavy overcast)."
        }
    ],
    "hot_inside": [
        {
            "min_value": none,
            "default_desc": "Unavailable",
            "short_desc": "N/A",
            "long_desc": "Status unknown",
            "icon": "mdi:close-circle",
            "color": "disabled",
            "full_desc": "No data.",
        },
        {
            "min_value": 0,
            "default_desc": "Comfortable",
            "short_desc": "Comfort",
            "long_desc": "Comfortable indoors",
            "icon": "mdi:home",
            "color": "green",
            "full_desc": "Indoor temperature is within the comfort range."
        },
        {
            "min_value": 1,
            "default_desc": "Hot inside",
            "short_desc": "Hot",
            "long_desc": "Hot conditions inside",
            "icon": "mdi:fire",
            "color": "red",
            "full_desc": "Indoor temperature exceeds comfort range."
        }
    ],
    "someone_home": [
        {
            "min_value": none,
            "default_desc":"Unavailable",
            "short_desc":"N/A",
            "long_desc":"Presence status unavailable",
            "icon":"mdi:close-circle",
            "color":"disabled",
            "full_desc":"No presence data."
        },
        {
            "min_value": 0,
            "default_desc":"Not home",
            "short_desc":"Away",
            "long_desc":"No one is home",
            "icon":"mdi:home-outline",
            "color":"#9ca3af",
            "full_desc":"All tracked people are away."
        },
        {
            "min_value": 1,
            "default_desc":"Someone home",
            "short_desc":"Home",
            "long_desc":"At least one person is home",
            "icon":"mdi:home-account",
            "color":"#22c55e",
            "full_desc":"Home is currently occupied."
        }
    ],
    "returning_home": [
        {
            "min_value": none,
            "default_desc":"Unavailable",
            "short_desc":"N/A",
            "long_desc":"Return status unavailable",
            "icon":"mdi:close-circle",
            "color":"disabled",
            "full_desc":"No return-trip data."
        },
        {
            "min_value": 0,
            "default_desc":"Climate normal",
            "short_desc":"Normal",
            "long_desc":"No pre-cooling",
            "icon":"mdi:snowflake-off",
            "color":"disabled",
            "full_desc":"AC is in normal mode."
        },
        {
            "min_value": 1,
            "default_desc":"Pre-Cooling",
            "short_desc":"PreCool",
            "long_desc":"Returning home—pre-cool active",
            "icon":"mdi:snowflake",
            "color":"#0ea5e9",
            "full_desc":"Manual ‘coming home’ flag set; AC pre-cooling."
        }
    ],
    "home_alone": [
        {
            "min_value": none,
            "default_desc":"Unavailable",
            "short_desc":"N/A",
            "long_desc":"Alone status unavailable",
            "icon":"mdi:close-circle",
            "color":"disabled",
            "full_desc":"No status data."
        },
        {
            "min_value": 0,
            "default_desc":"Not home alone",
            "short_desc":"OK",
            "long_desc":"A kid is not alone",
            "icon":"mdi:account-group",
            "color":"disabled",
            "full_desc":"At least one adult is present or kid is not alone."
        },
        {
            "min_value": 1,
            "default_desc":"Kids home alone",
            "short_desc":"Alone",
            "long_desc":"Child at home without adults",
            "icon":"mdi:alert",
            "color":"#f59e0b",
            "full_desc":"Child is home alone—heightened attention recommended."
        }
    ],
} %}

{% macro get_dc_context() %}
    {{- {'lookup_unit': lookup_unit, 'levels': levels} | tojson -}}
{% endmacro %}

{# ---- Local helpers (state → row) ---- #}
{% macro _resolve_levels(app, options) %}
    {# allow per-entity override via options.levels #}
    {%- set base = levels.get(app) if app in levels else levels['default'] -%}
    {%- if options is mapping and options.get('levels') is mapping and options.levels.get(app) is sequence -%}
        {{- options.levels.get(app) | tojson -}}
    {%- else -%}
        {{- base | tojson -}}
    {%- endif -%}
{% endmacro %}

{% macro _state_to_flag(options) %}
    {%- set raw = options.get('raw_state') -%}
    {%- set s = raw | string | lower | trim -%}
    {%- if s in ['on','true','1','yes'] -%}
        {{- true -}}
    {%- elif s in ['off','false','0','no'] -%}
        {{- false -}}
    {%- else -%}
        {{- none -}}
    {%- endif -%}
{% endmacro %}
{% macro state_to_flag(options) %}
    {{- _state_to_flag(options) -}}
{% endmacro %}

{% macro _pick_row(app, options) %}
    {%- set rows = _resolve_levels(app, options) | from_json -%}
    {%- set flag = _state_to_flag(options)|bool(none) -%}
    {%- if flag is none -%}
        {{- rows[0] | tojson -}}  {# unavailable row #}
    {%- else -%}
        {# rows[1] is the "inactive" (min_value: 0), rows[2] is "active" (min_value:1) in our convention #}
        {{- (rows[2] if flag else rows[1]) | tojson -}}
    {%- endif -%}
{% endmacro %}

{# ---- Getters (defer naming to global helper, everything else from picked row) ---- #}
{% macro get_default_desc(value, app, options) %}
    {%- if app == 'alarm' and options.summary is defined -%}
        {{- states(options.summary) | default('Unknown', true) -}}
    {%- else -%}
        {{- (_pick_row(app, options) | from_json).default_desc -}}
    {%- endif -%}
{% endmacro %}

{% macro get_short_desc(value, app, options) %}
    {{- (_pick_row(app, options) | from_json).short_desc -}}
{% endmacro %}

{% macro get_long_desc(value, app, options) %}
    {{- (_pick_row(app, options) | from_json).long_desc -}}
{% endmacro %}

{% macro get_full_desc(value, app, options) %}
    {{- (_pick_row(app, options) | from_json).full_desc -}}
{% endmacro %}

{% macro get_icon(value, app, options) %}
    {{- (_pick_row(app, options) | from_json).icon -}}
{% endmacro %}

{% macro get_color(value, app, options) %}
    {{- (_pick_row(app, options) | from_json).color -}}
{% endmacro %}

{% macro get_badge(value, app, options) %}
    {{- (_pick_row(app, options) | from_json).badge | default('', true) -}}
{% endmacro %}

{% macro get_name(value, app, options) %}
    {#- honor explicit name, then friendly_name, else app -#}
    {{- (options.get("name") or options.get('friendly_name') or app) -}}
{% endmacro %}
