{# # File: config/custom_templates/signal_strength.jinja ## #}
{# Macros for Signal Strength across common home/IoT radios:
   - Wi-Fi RSSI (dBm, usually -100 .. -30)
   - Zigbee LQI (0 .. 255)
   - LTE/5G-NR RSRP (dBm, usually -140 .. -70)

   Provides: levels, names, colors, icons, % quality, bars (0–4), and labels.
#}

{% from 'helpers.jinja' import level_find %}

{# ========================= Wi-Fi RSSI ========================= #}
{# RSSI breakpoints (lower bounds, dBm). Map to 7 buckets.
   Unusable < -90, Very Poor -90..-80, Poor -80..-70,
   Fair -70..-67, Good -67..-60, Very Good -60..-50, Excellent >= -50 #}
{% set bps_wifi_rssi = [-120, -90, -80, -70, -67, -60, -50] %}

{% set wifi_names = [
  "Unusable",
  "Very Poor",
  "Poor",
  "Fair",
  "Good",
  "Very Good",
  "Excellent"
] %}
{% set wifi_shorts = ["Unusable","V Poor","Poor","Fair","Good","V Good","Excel"] %}
{% set wifi_longs = [
  "Wi-Fi Signal: Unusable",
  "Wi-Fi Signal: Very Poor",
  "Wi-Fi Signal: Poor",
  "Wi-Fi Signal: Fair",
  "Wi-Fi Signal: Good",
  "Wi-Fi Signal: Very Good",
  "Wi-Fi Signal: Excellent"
] %}
{% set wifi_icons = [
  "mdi:wifi-strength-outline",
  "mdi:wifi-strength-1",
  "mdi:wifi-strength-1",
  "mdi:wifi-strength-2",
  "mdi:wifi-strength-3",
  "mdi:wifi-strength-4",
  "mdi:wifi"
] %}
{% set wifi_colors = [
  "#6b7280",  # Unusable
  "#ef4444",  # Very Poor
  "#f97316",  # Poor
  "#f59e0b",  # Fair
  "#84cc16",  # Good
  "#22c55e",  # Very Good
  "#10b981",  # Excellent
  "disabled"
] %}
{% set wifi_desc = [
  "Link effectively down; move closer or add AP.",
  "Very weak; expect dropouts and low throughput.",
  "Weak; basic connectivity only.",
  "Workable for web/IoT; not ideal for calls.",
  "Good for most uses, including HD streaming.",
  "Very good; VoIP/gaming should be fine.",
  "Excellent; near-AP performance."
] %}

{% macro wifi_level(rssi_dbm) -%}
  {%- set r = (rssi_dbm|float) -%}
  {%- set v = -120 if r < -120 else (-30 if r > -30 else r) -%}
  {{ level_find(v, bps_wifi_rssi) }}
{%- endmacro %}

{# 0–100% quality approximation: clamp and scale -100..-50 → 0..100 #}
{% macro wifi_quality_pct(rssi_dbm) -%}
  {%- set r = (rssi_dbm|float) -%}
  {%- set q = ( (r + 100.0) * 2.0 ) -%}
  {{ 0 if q < 0 else (100 if q > 100 else q) }}
{%- endmacro %}

{# Bars (0..4) from quality %} 
{% macro wifi_bars(rssi_dbm) -%}
  {%- set p = wifi_quality_pct(rssi_dbm)|float -%}
  {%- if p < 10 -%}0
  {%- elif p < 35 -%}1
  {%- elif p < 60 -%}2
  {%- elif p < 85 -%}3
  {%- else -%}4
  {%- endif -%}
{%- endmacro %}

{# djlint:off #}
{% macro wifi_name(rssi) %}{{ wifi_names[wifi_level(rssi)|int - 1] }}{% endmacro %}
{% macro wifi_short(rssi) %}{{ wifi_shorts[wifi_level(rssi)|int - 1] }}{% endmacro %}
{% macro wifi_long(rssi) %}{{ wifi_longs[wifi_level(rssi)|int - 1] }}{% endmacro %}
{% macro wifi_icon(rssi) %}{{ wifi_icons[wifi_level(rssi)|int - 1] }}{% endmacro %}
{% macro wifi_color(rssi) %}{{ wifi_colors[wifi_level(rssi)|int - 1] }}{% endmacro %}
{% macro wifi_desc_text(rssi) %}{{ wifi_desc[wifi_level(rssi)|int - 1] }}{% endmacro %}
{# djlint:on #}

{% macro wifi_label(rssi) -%}
  {%- set p = wifi_quality_pct(rssi)|float -%}
  {{ wifi_name(rssi) }} • {{ rssi|round(0) }} dBm • {{ p|round(0) }}%
{%- endmacro %}

{# ========================= Zigbee LQI ========================= #}
{# LQI (0..255). Higher is better. #}
{% set bps_zb_lqi = [0, 40, 80, 120, 160, 200, 240] %}

{% set zb_names = ["Unusable","Very Poor","Poor","Fair","Good","Very Good","Excellent"] %}
{% set zb_shorts = ["Unusable","V Poor","Poor","Fair","Good","V Good","Excel"] %}
{% set zb_longs = [
  "Zigbee Link: Unusable",
  "Zigbee Link: Very Poor",
  "Zigbee Link: Poor",
  "Zigbee Link: Fair",
  "Zigbee Link: Good",
  "Zigbee Link: Very Good",
  "Zigbee Link: Excellent"
] %}
{% set zb_icons = [
  "mdi:signal-off",
  "mdi:signal-cellular-1",
  "mdi:signal-cellular-1",
  "mdi:signal-cellular-2",
  "mdi:signal-cellular-3",
  "mdi:signal-cellular-4",
  "mdi:zigbee"
] %}
{% set zb_colors = wifi_colors %}
{% set zb_desc = [
  "No reliable link; re-pair or add router.",
  "Very weak mesh path.",
  "Weak; frequent retries expected.",
  "Fair; may be OK for infrequent sensors.",
  "Good; typical end device link.",
  "Very good; routed path is healthy.",
  "Excellent; strong mesh connectivity."
] %}

{% macro zb_level(lqi) -%}
  {%- set v = (lqi|float) -%}
  {%- set x = 0 if v < 0 else (255 if v > 255 else v) -%}
  {{ level_find(x, bps_zb_lqi) }}
{%- endmacro %}

{% macro zb_quality_pct(lqi) -%}
  {%- set v = (lqi|float) -%}
  {{ 0 if v < 0 else (100 if v > 255 else (v * 100.0 / 255.0)) }}
{%- endmacro %}

{% macro zb_bars(lqi) -%}
  {%- set p = zb_quality_pct(lqi)|float -%}
  {%- if p < 10 -%}0
  {%- elif p < 35 -%}1
  {%- elif p < 60 -%}2
  {%- elif p < 85 -%}3
  {%- else -%}4
  {%- endif -%}
{%- endmacro %}

{# djlint:off #}
{% macro zb_name(lqi) %}{{ zb_names[zb_level(lqi)|int - 1] }}{% endmacro %}
{% macro zb_short(lqi) %}{{ zb_shorts[zb_level(lqi)|int - 1] }}{% endmacro %}
{% macro zb_long(lqi) %}{{ zb_longs[zb_level(lqi)|int - 1] }}{% endmacro %}
{% macro zb_icon(lqi) %}{{ zb_icons[zb_level(lqi)|int - 1] }}{% endmacro %}
{% macro zb_color(lqi) %}{{ zb_colors[zb_level(lqi)|int - 1] }}{% endmacro %}
{% macro zb_desc_text(lqi) %}{{ zb_desc[zb_level(lqi)|int - 1] }}{% endmacro %}
{# djlint:on #}

{% macro zb_label(lqi) -%}
  {{ zb_name(lqi) }} • LQI {{ (lqi|float)|round(0) }} • {{ zb_quality_pct(lqi)|round(0) }}%
{%- endmacro %}

{# ========================= LTE/5G-NR RSRP ========================= #}
{# RSRP (dBm). Lower (more negative) is worse. #}
{% set bps_lte_rsrp = [-140, -120, -110, -100, -90, -80, -70] %}

{% set lte_names = ["No Signal","Very Poor","Poor","Fair","Good","Very Good","Excellent"] %}
{% set lte_shorts = ["No Sig","V Poor","Poor","Fair","Good","V Good","Excel"] %}
{% set lte_longs = [
  "Cellular: No Signal",
  "Cellular: Very Poor",
  "Cellular: Poor",
  "Cellular: Fair",
  "Cellular: Good",
  "Cellular: Very Good",
  "Cellular: Excellent"
] %}
{% set lte_icons = [
  "mdi:signal-off",
  "mdi:signal-cellular-1",
  "mdi:signal-cellular-1",
  "mdi:signal-cellular-2",
  "mdi:signal-cellular-3",
  "mdi:signal-cellular-4",
  "mdi:signal"
] %}
{% set lte_colors = wifi_colors %}
{% set lte_desc = [
  "No usable cell signal.",
  "Very weak RSRP; data unreliable.",
  "Weak signal; low throughput likely.",
  "Fair; workable for general use.",
  "Good; normal performance.",
  "Very good; strong and stable.",
  "Excellent; near site or clear LOS."
] %}

{% macro lte_level(rsrp_dbm) -%}
  {%- set r = (rsrp_dbm|float) -%}
  {%- set v = -140 if r < -140 else (-50 if r > -50 else r) -%}
  {{ level_find(v, bps_lte_rsrp) }}
{%- endmacro %}

{# Map -140..-70 dBm → 0..100% (clamped) #}
{% macro lte_quality_pct(rsrp_dbm) -%}
  {%- set r = (rsrp_dbm|float) -%}
  {%- set min = -140.0 -%}
  {%- set max = -70.0 -%}
  {%- set q = ((r - min) / ((max - min) if max != min else 1e-9)) * 100.0 -%}
  {{ 0 if q < 0 else (100 if q > 100 else q) }}
{%- endmacro %}

{% macro lte_bars(rsrp_dbm) -%}
  {%- set p = lte_quality_pct(rsrp_dbm)|float -%}
  {%- if p < 10 -%}0
  {%- elif p < 35 -%}1
  {%- elif p < 60 -%}2
  {%- elif p < 85 -%}3
  {%- else -%}4
  {%- endif -%}
{%- endmacro %}

{# djlint:off #}
{% macro lte_name(rsrp) %}{{ lte_names[lte_level(rsrp)|int - 1] }}{% endmacro %}
{% macro lte_short(rsrp) %}{{ lte_shorts[lte_level(rsrp)|int - 1] }}{% endmacro %}
{% macro lte_long(rsrp) %}{{ lte_longs[lte_level(rsrp)|int - 1] }}{% endmacro %}
{% macro lte_icon(rsrp) %}{{ lte_icons[lte_level(rsrp)|int - 1] }}{% endmacro %}
{% macro lte_color(rsrp) %}{{ lte_colors[lte_level(rsrp)|int - 1] }}{% endmacro %}
{% macro lte_desc_text(rsrp) %}{{ lte_desc[lte_level(rsrp)|int - 1] }}{% endmacro %}
{# djlint:on #}

{% macro lte_label(rsrp) -%}
  {{ lte_name(rsrp) }} • {{ rsrp|round(0) }} dBm • {{ lte_quality_pct(rsrp)|round(0) }}%
{%- endmacro %}

{# ========================= Unified Helpers ========================= #}
{# tech ∈ ['wifi','zigbee','zb','lte','cell'] #}

{% macro signal_level(tech, value) -%}
  {%- set t = (tech|string|lower) -%}
  {%- if t == 'wifi' -%}{{ wifi_level(value) }}
  {%- elif t in ['zigbee','zb'] -%}{{ zb_level(value) }}
  {%- else -%}{{ lte_level(value) }}{%- endif -%}
{%- endmacro %}

{% macro signal_name(tech, value) -%}
  {%- set t = (tech|string|lower) -%}
  {%- if t == 'wifi' -%}{{ wifi_name(value) }}
  {%- elif t in ['zigbee','zb'] -%}{{ zb_name(value) }}
  {%- else -%}{{ lte_name(value) }}{%- endif -%}
{%- endmacro %}

{% macro signal_short(tech, value) -%}
  {%- set t = (tech|string|lower) -%}
  {%- if t == 'wifi' -%}{{ wifi_short(value) }}
  {%- elif t in ['zigbee','zb'] -%}{{ zb_short(value) }}
  {%- else -%}{{ lte_short(value) }}{%- endif -%}
{%- endmacro %}

{% macro signal_icon(tech, value) -%}
  {%- set t = (tech|string|lower) -%}
  {%- if t == 'wifi' -%}{{ wifi_icon(value) }}
  {%- elif t in ['zigbee','zb'] -%}{{ zb_icon(value) }}
  {%- else -%}{{ lte_icon(value) }}{%- endif -%}
{%- endmacro %}

{% macro signal_color(tech, value) -%}
  {%- set t = (tech|string|lower) -%}
  {%- if t == 'wifi' -%}{{ wifi_color(value) }}
  {%- elif t in ['zigbee','zb'] -%}{{ zb_color(value) }}
  {%- else -%}{{ lte_color(value) }}{%- endif -%}
{%- endmacro %}

{% macro signal_desc(tech, value) -%}
  {%- set t = (tech|string|lower) -%}
  {%- if t == 'wifi' -%}{{ wifi_desc_text(value) }}
  {%- elif t in ['zigbee','zb'] -%}{{ zb_desc_text(value) }}
  {%- else -%}{{ lte_desc_text(value) }}{%- endif -%}
{%- endmacro %}

{% macro signal_quality_pct(tech, value) -%}
  {%- set t = (tech|string|lower) -%}
  {%- if t == 'wifi' -%}{{ wifi_quality_pct(value) }}
  {%- elif t in ['zigbee','zb'] -%}{{ zb_quality_pct(value) }}
  {%- else -%}{{ lte_quality_pct(value) }}{%- endif -%}
{%- endmacro %}

{% macro signal_bars(tech, value) -%}
  {%- set t = (tech|string|lower) -%}
  {%- if t == 'wifi' -%}{{ wifi_bars(value) }}
  {%- elif t in ['zigbee','zb'] -%}{{ zb_bars(value) }}
  {%- else -%}{{ lte_bars(value) }}{%- endif -%}
{%- endmacro %}

{# Composite label examples:
   signal_label('wifi', -62) => "Wi-Fi: Good • -62 dBm • 76% • 3/4 bars"
   signal_label('zigbee', 187) => "Zigbee: Very Good • LQI 187 • 73% • 3/4 bars"
   signal_label('lte', -92) => "Cellular: Fair • -92 dBm • 69% • 2/4 bars"
#}
{% macro signal_label(tech, value) -%}
  {%- set t = (tech|string|lower) -%}
  {%- set pct = signal_quality_pct(t, value)|float -%}
  {%- set bars = signal_bars(t, value)|int -%}
  {%- if t == 'wifi' -%}
    Wi-Fi: {{ wifi_name(value) }} • {{ value|round(0) }} dBm • {{ pct|round(0) }}% • {{ bars }}/4 bars
  {%- elif t in ['zigbee','zb'] -%}
    Zigbee: {{ zb_name(value) }} • LQI {{ (value|float)|round(0) }} • {{ pct|round(0) }}% • {{ bars }}/4 bars
  {%- else -%}
    Cellular: {{ lte_name(value) }} • {{ value|round(0) }} dBm • {{ pct|round(0) }}% • {{ bars }}/4 bars
  {%- endif -%}
{%- endmacro %}
