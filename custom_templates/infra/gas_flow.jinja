{# # File: config/custom_templates/gas_flow.jinja ## #}
{# Macros for Natural Gas Flow Rate categories, icons, colors, labels, and helpers.
   Default input unit: CFH (cubic feet per hour) at standard conditions.
   Supported units: 'cfh','scfh','cfm','scfm','m3/h','lpm'.
   Includes BTU/h conversion (default 1000 BTU per cubic foot).
#}

{% from 'helpers.jinja' import level_find %}

{# ------------------------------------------------------------------
   Breakpoints for gas flow (lower bounds) in CFH
   0       : None
   0.5     : Pilot / Standby
   5       : Very Low (small appliance)
   20      : Low (single burner / small WH)
   60      : Moderate (range top or small furnace stage)
   120     : High (typical furnace stage or WH+range)
   240     : Very High (large furnace / multiple appliances)
   400+    : Excessive (near service sizing or abnormal)
   ------------------------------------------------------------------ #}
{% set bps_cfh = [0, 0.5, 5, 20, 60, 120, 240, 400] %}

{% set names = [
  "None",
  "Pilot",
  "Very Low",
  "Low",
  "Moderate",
  "High",
  "Very High",
  "Excessive"
] %}

{% set shorts = [
  "None",
  "Pilot",
  "V Low",
  "Low",
  "Moder",
  "High",
  "V High",
  "Excess"
] %}

{% set longs = [
  "Gas Flow: None",
  "Gas Flow: Pilot/Standby",
  "Gas Flow: Very Low",
  "Gas Flow: Low",
  "Gas Flow: Moderate",
  "Gas Flow: High",
  "Gas Flow: Very High",
  "Gas Flow: Excessive"
] %}

{% set icons = [
  "mdi:fire-off",          # None
  "mdi:fire",              # Pilot
  "mdi:gas-burner",        # Very Low
  "mdi:gas-burner",        # Low
  "mdi:fire",              # Moderate
  "mdi:fire-alert",        # High
  "mdi:alert",             # Very High
  "mdi:alert-octagon"      # Excessive
] %}

{% set colors = [
  "#9ca3af",  # None
  "#22c55e",  # Pilot
  "#84cc16",  # Very Low
  "#eab308",  # Low
  "#f59e0b",  # Moderate
  "#ef4444",  # High
  "#dc2626",  # Very High
  "#7c3aed",  # Excessive
  "disabled"
] %}

{% set descriptions = [
  "No gas flow detected.",
  "Pilot or standby flame only.",
  "Small appliance draw.",
  "Single appliance operating.",
  "Multiple burners or medium appliance.",
  "Large appliance or several operating simultaneously.",
  "Very high whole-home draw.",
  "Unusually high flow; verify appliances and check for issues."
] %}

{# -------------------- Unit conversion helpers -------------------- #}
{% macro convert_gas_flow_value(value, from_unit='cfh', to_unit='cfh') -%}
  {%- set v = value|float -%}
  {%- set fu = (from_unit|string|lower) -%}
  {%- set tu = (to_unit|string|lower) -%}

  {# normalize #}
  {%- if fu in ['scfh'] -%}{% set fu = 'cfh' %}{% endif -%}
  {%- if fu in ['cfm','scfm'] -%}{% set fu = 'cfm' %}{% endif -%}
  {%- if fu in ['m3/h','m³/h','m^3/h'] -%}{% set fu = 'm3/h' %}{% endif -%}
  {%- if fu in ['lpm','l/min'] -%}{% set fu = 'lpm' %}{% endif -%}

  {%- if tu in ['scfh'] -%}{% set tu = 'cfh' %}{% endif -%}
  {%- if tu in ['cfm','scfm'] -%}{% set tu = 'cfm' %}{% endif -%}
  {%- if tu in ['m3/h','m³/h','m^3/h'] -%}{% set tu = 'm3/h' %}{% endif -%}
  {%- if tu in ['lpm','l/min'] -%}{% set tu = 'lpm' %}{% endif -%}

  {# to CFH #}
  {%- if fu == 'cfm' -%}
    {%- set cfh = v * 60.0 -%}
  {%- elif fu == 'm3/h' -%}
    {%- set cfh = v * 35.3146667 -%}
  {%- elif fu == 'lpm' -%}
    {%- set cfh = v * 0.06 * 35.3146667 -%} {# 1 L/min = 0.06 m³/h #}
  {%- else -%}
    {%- set cfh = v -%}
  {%- endif -%}

  {# from CFH #}
  {%- if tu == 'cfm' -%}
    {{ cfh / 60.0 }}
  {%- elif tu == 'm3/h' -%}
    {{ cfh / 35.3146667 }}
  {%- elif tu == 'lpm' -%}
    {{ (cfh / 35.3146667) / 0.06 }}
  {%- else -%}
    {{ cfh }}
  {%- endif -%}
{%- endmacro %}

{# BTU/h <-> CFH (assumes HHV ~ 1000 BTU/ft³ by default) #}
{% macro gas_cfh_to_btuh(cfh, btu_per_cuft=1000) -%}
  {{ (cfh|float) * (btu_per_cuft|float) }}
{%- endmacro %}

{% macro gas_btuh_to_cfh(btuh, btu_per_cuft=1000) -%}
  {{ (btuh|float) / (btu_per_cuft|float if btu_per_cuft else 1000.0) }}
{%- endmacro %}

{# -------------------- Categorization helpers -------------------- #}
{% macro level(rate, unit='cfh') -%}
  {%- set cfh = convert_gas_flow_value(rate, unit, 'cfh')|float -%}
  {%- set val = 0 if cfh < 0 else (100000 if cfh > 100000 else cfh) -%}
  {{ level_find(val, bps_cfh) }}
{%- endmacro %}

{# djlint:off #}
{% macro name(rate, unit='cfh') %}{{ names[level(rate, unit)|int - 1] }}{% endmacro %}
{% macro short(rate, unit='cfh') %}{{ shorts[level(rate, unit)|int - 1] }}{% endmacro %}
{% macro long(rate, unit='cfh') %}{{ longs[level(rate, unit)|int - 1] }}{% endmacro %}
{% macro icon(rate, unit='cfh') %}{{ icons[level(rate, unit)|int - 1] }}{% endmacro %}
{% macro color(rate, unit='cfh') %}{{ colors[level(rate, unit)|int - 1] }}{% endmacro %}
{% macro desc(rate, unit='cfh') %}{{ descriptions[level(rate, unit)|int - 1] }}{% endmacro %}
{# djlint:on #}

{# -------------------- Labels & helpers -------------------- #}
{% macro label(rate, unit='cfh', btu_per_cuft=1000) -%}
  {%- set cfh = convert_gas_flow_value(rate, unit, 'cfh')|float -%}
  {%- set m3h = convert_gas_flow_value(cfh, 'cfh', 'm3/h')|float -%}
  {%- set btuh = gas_cfh_to_btuh(cfh, btu_per_cuft)|float -%}
  {{ names[level(cfh, 'cfh')|int - 1] }} • {{ cfh|round(0) }} CFH ({{ m3h|round(2) }} m³/h) • ≈ {{ (btuh/1000.0)|round(0) }}k BTU/h
{%- endmacro %}

{% macro pilot_only(rate, unit='cfh') -%}
  {{ level(rate, unit)|int == 2 }}
{%- endmacro %}

{% macro unexpected_high(rate, unit='cfh', threshold_cfh=240) -%}
  {%- set cfh = convert_gas_flow_value(rate, unit, 'cfh')|float -%}
  {{ cfh >= threshold_cfh }}
{%- endmacro %}
