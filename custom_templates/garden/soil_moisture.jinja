{# # File: config/custom_templates/soil_moisture.jinja ## #}
{# Macros for Soil Moisture:
   - Supports:
       • Percent-based sensors (VWC %, or relative 0..100)
       • Ratio (0..1) readings
       • Raw ADC (e.g., 0..1023), with optional inversion
       • Soil moisture tension (kPa / cbar) from tensiometers
   - Provides:
       • Categories, icons, colors, descriptions
       • Bars (0–4), quality %, labels & chips
       • Watering advice by plant & soil type
       • Trend helpers
#}

{% from 'helpers.jinja' import level_find %}

{# ========================= Percent-based moisture (VWC %) ========================= #}
{# Buckets by % moisture (approximate VWC / relative wetness)
   0–10 Very Dry
   10–20 Dry
   20–35 Low
   35–60 Optimal
   60–80 Wet
   80–95 Waterlogged
   >=95 Saturated
#}
{% set bps_pct = [0, 10, 20, 35, 60, 80, 95] %}

{% set names_pct = ["Very Dry","Dry","Low","Optimal","Wet","Waterlogged","Saturated"] %}
{% set shorts_pct = ["V Dry","Dry","Low","Opt","Wet","Wlog","Sat"] %}
{% set longs_pct = [
  "Soil: Very Dry",
  "Soil: Dry",
  "Soil: Low Moisture",
  "Soil: Optimal Moisture",
  "Soil: Wet",
  "Soil: Waterlogged",
  "Soil: Saturated"
] %}

{% set icons_pct = [
  "mdi:water-off",
  "mdi:water-outline",
  "mdi:water-percent",
  "mdi:water-check",
  "mdi:water",
  "mdi:waves-arrow-up",
  "mdi:waves"
] %}

{# red → green (optimal) → blue (wet) #}
{% set colors_pct = [
  "#ef4444",  # Very Dry
  "#f97316",  # Dry
  "#eab308",  # Low
  "#22c55e",  # Optimal
  "#3b82f6",  # Wet
  "#6366f1",  # Waterlogged
  "#7c3aed",  # Saturated
  "disabled"
] %}

{% set desc_pct = [
  "Soil is parched; roots stressed.",
  "Too dry for most plants; water soon.",
  "Below ideal; consider watering.",
  "In the sweet spot for most plants.",
  "Quite wet; ensure drainage.",
  "Waterlogged; risk of root rot.",
  "Fully saturated; poor aeration."
] %}

{# ========================= Tension-based moisture (kPa / cbar) ========================= #}
{# NOTE: Lower kPa = wetter. Breakpoints are absolute kPa (cbar = kPa).
   0–10 Saturated
   10–20 Wet
   20–40 Optimal
   40–60 Drying
   60–100 Dry
   100–200 Very Dry
   >=200 Parched
#}
{% set bps_kpa = [0, 10, 20, 40, 60, 100, 200] %}

{% set names_kpa = ["Saturated","Wet","Optimal","Drying","Dry","Very Dry","Parched"] %}
{% set shorts_kpa = ["Sat","Wet","Opt","Drying","Dry","V Dry","Parched"] %}
{% set longs_kpa = [
  "Soil: Saturated",
  "Soil: Wet",
  "Soil: Optimal Moisture (tension)",
  "Soil: Drying",
  "Soil: Dry",
  "Soil: Very Dry",
  "Soil: Parched"
] %}

{% set icons_kpa = [
  "mdi:waves",
  "mdi:water",
  "mdi:water-check",
  "mdi:water-percent",
  "mdi:water-outline",
  "mdi:water-off",
  "mdi:alert-decagram"
] %}

{# blue → green (optimal) → red (dry) #}
{% set colors_kpa = [
  "#3b82f6",  # Saturated
  "#60a5fa",  # Wet
  "#22c55e",  # Optimal
  "#eab308",  # Drying
  "#f59e0b",  # Dry
  "#ef4444",  # Very Dry
  "#7c3aed",  # Parched
  "disabled"
] %}

{% set desc_kpa = [
  "Fully saturated; limited oxygen to roots.",
  "Very wet; allow to drain.",
  "Good plant-available water.",
  "Starting to dry; monitor closely.",
  "Dry for many plants; consider watering.",
  "Very dry; stress likely.",
  "Extremely dry; water immediately."
] %}

{# ========================= Unit helpers ========================= #}
{# Normalize any input to % moisture (0..100). For raw ADC, map [raw_min..raw_max] → [0..100].
   Set invert=true if lower raw means wetter (common with some capacitive sensors). #}
{% macro to_pct(value, unit='pct', raw_min=0, raw_max=1023, invert=false) -%}
  {%- set u = (unit|string|lower) -%}
  {%- set v = value|float -%}
  {%- if u in ['pct','%','percent','percentage','vwc'] -%}
    {{ 0 if v < 0 else (100 if v > 100 else v) }}
  {%- elif u in ['ratio','frac','fraction'] -%}
    {{ 0 if v < 0 else (100 if v > 1 else (v*100.0)) }}
  {%- elif u in ['raw','adc','counts'] -%}
    {%- set r0 = raw_min|float -%}
    {%- set r1 = raw_max|float if (raw_max|float) != (raw_min|float) else (raw_min|float + 1.0) -%}
    {%- set x = (v - r0) / (r1 - r0) -%}
    {%- set p = (1.0 - x)*100.0 if invert else (x*100.0) -%}
    {{ 0 if p < 0 else (100 if p > 100 else p) }}
  {%- else -%} {# treat unknown as pct #}
    {{ 0 if v < 0 else (100 if v > 100 else v) }}
  {%- endif -%}
{%- endmacro %}

{# Tension: support 'kpa' or 'cbar' (1 cbar = 1 kPa). #}
{% macro to_kpa(value, unit='kpa') -%}
  {%- set u = (unit|string|lower) -%}
  {%- set v = value|float -%}
  {{ v if u in ['kpa','cbar'] else v }}
{%- endmacro %}

{# Wetness quality % (0..100): for pct use value; for kPa map 0 kPa→100, 200 kPa→0 (clamped). #}
{% macro wetness_quality_pct(value, unit='pct') -%}
  {%- if (unit|string|lower) in ['kpa','cbar'] -%}
    {%- set k = to_kpa(value, unit)|float -%}
    {%- set q = (1.0 - (k / 200.0)) * 100.0 -%}
    {{ 100 if q > 100 else (0 if q < 0 else q) }}
  {%- else -%}
    {{ to_pct(value, unit)|float }}
  {%- endif -%}
{%- endmacro %}

{# Bars 0..4 based on wetness % #}
{% macro bars(value, unit='pct') -%}
  {%- set p = wetness_quality_pct(value, unit)|float -%}
  {%- if p < 10 -%}0
  {%- elif p < 35 -%}1
  {%- elif p < 60 -%}2
  {%- elif p < 85 -%}3
  {%- else -%}4
  {%- endif -%}
{%- endmacro %}

{# ========================= Levels & lookups ========================= #}
{% macro level_pct(pct) -%}{{ level_find(to_pct(pct, 'pct')|float, bps_pct) }}{%- endmacro %}
{% macro level_kpa(kpa) -%}{{ level_find(to_kpa(kpa, 'kpa')|float, bps_kpa) }}{%- endmacro %}

{# Unified wrappers that choose by unit #}
{% macro level(value, unit='pct') -%}
  {%- set u = (unit|string|lower) -%}
  {{ level_kpa(value) if u in ['kpa','cbar'] else level_pct(value) }}
{%- endmacro %}

{# djlint:off #}
{% macro name(value, unit='pct') %}{{ (names_kpa if unit|string|lower in ['kpa','cbar'] else names_pct)[level(value, unit)|int - 1] }}{% endmacro %}
{% macro short(value, unit='pct') %}{{ (shorts_kpa if unit|string|lower in ['kpa','cbar'] else shorts_pct)[level(value, unit)|int - 1] }}{% endmacro %}
{% macro long(value, unit='pct') %}{{ (longs_kpa if unit|string|lower in ['kpa','cbar'] else longs_pct)[level(value, unit)|int - 1] }}{% endmacro %}
{% macro icon(value, unit='pct') %}{{ (icons_kpa if unit|string|lower in ['kpa','cbar'] else icons_pct)[level(value, unit)|int - 1] }}{% endmacro %}
{% macro color(value, unit='pct') %}{{ (colors_kpa if unit|string|lower in ['kpa','cbar'] else colors_pct)[level(value, unit)|int - 1] }}{% endmacro %}
{% macro desc(value, unit='pct') %}{{ (desc_kpa if unit|string|lower in ['kpa','cbar'] else desc_pct)[level(value, unit)|int - 1] }}{% endmacro %}
{# djlint:on #}

{# ========================= Labels & chips ========================= #}
{% macro label(value, unit='pct') -%}
  {%- if (unit|string|lower) in ['kpa','cbar'] -%}
    {%- set k = to_kpa(value, unit)|float -%}
    {{ name(k, 'kpa') }} • {{ k|round(0) }} kPa
  {%- else -%}
    {%- set p = to_pct(value, unit)|float -%}
    {{ name(p, 'pct') }} • {{ p|round(0) }}%
  {%- endif -%}
{%- endmacro %}

{% macro chip(value, unit='pct') -%}
  {%- if (unit|string|lower) in ['kpa','cbar'] -%}
    {%- set k = to_kpa(value, unit)|float -%}
    {{ short(k, 'kpa') }} • {{ k|round(0) }} kPa
  {%- else -%}
    {%- set p = to_pct(value, unit)|float -%}
    {{ short(p, 'pct') }} • {{ p|round(0) }}%
  {%- endif -%}
{%- endmacro %}

{% macro detail(value, unit='pct') -%}
  {%- set q = wetness_quality_pct(value, unit)|float -%}
  {{ label(value, unit) }} • {{ q|round(0) }}% wetness • {{ bars(value, unit) }}/4 bars
{%- endmacro %}

{# ========================= Watering guidance ========================= #}
{# Simple triggers by plant & soil type. Tune as desired.
   plant ∈ ['succulent','cactus','houseplant','herb','veggie','vegetable','fruit','lawn','general']
   soil  ∈ ['sand','sandy','loam','loamy','clay','clayey']
#}
{% macro _plant_base_trigger_pct(plant='general') -%}
  {%- set p = (plant|string|lower) -%}
  {%- if p in ['succulent','cactus'] -%}15
  {%- elif p in ['houseplant','herb'] -%}30
  {%- elif p in ['veggie','vegetable','fruit'] -%}35
  {%- elif p in ['lawn'] -%}25
  {%- else -%}30
  {%- endif -%}
{%- endmacro %}

{% macro _soil_adjust_pct(soil='loam') -%}
  {%- set s = (soil|string|lower) -%}
  {%- if s in ['sand','sandy'] -%}-5
  {%- elif s in ['clay','clayey'] -%}+5
  {%- else -%}0
  {%- endif -%}
{%- endmacro %}

{% macro _trigger_pct(plant='general', soil='loam') -%}
  {{ (_plant_base_trigger_pct(plant)|float) + (_soil_adjust_pct(soil)|float) }}
{%- endmacro %}

{% macro _trigger_kpa(plant='general') -%}
  {# Rough tension thresholds (higher = drier). #}
  {%- set p = (plant|string|lower) -%}
  {%- if p in ['succulent','cactus'] -%}100
  {%- elif p in ['houseplant','herb','lawn'] -%}60
  {%- elif p in ['veggie','vegetable','fruit'] -%}50
  {%- else -%}60
  {%- endif -%}
{%- endmacro %}

{% macro should_water(value, unit='pct', plant='general', soil='loam') -%}
  {%- if (unit|string|lower) in ['kpa','cbar'] -%}
    {{ to_kpa(value, unit)|float >= _trigger_kpa(plant)|float }}
  {%- else -%}
    {{ to_pct(value, unit)|float <= _trigger_pct(plant, soil)|float }}
  {%- endif -%}
{%- endmacro %}

{% macro advice(value, unit='pct', plant='general', soil='loam') -%}
  {%- if should_water(value, unit, plant, soil) -%}
    {%- if (unit|string|lower) in ['kpa','cbar'] -%}
      Water now for {{ plant }} (tension ≥ {{ _trigger_kpa(plant)|round(0) }} kPa). Ensure drainage for {{ soil }} soil.
    {%- else -%}
      Water now for {{ plant }} (≤ {{ _trigger_pct(plant, soil)|round(0) }}% target). Water deeply; avoid frequent shallow watering.
    {%- endif -%}
  {%- else -%}
    Moisture OK for {{ plant }}. Recheck soon{{ ' (clay holds water longer)' if (soil|string|lower) in ['clay','clayey'] else '' }}.
  {%- endif -%}
{%- endmacro %}

{% macro field_capacity_hint(soil='loam') -%}
  {%- set s = (soil|string|lower) -%}
  {%- if s in ['sand','sandy'] -%}Typical field capacity ~10–20% VWC; drains fast.
  {%- elif s in ['clay','clayey'] -%}Typical field capacity ~35–45% VWC; drains slow.
  {%- else -%}Typical field capacity ~25–35% VWC (loam).
  {%- endif -%}
{%- endmacro %}

{# ========================= Booleans ========================= #}
{% macro is_dry(value, unit='pct') -%}
  {%- if (unit|string|lower) in ['kpa','cbar'] -%}
    {{ level(value, unit)|int >= 5 }}
  {%- else -%}
    {{ level(value, unit)|int <= 2 }}
  {%- endif -%}
{%- endmacro %}

{% macro is_waterlogged(value, unit='pct') -%}
  {%- if (unit|string|lower) in ['kpa','cbar'] -%}
    {{ level(value, unit)|int <= 2 }} {# Saturated/Wet #}
  {%- else -%}
    {{ level(value, unit)|int >= 6 }} {# Waterlogged/Saturated #}
  {%- endif -%}
{%- endmacro %}

{# ========================= Trends ========================= #}
{% macro delta_pct(curr, prev, unit='pct') -%}
  {{ to_pct(curr, unit)|float - to_pct(prev, unit)|float }}
{%- endmacro %}

{% macro delta_kpa(curr, prev, unit='kpa') -%}
  {{ to_kpa(curr, unit)|float - to_kpa(prev, unit)|float }}
{%- endmacro %}

{% macro trend_label(curr, prev, unit='pct') -%}
  {%- if (unit|string|lower) in ['kpa','cbar'] -%}
    {%- set d = delta_kpa(curr, prev, unit)|float -%}
    {%- if d > 2 -%}Drying (+{{ d|round(1) }} kPa)
    {%- elif d < -2 -%}Wetting ({{ d|round(1) }} kPa)
    {%- else -%}Stable
    {%- endif -%}
  {%- else -%}
    {%- set d = delta_pct(curr, prev, unit)|float -%}
    {%- if d > 2 -%}Wetting (+{{ d|round(1) }}%)
    {%- elif d < -2 -%}Drying ({{ d|round(1) }}%)
    {%- else -%}Stable
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}
