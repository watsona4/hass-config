
{#-  -------------------- Heat Index calculation -------------------- -#}
{#- Returns Heat Index in °F using NOAA Rothfusz regression with adjustments -#}
{% macro hi_f(t_f, rh_pct) %}
    {%- set T = t_f|float -%}
    {%- set RH = rh_pct|float -%}
    {%- set RH = 0 if RH < 0 else (100 if RH > 100 else RH) -%}

    {#- Simple approximation for T < 80°F -#}
    {%- if T < 80 -%}
        {{- 0.5 * (T + 61.0 + ((T - 68.0) * 1.2) + (RH * 0.094)) -}}
    {%- else -%}
        {#- Rothfusz regression -#}
        {%- set HI = (
                -42.379
                + 2.04901523 * T
                + 10.14333127 * RH
                - 0.22475541 * T * RH
                - 0.00683783 * T * T
                - 0.05481717 * RH * RH
                + 0.00122874 * T * T * RH
                + 0.00085282 * T * RH * RH
                - 0.00000199 * T * T * RH * RH
                ) -%}

        {#- Low humidity adjustment: RH < 13% and 80–112°F -#}
        {%- if RH < 13 and 80 <= T <= 112 -%}
            {%- set adj = ((13 - RH) / 4.0) * (((17 - (T - 95)|abs) / 17.0) ** 0.5) -%}
            {%- set HI = HI - adj -%}
        {%- endif -%}

        {#- High humidity adjustment: RH > 85% and 80–87°F -#}
        {%- if RH > 85 and 80 <= T <= 87 -%}
            {%- set adj = ((RH - 85) / 10.0) * ((87 - T) / 5.0) -%}
            {%- set HI = HI + adj -%}
        {%- endif -%}

        {{- HI -}}
    {%- endif -%}
{% endmacro %}

{#- Wrapper that returns Heat Index in requested unit.
   Assume input temperature unit is Fahrenheit by default. -#}
{% macro hi(t, rh_pct, unit='f') %}
    {%- set Tf = convert_temp(t, unit, 'f')|float -%}
    {%- set hif = hi_f(Tf, rh_pct)|float -%}
    {{- convert_temp(hif, 'f', unit) -}}
{% endmacro %}
