{# # File: config/custom_templates/drill_press_rpm.jinja ## #}
{# Drill press RPM: compute recommended RPM and classify actual vs target #}

{% from 'helpers.jinja' import level_find %}

{# Metals: RPM ≈ (SFM * 3.82) / Diameter_in #}
{% set sfm = {
  'aluminum': 250, 'brass': 150, 'mild_steel': 80, 'stainless': 60, 'cast_iron': 70, 'plastic': 150
} %}

{# Wood (approx for drill press caps) piecewise by diameter (in): #}
{% macro wood_rpm(d_in) -%}
  {%- set d = (d_in|float if d_in else 0.125) -%}
  {%- if d <= 0.25 -%}3000
  {%- elif d <= 0.5 -%}1500
  {%- elif d <= 1.0 -%}750
  {%- elif d <= 2.0 -%}375
  {%- else -%}250
  {%- endif -%}
{%- endmacro %}

{% macro recommended_rpm(material='mild_steel', diameter_in=0.25) -%}
  {%- set mat = (material|string|lower) -%}
  {%- if mat in ['wood','softwood','hardwood'] -%}
    {{ wood_rpm(diameter_in) }}
  {%- else -%}
    {{ (sfm.get(mat, 80) * 3.82) / (diameter_in|float if diameter_in else 0.25) }}
  {%- endif -%}
{%- endmacro %}

{# Compare actual vs recommended (pct of target) #}
{% set bps_pct = [0, 60, 85, 110, 140, 200] %}
{% set names = ["Way Slow","Slightly Slow","Optimal","Slightly Fast","Fast","Very Fast"] %}
{% set icons = ["mdi:speedometer-slow","mdi:speedometer-slow","mdi:speedometer","mdi:speedometer","mdi:speedometer-medium","mdi:alert"] %}
{% set colors= ["#60a5fa","#eab308","#22c55e","#eab308","#f97316","#ef4444","disabled"] %}

{% macro pct_of_target(actual_rpm, material='mild_steel', diameter_in=0.25) -%}
  {%- set rec = recommended_rpm(material, diameter_in)|float -%}
  {{ (actual_rpm|float) / (rec if rec>0 else 1.0) * 100.0 }}
{%- endmacro %}

{% macro level(actual_rpm, material='mild_steel', diameter_in=0.25) -%}
  {{ level_find(pct_of_target(actual_rpm, material, diameter_in), bps_pct) }}
{%- endmacro %}
{% macro name(actual_rpm, material='mild_steel', diameter_in=0.25) -%}{{ names[level(actual_rpm,material,diameter_in)|int-1] }}{%- endmacro %}
{% macro icon(actual_rpm, material='mild_steel', diameter_in=0.25) -%}{{ icons[level(actual_rpm,material,diameter_in)|int-1] }}{%- endmacro %}
{% macro color(actual_rpm, material='mild_steel', diameter_in=0.25) -%}{{ colors[level(actual_rpm,material,diameter_in)|int-1] }}{%- endmacro %}
{% macro label(actual_rpm, material='mild_steel', diameter_in=0.25) -%}
  {%- set rec = recommended_rpm(material, diameter_in)|float -%}
  {%- set p = pct_of_target(actual_rpm, material, diameter_in)|float -%}
  {{ name(actual_rpm, material, diameter_in) }} • {{ (actual_rpm|float)|round(0) }} rpm (target ~{{ rec|round(0) }}, {{ p|round(0) }}%)
{%- endmacro %}