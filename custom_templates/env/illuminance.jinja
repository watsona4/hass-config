{# # File: config/custom_templates/illuminance.jinja ## #}
{# Macros for Illuminance (light level) categories, icons, colors, and guidance #}
{# Default input unit: lux (lx). Supported units: lx, klx, fc (foot-candles). #}

{% from 'helpers.jinja' import level_find %}

{# ------------------------------------------------------------------
   Breakpoints for illuminance, lower bounds of each band, in lux (lx)
   0, 0.1, 1, 3, 10, 50, 200, 500, 1000, 5000, 10000, 20000, 50000
   ------------------------------------------------------------------ #}
{% set bps_lx = [0, 0.1, 1, 3, 10, 50, 200, 500, 1000, 5000, 10000, 20000, 50000] %}

{# Names for categories #}
{% set names = [
  "Darkness",            # 0+
  "Moonlight",           # 0.1+
  "Night Light",         # 1+
  "Very Dim",            # 3+
  "Dim",                 # 10+
  "Moderate Indoor",     # 50+
  "Bright Indoor",       # 200+
  "Task Lighting",       # 500+
  "Very Bright Indoor",  # 1000+
  "Overcast Daylight",   # 5000+
  "Daylight",            # 10000+
  "Bright Daylight",     # 20000+
  "Direct Sun"           # 50000+
] %}

{# Short names for compact UIs #}
{% set shorts = [
  "Dark",
  "Moon",
  "Night",
  "V Dim",
  "Dim",
  "Mod Ind",
  "Bright Ind",
  "Task",
  "V Bright",
  "Ovc Day",
  "Daylight",
  "Bright Day",
  "Sun"
] %}

{# Long names for descriptive titles #}
{% set longs = [
  "Complete Darkness",
  "Moonlight Level",
  "Night Light Level",
  "Very Dim Light",
  "Dim Light",
  "Moderate Indoor Light",
  "Bright Indoor Light",
  "Task Lighting Level",
  "Very Bright Indoor Light",
  "Overcast Daylight",
  "Daylight Level",
  "Bright Daylight",
  "Direct Sunlight"
] %}

{# Icons for light categories #}
{% set icons = [
  "mdi:weather-night",         # Darkness
  "mdi:moon-waxing-crescent",  # Moonlight
  "mdi:lamp",                  # Night Light
  "mdi:lightbulb-outline",     # Very Dim
  "mdi:lightbulb",             # Dim
  "mdi:ceiling-light",         # Moderate Indoor
  "mdi:lightbulb-on",          # Bright Indoor
  "mdi:desk-lamp",             # Task Lighting
  "mdi:spotlight-beam",        # Very Bright Indoor
  "mdi:weather-cloudy",        # Overcast Daylight
  "mdi:weather-sunny",         # Daylight
  "mdi:white-balance-sunny",   # Bright Daylight
  "mdi:weather-sunny-alert"    # Direct Sun
] %}

{# Colors from dark slate to warm sun #}
{% set colors = [
  "#0f172a",  # Darkness
  "#1e293b",  # Moonlight
  "#334155",  # Night Light
  "#475569",  # Very Dim
  "#64748b",  # Dim
  "#a3e635",  # Moderate Indoor
  "#84cc16",  # Bright Indoor
  "#facc15",  # Task Lighting
  "#f59e0b",  # Very Bright Indoor
  "#fde047",  # Overcast Daylight
  "#fbbf24",  # Daylight
  "#fb923c",  # Bright Daylight
  "#f97316",  # Direct Sun
  "disabled"
] %}

{# Descriptions for each level #}
{% set descriptions = [
  "No usable light.",
  "Roughly a clear night with moonlight.",
  "Similar to a small night light.",
  "Very low indoor lighting.",
  "Low ambient light; navigation only.",
  "Typical living space or hallway.",
  "Bright room; comfortable reading.",
  "Focused task workbench or kitchen prep.",
  "Very bright workspace or studio.",
  "Heavily overcast outdoor daylight.",
  "Typical outdoor daylight.",
  "Bright outdoor daylight with minimal clouds.",
  "Direct sunlight; glare likely."
] %}

{# -------------------- Unit conversion helper -------------------- #}
{# Convert illuminance between 'lx', 'klx', and 'fc' (foot-candles).
   Defaults to lx for both input and output. #}
{% macro convert_illuminance_value(value, from_unit='lx', to_unit='lx') -%}
  {%- set v = value|float -%}
  {%- set fu = (from_unit|string|lower) -%}
  {%- set tu = (to_unit|string|lower) -%}

  {# normalize keys #}
  {%- if fu in ['lux', 'lx'] -%}{% set fu = 'lx' %}{% endif -%}
  {%- if fu in ['klux', 'klx'] -%}{% set fu = 'klx' %}{% endif -%}
  {%- if fu in ['footcandle','foot-candle','fc','footcandles'] -%}{% set fu = 'fc' %}{% endif -%}
  {%- if tu in ['lux', 'lx'] -%}{% set tu = 'lx' %}{% endif -%}
  {%- if tu in ['klux', 'klx'] -%}{% set tu = 'klx' %}{% endif -%}
  {%- if tu in ['footcandle','foot-candle','fc','footcandles'] -%}{% set tu = 'fc' %}{% endif -%}

  {# to lux #}
  {%- if fu == 'klx' -%}
    {%- set lx = v * 1000 -%}
  {%- elif fu == 'fc' -%}
    {%- set lx = v * 10.76391 -%}
  {%- else -%}
    {%- set lx = v -%}
  {%- endif -%}

  {# from lux #}
  {%- if tu == 'klx' -%}
    {{ lx / 1000 }}
  {%- elif tu == 'fc' -%}
    {{ lx / 10.76391 }}
  {%- else -%}
    {{ lx }}
  {%- endif -%}
{%- endmacro %}

{# -------------------- Categorization helpers -------------------- #}
{# Return category level (1-based) for a given illuminance. Default input is lux. #}
{% macro level(ill, unit='lx') -%}
  {%- set lx = convert_illuminance_value(ill, unit, 'lx')|float -%}
  {%- set val = 0 if lx < 0 else (150000 if lx > 150000 else lx) -%}
  {{ level_find(val, bps_lx) }}
{%- endmacro %}

{# -------------------- Wrappers for lookups -------------------- #}
{# djlint:off #}
{% macro name(ill, unit='lx') %}{{ names[level(ill, unit)|int - 1] }}{% endmacro %}
{% macro short(ill, unit='lx') %}{{ shorts[level(ill, unit)|int - 1] }}{% endmacro %}
{% macro long(ill, unit='lx') %}{{ longs[level(ill, unit)|int - 1] }}{% endmacro %}
{% macro icon(ill, unit='lx') %}{{ icons[level(ill, unit)|int - 1] }}{% endmacro %}
{% macro desc(ill, unit='lx') %}{{ descriptions[level(ill, unit)|int - 1] }}{% endmacro %}
{% macro color(ill, unit='lx') %}{{ colors[level(ill, unit)|int - 1] }}{% endmacro %}
{# djlint:on #}

{# -------------------- Convenience formatter -------------------- #}
{# Example label: "Very Bright Indoor (1,500 lx)" #}
{% macro label(ill, unit='lx') -%}
  {%- set lx = convert_illuminance_value(ill, unit, 'lx')|float -%}
  {{ names[level(lx)|int - 1] }} ({{ lx|round(0) | int | string }} lx)
{%- endmacro %}
