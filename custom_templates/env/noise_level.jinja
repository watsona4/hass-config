{# # File: config/custom_templates/noise_level.jinja ## #}
{# Macros for environmental Noise Level (sound pressure) categories, icons, colors, and safety guidance.
   Default input unit: dBA (A-weighted decibels).
   Includes NIOSH/OSHA safe-exposure helpers (approximate). #}

{% from 'helpers.jinja' import level_find %}

{# ------------------------------------------------------------------
   Breakpoints for noise level (lower bounds) in dBA
   0–29    Silent
   30–39   Very Quiet
   40–54   Quiet
   55–69   Moderate
   70–84   Loud (prolonged exposure may be fatiguing)
   85–99   Very Loud (hearing protection recommended)
   100–119 Extremely Loud (short exposures only)
   >=120   Painful (immediate risk)
   ------------------------------------------------------------------ #}
{% set bps_dba = [0, 30, 40, 55, 70, 85, 100, 120] %}

{# Names for categories #}
{% set names = [
  "Silent",
  "Very Quiet",
  "Quiet",
  "Moderate",
  "Loud",
  "Very Loud",
  "Extremely Loud",
  "Painful"
] %}

{# Short names for compact UIs #}
{% set shorts = [
  "Silent",
  "V Quiet",
  "Quiet",
  "Moder",
  "Loud",
  "V Loud",
  "X Loud",
  "Painful"
] %}

{# Long names for descriptive titles #}
{% set longs = [
  "Silent Environment",
  "Very Quiet Environment",
  "Quiet Environment",
  "Moderate Noise",
  "Loud Noise",
  "Very Loud Noise",
  "Extremely Loud Noise",
  "Painful Noise Level"
] %}

{# Icons for categories (MDI) #}
{% set icons = [
  "mdi:volume-mute",           # Silent
  "mdi:volume-low",            # Very Quiet
  "mdi:volume-low",            # Quiet
  "mdi:volume-medium",         # Moderate
  "mdi:volume-high",           # Loud
  "mdi:bullhorn",              # Very Loud
  "mdi:bullhorn-variant",      # Extremely Loud
  "mdi:alert-decagram"         # Painful
] %}

{# Colors from calm green to warning red/purple #}
{% set colors = [
  "#10b981",  # Silent
  "#22c55e",  # Very Quiet
  "#84cc16",  # Quiet
  "#eab308",  # Moderate
  "#f59e0b",  # Loud
  "#ef4444",  # Very Loud
  "#dc2626",  # Extremely Loud
  "#7c3aed",  # Painful
  "disabled"
] %}

{# Descriptions for each level #}
{% set descriptions = [
  "Near silence; studio or remote night setting.",
  "Whisper / library level.",
  "Calm conversation / quiet office.",
  "Normal conversation, light traffic.",
  "Busy street or vacuum cleaner; prolonged exposure may be fatiguing.",
  "Motorcycle / loud music; hearing protection recommended.",
  "Chain saw / nightclub; brief exposure only.",
  "Jet engine / siren close by; immediate risk of pain and damage."
] %}

{# -------------------- Categorization helpers -------------------- #}
{# Clamp to plausible range and bucket. Default unit: dBA #}
{% macro level(db_a) -%}
  {%- set v = db_a|float -%}
  {%- set v = 0 if v < 0 else (150 if v > 150 else v) -%}
  {{ level_find(v, bps_dba) }}
{%- endmacro %}

{# djlint:off #}
{% macro name(db_a) %}{{ names[level(db_a)|int - 1] }}{% endmacro %}
{% macro short(db_a) %}{{ shorts[level(db_a)|int - 1] }}{% endmacro %}
{% macro long(db_a) %}{{ longs[level(db_a)|int - 1] }}{% endmacro %}
{% macro icon(db_a) %}{{ icons[level(db_a)|int - 1] }}{% endmacro %}
{% macro desc(db_a) %}{{ descriptions[level(db_a)|int - 1] }}{% endmacro %}
{% macro color(db_a) %}{{ colors[level(db_a)|int - 1] }}{% endmacro %}
{# djlint:on #}

{# Composite label like "Very Loud (92 dBA)" #}
{% macro label(db_a) -%}
  {{ names[level(db_a)|int - 1] }} ({{ db_a|round(0) }} dBA)
{%- endmacro %}

{# -------------------- Safety helpers (approximate) -------------------- #}
{# NIOSH REL: 85 dBA for 8 h, 3 dB exchange rate (every +3 dB halves safe time)
   Safe time (hours) = 8 * 2^((85 - L)/3)  for L >= 85; larger for L<85 but we cap at 24 h. #}
{% macro safe_hours_niosh(db_a) -%}
  {%- set L = db_a|float -%}
  {%- if L <= 50 -%}
    24.0
  {%- else -%}
    {%- set hours = 8.0 * (2 ** ((85.0 - L) / 3.0)) -%}
    {{ 24.0 if hours > 24.0 else (0.0 if hours < 0.0 else hours) }}
  {%- endif -%}
{%- endmacro %}

{# OSHA PEL: 90 dBA for 8 h, 5 dB exchange rate (every +5 dB halves safe time)
   Safe time (hours) = 8 * 2^((90 - L)/5) #}
{% macro safe_hours_osha(db_a) -%}
  {%- set L = db_a|float -%}
  {%- set hours = 8.0 * (2 ** ((90.0 - L) / 5.0)) -%}
  {{ 24.0 if hours > 24.0 else (0.0 if hours < 0.0 else hours) }}
{%- endmacro %}

{# Format a duration in hours as "Hh Mm" or "Xm" for UI chips #}
{% macro fmt_duration(hours) -%}
  {%- set h = (hours|float) -%}
  {%- if h <= 0 -%}
    "0m"
  {%- elif h >= 24 -%}
    "24h+"
  {%- else -%}
    {%- set ih = (h // 1)|int -%}
    {%- set m = ((h - ih) * 60)|round(0)|int -%}
    {{ (ih|string ~ 'h ' if ih > 0 else '') ~ (m|string ~ 'm') }}
  {%- endif -%}
{%- endmacro %}

{# Exposure dose (percent of allowable) for a given time using NIOSH/OSHA model #}
{% macro dose_percent_niosh(db_a, hours_exposed) -%}
  {%- set allowed = safe_hours_niosh(db_a)|float -%}
  {{ (hours_exposed|float / (allowed if allowed > 0 else 1e-9)) * 100.0 }}
{%- endmacro %}

{% macro dose_percent_osha(db_a, hours_exposed) -%}
  {%- set allowed = safe_hours_osha(db_a)|float -%}
  {{ (hours_exposed|float / (allowed if allowed > 0 else 1e-9)) * 100.0 }}
{%- endmacro %}

{# Safety labels #}
{% macro safety_label(db_a) -%}
  {%- set n = safe_hours_niosh(db_a)|float -%}
  {%- set o = safe_hours_osha(db_a)|float -%}
  {%- if n >= 24 and o >= 24 -%}
    Safe exposure: 24h+ (NIOSH/OSHA)
  {%- else -%}
    Safe exposure: ~{{ fmt_duration(n) }} (NIOSH) • ~{{ fmt_duration(o) }} (OSHA)
  {%- endif -%}
{%- endmacro %}

{# -------------------- Convenience booleans & guidance -------------------- #}
{% macro protection_recommended(db_a) -%}
  {{ db_a|float >= 85.0 }}
{%- endmacro %}

{% macro protection_required(db_a) -%}
  {{ db_a|float >= 100.0 }}
{%- endmacro %}

{% macro advice(db_a) -%}
  {%- set L = db_a|float -%}
  {%- if L < 70 -%}
    Comfortable level for most; prolonged exposure is generally fine.
  {%- elif L < 85 -%}
    Consider breaks to reduce fatigue; prolonged exposure may be tiring.
  {%- elif L < 100 -%}
    Wear hearing protection (earplugs or earmuffs) and limit exposure time.
  {%- elif L < 120 -%}
    Use double protection (plugs + muffs); restrict exposure to short durations.
  {%- else -%}
    Avoid exposure; immediate risk of pain and damage.
  {%- endif -%}
{%- endmacro %}

{# -------------------- Example combined label -------------------- #}
{# "Very Loud (92 dBA) • Safe: ~47m NIOSH / ~2h OSHA" #}
{% macro combined_label(db_a) -%}
  {%- set L = db_a|float -%}
  {%- set n = safe_hours_niosh(L)|float -%}
  {%- set o = safe_hours_osha(L)|float -%}
  {{ names[level(L)|int - 1] }} ({{ L|round(0) }} dBA) • Safe: ~{{ fmt_duration(n) }} NIOSH / ~{{ fmt_duration(o) }} OSHA
{%- endmacro %}
