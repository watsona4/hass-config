{# # File: config/custom_templates/net_speed.jinja ## #}
{# Macros for Network Throughput (Download / Upload):
   - Works with bits/bytes per second (bps, Kbps, Mbps, Gbps, B/s, KB/s, MB/s, GB/s)
   - Default unit input: 'Mbps'
   - Provides: levels, names, icons, colors, descriptions, % of plan, bars (0–4), labels & chips
#}

{% from 'helpers.jinja' import level_find %}

{# ========================= Unit helpers ========================= #}
{# Convert any throughput to Mbps (decimal) #}
{% macro to_mbps(value, unit='Mbps') -%}
  {%- set v = (value|float if value is not none else 0.0) -%}
  {%- set u = (unit|string|lower) -%}
  {# bits per second families (decimal SI) #}
  {%- if u in ['bps','bit/s','bits/s'] -%}
    {{ v / 1_000_000.0 }}
  {%- elif u in ['kbps','kbit/s','kbits/s','kb/s'] -%}
    {{ v / 1_000.0 }}
  {%- elif u in ['mbps','mbit/s','mbits/s','mb/s'] -%}
    {{ v }}
  {%- elif u in ['gbps','gbit/s','gbits/s','gb/s'] -%}
    {{ v * 1_000.0 }}
  {%- elif u in ['tbps','tbit/s','tbits/s','tb/s'] -%}
    {{ v * 1_000_000.0 }}
  {# bytes per second families (decimal; multiply by 8) #}
  {%- elif u in ['b/s','byte/s','bytes/s','bps_bytes'] -%}
    {{ (v * 8.0) / 1_000_000.0 }}
  {%- elif u in ['kb/s','kbyte/s','kbytes/s'] -%}
    {{ (v * 8.0) / 1_000.0 }}
  {%- elif u in ['mb/s','mbyte/s','mbytes/s','mib/s','mib'] -%} {# treat MB/s as decimal #}
    {{ (v * 8.0) }}
  {%- elif u in ['gb/s','gbyte/s','gbytes/s'] -%}
    {{ (v * 8.0) * 1_000.0 }}
  {%- elif u in ['tb/s','tbyte/s','tbytes/s'] -%}
    {{ (v * 8.0) * 1_000_000.0 }}
  {# fall back assuming already Mbps #}
  {%- else -%}
    {{ v }}
  {%- endif -%}
{%- endmacro %}

{% macro format_rate_mbps(mbps, symbol='') -%}
  {%- set r = (mbps|float if mbps is not none else 0.0) -%}
  {%- if r >= 1_000_000.0 -%}{{ (r/1_000_000.0)|round(2) }} Tbps{{ symbol }}
  {%- elif r >= 1_000.0 -%}{{ (r/1_000.0)|round(2) }} Gbps{{ symbol }}
  {%- elif r >= 1.0 -%}{{ r|round(1) }} Mbps{{ symbol }}
  {%- elif r >= 0.001 -%}{{ (r*1_000.0)|round(1) }} Kbps{{ symbol }}
  {%- else -%}{{ (r*1_000_000.0)|round(0) }} bps{{ symbol }}
  {%- endif -%}
{%- endmacro %}

{# percent helper (0..100) #}
{% macro pct(actual, reference) -%}
  {%- set a = (actual|float) -%}
  {%- set r = (reference|float) -%}
  {%- set p = (a / (r if r>0 else 1e-9)) * 100.0 -%}
  {{ 0 if p < 0 else (1000 if p > 1000 else p) }}
{%- endmacro %}

{# ========================= Buckets & lookups ========================= #}
{# Throughput buckets by lower-bound Mbps (download-focused defaults):
   0–0.1 No Link
   0.1–1 Very Slow
   1–10 Slow
   10–50 Moderate
   50–200 Fast
   200–1000 Very Fast
   >=1000 Ultra / Gig+
#}
{% set bps_mbps = [0, 0.1, 1, 10, 50, 200, 1000] %}

{% set names = ["No Link","Very Slow","Slow","Moderate","Fast","Very Fast","Ultra (Gig+)"] %}
{% set shorts = ["None","V Slow","Slow","Moder","Fast","V Fast","Ultra"] %}
{% set longs  = [
  "Throughput: No Link",
  "Throughput: Very Slow",
  "Throughput: Slow",
  "Throughput: Moderate",
  "Throughput: Fast",
  "Throughput: Very Fast",
  "Throughput: Ultra (Gigabit+)"
] %}

{# Icons for generic speed; direction-specific icons provided below #}
{% set icons = [
  "mdi:lan-disconnect",
  "mdi:speedometer-slow",
  "mdi:speedometer-slow",
  "mdi:speedometer-medium",
  "mdi:speedometer",
  "mdi:speedometer",
  "mdi:lightning-bolt"
] %}

{% set colors = [
  "#6b7280",  # No Link
  "#ef4444",  # Very Slow
  "#f97316",  # Slow
  "#eab308",  # Moderate
  "#84cc16",  # Fast
  "#22c55e",  # Very Fast
  "#10b981",  # Ultra
  "disabled"
] %}

{% set descriptions = [
  "No usable throughput.",
  "Barely functional—text browsing only.",
  "Slow—basic web and SD streaming.",
  "Moderate—HD streaming and general use.",
  "Fast—multiple HD streams and quick downloads.",
  "Very fast—4K streams, low wait times.",
  "Ultra—Gigabit+; excellent for heavy workloads."
] %}

{% macro level(speed, unit='Mbps') -%}
  {%- set mb = to_mbps(speed, unit)|float -%}
  {%- set v = 0 if mb < 0 else (1e9 if mb > 1e9 else mb) -%}
  {{ level_find(v, bps_mbps) }}
{%- endmacro %}

{# djlint:off #}
{% macro name(speed, unit='Mbps') %}{{ names[level(speed, unit)|int - 1] }}{% endmacro %}
{% macro short(speed, unit='Mbps') %}{{ shorts[level(speed, unit)|int - 1] }}{% endmacro %}
{% macro long(speed, unit='Mbps') %}{{ longs[level(speed, unit)|int - 1] }}{% endmacro %}
{% macro icon(speed, unit='Mbps') %}{{ icons[level(speed, unit)|int - 1] }}{% endmacro %}
{% macro color(speed, unit='Mbps') %}{{ colors[level(speed, unit)|int - 1] }}{% endmacro %}
{% macro desc(speed, unit='Mbps') %}{{ descriptions[level(speed, unit)|int - 1] }}{% endmacro %}
{# djlint:on #}

{# Bars (0..4) relative to a reference (default 1000 Mbps) or plan speed if provided #}
{% macro bars(speed, unit='Mbps', ref_mbps=1000) -%}
  {%- set p = pct(to_mbps(speed, unit), (ref_mbps|float if ref_mbps else 1000.0))|float -%}
  {%- if p < 10 -%}0
  {%- elif p < 35 -%}1
  {%- elif p < 60 -%}2
  {%- elif p < 85 -%}3
  {%- else -%}4
  {%- endif -%}
{%- endmacro %}

{# ========================= Direction-specific wrappers ========================= #}
{% macro down_icon(speed, unit='Mbps') -%}
  {%- set L = level(speed, unit)|int -%}
  {%- if L <= 1 -%}mdi:download-off
  {%- elif L >= 7 -%}mdi:download-network-outline
  {%- else -%}mdi:download
  {%- endif -%}
{%- endmacro %}

{% macro up_icon(speed, unit='Mbps') -%}
  {%- set L = level(speed, unit)|int -%}
  {%- if L <= 1 -%}mdi:upload-off
  {%- elif L >= 7 -%}mdi:upload-network-outline
  {%- else -%}mdi:upload
  {%- endif -%}
{%- endmacro %}

{% macro down_label(speed, unit='Mbps', plan_mbps=None) -%}
  {%- set mb = to_mbps(speed, unit)|float -%}
  {%- set plan = (plan_mbps|float) if plan_mbps is not none else none -%}
  {%- set util = (pct(mb, plan)|float) if plan is not none else none -%}
  {{ name(mb, 'Mbps') }} • {{ format_rate_mbps(mb, ' ↓') }}{{ ' • ' ~ util|round(0) ~ '% of ' ~ format_rate_mbps(plan, '') if util is not none else '' }}
{%- endmacro %}

{% macro up_label(speed, unit='Mbps', plan_mbps=None) -%}
  {%- set mb = to_mbps(speed, unit)|float -%}
  {%- set plan = (plan_mbps|float) if plan_mbps is not none else none -%}
  {%- set util = (pct(mb, plan)|float) if plan is not none else none -%}
  {{ name(mb, 'Mbps') }} • {{ format_rate_mbps(mb, ' ↑') }}{{ ' • ' ~ util|round(0) ~ '% of ' ~ format_rate_mbps(plan, '') if util is not none else '' }}
{%- endmacro %}

{% macro down_chip(speed, unit='Mbps') -%}
  {%- set mb = to_mbps(speed, unit)|float -%}
  Dn: {{ format_rate_mbps(mb) }}
{%- endmacro %}

{% macro up_chip(speed, unit='Mbps') -%}
  {%- set mb = to_mbps(speed, unit)|float -%}
  Up: {{ format_rate_mbps(mb) }}
{%- endmacro %}

{# Combined speedtest-like label #}
{% macro speedtest_label(down_speed, up_speed, unit='Mbps', plan_down=None, plan_up=None) -%}
  {%- set d = to_mbps(down_speed, unit)|float -%}
  {%- set u = to_mbps(up_speed, unit)|float -%}
  {%- set pd = (plan_down|float) if plan_down is not none else none -%}
  {%- set pu = (plan_up|float) if plan_up is not none else none -%}
  {%- set ud = (pct(d, pd)|float) if pd is not none else none -%}
  {%- set uu = (pct(u, pu)|float) if pu is not none else none -%}
  ↓ {{ format_rate_mbps(d) }}{{ ' • ' ~ ud|round(0) ~ '% of ' ~ format_rate_mbps(pd, '') if ud is not none else '' }} •
  ↑ {{ format_rate_mbps(u) }}{{ ' • ' ~ uu|round(0) ~ '% of ' ~ format_rate_mbps(pu, '') if uu is not none else '' }}
{%- endmacro %}

{# ========================= Guidance & booleans ========================= #}
{% macro below_plan(speed, plan_mbps, unit='Mbps', threshold_pct=80) -%}
  {%- set mb = to_mbps(speed, unit)|float -%}
  {%- set util = pct(mb, plan_mbps)|float -%}
  {{ util < (threshold_pct|float) }}
{%- endmacro %}

{% macro is_ultra(speed, unit='Mbps') -%}
  {{ level(speed, unit)|int >= 7 }}
{%- endmacro %}

{% macro is_fast_or_better(speed, unit='Mbps') -%}
  {{ level(speed, unit)|int >= 5 }}
{%- endmacro %}

{% macro capability_hint(down_speed, up_speed=None, unit='Mbps') -%}
  {%- set d = to_mbps(down_speed, unit)|float -%}
  {%- set u = (to_mbps(up_speed, unit)|float) if up_speed is not none else d -%}
  {%- if d >= 1000 and u >= 50 -%}
    Excellent for 4K multi-streaming, cloud backups, and low-latency gaming.
  {%- elif d >= 200 and u >= 20 -%}
    Great for multiple HD/4K streams, conferencing, and fast downloads.
  {%- elif d >= 50 and u >= 10 -%}
    Good for HD streaming and general work from home.
  {%- elif d >= 10 and u >= 2 -%}
    Basic streaming and browsing; large downloads will be slow.
  {%- else -%}
    Very limited; consider upgrading or troubleshooting connectivity.
  {%- endif -%}
{%- endmacro %}

{# ========================= Trends ========================= #}
{% macro delta_mbps(curr, prev, unit='Mbps') -%}
  {{ to_mbps(curr, unit)|float - to_mbps(prev, unit)|float }}
{%- endmacro %}

{% macro trend_label(curr, prev, unit='Mbps') -%}
  {%- set d = delta_mbps(curr, prev, unit)|float -%}
  {%- if d > 5 -%}
    Improving (+{{ format_rate_mbps(d) }})
  {%- elif d < -5 -%}
    Slowing ({{ format_rate_mbps(d) }})
  {%- else -%}
    Stable
  {%- endif -%}
{%- endmacro %}

{# ========================= Aggregates ========================= #}
{% macro avg_mbps(values, unit='Mbps') -%}
  {%- set n = values|count -%}
  {%- if n == 0 -%}0
  {%- else -%}
    {%- set total = 0 -%}
    {%- for v in values -%}{% set total = total + (to_mbps(v, unit)|float) %}{%- endfor -%}
    {{ total / n }}
  {%- endif -%}
{%- endmacro %}

{% macro max_mbps(values, unit='Mbps') -%}
  {%- set m = 0 -%}
  {%- for v in values -%}{% set x = to_mbps(v, unit)|float %}{% set m = x if x > m else m %}{%- endfor -%}
  {{ m }}
{%- endmacro %}

{% macro group_label(down_values, up_values=None, unit='Mbps') -%}
  {%- set davg = avg_mbps(down_values, unit)|float -%}
  {%- set uavg = (avg_mbps(up_values, unit)|float) if up_values is not none else none -%}
  {{ '↓ ' ~ format_rate_mbps(davg) ~ ( ' • ↑ ' ~ format_rate_mbps(uavg) if uavg is not none else '' ) }}
{%- endmacro %}
