# =====================================================================
# Google Pollen â€“ REST sensors + derived template sensors (Nearby/Home/RV)
# Shared macros: env/pollen_core.jinja
# =====================================================================

###############################################################################
# REST commands: Google Pollen (Nearby / Home / RV)
# Note: api_key is passed in from the automation (keeps !secret out of command)
###############################################################################
rest_command:
  google_pollen_nearby_fetch:
    url: >-
      {%- from 'macros/rest_helpers.jinja' import nearby_is_valid, nearby_lat, nearby_lon -%}
      {%- set base = 'https://pollen.googleapis.com/v1/forecast:lookup' if (nearby_is_valid() | bool) else 'http://127.0.0.1:65535/' -%}
      {%- if base.startswith('http://127.0.0.1') -%}
        {{ base }}
      {%- else -%}
        {{ base }}?location.latitude={{ nearby_lat() }}&location.longitude={{ nearby_lon() }}&days=5&languageCode=en&key={{ api_key }}
      {%- endif -%}
    method: GET
    timeout: 8
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache

  google_pollen_home_fetch:
    url: >-
      {%- from 'macros/rest_helpers.jinja' import home_is_valid, home_lat, home_lon -%}
      {%- set base = 'https://pollen.googleapis.com/v1/forecast:lookup' if (home_is_valid() | bool) else 'http://127.0.0.1:65535/' -%}
      {%- if base.startswith('http://127.0.0.1') -%}
        {{ base }}
      {%- else -%}
        {{ base }}?location.latitude={{ home_lat() }}&location.longitude={{ home_lon() }}&days=5&languageCode=en&key={{ api_key }}
      {%- endif -%}
    method: GET
    timeout: 8
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache

  google_pollen_rv_fetch:
    url: >-
      {%- from 'macros/rest_helpers.jinja' import rv_is_valid, rv_lat, rv_lon -%}
      {%- set base = 'https://pollen.googleapis.com/v1/forecast:lookup' if (rv_is_valid() | bool) else 'http://127.0.0.1:65535/' -%}
      {%- if base.startswith('http://127.0.0.1') -%}
        {{ base }}
      {%- else -%}
        {{ base }}?location.latitude={{ rv_lat() }}&location.longitude={{ rv_lon() }}&days=5&languageCode=en&key={{ api_key }}
      {%- endif -%}
    method: GET
    timeout: 8
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache

# ---------- Template sensors (shared structure, per location) ----------
template:

  - trigger:
      - platform: event
        event_type: google_pollen_nearby_update
    sensor:
      - name: Google Pollen Nearby
        unique_id: google_pollen_nearby
        availability: "{{ trigger.event.data.available | default(false) }}"
        state: >-
          {%- set data =
                trigger.event.data.parsed
                if (trigger and trigger.event and trigger.event.data.parsed is mapping)
                else ((trigger.event.data.parsed | default('') | from_json(default={}))) -%}
          {%- if data is mapping and data.error is not defined -%}
            {%- set di = data.get('dailyInfo') or [] -%}
            {{ states(this.entity_id) if (di | count) == 0 else now().isoformat() }}
          {%- else -%}
            {{ states(this.entity_id) }}
          {%- endif -%}
        attributes:
          dailyInfo: >-
            {%- set data =
                  trigger.event.data.parsed
                  if (trigger and trigger.event and trigger.event.data.parsed is mapping)
                  else ((trigger.event.data.parsed | default('') | from_json(default={}))) -%}
            {{ data.get('dailyInfo') }}
          plantInfo: >-
            {%- set data =
                  trigger.event.data.parsed
                  if (trigger and trigger.event and trigger.event.data.parsed is mapping)
                  else ((trigger.event.data.parsed | default('') | from_json(default={}))) -%}
            {{ data.get('plantInfo') }}

  - trigger:
      - platform: event
        event_type: google_pollen_home_update
    sensor:
      - name: Google Pollen Home
        unique_id: google_pollen_home
        availability: "{{ trigger.event.data.available | default(false) }}"
        state: >-
          {%- set data =
                trigger.event.data.parsed
                if (trigger and trigger.event and trigger.event.data.parsed is mapping)
                else ((trigger.event.data.parsed | default('') | from_json(default={}))) -%}
          {%- if data is mapping and data.error is not defined -%}
            {%- set di = data.get('dailyInfo') or [] -%}
            {{ states(this.entity_id) if (di | count) == 0 else now().isoformat() }}
          {%- else -%}
            {{ states(this.entity_id) }}
          {%- endif -%}
        attributes:
          dailyInfo: >-
            {%- set data =
                  trigger.event.data.parsed
                  if (trigger and trigger.event and trigger.event.data.parsed is mapping)
                  else ((trigger.event.data.parsed | default('') | from_json(default={}))) -%}
            {{ data.get('dailyInfo') }}
          plantInfo: >-
            {%- set data =
                  trigger.event.data.parsed
                  if (trigger and trigger.event and trigger.event.data.parsed is mapping)
                  else ((trigger.event.data.parsed | default('') | from_json(default={}))) -%}
            {{ data.get('plantInfo') }}

  - trigger:
      - platform: event
        event_type: google_pollen_rv_update
    sensor:
      - name: Google Pollen RV
        unique_id: google_pollen_rv
        availability: "{{ trigger.event.data.available | default(false) and has_value('device_tracker.rv_gps') }}"
        state: >-
          {%- set data =
                trigger.event.data.parsed
                if (trigger and trigger.event and trigger.event.data.parsed is mapping)
                else ((trigger.event.data.parsed | default('') | from_json(default={}))) -%}
          {%- if data is mapping and data.error is not defined -%}
            {%- set di = data.get('dailyInfo') or [] -%}
            {{ states(this.entity_id) if (di | count) == 0 else now().isoformat() }}
          {%- else -%}
            {{ states(this.entity_id) }}
          {%- endif -%}
        attributes:
          dailyInfo: >-
            {%- set data =
                  trigger.event.data.parsed
                  if (trigger and trigger.event and trigger.event.data.parsed is mapping)
                  else ((trigger.event.data.parsed | default('') | from_json(default={}))) -%}
            {{ data.get('dailyInfo') }}
          plantInfo: >-
            {%- set data =
                  trigger.event.data.parsed
                  if (trigger and trigger.event and trigger.event.data.parsed is mapping)
                  else ((trigger.event.data.parsed | default('') | from_json(default={}))) -%}
            {{ data.get('plantInfo') }}

  # ================= NEARBY =================
  - trigger:
      - platform: state
        entity_id: sensor.google_pollen_nearby
    variables:
      src: sensor.google_pollen_nearby
      ctx: >-
        {%- from 'metrics/pollen/pollen.jinja' import build_ctx -%}
        {{- build_ctx(src) | from_json(default={}) -}}
      d0: >-
        {%- set di = ctx.di if ctx is mapping and 'di' in ctx else [] -%}
        {{ (di[0] if di is sequence and (di | count) > 0 else {}) }}
      types: >-
        {{ (d0.get('pollenTypeInfo') or []) }}
      ranked: >-
        {{ (types
            | selectattr('indexInfo','defined')
            | selectattr('indexInfo.value','defined')
            | sort(attribute='indexInfo.value', reverse=true)
            | list) }}
      top: >-
        {{ (ranked[0] if ranked | count > 0 else {}) }}
      has_vals: "{{ ranked | count > 0 }}"
      neutral_hex: "#9E9E9E"
      di_attr: "{{ state_attr(src, 'dailyInfo') or [] }}"
      d0_attr: "{{ di_attr[0] if di_attr|count>0 else {} }}"
      plants_fallback: "{{ d0_attr.get('plantInfo') or [] }}"
    sensor:
      - name: Google Pollen Nearby Today
        unique_id: google_pollen_nearby_today
        icon: mdi:flower-pollen
        availability: "{{ has_value(src) and ((ctx.di | count) > 0) }}"
        state: >-
          {{- (top.get('displayName') or top.get('code')) if has_vals else 'none' -}}
        attributes:
          date: >-
            {%- set dt = d0.get('date') or {} -%}
            {{- "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none -}}
          dominant_value: >-
            {{- (top.get('indexInfo') or {}).get('value') if has_vals else 0 -}}
          dominant_category: >-
            {{- (top.get('indexInfo') or {}).get('category') if has_vals else 'none' -}}
          dominant_hex: >-
            {%- if has_vals -%}
              {%- set c = (top.get('indexInfo') or {}).get('color') or {} -%}
              {%- set r = (c.get('red') or 0) * 255 -%}
              {%- set g = (c.get('green') or 0) * 255 -%}
              {%- set b = (c.get('blue') or 0) * 255 -%}
              {{- '#%02X%02X%02X'|format(r|round(0)|int(0), g|round(0)|int(0), b|round(0)|int(0)) -}}
            {%- else -%}
              {{ neutral_hex }}
            {%- endif -%}
          grass_value: >-
            {%- set xlist = (types | selectattr('code','eq','GRASS') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (has_vals and xlist|count>0) else 0 -}}
          tree_value: >-
            {%- set xlist = (types | selectattr('code','eq','TREE') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (has_vals and xlist|count>0) else 0 -}}
          weed_value: >-
            {%- set xlist = (types | selectattr('code','eq','WEED') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (has_vals and xlist|count>0) else 0 -}}
          recommendations: >-
            {{ (ranked[0].get('healthRecommendations') or []) | unique | list if has_vals else [] }}

      - name: Pollen Species Nearby Today
        unique_id: pollen_species_nearby_today
        icon: mdi:leaf
        availability: >-
          {{- has_value(src) and ( (ctx.plants | count) > 0 or (plants_fallback | count) > 0 ) -}}
        state: >-
          {{- ctx.pick.name if (ctx.plants | count) > 0 else
              (plants_fallback[0].get('displayName') if (plants_fallback|count>0) else 'none') -}}
        attributes:
          code: >-
            {{- ctx.pick.code if (ctx.plants | count) > 0 else
                (plants_fallback[0].get('code') if (plants_fallback|count>0) else none) -}}
          type: >-
            {{- ctx.pick.type if (ctx.plants | count) > 0 else none -}}
          in_season: >-
            {{- ctx.pick.in_season if (ctx.plants | count) > 0 else none -}}
          category: >-
            {{- ctx.pick.category if (ctx.plants | count) > 0 else 'none' -}}
          value: >-
            {{- ctx.pick.value if (ctx.plants | count) > 0 else 0 -}}
          entity_picture: >-
            {{- ctx.pick.picture if (ctx.plants | count) > 0 else none -}}

      - name: Pollen Forecast Nearby Day 0
        unique_id: pollen_forecast_nearby_day_0
        icon: mdi:calendar-today
        availability: >-
          {{ (ctx.days | count) > 0 }}
        state: >-
          {%- if (ctx.days | count) > 0 and (ctx.days[0].get('exists') | default(false)) -%}
            {{ ctx.days[0].get('state') or 'unknown' }}
          {%- else -%}
            none
          {%- endif -%}
        attributes:
          date: "{{ (ctx.days[0].get('date') if (ctx.days|count)>0 else none) }}"
          dominant_type: "{{ (ctx.days[0].get('dominant_type') if (ctx.days|count)>0 else none) or 'none' }}"
          dominant_value: "{{ (ctx.days[0].get('dominant_value') if (ctx.days|count)>0 else 0) | default(0) }}"
          dominant_category: "{{ (ctx.days[0].get('dominant_category') if (ctx.days|count)>0 else 'none') }}"
          dominant_hex: "{{ (ctx.days[0].get('dominant_hex') if (ctx.days|count)>0 else neutral_hex) }}"
          species_name: "{{ (ctx.days[0].get('species_name') if (ctx.days|count)>0 else none) }}"
          species_value: "{{ (ctx.days[0].get('species_value') if (ctx.days|count)>0 else 0) }}"
          species_category: "{{ (ctx.days[0].get('species_category') if (ctx.days|count)>0 else 'none') }}"
          species_type: "{{ (ctx.days[0].get('species_type') if (ctx.days|count)>0 else none) }}"
          species_picture: "{{ (ctx.days[0].get('species_picture') if (ctx.days|count)>0 else none) }}"

      - name: Pollen Forecast Nearby Day 1
        unique_id: pollen_forecast_nearby_day_1
        icon: mdi:calendar
        availability: "{{ (ctx.days | count) > 1 }}"
        state: >-
          {%- if (ctx.days | count) > 1 and (ctx.days[1].get('exists') | default(false)) -%}
            {{ ctx.days[1].get('state') or 'unknown' }}
          {%- else -%}
            none
          {%- endif -%}
        attributes:
          date: "{{ (ctx.days[1].get('date') if (ctx.days|count)>1 else none) }}"
          dominant_type: "{{ (ctx.days[1].get('dominant_type') if (ctx.days|count)>1 else none) or 'none' }}"
          dominant_value: "{{ (ctx.days[1].get('dominant_value') if (ctx.days|count)>1 else 0) | default(0) }}"
          dominant_category: "{{ (ctx.days[1].get('dominant_category') if (ctx.days|count)>1 else 'none') }}"
          dominant_hex: "{{ (ctx.days[1].get('dominant_hex') if (ctx.days|count)>1 else neutral_hex) }}"
          species_name: "{{ (ctx.days[1].get('species_name') if (ctx.days|count)>1 else none) }}"
          species_value: "{{ (ctx.days[1].get('species_value') if (ctx.days|count)>1 else 0) }}"
          species_category: "{{ (ctx.days[1].get('species_category') if (ctx.days|count)>1 else 'none') }}"
          species_type: "{{ (ctx.days[1].get('species_type') if (ctx.days|count)>1 else none) }}"
          species_picture: "{{ (ctx.days[1].get('species_picture') if (ctx.days|count)>1 else none) }}"

      - name: Pollen Forecast Nearby Day 2
        unique_id: pollen_forecast_nearby_day_2
        icon: mdi:calendar
        availability: "{{ (ctx.days | count) > 2 }}"
        state: >-
          {%- if (ctx.days | count) > 2 and (ctx.days[2].get('exists') | default(false)) -%}
            {{ ctx.days[2].get('state') or 'unknown' }}
          {%- else -%}
            none
          {%- endif -%}
        attributes:
          date: "{{ (ctx.days[2].get('date') if (ctx.days|count)>2 else none) }}"
          dominant_type: "{{ (ctx.days[2].get('dominant_type') if (ctx.days|count)>2 else none) or 'none' }}"
          dominant_value: "{{ (ctx.days[2].get('dominant_value') if (ctx.days|count)>2 else 0) | default(0) }}"
          dominant_category: "{{ (ctx.days[2].get('dominant_category') if (ctx.days|count)>2 else 'none') }}"
          dominant_hex: "{{ (ctx.days[2].get('dominant_hex') if (ctx.days|count)>2 else neutral_hex) }}"
          species_name: "{{ (ctx.days[2].get('species_name') if (ctx.days|count)>2 else none) }}"
          species_value: "{{ (ctx.days[2].get('species_value') if (ctx.days|count)>2 else 0) }}"
          species_category: "{{ (ctx.days[2].get('species_category') if (ctx.days|count)>2 else 'none') }}"
          species_type: "{{ (ctx.days[2].get('species_type') if (ctx.days|count)>2 else none) }}"
          species_picture: "{{ (ctx.days[2].get('species_picture') if (ctx.days|count)>2 else none) }}"

      - name: Pollen Species List Nearby Today
        unique_id: pollen_species_list_nearby_today
        availability: "{{ has_value(src) and ( (ctx.di | count) > 0 ) }}"
        state: "{{ (ctx.di | count) > 0 }}"
        attributes:
          species: >-
            {%- set plants = (ctx.d or {}).get('plantInfo') or [] -%}
            {%- if plants | count == 0 -%}
              {%- set plants = plants_fallback -%}
            {%- endif -%}
            {%- set ns = namespace(out=[]) -%}
            {%- for p in plants -%}
              {%- set item = {
                'code': p.get('code'),
                'name': p.get('displayName'),
                'type': none,
                'in_season': none,
                'value': 0,
                'category': 'none',
                'picture': none
              } -%}
              {%- set ns.out = ns.out + [item] -%}
            {%- endfor -%}
            {{- ns.out -}}

      - name: Pollen Peak Index Nearby Today
        unique_id: pollen_peak_index_nearby_today
        icon: mdi:meter-gas
        availability: "{{ has_value(src) and ((((ctx.d or {}).get('pollenTypeInfo') or []) | count) > 0) }}"
        state: >-
          {%- set types = (ctx.d or {}).get('pollenTypeInfo') or [] -%}
          {%- set vals = (
                types
                | selectattr('indexInfo','defined')
                | selectattr('indexInfo.value','defined')
                | map(attribute='indexInfo.value')
                | list
            ) -%}
          {{ (vals|max) if (vals|count) > 0 else 0 }}

  # ================= HOME =================
  - trigger:
      - platform: state
        entity_id: sensor.google_pollen_home
    variables:
      src: sensor.google_pollen_home
      ctx: >-
        {%- from 'metrics/pollen/pollen.jinja' import build_ctx -%}
        {{- build_ctx(src) | from_json(default={}) -}}
      d0: >-
        {%- set di = ctx.di if ctx is mapping and 'di' in ctx else [] -%}
        {{ (di[0] if di is sequence and (di | count) > 0 else {}) }}
      types: >-
        {{ (d0.get('pollenTypeInfo') or []) }}
      ranked: >-
        {{ (types
            | selectattr('indexInfo','defined')
            | selectattr('indexInfo.value','defined')
            | sort(attribute='indexInfo.value', reverse=true)
            | list) }}
      top: >-
        {{ (ranked[0] if ranked | count > 0 else {}) }}
      has_vals: "{{ ranked | count > 0 }}"
      neutral_hex: "#9E9E9E"
      di_attr: "{{ state_attr(src, 'dailyInfo') or [] }}"
      d0_attr: "{{ di_attr[0] if di_attr|count>0 else {} }}"
      plants_fallback: "{{ d0_attr.get('plantInfo') or [] }}"
    sensor:
      - name: Google Pollen Home Today
        unique_id: google_pollen_home_today
        icon: mdi:flower-pollen
        availability: "{{ has_value(src) and ((ctx.di | count) > 0) }}"
        state: >-
          {{- (top.get('displayName') or top.get('code')) if has_vals else 'none' -}}
        attributes:
          date: >-
            {%- set dt = d0.get('date') or {} -%}
            {{- "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none -}}
          dominant_value: >-
            {{- (top.get('indexInfo') or {}).get('value') if has_vals else 0 -}}
          dominant_category: >-
            {{- (top.get('indexInfo') or {}).get('category') if has_vals else 'none' -}}
          dominant_hex: >-
            {%- if has_vals -%}
              {%- set c = (top.get('indexInfo') or {}).get('color') or {} -%}
              {%- set r = (c.get('red') or 0) * 255 -%}
              {%- set g = (c.get('green') or 0) * 255 -%}
              {%- set b = (c.get('blue') or 0) * 255 -%}
              {{- '#%02X%02X%02X'|format(r|round(0)|int(0), g|round(0)|int(0), b|round(0)|int(0)) -}}
            {%- else -%}
              {{ neutral_hex }}
            {%- endif -%}
          grass_value: >-
            {%- set xlist = (types | selectattr('code','eq','GRASS') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (has_vals and xlist|count>0) else 0 -}}
          tree_value: >-
            {%- set xlist = (types | selectattr('code','eq','TREE') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (has_vals and xlist|count>0) else 0 -}}
          weed_value: >-
            {%- set xlist = (types | selectattr('code','eq','WEED') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (has_vals and xlist|count>0) else 0 -}}
          recommendations: >-
            {{ (ranked[0].get('healthRecommendations') or []) | unique | list if has_vals else [] }}

      - name: Pollen Species Home Today
        unique_id: pollen_species_home_today
        icon: mdi:leaf
        availability: >-
          {{- has_value(src) and ( (ctx.plants | count) > 0 or (plants_fallback | count) > 0 ) -}}
        state: >-
          {{- ctx.pick.name if (ctx.plants | count) > 0 else
              (plants_fallback[0].get('displayName') if (plants_fallback|count>0) else 'none') -}}
        attributes:
          code: >-
            {{- ctx.pick.code if (ctx.plants | count) > 0 else
                (plants_fallback[0].get('code') if (plants_fallback|count>0) else none) -}}
          type: >-
            {{- ctx.pick.type if (ctx.plants | count) > 0 else none -}}
          in_season: >-
            {{- ctx.pick.in_season if (ctx.plants | count) > 0 else none -}}
          category: >-
            {{- ctx.pick.category if (ctx.plants | count) > 0 else 'none' -}}
          value: >-
            {{- ctx.pick.value if (ctx.plants | count) > 0 else 0 -}}
          entity_picture: >-
            {{- ctx.pick.picture if (ctx.plants | count) > 0 else none -}}

      - name: Pollen Forecast Home Day 0
        unique_id: pollen_forecast_home_day_0
        icon: mdi:calendar-today
        availability: >-
          {{ (ctx.days | count) > 0 }}
        state: >-
          {%- if (ctx.days | count) > 0 and (ctx.days[0].get('exists') | default(false)) -%}
            {{ ctx.days[0].get('state') or 'unknown' }}
          {%- else -%}
            none
          {%- endif -%}
        attributes:
          date: "{{ (ctx.days[0].get('date') if (ctx.days|count)>0 else none) }}"
          dominant_type: "{{ (ctx.days[0].get('dominant_type') if (ctx.days|count)>0 else none) or 'none' }}"
          dominant_value: "{{ (ctx.days[0].get('dominant_value') if (ctx.days|count)>0 else 0) | default(0) }}"
          dominant_category: "{{ (ctx.days[0].get('dominant_category') if (ctx.days|count)>0 else 'none') }}"
          dominant_hex: "{{ (ctx.days[0].get('dominant_hex') if (ctx.days|count)>0 else neutral_hex) }}"
          species_name: "{{ (ctx.days[0].get('species_name') if (ctx.days|count)>0 else none) }}"
          species_value: "{{ (ctx.days[0].get('species_value') if (ctx.days|count)>0 else 0) }}"
          species_category: "{{ (ctx.days[0].get('species_category') if (ctx.days|count)>0 else 'none') }}"
          species_type: "{{ (ctx.days[0].get('species_type') if (ctx.days|count)>0 else none) }}"
          species_picture: "{{ (ctx.days[0].get('species_picture') if (ctx.days|count)>0 else none) }}"

      - name: Pollen Forecast Home Day 1
        unique_id: pollen_forecast_home_day_1
        icon: mdi:calendar
        availability: "{{ (ctx.days | count) > 1 }}"
        state: >-
          {%- if (ctx.days | count) > 1 and (ctx.days[1].get('exists') | default(false)) -%}
            {{ ctx.days[1].get('state') or 'unknown' }}
          {%- else -%}
            none
          {%- endif -%}
        attributes:
          date: "{{ (ctx.days[1].get('date') if (ctx.days|count)>1 else none) }}"
          dominant_type: "{{ (ctx.days[1].get('dominant_type') if (ctx.days|count)>1 else none) or 'none' }}"
          dominant_value: "{{ (ctx.days[1].get('dominant_value') if (ctx.days|count)>1 else 0) | default(0) }}"
          dominant_category: "{{ (ctx.days[1].get('dominant_category') if (ctx.days|count)>1 else 'none') }}"
          dominant_hex: "{{ (ctx.days[1].get('dominant_hex') if (ctx.days|count)>1 else neutral_hex) }}"
          species_name: "{{ (ctx.days[1].get('species_name') if (ctx.days|count)>1 else none) }}"
          species_value: "{{ (ctx.days[1].get('species_value') if (ctx.days|count)>1 else 0) }}"
          species_category: "{{ (ctx.days[1].get('species_category') if (ctx.days|count)>1 else 'none') }}"
          species_type: "{{ (ctx.days[1].get('species_type') if (ctx.days|count)>1 else none) }}"
          species_picture: "{{ (ctx.days[1].get('species_picture') if (ctx.days|count)>1 else none) }}"

      - name: Pollen Forecast Home Day 2
        unique_id: pollen_forecast_home_day_2
        icon: mdi:calendar
        availability: "{{ (ctx.days | count) > 2 }}"
        state: >-
          {%- if (ctx.days | count) > 2 and (ctx.days[2].get('exists') | default(false)) -%}
            {{ ctx.days[2].get('state') or 'unknown' }}
          {%- else -%}
            none
          {%- endif -%}
        attributes:
          date: "{{ (ctx.days[2].get('date') if (ctx.days|count)>2 else none) }}"
          dominant_type: "{{ (ctx.days[2].get('dominant_type') if (ctx.days|count)>2 else none) or 'none' }}"
          dominant_value: "{{ (ctx.days[2].get('dominant_value') if (ctx.days|count)>2 else 0) | default(0) }}"
          dominant_category: "{{ (ctx.days[2].get('dominant_category') if (ctx.days|count)>2 else 'none') }}"
          dominant_hex: "{{ (ctx.days[2].get('dominant_hex') if (ctx.days|count)>2 else neutral_hex) }}"
          species_name: "{{ (ctx.days[2].get('species_name') if (ctx.days|count)>2 else none) }}"
          species_value: "{{ (ctx.days[2].get('species_value') if (ctx.days|count)>2 else 0) }}"
          species_category: "{{ (ctx.days[2].get('species_category') if (ctx.days|count)>2 else 'none') }}"
          species_type: "{{ (ctx.days[2].get('species_type') if (ctx.days|count)>2 else none) }}"
          species_picture: "{{ (ctx.days[2].get('species_picture') if (ctx.days|count)>2 else none) }}"

      - name: Pollen Species List Home Today
        unique_id: pollen_species_list_home_today
        availability: "{{ has_value(src) and ( (ctx.di | count) > 0 ) }}"
        state: "{{ (ctx.di | count) > 0 }}"
        attributes:
          species: >-
            {%- set plants = (ctx.d or {}).get('plantInfo') or [] -%}
            {%- if plants | count == 0 -%}
              {%- set plants = plants_fallback -%}
            {%- endif -%}
            {%- set ns = namespace(out=[]) -%}
            {%- for p in plants -%}
              {%- set item = {
                'code': p.get('code'),
                'name': p.get('displayName'),
                'type': none,
                'in_season': none,
                'value': 0,
                'category': 'none',
                'picture': none
              } -%}
              {%- set ns.out = ns.out + [item] -%}
            {%- endfor -%}
            {{- ns.out -}}

      - name: Pollen Peak Index Home Today
        unique_id: pollen_peak_index_home_today
        icon: mdi:meter-gas
        availability: "{{ has_value(src) and ((((ctx.d or {}).get('pollenTypeInfo') or []) | count) > 0) }}"
        state: >-
          {%- set types = (ctx.d or {}).get('pollenTypeInfo') or [] -%}
          {%- set vals = (
                types
                | selectattr('indexInfo','defined')
                | selectattr('indexInfo.value','defined')
                | map(attribute='indexInfo.value')
                | list
            ) -%}
          {{ (vals|max) if (vals|count) > 0 else 0 }}

  # ================= RV =================
  - trigger:
      - platform: state
        entity_id: sensor.google_pollen_rv
    variables:
      src: sensor.google_pollen_rv
      ctx: >-
        {%- from 'metrics/pollen/pollen.jinja' import build_ctx -%}
        {{- build_ctx(src) | from_json(default={}) -}}
      d0: >-
        {%- set di = ctx.di if ctx is mapping and 'di' in ctx else [] -%}
        {{ (di[0] if di is sequence and (di | count) > 0 else {}) }}
      types: >-
        {{ (d0.get('pollenTypeInfo') or []) }}
      ranked: >-
        {{ (types
            | selectattr('indexInfo','defined')
            | selectattr('indexInfo.value','defined')
            | sort(attribute='indexInfo.value', reverse=true)
            | list) }}
      top: >-
        {{ (ranked[0] if ranked | count > 0 else {}) }}
      has_vals: "{{ ranked | count > 0 }}"
      neutral_hex: "#9E9E9E"
      di_attr: "{{ state_attr(src, 'dailyInfo') or [] }}"
      d0_attr: "{{ di_attr[0] if di_attr|count>0 else {} }}"
      plants_fallback: "{{ d0_attr.get('plantInfo') or [] }}"
    sensor:
      - name: Google Pollen RV Today
        unique_id: google_pollen_rv_today
        icon: mdi:flower-pollen
        availability: "{{ has_value(src) and ((ctx.di | count) > 0) }}"
        state: >-
          {{- (top.get('displayName') or top.get('code')) if has_vals else 'none' -}}
        attributes:
          date: >-
            {%- set dt = d0.get('date') or {} -%}
            {{- "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none -}}
          dominant_value: >-
            {{- (top.get('indexInfo') or {}).get('value') if has_vals else 0 -}}
          dominant_category: >-
            {{- (top.get('indexInfo') or {}).get('category') if has_vals else 'none' -}}
          dominant_hex: >-
            {%- if has_vals -%}
              {%- set c = (top.get('indexInfo') or {}).get('color') or {} -%}
              {%- set r = (c.get('red') or 0) * 255 -%}
              {%- set g = (c.get('green') or 0) * 255 -%}
              {%- set b = (c.get('blue') or 0) * 255 -%}
              {{- '#%02X%02X%02X'|format(r|round(0)|int(0), g|round(0)|int(0), b|round(0)|int(0)) -}}
            {%- else -%}
              {{ neutral_hex }}
            {%- endif -%}
          grass_value: >-
            {%- set xlist = (types | selectattr('code','eq','GRASS') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (has_vals and xlist|count>0) else 0 -}}
          tree_value: >-
            {%- set xlist = (types | selectattr('code','eq','TREE') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (has_vals and xlist|count>0) else 0 -}}
          weed_value: >-
            {%- set xlist = (types | selectattr('code','eq','WEED') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (has_vals and xlist|count>0) else 0 -}}
          recommendations: >-
            {{ (ranked[0].get('healthRecommendations') or []) | unique | list if has_vals else [] }}

      - name: Pollen Species RV Today
        unique_id: pollen_species_rv_today
        icon: mdi:leaf
        availability: >-
          {{- has_value(src) and ( (ctx.plants | count) > 0 or (plants_fallback | count) > 0 ) -}}
        state: >-
          {{- ctx.pick.name if (ctx.plants | count) > 0 else
              (plants_fallback[0].get('displayName') if (plants_fallback|count>0) else 'none') -}}
        attributes:
          code: >-
            {{- ctx.pick.code if (ctx.plants | count) > 0 else
                (plants_fallback[0].get('code') if (plants_fallback|count>0) else none) -}}
          type: >-
            {{- ctx.pick.type if (ctx.plants | count) > 0 else none -}}
          in_season: >-
            {{- ctx.pick.in_season if (ctx.plants | count) > 0 else none -}}
          category: >-
            {{- ctx.pick.category if (ctx.plants | count) > 0 else 'none' -}}
          value: >-
            {{- ctx.pick.value if (ctx.plants | count) > 0 else 0 -}}
          entity_picture: >-
            {{- ctx.pick.picture if (ctx.plants | count) > 0 else none -}}

      - name: Pollen Forecast RV Day 0
        unique_id: pollen_forecast_rv_day_0
        icon: mdi:calendar-today
        availability: >-
          {{ (ctx.days | count) > 0 }}
        state: >-
          {%- if (ctx.days | count) > 0 and (ctx.days[0].get('exists') | default(false)) -%}
            {{ ctx.days[0].get('state') or 'unknown' }}
          {%- else -%}
            none
          {%- endif -%}
        attributes:
          date: "{{ (ctx.days[0].get('date') if (ctx.days|count)>0 else none) }}"
          dominant_type: "{{ (ctx.days[0].get('dominant_type') if (ctx.days|count)>0 else none) or 'none' }}"
          dominant_value: "{{ (ctx.days[0].get('dominant_value') if (ctx.days|count)>0 else 0) | default(0) }}"
          dominant_category: "{{ (ctx.days[0].get('dominant_category') if (ctx.days|count)>0 else 'none') }}"
          dominant_hex: "{{ (ctx.days[0].get('dominant_hex') if (ctx.days|count)>0 else neutral_hex) }}"
          species_name: "{{ (ctx.days[0].get('species_name') if (ctx.days|count)>0 else none) }}"
          species_value: "{{ (ctx.days[0].get('species_value') if (ctx.days|count)>0 else 0) }}"
          species_category: "{{ (ctx.days[0].get('species_category') if (ctx.days|count)>0 else 'none') }}"
          species_type: "{{ (ctx.days[0].get('species_type') if (ctx.days|count)>0 else none) }}"
          species_picture: "{{ (ctx.days[0].get('species_picture') if (ctx.days|count)>0 else none) }}"

      - name: Pollen Forecast RV Day 1
        unique_id: pollen_forecast_rv_day_1
        icon: mdi:calendar
        availability: "{{ (ctx.days | count) > 1 }}"
        state: >-
          {%- if (ctx.days | count) > 1 and (ctx.days[1].get('exists') | default(false)) -%}
            {{ ctx.days[1].get('state') or 'unknown' }}
          {%- else -%}
            none
          {%- endif -%}
        attributes:
          date: "{{ (ctx.days[1].get('date') if (ctx.days|count)>1 else none) }}"
          dominant_type: "{{ (ctx.days[1].get('dominant_type') if (ctx.days|count)>1 else none) or 'none' }}"
          dominant_value: "{{ (ctx.days[1].get('dominant_value') if (ctx.days|count)>1 else 0) | default(0) }}"
          dominant_category: "{{ (ctx.days[1].get('dominant_category') if (ctx.days|count)>1 else 'none') }}"
          dominant_hex: "{{ (ctx.days[1].get('dominant_hex') if (ctx.days|count)>1 else neutral_hex) }}"
          species_name: "{{ (ctx.days[1].get('species_name') if (ctx.days|count)>1 else none) }}"
          species_value: "{{ (ctx.days[1].get('species_value') if (ctx.days|count)>1 else 0) }}"
          species_category: "{{ (ctx.days[1].get('species_category') if (ctx.days|count)>1 else 'none') }}"
          species_type: "{{ (ctx.days[1].get('species_type') if (ctx.days|count)>1 else none) }}"
          species_picture: "{{ (ctx.days[1].get('species_picture') if (ctx.days|count)>1 else none) }}"

      - name: Pollen Forecast RV Day 2
        unique_id: pollen_forecast_rv_day_2
        icon: mdi:calendar
        availability: "{{ (ctx.days | count) > 2 }}"
        state: >-
          {%- if (ctx.days | count) > 2 and (ctx.days[2].get('exists') | default(false)) -%}
            {{ ctx.days[2].get('state') or 'unknown' }}
          {%- else -%}
            none
          {%- endif -%}
        attributes:
          date: "{{ (ctx.days[2].get('date') if (ctx.days|count)>2 else none) }}"
          dominant_type: "{{ (ctx.days[2].get('dominant_type') if (ctx.days|count)>2 else none) or 'none' }}"
          dominant_value: "{{ (ctx.days[2].get('dominant_value') if (ctx.days|count)>2 else 0) | default(0) }}"
          dominant_category: "{{ (ctx.days[2].get('dominant_category') if (ctx.days|count)>2 else 'none') }}"
          dominant_hex: "{{ (ctx.days[2].get('dominant_hex') if (ctx.days|count)>2 else neutral_hex) }}"
          species_name: "{{ (ctx.days[2].get('species_name') if (ctx.days|count)>2 else none) }}"
          species_value: "{{ (ctx.days[2].get('species_value') if (ctx.days|count)>2 else 0) }}"
          species_category: "{{ (ctx.days[2].get('species_category') if (ctx.days|count)>2 else 'none') }}"
          species_type: "{{ (ctx.days[2].get('species_type') if (ctx.days|count)>2 else none) }}"
          species_picture: "{{ (ctx.days[2].get('species_picture') if (ctx.days|count)>2 else none) }}"

      - name: Pollen Species List RV Today
        unique_id: pollen_species_list_rv_today
        availability: "{{ has_value(src) and ( (ctx.di | count) > 0 ) }}"
        state: "{{ (ctx.di | count) > 0 }}"
        attributes:
          species: >-
            {%- set plants = (ctx.d or {}).get('plantInfo') or [] -%}
            {%- if plants | count == 0 -%}
              {%- set plants = plants_fallback -%}
            {%- endif -%}
            {%- set ns = namespace(out=[]) -%}
            {%- for p in plants -%}
              {%- set item = {
                'code': p.get('code'),
                'name': p.get('displayName'),
                'type': none,
                'in_season': none,
                'value': 0,
                'category': 'none',
                'picture': none
              } -%}
              {%- set ns.out = ns.out + [item] -%}
            {%- endfor -%}
            {{- ns.out -}}

      - name: Pollen Peak Index RV Today
        unique_id: pollen_peak_index_rv_today
        icon: mdi:meter-gas
        availability: "{{ has_value(src) and ((((ctx.d or {}).get('pollenTypeInfo') or []) | count) > 0) }}"
        state: >-
          {%- set types = (ctx.d or {}).get('pollenTypeInfo') or [] -%}
          {%- set vals = (
                types
                | selectattr('indexInfo','defined')
                | selectattr('indexInfo.value','defined')
                | map(attribute='indexInfo.value')
                | list
            ) -%}
          {{ (vals|max) if (vals|count) > 0 else 0 }}

###############################################################################
# Automations: staggered updates per location, ~10 min cadence with jitter
# Pass api_key via data so rest_command.url can template {{ api_key }}
###############################################################################
automation:
  # Nearby
  - id: google_pollen_nearby_refresh_via_rest_command
    alias: Google Pollen Nearby, refresh via REST command
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/10"
    variables:
      nearby_valid: >-
        {%- from 'macros/rest_helpers.jinja' import nearby_is_valid -%}
        {{ nearby_is_valid() | bool }}
    action:
      # early window jitter
      - delay:
          seconds: "{{ range(0, 20) | random | int }}"
      - choose:
          - conditions: "{{ nearby_valid }}"
            sequence:
              - service: rest_command.google_pollen_nearby_fetch
                data:
                  api_key: !secret google_pollen_api_key
                response_variable: resp
              - variables:
                  ok: "{{ resp is mapping and (resp.status | int(0)) == 200 and (resp.content is mapping or resp.content | string != '') }}"
                  parsed_obj: >-
                    {{ resp.content if resp is mapping and resp.content is mapping
                       else (resp.content | default('') | string | from_json(default={})) }}
              - event: google_pollen_nearby_update
                event_data:
                  available: "{{ ok }}"
                  parsed: "{{ parsed_obj | tojson }}"
        default:
          - event: google_pollen_nearby_update
            event_data:
              available: false
              parsed: "{}"

  # Home
  - id: google_pollen_home_refresh_via_rest_command
    alias: Google Pollen Home, refresh via REST command
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/10"
    variables:
      home_valid: >-
        {%- from 'macros/rest_helpers.jinja' import home_is_valid -%}
        {{ home_is_valid() | bool }}
    action:
      # mid window jitter, stagger vs Nearby
      - delay:
          seconds: "{{ 20 + (range(0, 20) | random | int) }}"
      - choose:
          - conditions: "{{ home_valid }}"
            sequence:
              - service: rest_command.google_pollen_home_fetch
                data:
                  api_key: !secret google_pollen_api_key
                response_variable: resp
              - variables:
                  ok: "{{ resp is mapping and (resp.status | int(0)) == 200 and (resp.content is mapping or resp.content | string != '') }}"
                  parsed_obj: >-
                    {{ resp.content if resp is mapping and resp.content is mapping
                       else (resp.content | default('') | string | from_json(default={})) }}
              - event: google_pollen_home_update
                event_data:
                  available: "{{ ok }}"
                  parsed: "{{ parsed_obj | tojson }}"
        default:
          - event: google_pollen_home_update
            event_data:
              available: false
              parsed: "{}"

  # RV
  - id: google_pollen_rv_refresh_via_rest_command
    alias: Google Pollen RV, refresh via REST command
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/10"
    conditions:
      - condition: template
        value_template: "{{ has_value('device_tracker.rv_gps') }}"
    variables:
      rv_valid: >-
        {%- from 'macros/rest_helpers.jinja' import rv_is_valid -%}
        {{ rv_is_valid() | bool }}
    action:
      # late window jitter, stagger vs Nearby/Home
      - delay:
          seconds: "{{ 40 + (range(0, 20) | random | int) }}"
      - choose:
          - conditions: "{{ rv_valid }}"
            sequence:
              - service: rest_command.google_pollen_rv_fetch
                data:
                  api_key: !secret google_pollen_api_key
                response_variable: resp
              - variables:
                  ok: "{{ resp is mapping and (resp.status | int(0)) == 200 and (resp.content is mapping or resp.content | string != '') }}"
                  parsed_obj: >-
                    {{ resp.content if resp is mapping and resp.content is mapping
                       else (resp.content | default('') | string | from_json(default={})) }}
              - event: google_pollen_rv_update
                event_data:
                  available: "{{ ok }}"
                  parsed: "{{ parsed_obj | tojson }}"
        default:
          - event: google_pollen_rv_update
            event_data:
              available: false
              parsed: "{}"
