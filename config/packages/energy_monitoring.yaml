# =============================================================================
# Utilities Package (merged)
# - Electric, Water: unchanged from original
# - Gas: flows now use input_numbers, add CCF/therms, kWh from therms, cost from therms
# For each appliance, the pipeline is now: binary_sensor.<appliance>_heating_state →
# sensor.<appliance>_gas_flow → sensor.<appliance>_gas_meter (integrated ft³) →
# sensor.<appliance>_gas_energy_total (kWh) → utility_meter.<appliance>_gas_energy_today (daily).
# =============================================================================

homeassistant:
  customize:
    # Mark all room "today" sensors as daily meters for your dashboards.
    sensor.parlor_energy_today:
      meter: daily
    sensor.living_room_energy_today:
      meter: daily
    sensor.dining_room_energy_today:
      meter: daily
    sensor.breakfast_room_energy_today:
      meter: daily
    sensor.kitchen_energy_today:
      meter: daily
    sensor.pantry_energy_today:
      meter: daily
    sensor.laundry_room_energy_today:
      meter: daily
    sensor.front_hallway_energy_today:
      meter: daily
    sensor.study_energy_today:
      meter: daily
    sensor.master_bedroom_energy_today:
      meter: daily
    sensor.guest_bedroom_energy_today:
      meter: daily
    sensor.master_bathroom_energy_today:
      meter: daily
    sensor.kids_bathroom_energy_today:
      meter: daily
    sensor.back_hallway_energy_today:
      meter: daily
    sensor.eleanor_s_room_energy_today:
      meter: daily
    sensor.michael_s_room_energy_today:
      meter: daily
    sensor.garage_energy_today:
      meter: daily
    sensor.shop_energy_today:
      meter: daily
    sensor.playroom_energy_today:
      meter: daily
    sensor.exercise_room_energy_today:
      meter: daily
    sensor.exterior_energy_today:
      meter: daily_total
    sensor.chicken_coop_energy_today:
      meter: daily
    sensor.rv_energy_today:
      meter: daily
    sensor.attic_energy_today:
      meter: daily
    sensor.basement_energy_today:
      meter: daily
    sensor.furnace_gas_energy_today:
      meter: daily
    sensor.dryer_gas_energy_today:
      meter: daily
    sensor.water_heater_gas_energy_today:
      meter: daily
    sensor.gas_stove_gas_energy_today:
      meter: daily
    sensor.shop_furnace_gas_energy_today:
      meter: daily
    sensor.furnace_gas_meter_today:
      meter: daily
      device_class: gas
    sensor.dryer_gas_meter_today:
      meter: daily
      device_class: gas
    sensor.water_heater_gas_meter_today:
      meter: daily
      device_class: gas
    sensor.gas_stove_gas_meter_today:
      meter: daily
      device_class: gas
    sensor.shop_furnace_gas_meter_today:
      meter: daily
      device_class: gas
    sensor.furnace_gas_meter:
      device_class: gas
    sensor.dryer_gas_meter:
      device_class: gas
    sensor.water_heater_gas_meter:
      device_class: gas
    sensor.gas_stove_gas_meter:
      device_class: gas
    sensor.shop_furnace_gas_meter:
      device_class: gas
    sensor.gas_daily:
      meter: daily_total
    sensor.water_daily:
      meter: daily_total
    sensor.electric_daily:
      meter: daily_total

# -----------------------------------------------------------------------------
# Input helpers for GAS (preferred over macros)
# -----------------------------------------------------------------------------
input_number:
  # Appliance input rates (BTU/hr)
  furnace_btu_per_hr:
    name: "Furnace Input Rate"
    unit_of_measurement: "BTU/hr"
    min: 50_000
    max: 200_000
    step: 500
    initial: 135_000
  dryer_btu_per_hr:
    name: "Dryer Input Rate"
    unit_of_measurement: "BTU/hr"
    min: 5_000
    max: 50_000
    step: 250
    initial: 20_000
  water_heater_btu_per_hr:
    name: "Water Heater Input Rate"
    unit_of_measurement: "BTU/hr"
    min: 5_000
    max: 60_000
    step: 250
    initial: 30_000
  gas_stove_btu_per_hr:
    name: "Gas Stove Input Rate"
    unit_of_measurement: "BTU/hr"
    min: 2_000
    max: 50_000
    step: 250
    initial: 25_000
  shop_furnace_btu_per_hr:
    name: "Shop Furnace Input Rate"
    unit_of_measurement: "BTU/hr"
    min: 5_000
    max: 80_000
    step: 250
    initial: 45_000

  # Gas constants (can be tuned per your utility/bill)
  gas_hhv_btu_per_ft3:
    name: "Gas HHV (BTU/ft³)"
    unit_of_measurement: "BTU/ft³"
    min: 950
    max: 1150
    step: 0.1
    initial: 1030.0
  gas_therm_factor:
    name: "Gas Therm Factor (therm/CCF)"
    unit_of_measurement: "therm/CCF"
    min: 0.95
    max: 1.10
    step: 0.00001
    initial: 1.02623
  gas_kwh_per_therm:
    name: "Gas kWh per Therm"
    unit_of_measurement: "kWh/therm"
    min: 28
    max: 31
    step: 0.0001
    initial: 29.300111

  # Cost model (from your bill)
  gas_fixed_charge_usd:
    name: "Gas Fixed Charge (incl first N therms)"
    unit_of_measurement: "USD"
    min: 0
    max: 100
    step: 0.01
    initial: 22.07
  gas_included_therms:
    name: "Gas Included Therms"
    unit_of_measurement: "therm"
    min: 0
    max: 10
    step: 0.01
    initial: 3
  gas_rate_usd_per_therm:
    name: "Gas Rate per Therm"
    unit_of_measurement: "USD/therm"
    min: 0
    max: 5
    step: 0.00001
    initial: 0.80004766
  gas_delivery_adj_usd_per_therm:
    name: "Gas Delivery Adj per Therm"
    unit_of_measurement: "USD/therm"
    min: 0
    max: 1
    step: 0.00001
    initial: 0.00576007
  gas_tariff_surcharge_pct:
    name: "Gas Tariff Surcharge (%)"
    unit_of_measurement: "%"
    min: 0
    max: 25
    step: 0.00001
    initial: 3.09278

# -----------------------------------------------------------------------------
# Physical/derived sensors (integration & derivative)
# -----------------------------------------------------------------------------
sensor:
  # Integrate gas flow rates (ft³/min) to cumulative volume (ft³).
  - platform: integration
    name: "Furnace Gas Meter"
    unique_id: e0b90494-7dc3-4117-ba79-f8e4212f4489
    source: sensor.furnace_gas_flow
    unit_time: min
    method: trapezoidal
    round: 6

  - platform: integration
    name: "Dryer Gas Meter"
    unique_id: eb0c8c6d-760b-488e-8cd6-d7a7165d7430
    source: sensor.dryer_gas_flow
    unit_time: min
    method: trapezoidal
    round: 6

  - platform: integration
    name: "Water Heater Gas Meter"
    unique_id: c4d8d040-b281-409b-8e88-5579a201e715
    source: sensor.water_heater_gas_flow
    unit_time: min
    method: trapezoidal
    round: 6

  - platform: integration
    name: "Gas Stove Gas Meter"
    unique_id: a1217825-f2e5-4f08-a5a9-c2df904214df
    source: sensor.gas_stove_gas_flow
    unit_time: min
    method: trapezoidal
    round: 6

  - platform: integration
    name: "Shop Furnace Gas Meter"
    unique_id: e50aebac-e1b6-439d-87a2-78befee2363b
    source: sensor.shop_furnace_gas_flow
    unit_time: min
    method: trapezoidal
    round: 6

  # Water usage rate from totalizer. Units will match the totalizer per minute.
  - platform: derivative
    name: "Water Usage Rate"
    source: sensor.water_meter
    unit_time: min
    time_window: "0:30:00"

  - platform: integration
    name: "Electric Usage"
    unique_id: 20558ee1-49d6-49fc-89cb-c4d89a89019a
    source: sensor.none_123_1min
    method: trapezoidal
    round: 6

# -----------------------------------------------------------------------------
# Template sensors: gas flows (ft³/min) using input_numbers, meters, conversions
# -----------------------------------------------------------------------------
template:
  # Equipment state inference for gas flow availability.
  - binary_sensor:
      - name: "Furnace Heating State"
        unique_id: 83658176-35de-43ae-a8ae-a0d77de90c41
        device_class: running
        availability: "{{ state_attr('climate.downstairs_thermostat','hvac_action') is not none }}"
        state: "{{ is_state_attr('climate.downstairs_thermostat','hvac_action','heating') }}"

      - name: "Dryer Heating State"
        unique_id: 588218ad-a81d-4190-8d9e-5f3f7db86add
        device_class: running
        availability: "{{ has_value('sensor.dryer_power') }}"
        state: "{{ states('sensor.dryer_power') | float(0) > 10 }}"

      - name: "Water Heater Heating State"
        unique_id: 800639ef-a977-4757-ac00-b5bc3cac71d9
        device_class: running
        availability: "{{ has_value('sensor.water_heater_outlet_power') }}"
        state: "{{ states('sensor.water_heater_outlet_power') | float(0) > 10 }}"

      - name: "Gas Stove Heating State"
        unique_id: c3e8bbab-7306-4f33-a89a-bae67270e1e8
        device_class: running
        availability: "{{ has_value('switch.gas_stove_switch') }}"
        state: "{{ is_state('switch.gas_stove_switch','on') }}"

      - name: "Shop Furnace Heating State"
        unique_id: bb29bfaa-2f5b-460c-a519-0dd5a04d46c5
        device_class: running
        availability: "{{ has_value('sensor.shop_furnace_switch_0_power') }}"
        state: "{{ states('sensor.shop_furnace_switch_0_power') | float(0) > 10 }}"

  - sensor:
      # Gas flow rates inferred from equipment state; computed from input_numbers.
      - name: "Furnace Gas Flow"
        unique_id: 78df6cce-146e-402a-91e4-9350521a6cb2
        device_class: volume_flow_rate
        unit_of_measurement: "ft³/min"
        state_class: measurement
        availability: "{{ has_value('binary_sensor.furnace_heating_state') }}"
        state: >-
          {% set on = is_state('binary_sensor.furnace_heating_state','on') %}
          {% set btu = states('input_number.furnace_btu_per_hr') | float %}
          {% set hhv = states('input_number.gas_hhv_btu_per_ft3') | float %}
          {{ (btu / hhv) / 60 if on else 0 }}

      - name: "Dryer Gas Flow"
        unique_id: 5231012c-c2e4-418b-b1ac-452dbe5f1e44
        device_class: volume_flow_rate
        unit_of_measurement: "ft³/min"
        state_class: measurement
        availability: "{{ has_value('binary_sensor.dryer_heating_state') }}"
        state: >-
          {% set on = is_state('binary_sensor.dryer_heating_state','on') %}
          {% set btu = states('input_number.dryer_btu_per_hr') | float %}
          {% set hhv = states('input_number.gas_hhv_btu_per_ft3') | float %}
          {{ (btu / hhv) / 60 if on else 0 }}

      - name: "Water Heater Gas Flow"
        unique_id: 36ed9cd0-101a-49d7-9d43-961b94028378
        device_class: volume_flow_rate
        unit_of_measurement: "ft³/min"
        state_class: measurement
        availability: "{{ has_value('binary_sensor.water_heater_heating_state') }}"
        state: >-
          {% set on = is_state('binary_sensor.water_heater_heating_state','on') %}
          {% set btu = states('input_number.water_heater_btu_per_hr') | float %}
          {% set hhv = states('input_number.gas_hhv_btu_per_ft3') | float %}
          {{ (btu / hhv) / 60 if on else 0 }}

      - name: "Gas Stove Gas Flow"
        unique_id: 156229d6-bf11-4b67-aef6-c1910b550946
        device_class: volume_flow_rate
        unit_of_measurement: "ft³/min"
        state_class: measurement
        availability: "{{ has_value('binary_sensor.gas_stove_heating_state') }}"
        state: >-
          {% set on = is_state('binary_sensor.gas_stove_heating_state','on') %}
          {% set btu = states('input_number.gas_stove_btu_per_hr') | float %}
          {% set hhv = states('input_number.gas_hhv_btu_per_ft3') | float %}
          {{ (btu / hhv) / 60 if on else 0 }}

      - name: "Shop Furnace Gas Flow"
        unique_id: 8d0e3594-cb1c-4f96-8dea-dd4745e785ba
        device_class: volume_flow_rate
        unit_of_measurement: "ft³/min"
        state_class: measurement
        availability: "{{ has_value('binary_sensor.shop_furnace_heating_state') }}"
        state: >-
          {% set on = is_state('binary_sensor.shop_furnace_heating_state','on') %}
          {% set btu = states('input_number.shop_furnace_btu_per_hr') | float %}
          {% set hhv = states('input_number.gas_hhv_btu_per_ft3') | float %}
          {{ (btu / hhv) / 60 if on else 0 }}

  - sensor:
      # Total appliance energy usage from integrated flow and input numbers.
      - name: "Furnace Gas Energy Total"
        unique_id: 9a109001-d437-4f91-8cee-3de5792453f4
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        availability: "{{ has_value('sensor.furnace_gas_meter') }}"
        state: >-
          {% set ft3 = states('sensor.furnace_gas_meter') | float(0) %}
          {% set ccf = ft3 / 100 %}
          {% set therms = ccf * states('input_number.gas_therm_factor') | float %}
          {{ therms * states('input_number.gas_kwh_per_therm') | float }}
        attributes:
          source_entity: sensor.furnace_gas_meter

      - name: "Shop Furnace Gas Energy Total"
        unique_id: 67e2f8bd-3b8a-4ae6-a135-20fd40c3f365
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        availability: "{{ has_value('sensor.shop_furnace_gas_meter') }}"
        state: >-
          {% set ft3 = states('sensor.shop_furnace_gas_meter') | float(0) %}
          {% set ccf = ft3 / 100 %}
          {% set therms = ccf * states('input_number.gas_therm_factor') | float %}
          {{ therms * states('input_number.gas_kwh_per_therm') | float }}
        attributes:
          source_entity: sensor.shop_furnace_gas_meter

      - name: "Gas Stove Gas Energy Total"
        unique_id: 2c6df629-12fb-4d74-8872-68b6175c6fe4
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        availability: "{{ has_value('sensor.gas_stove_gas_meter') }}"
        state: >-
          {% set ft3 = states('sensor.gas_stove_gas_meter') | float(0) %}
          {% set ccf = ft3 / 100 %}
          {% set therms = ccf * states('input_number.gas_therm_factor') | float %}
          {{ therms * states('input_number.gas_kwh_per_therm') | float }}
        attributes:
          source_entity: sensor.gas_stove_gas_meter

      - name: "Dryer Gas Energy Total"
        unique_id: 0a4ba866-f59a-41ac-84a0-18b2a2b972ed
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        availability: "{{ has_value('sensor.dryer_gas_meter') }}"
        state: >-
          {% set ft3 = states('sensor.dryer_gas_meter') | float(0) %}
          {% set ccf = ft3 / 100 %}
          {% set therms = ccf * states('input_number.gas_therm_factor') | float %}
          {{ therms * states('input_number.gas_kwh_per_therm') | float }}
        attributes:
          source_entity: sensor.dryer_gas_meter

      - name: "Water Heater Gas Energy Total"
        unique_id: 6b5f4390-6200-45cf-a8d0-6566fd467ce2
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        availability: "{{ has_value('sensor.water_heater_gas_meter') }}"
        state: >-
          {% set ft3 = states('sensor.water_heater_gas_meter') | float(0) %}
          {% set ccf = ft3 / 100 %}
          {% set therms = ccf * states('input_number.gas_therm_factor') | float %}
          {{ therms * states('input_number.gas_kwh_per_therm') | float }}
        attributes:
          source_entity: sensor.water_heater_gas_meter

  # Aggregated total gas (sum of per-appliance meters)
  - sensor:
      - name: "Gas Meter"
        unique_id: dfb58452-cd2d-49c5-b591-8f7408889a82
        device_class: gas
        unit_of_measurement: "CCF"
        state_class: total_increasing
        state: >-
          {% set state = ([
              states('sensor.furnace_gas_meter') | float(0),
              states('sensor.dryer_gas_meter') | float(0),
              states('sensor.water_heater_gas_meter') | float(0),
              states('sensor.gas_stove_gas_meter') | float(0),
              states('sensor.shop_furnace_gas_meter') | float(0)
            ] | sum) / 100
          %}
          {{ this.state if state < (this.state | float(0)) else state }}

      - name: "Gas Therms Total"
        unique_id: 65f9db01-f783-4f1c-b99a-c6cad60bb262
        state_class: total_increasing
        unit_of_measurement: "therm"
        availability: "{{ has_value('sensor.gas_meter') }}"
        state: >-
          {% set ccf = states('sensor.gas_meter') | float(0) %}
          {{ ccf * states('input_number.gas_therm_factor') | float }}

      # Energy Dashboard kWh from therms (single source of truth)
      - name: "Gas Energy Total"
        unique_id: 281e4724-4c9c-402a-9166-a50f6bc2d6ab
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        availability: "{{ has_value('sensor.gas_therms_total') }}"
        state: >-
          {{ states('sensor.gas_therms_total') | float(0)
             * states('input_number.gas_kwh_per_therm') | float }}
        attributes:
          basis_therms: "{{ states('sensor.gas_therms_total') | float(0) }}"

  # Persist water total across restarts without dropping to zero.  (unchanged)
  - trigger:
      - platform: state
        entity_id: sensor.water_meter
        not_to: [unavailable, unknown, none]
      - platform: homeassistant
        event: start
    sensor:
      - name: "Water Meter (persisted)"
        unique_id: a70f4186-84bf-44fa-93f7-7ccd189f7c31
        device_class: water
        unit_of_measurement: gal
        state_class: total_increasing
        state: >-
          {% set src = 'sensor.water_meter' %}
          {% if trigger.platform == 'state' %}
            {{ trigger.to_state.state }}
          {% else %}
            {{ states(src) if has_value(src) else this.state }}
          {% endif %}

  # -----------------------------------------------------------------------------
  # Cost models
  # -----------------------------------------------------------------------------
  - sensor:
      # Gas Cost from THERMS (relies on monthly ft³ relay → CCF → therms)
      - name: "Gas Therms Relay"
        unique_id: 6b99992f-43d1-400c-a76d-cf9e1676603c
        state_class: total
        unit_of_measurement: "therm"
        availability: "{{ has_value('sensor.gas_meter_relay') }}"
        state: >-
          {% set ft3 = states('sensor.gas_meter_relay') | float(0) %}
          {% set ccf = ft3 / 100 %}
          {{ ccf * states('input_number.gas_therm_factor') | float }}
        attributes:
          basis_volume_ft3: "{{ states('sensor.gas_meter_relay') | float(0) }}"
          basis_volume_ccf: "{{ (states('sensor.gas_meter_relay') | float(0) / 100) | round(6) }}"
          therm_factor: "{{ states('input_number.gas_therm_factor') | float }}"
          last_reset: "{{ state_attr('sensor.gas_meter_relay', 'last_reset') }}"

      - name: "Gas Cost"
        unique_id: 1a08b783-b0da-46e4-9266-c3a578c79e08
        device_class: monetary
        state_class: total
        unit_of_measurement: "USD"
        availability: "{{ has_value('sensor.gas_therms_relay') }}"
        state: >-
          {% set therms = states('sensor.gas_therms_relay') | float(0) %}
          {% set fixed = states('input_number.gas_fixed_charge_usd') | float %}
          {% set incl = states('input_number.gas_included_therms') | float %}
          {% set rate = states('input_number.gas_rate_usd_per_therm') | float %}
          {% set adj = states('input_number.gas_delivery_adj_usd_per_therm') | float %}
          {% set pct = states('input_number.gas_tariff_surcharge_pct') | float / 100 %}
          {% set over = max(therms - incl, 0) %}
          {% set subtotal = fixed + (rate * over) + (adj * therms) %}
          {{ (subtotal * (1 + pct)) | round(2) }}
        attributes:
          basis_therms: "{{ states('sensor.gas_therms_relay') | float(0) }}"
          fixed_component_usd: "{{ states('input_number.gas_fixed_charge_usd') | float }}"
          included_therms: "{{ states('input_number.gas_included_therms') | float }}"
          over_therms: >-
            {% set t = states('sensor.gas_therms_relay') | float(0) %}
            {% set i = states('input_number.gas_included_therms') | float %}
            {{ max(t - i, 0) }}
          variable_rate_usd_per_therm: "{{ states('input_number.gas_rate_usd_per_therm') | float }}"
          delivery_adj_usd_per_therm: "{{ states('input_number.gas_delivery_adj_usd_per_therm') | float }}"
          tariff_surcharge_pct: "{{ states('input_number.gas_tariff_surcharge_pct') | float }}"
          subtotal_before_surcharge_usd: >-
            {% set therms = states('sensor.gas_therms_relay') | float(0) %}
            {% set fixed = states('input_number.gas_fixed_charge_usd') | float %}
            {% set incl = states('input_number.gas_included_therms') | float %}
            {% set rate = states('input_number.gas_rate_usd_per_therm') | float %}
            {% set adj = states('input_number.gas_delivery_adj_usd_per_therm') | float %}
            {% set over = max(therms - incl, 0) %}
            {{ (fixed + (rate * over) + (adj * therms)) | round(2) }}
          last_reset: "{{ state_attr('sensor.gas_meter_relay', 'last_reset') }}"

      # Electric Cost (from electric_meter_relay total)
      - name: "Electric Cost"
        unique_id: 4689e76f-9787-46cb-864b-3abbcac5cc11
        device_class: monetary
        state_class: total
        unit_of_measurement: "USD"
        availability: "{{ has_value('sensor.electric_meter_relay') }}"
        state: >-
          {% set x = states('sensor.electric_meter_relay') | float(0) %}
          {{ 17.87 + 0.16008 * x }}
        attributes:
          last_reset: "{{ state_attr('sensor.electric_meter_relay', 'last_reset') }}"

      # Water Cost (tiered from water_meter_relay total)
      - name: "Water Cost"
        unique_id: b79b9c24-fffc-496f-9ab5-5ca06e82742f
        device_class: monetary
        state_class: total
        unit_of_measurement: "USD"
        availability: "{{ has_value('sensor.water_meter_relay') }}"
        state: >-
          {% set x = states('sensor.water_meter_relay') | float(0) %}
          {% if x < 10_000 %}
            {{ 76.00 }}
          {% elif x < 56_600 %}
            {{ 76.00 + 0.0038 * x }}
          {% elif x < 66_600 %}
            {{ 291.08 + 0.00345 * x }}
          {% else %}
            {{ 520.85 + 0.00259 * x }}
          {% endif %}
        attributes:
          last_reset: "{{ state_attr('sensor.water_meter_relay', 'last_reset') }}"

  # Area energy totals
  - sensor:
      - name: "Parlor Energy Total"
        unique_id: 3a0bbc83-2eb3-447b-9b4c-95ac4798d277
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('parlor', exclude=[this.entity_id, 'sensor.parlor_energy_today']) }}
      - name: "Living Room Energy Total"
        unique_id: ea816434-d0aa-4a02-8f24-26baf0ffdd44
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('living_room', exclude=[this.entity_id, 'sensor.living_room_energy_today']) }}
      - name: "Dining Room Energy Total"
        unique_id: 4f734637-53f3-4af7-9882-1bd1a18fc71a
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('dining_room', exclude=[this.entity_id, 'sensor.dining_room_energy_today']) }}
      - name: "Breakfast Room Energy Total"
        unique_id: e1760f1c-8f83-4876-8243-5f63e96d0dc7
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('breakfast_room', exclude=[this.entity_id, 'sensor.breakfast_room_energy_today']) }}
      - name: "Kitchen Energy Total"
        unique_id: 84e6e5ab-8630-4549-8741-670b2559c9f7
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('kitchen', exclude=[this.entity_id, 'sensor.kitchen_energy_today']) }}
      - name: "Pantry Energy Total"
        unique_id: 5f469a68-1a41-4697-b0e1-27ccd99f3dc3
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('pantry', exclude=[this.entity_id, 'sensor.pantry_energy_today']) }}
      - name: "Laundry Room Energy Total"
        unique_id: 5d926b1e-5181-46b9-8aa0-a12d398ce7b8
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('laundry_room', exclude=[this.entity_id, 'sensor.laundry_room_energy_today']) }}
      - name: "Front Hallway Energy Total"
        unique_id: ef1d2262-405c-47af-a113-34922806e774
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('front_hallway', exclude=[this.entity_id, 'sensor.front_hallway_energy_today']) }}
      - name: "Study Energy Total"
        unique_id: 492a7b80-a94b-4af9-b8f3-19aeb8a0c728
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('study', exclude=[this.entity_id, 'sensor.study_energy_today']) }}
      - name: "Guest Bedroom Energy Total"
        unique_id: 0e4bb08b-3e5f-4893-94ef-3bbdf1a40130
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('guest_bedroom', exclude=[this.entity_id, 'sensor.guest_bedroom_energy_today']) }}
      - name: "Master Bedroom Energy Total"
        unique_id: 1db5e421-5670-46ef-b234-6d227a257fc6
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('master_bedroom', exclude=[this.entity_id, 'sensor.master_bedroom_energy_today']) }}
      - name: "Master Bathroom Energy Total"
        unique_id: a5b69b8f-6a0f-459b-9252-5d6f087637a4
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('master_bathroom', exclude=[this.entity_id, 'sensor.master_bathroom_energy_today']) }}
      - name: "Back Hallway Energy Total"
        unique_id: bd53129e-d992-4f56-8ca0-a3b82aff9b29
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('back_hallway', exclude=[this.entity_id, 'sensor.back_hallway_energy_today']) }}
      - name: "Eleanor's Room Energy Total"
        unique_id: f359f822-6982-4e73-b81a-189f08b94bc1
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('eleanor_s_room', exclude=[this.entity_id, 'sensor.eleanor_s_room_energy_today']) }}
      - name: "Michael's Room Energy Total"
        unique_id: ac44b434-3e53-4c59-aea0-5e1433f2567b
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('michael_s_room', exclude=[this.entity_id, 'sensor.michael_s_room_energy_today']) }}
      - name: "Kids Bathroom Energy Total"
        unique_id: 3c9e46ba-45d7-445e-aa34-8aff029ad674
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('kids_bathroom', exclude=[this.entity_id, 'sensor.kids_bathroom_energy_today']) }}
      - name: "Exterior Energy Total"
        unique_id: 97f9a035-b2d0-4bf2-b1a8-a95f9720628c
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('exterior', exclude=[this.entity_id, 'sensor.exterior_energy_today']) }}
      - name: "Chicken Coop Energy Total"
        unique_id: 09f0b18e-1cb2-48d4-b916-8b9e74b9a3b7
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('chicken_coop', exclude=[this.entity_id, 'sensor.chicken_coop_energy_today']) }}
      - name: "RV Energy Total"
        unique_id: f58b6dc8-99f6-4ce6-9eac-16773e70fb1d
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('rv', exclude=[this.entity_id, 'sensor.rv_energy_today']) }}
      - name: "Garage Energy Total"
        unique_id: 7a7a41f1-5980-4207-a1fc-5aff645ea6d6
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('garage', exclude=[this.entity_id, 'sensor.garage_energy_today']) }}
      - name: "Shop Energy Total"
        unique_id: 65c2818c-1fb0-4442-8976-843142738640
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('shop', exclude=[this.entity_id, 'sensor.shop_energy_today']) }}
      - name: "Exercise Room Energy Total"
        unique_id: 22b93f80-ac6e-4a61-bc7c-df20582d3ccc
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('exercise_room', exclude=[this.entity_id, 'sensor.exercise_room_energy_today']) }}
      - name: "Playroom Energy Total"
        unique_id: a0c20626-fa28-42b7-95b9-436cc58ca43d
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('playroom', exclude=[this.entity_id, 'sensor.playroom_energy_today']) }}
      - name: "Attic Energy Total"
        unique_id: f3211704-3afc-407f-ac0b-050bc760fc96
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('attic', exclude=[this.entity_id, 'sensor.attic_energy_today']) }}
      - name: "Basement Energy Total"
        unique_id: 72a56ffd-a7f8-48ee-8ec1-9dc224d43cf6
        device_class: energy
        state_class: total_increasing
        unit_of_measurement: "kWh"
        state: >-
          {% from 'metrics/utilities/electric_helpers.jinja' import area_energy %}
          {{ area_energy('basement', exclude=[this.entity_id, 'sensor.basement_energy_today']) }}

# -----------------------------------------------------------------------------
# Utility meters
# -----------------------------------------------------------------------------
utility_meter:
  # ---------------------- Water ----------------------
  water:
    unique_id: 932d21e5-7bb0-4e2d-b6b9-2194e2817ee6
    name: "Water Meter Relay"
    source: sensor.water_meter_persisted
    periodically_resetting: false
    always_available: true

  water_daily:
    unique_id: 34418945-b814-4b8d-993c-f50f76eb5300
    name: "Water Daily"
    source: sensor.water_meter_persisted
    cycle: daily

  # ---------------------- Electric -------------------
  energy:
    unique_id: ad6434a6-e10f-4ad5-9c80-6ef82bb31e35
    name: "Electric Meter Relay"
    source: sensor.electric_usage
    periodically_resetting: true
    always_available: true
    cycle: monthly
    offset:
      days: 17

  energy_daily:
    unique_id: beb88c50-da0f-47fb-8d2d-ef6ff7ee8e97
    name: "Electric Daily"
    source: sensor.electric_usage
    cycle: daily

  # ---------------------- Gas ----------------
  gas:
    unique_id: 902ade2c-5716-431b-88c7-27c969e91396
    name: "Gas Meter Relay"
    source: sensor.gas_meter
    periodically_resetting: false
    always_available: true
    cycle: monthly
    offset:
      days: 17

  gas_daily:
    unique_id: 2f851e31-828c-45fb-82bd-89d825abb8f6
    name: "Gas Daily"
    source: sensor.gas_meter
    cycle: daily

  # Per-appliance daily gas usage
  furnace_gas_energy_today:
    unique_id: 6357d0a1-cb8d-4a2c-8d77-e23b9a53e6ad
    name: "Furnace Gas Energy Today"
    source: sensor.furnace_gas_energy_total
    cycle: daily
  dryer_gas_energy_today:
    unique_id: 086279a9-c7ab-4be0-9ae5-8f554a599acf
    name: "Dryer Gas Energy Today"
    source: sensor.dryer_gas_energy_total
    cycle: daily
  water_heater_gas_energy_today:
    unique_id: f85f8e36-59ab-4ff5-857b-145ce0fff7c1
    name: "Water Heater Gas Energy Today"
    source: sensor.water_heater_gas_energy_total
    cycle: daily
  gas_stove_gas_energy_today:
    unique_id: 791c7cfc-5ed3-4f9c-923f-97ef463adc40
    name: "Gas Stove Gas Energy Today"
    source: sensor.gas_stove_gas_energy_total
    cycle: daily
  shop_furnace_gas_energy_today:
    unique_id: 6b9e660b-aec0-45ea-acd7-664009b73984
    name: "Shop Furnace Gas Energy Today"
    source: sensor.shop_furnace_gas_energy_total
    cycle: daily

  furnace_gas_meter_today:
    unique_id: 07b922dd-8e17-420a-96c1-f2114c7b0ac1
    name: "Furnace Gas Meter Today"
    source: sensor.furnace_gas_meter
    cycle: daily
  dryer_gas_meter_today:
    unique_id: abe3b4ee-292d-4645-9f93-9ad4317f62fb
    name: "Dryer Gas Meter Today"
    source: sensor.dryer_gas_meter
    cycle: daily
  water_heater_gas_meter_today:
    unique_id: 5c5daa22-6fec-4d80-96d8-274b8da3af8f
    name: "Water Heater Gas Meter Today"
    source: sensor.water_heater_gas_meter
    cycle: daily
  gas_stove_gas_meter_today:
    unique_id: 248263fa-a38e-436e-b0ad-3265826a7c9f
    name: "Gas Stove Gas Meter Today"
    source: sensor.gas_stove_gas_meter
    cycle: daily
  shop_furnace_gas_meter_today:
    unique_id: 36eec78d-497e-45de-b44a-ce9ad11c86d5
    name: "Shop Furnace Gas Meter Today"
    source: sensor.shop_furnace_gas_meter
    cycle: daily

  # -----------------------------------------------------------------------------
  # Daily “today” meters for Electric areas (unchanged from original)
  # -----------------------------------------------------------------------------
  parlor_energy_today:
    unique_id: 8c6cfade-0fff-4bb1-9e51-3f83f1d8b3ca
    name: "Parlor Energy Today"
    source: sensor.parlor_energy_total
    cycle: daily
  living_room_energy_today:
    unique_id: de5fe44b-c367-4ac1-b497-eda1a637861e
    name: "Living Room Energy Today"
    source: sensor.living_room_energy_total
    cycle: daily
  dining_room_energy_today:
    unique_id: cde0687e-f653-4ea7-ac19-6df32faa754d
    name: "Dining Room Energy Today"
    source: sensor.dining_room_energy_total
    cycle: daily
  breakfast_room_energy_today:
    unique_id: cf80d4de-309b-4a29-97c0-6e60add5eb6d
    name: "Breakfast Room Energy Today"
    source: sensor.breakfast_room_energy_total
    cycle: daily
  kitchen_energy_today:
    unique_id: 1effc67a-7cad-4c60-a4a2-72e74dfd4785
    name: "Kitchen Energy Today"
    source: sensor.kitchen_energy_total
    cycle: daily
  pantry_energy_today:
    unique_id: 12beba60-5c41-4d6e-ad98-ddf86839368b
    name: "Pantry Energy Today"
    source: sensor.pantry_energy_total
    cycle: daily
  laundry_room_energy_today:
    unique_id: 94ecc1b6-258e-4881-ae89-534fe582a4aa
    name: "Laundry Room Energy Today"
    source: sensor.laundry_room_energy_total
    cycle: daily
  front_hallway_energy_today:
    unique_id: c21c8880-3a44-4176-8fce-9b4a8cfbad22
    name: "Front Hallway Energy Today"
    source: sensor.front_hallway_energy_total
    cycle: daily
  study_energy_today:
    unique_id: 44ed6510-d9ad-4f68-b32a-c51d34a6be8c
    name: "Study Energy Today"
    source: sensor.study_energy_total
    cycle: daily
  master_bedroom_energy_today:
    unique_id: 9993735f-f08c-429d-ba74-5297f85312b9
    name: "Master Bedroom Energy Today"
    source: sensor.master_bedroom_energy_total
    cycle: daily
  guest_bedroom_energy_today:
    unique_id: 1840d938-abf6-4502-a213-9935b4dfd5dc
    name: "Guest Bedroom Energy Today"
    source: sensor.guest_bedroom_energy_total
    cycle: daily
  master_bathroom_energy_today:
    unique_id: 814a3b49-03d4-4da1-81aa-9898e8f728e3
    name: "Master Bathroom Energy Today"
    source: sensor.master_bathroom_energy_total
    cycle: daily
  kids_bathroom_energy_today:
    unique_id: 406c0127-406a-4ad0-ae44-a683a8eea990
    name: "Kids Bathroom Energy Today"
    source: sensor.kids_bathroom_energy_total
    cycle: daily
  back_hallway_energy_today:
    unique_id: f023c955-8df0-4390-9282-77bd4c59d643
    name: "Back Hallway Energy Today"
    source: sensor.back_hallway_energy_total
    cycle: daily
  eleanor_s_room_energy_today:
    unique_id: 5b3200a2-8bc6-4f85-858c-5cbe7a8051fd
    name: "Eleanor's Room Energy Today"
    source: sensor.eleanor_s_room_energy_total
    cycle: daily
  michael_s_room_energy_today:
    unique_id: 083d1e25-8b68-49fa-a80e-024b75b35aca
    name: "Michael's Room Energy Today"
    source: sensor.michael_s_room_energy_total
    cycle: daily
  garage_energy_today:
    unique_id: 0baabe23-9020-412d-bc0d-6095c2d73deb
    name: "Garage Energy Today"
    source: sensor.garage_energy_total
    cycle: daily
  shop_energy_today:
    unique_id: dcf426c4-7891-435b-8a0a-fa8695cf1580
    name: "Shop Energy Today"
    source: sensor.shop_energy_total
    cycle: daily
  playroom_energy_today:
    unique_id: ebd54786-fb6e-42e4-9464-1015dafbb5b3
    name: "Playroom Energy Today"
    source: sensor.playroom_energy_total
    cycle: daily
  exercise_room_energy_today:
    unique_id: d7c1982e-b47d-41c6-9ba8-d1e0a6ab086d
    name: "Exercise Room Energy Today"
    source: sensor.exercise_room_energy_total
    cycle: daily
  exterior_energy_today:
    unique_id: 9be64a0f-88c4-4c42-8b44-de1e30aa24b3
    name: "Exterior Energy Today"
    source: sensor.exterior_energy_total
    cycle: daily
  chicken_coop_energy_today:
    unique_id: 0c41d384-0fbc-433d-998f-bbbcf1cee95a
    name: "Chicken Coop Energy Today"
    source: sensor.chicken_coop_energy_total
    cycle: daily
  rv_energy_today:
    unique_id: 46abeb0c-1ae1-48ff-b725-48970e54ec27
    name: "RV Energy Today"
    source: sensor.rv_energy_total
    cycle: daily
  attic_energy_today:
    unique_id: 86d957ba-6c01-489b-ad42-6304f4653343
    name: "Attic Energy Today"
    source: sensor.attic_energy_total
    cycle: daily
  basement_energy_today:
    unique_id: 6e5aa57d-59c3-479e-acf4-16ea14bd9aa8
    name: "Basement Energy Today"
    source: sensor.basement_energy_total
    cycle: daily
