###############################################################################
# PACKAGE: presence_and_return_from_proximity.yaml
# Uses GUI-created Proximity sensors (no proximity: YAML)
###############################################################################

############################
# TUNABLE INPUTS
############################
input_number:
  # Home hysteresis thresholds (mi)
  home_arrive_radius_mi:
    name: Home arrive radius (mi)
    min: 0.1
    max: 5
    step: 0.1
    mode: slider
    unit_of_measurement: "mi"
    icon: mdi:map-marker-radius
  home_depart_radius_mi:
    name: Home depart radius (mi)
    min: 0.3
    max: 8
    step: 0.1
    mode: slider
    unit_of_measurement: "mi"
    icon: mdi:map-marker-distance

  # Work return preheat approach radii (mi)
  work_preheat_radius_aaron_mi:
    name: Work preheat radius, Aaron (mi)
    min: 1
    max: 40
    step: 0.5
    mode: slider
    unit_of_measurement: "mi"
    icon: mdi:ray-start-end
  work_preheat_radius_ashley_mi:
    name: Work preheat radius, Ashley (mi)
    min: 0.2
    max: 5
    step: 0.1
    mode: slider
    unit_of_measurement: "mi"
    icon: mdi:ray-start-end

  # Camper return logic
  rv_min_distance_home_mi:
    name: RV min distance from home (mi)
    min: 1
    max: 500
    step: 1
    mode: slider
    unit_of_measurement: "mi"
    icon: mdi:map-marker-distance
  homeward_fraction_camper:
    name: Camper return fraction (× current home↔RV distance)
    min: 0.3
    max: 0.9
    step: 0.05
    mode: slider
    unit_of_measurement: "×"
    icon: mdi:ray-start-end

  # Optional stability to reduce flip-flop
  stability_min:
    name: Condition stability (min)
    min: 0
    max: 30
    step: 1
    mode: slider
    unit_of_measurement: "min"
    icon: mdi:timer

############################
# LATCHES
############################
input_boolean:
  home_occupied_latch:
    name: Home occupied (latched)
    icon: mdi:home-account
  returning_home_from_work_latch:
    name: Returning home from work (latched)
    icon: mdi:home-import-outline
  returning_home_from_camper_latch:
    name: Returning home from camper (latched)
    icon: mdi:home-import-outline
  someone_is_home_raw:
    name: Someone is Home (raw)
    icon: mdi:home-account

############################
# CORE LOGIC
############################
# Proximity sensors produced by the GUI integration, as you listed:
#   sensor.home_nearest_distance (ft)
#   sensor.home_nearest_direction_of_travel
#   sensor.home_aaron_watson_distance (ft)
#   sensor.home_aaron_watson_direction_of_travel
#   sensor.home_ashley_watson_distance (ft)
#   sensor.home_ashley_watson_direction_of_travel
#
# Camper GPS device:
#   device_tracker.rv_gps  (from statestream)
#
# We convert feet->miles for thresholds.
template:

  - binary_sensor:
      # OVERRIDES (optional, adjust or remove)
      - name: Home presence override
        icon: mdi:home
        state: "{{ is_state('person.aaron_watson','home') or is_state('person.ashley_watson','home') }}"

      # Simple away flag for the house
      - name: Home Away Mode
        unique_id: 3c8d5d5f-8a7c-4f7a-a9b8-1df6d2d02a01
        state: "{{ not is_state('input_boolean.home_occupied_latch','on') }}"
        icon: >-
          {{ 'mdi:home-outline' if is_state('binary_sensor.home_away_mode','on') else 'mdi:home' }}

      # Returning signals for UI and automations
      - name: Returning Home From Work
        unique_id: 9a3c0d9c-1478-4f2a-8c0d-4f75e6b1bb11
        state: "{{ is_state('input_boolean.returning_home_from_work_latch','on') }}"
        icon: >-
          {{ 'mdi:home-import-outline' if is_state('binary_sensor.returning_home_from_work','on') else 'mdi:home-outline' }}
        attributes:
          aaron_distance_home_mi: >-
            {{ (states('sensor.home_aaron_watson_distance')|float(0) * 0.000189393939) }}
          aaron_dir: "{{ states('sensor.home_aaron_watson_direction_of_travel') or 'unknown' }}"
          ashley_distance_home_mi: >-
            {{ (states('sensor.home_ashley_watson_distance')|float(0) * 0.000189393939) }}
          ashley_dir: "{{ states('sensor.home_ashley_watson_direction_of_travel') or 'unknown' }}"
          aaron_preheat_radius_mi: "{{ states('input_number.work_preheat_radius_aaron_mi')|float(10) }}"
          ashley_preheat_radius_mi: "{{ states('input_number.work_preheat_radius_ashley_mi')|float(0.6) }}"

      - name: Returning Home From Camper
        unique_id: 7ad26ed5-18a4-4f8b-b343-1325a00a9932
        availability: "{{ has_value('device_tracker.rv_gps') }}"
        state: "{{ is_state('input_boolean.returning_home_from_camper_latch','on') }}"
        icon: >-
          {{ 'mdi:home-import-outline' if is_state('binary_sensor.returning_home_from_camper','on') else 'mdi:home-outline' }}
        attributes:
          family_distance_home_mi: >-
            {{ (states('sensor.home_nearest_distance')|float(0) * 0.000189393939) }}
          family_dir: "{{ states('sensor.home_nearest_direction_of_travel') or 'unknown' }}"
          rv_distance_home_mi: "{{ distance('zone.home','device_tracker.rv_gps')|float(0) }}"
          fraction_threshold: "{{ states('input_number.homeward_fraction_camper')|float(0.5) }}"
          halfway_threshold_mi: >-
            {{ (distance('zone.home','device_tracker.rv_gps')|float(0) *
                states('input_number.homeward_fraction_camper')|float(0.5))|round(2) }}
          rv_enabled: >-
            {{ distance('zone.home','device_tracker.rv_gps')|float(0) >=
              states('input_number.rv_min_distance_home_mi')|float(20) }}

  - binary_sensor:
      - name: "Truck away"
        unique_id: truck_away_reliable
        state: >
          {{ is_state('device_tracker.truck_ibeacon', 'not_home') }}

      - name: "Minivan away"
        unique_id: minivan_away_reliable
        state: >
          {{ is_state('device_tracker.minivan_ibeacon', 'not_home') }}

      - name: "Any vehicle away"
        unique_id: any_vehicle_away
        state: >
          {{ is_state('binary_sensor.truck_away', 'on')
             or is_state('binary_sensor.minivan_away', 'on') }}

automation:
  - id: home_presence_latch
    alias: Home presence latch
    mode: single

    triggers:
      - trigger: state
        entity_id:
          - sensor.home_nearest_distance
          - sensor.home_nearest_direction_of_travel
          - sensor.home_aaron_watson_distance
          - sensor.home_aaron_watson_direction_of_travel
          - sensor.home_ashley_watson_distance
          - sensor.home_ashley_watson_direction_of_travel
          - device_tracker.rv_gps
          - binary_sensor.home_presence_override
          - input_number.home_arrive_radius_mi
          - input_number.home_depart_radius_mi
          - input_number.work_preheat_radius_aaron_mi
          - input_number.work_preheat_radius_ashley_mi
          - input_number.rv_min_distance_home_mi
          - input_number.homeward_fraction_camper
          - input_number.stability_min

    actions:
      - variables:
          _ft_to_mi: 0.000189393939
          home_arr: "{{ states('input_number.home_arrive_radius_mi')|float(0.4) }}"
          home_dep: "{{ states('input_number.home_depart_radius_mi')|float(1.2) }}"
          fam_d_mi: "{{ (states('sensor.home_nearest_distance')|float(999999) * _ft_to_mi)|float(9999) }}"
          fam_dir: "{{ states('sensor.home_nearest_direction_of_travel') or 'unknown' }}"
          aar_d_mi: "{{ (states('sensor.home_aaron_watson_distance')|float(999999) * _ft_to_mi)|float(9999) }}"
          aar_dir: "{{ states('sensor.home_aaron_watson_direction_of_travel') or 'unknown' }}"
          ash_d_mi: "{{ (states('sensor.home_ashley_watson_distance')|float(999999) * _ft_to_mi)|float(9999) }}"
          ash_dir: "{{ states('sensor.home_ashley_watson_direction_of_travel') or 'unknown' }}"
          aar_pre: "{{ states('input_number.work_preheat_radius_aaron_mi')|float(10) }}"
          ash_pre: "{{ states('input_number.work_preheat_radius_ashley_mi')|float(0.6) }}"
          home_override: "{{ is_state('binary_sensor.home_presence_override','on') }}"
          d_home_rv_mi: "{{ distance('zone.home','device_tracker.rv_gps')|float(0) }}"
          rv_min_home: "{{ states('input_number.rv_min_distance_home_mi')|float(20) }}"
          camper_enabled: "{{ d_home_rv_mi >= rv_min_home }}"
          frac_camper: "{{ states('input_number.homeward_fraction_camper')|float(0.5) }}"
          halfway_thr_mi: "{{ (d_home_rv_mi * frac_camper)|float(0) }}"
          home_arrive_now: "{{ fam_d_mi <= home_arr }}"
          home_depart_now: "{{ fam_d_mi >= home_dep and fam_dir in ['away_from','stationary','unknown'] }}"
          work_return_now: >-
            {{
              (aar_d_mi <= aar_pre and aar_dir == 'towards')
              or
              (ash_d_mi <= ash_pre and ash_dir == 'towards')
            }}
          camper_return_now: "{{ camper_enabled and fam_dir == 'towards' and fam_d_mi <= halfway_thr_mi }}"

      - choose:
          - conditions: "{{ home_override or home_arrive_now }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.home_occupied_latch
          - conditions: "{{ (not home_override) and home_depart_now }}"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.home_occupied_latch

      - choose:
          - conditions: "{{ work_return_now }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.returning_home_from_work_latch
          - conditions: "{{ not work_return_now }}"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.returning_home_from_work_latch

      - choose:
          - conditions: "{{ camper_return_now }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.returning_home_from_camper_latch
          - conditions: "{{ not camper_return_now }}"
            sequence:
              - service: input_boolean.turn_off
                target:
                  entity_id: input_boolean.returning_home_from_camper_latch

  - id: aggregate_someone_is_home
    alias: Aggregate Someone is Home
    description: "Apply vehicle override to someone_is_home_raw"
    mode: single

    trigger:
      - platform: state
        entity_id:
          - input_boolean.someone_is_home_raw
          - person.aaron_watson
          - person.ashley_watson
          - binary_sensor.any_vehicle_away

    condition: []

    action:
      - variables:
          raw_on: "{{ is_state('input_boolean.someone_is_home_raw', 'on') }}"
          any_vehicle_away: "{{ is_state('binary_sensor.any_vehicle_away', 'on') }}"
          aaron_home: "{{ is_state('person.aaron_watson', 'home') }}"
          ashley_home: "{{ is_state('person.ashley_watson', 'home') }}"

          # "Fake presence" case:
          # - Your presence logic thinks someone is home (raw_on)
          # - Your phone says you are home (aaron_home)
          # - Ashley is not home
          # - At least one vehicle is away
          fake_presence: >
            {{ raw_on
              and aaron_home
              and not ashley_home
              and any_vehicle_away }}

          # Final, vehicle aware someone_is_home
          aggregated_on: "{{ raw_on and not fake_presence }}"

      - choose:
          - conditions:
              - condition: template
                value_template: "{{ aggregated_on }}"
            sequence:
              - service: input_boolean.turn_on
                target:
                  entity_id: input_boolean.someone_is_home
        default:
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.someone_is_home

############################
# SANE DEFAULTS
############################
homeassistant:
  customize:
    input_number.home_arrive_radius_mi:
      initial: 0.4      # inside Ashley's ~1 mi work distance
    input_number.home_depart_radius_mi:
      initial: 1.2
    input_number.work_preheat_radius_aaron_mi:
      initial: 10       # longer commute
    input_number.work_preheat_radius_ashley_mi:
      initial: 0.6      # short commute
    input_number.rv_min_distance_home_mi:
      initial: 20       # ignore RV when parked near home
    input_number.homeward_fraction_camper:
      initial: 0.5      # halfway home
    input_number.stability_min:
      initial: 5
