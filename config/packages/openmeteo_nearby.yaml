# =====================================================================================
# OpenMeteo: consolidated package with per-location and selector
# Exposes:
#   - Weather entities for Nearby, Home, RV
#   - Individual current metrics as sensors per-location
#   - Individual daily (index 0 = today) metrics as sensors per-location
# Dependencies:
#   - sensors: sensor.openmeteo_nearby, sensor.openmeteo_home, sensor.openmeteo_rv
#   - jinja: env/weather_codes.jinja (for condition mapping)
# Notes:
#   - All templates use has_value and safe indexing to avoid errors.
#   - Units: uses native units coming from your REST/OpenMeteo setup.
# =====================================================================================

###############################################################################
# REST command: OpenMeteo Nearby
###############################################################################
rest_command:
  openmeteo_nearby_fetch:
    url: >-
      {%- from 'macros/rest_helpers.jinja' import nearby_is_valid, nearby_lat, nearby_lon, nearby_alt -%}
      {%- set base = 'https://api.open-meteo.com/v1/forecast' if (nearby_is_valid() | bool) else 'http://127.0.0.1:65535/' -%}
      {%- if base.startswith('http://127.0.0.1') -%}
        {{ base }}
      {%- else -%}
        {{ base }}?latitude={{ nearby_lat() }}&longitude={{ nearby_lon() }}&elevation={{ nearby_alt() }}&timezone=auto&current=apparent_temperature,cloud_cover,dew_point_2m,is_day,relative_humidity_2m,surface_pressure,temperature_2m,uv_index,visibility,weather_code,wind_direction_10m,wind_gusts_10m,wind_speed_10m&daily=precipitation_probability_max,precipitation_sum,rain_sum,snowfall_sum,sunrise,sunset,temperature_2m_max,temperature_2m_min,uv_index_max,weather_code,wind_gusts_10m_max,wind_direction_10m_dominant,wind_speed_10m_max&hourly=apparent_temperature,cloud_cover,dew_point_2m,is_day,precipitation,precipitation_probability,relative_humidity_2m,surface_pressure,temperature_2m,uv_index,weather_code,wind_direction_10m,wind_gusts_10m,wind_speed_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&forecast_hours=24
      {%- endif -%}
    method: GET
    timeout: 60
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache

template:

  - weather:
      - name: OpenMeteo Weather Nearby
        unique_id: openmeteo_weather_nearby
        condition_template: >
          {%- from 'metrics/weather/forecasts.jinja' import current_condition -%}
          {{- current_condition('sensor.openmeteo_nearby') -}}
        apparent_temperature_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('apparent_temperature') -}}"
        cloud_coverage_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('cloud_cover') -}}"
        dew_point_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('dew_point_2m') -}}"
        humidity_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('relative_humidity_2m') -}}"
        pressure_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('surface_pressure') -}}"
        temperature_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('temperature_2m') -}}"
        visibility_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('visibility') -}}"
        wind_bearing_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('wind_direction_10m') -}}"
        wind_gust_speed_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('wind_gusts_10m') -}}"
        wind_speed_template: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('wind_speed_10m') -}}"
        precipitation_unit: "in"
        pressure_unit: "hPa"
        temperature_unit: "°F"
        visibility_unit: "m"
        wind_speed_unit: "mph"
        forecast_daily_template: >
          {%- from 'metrics/weather/forecasts.jinja' import forecast_daily -%}
          {{- forecast_daily('sensor.openmeteo_nearby') | from_json(default={}) -}}
        forecast_hourly_template: >
          {%- from 'metrics/weather/forecasts.jinja' import forecast_hourly -%}
          {{- forecast_hourly('sensor.openmeteo_nearby') | from_json(default={}) -}}

  - trigger:
      - platform: event
        event_type: openmeteo_nearby_update
    sensor:
      - name: OpenMeteo Nearby
        unique_id: openmeteo_nearby
        device_class: temperature
        state_class: measurement
        unit_of_measurement: "°F"
        availability: >-
          {{ trigger is not none
             and trigger.event is not none
             and trigger.event.data is mapping
             and (trigger.event.data.available | default(false)) }}
        state: >-
          {%- set data = trigger.event.data.parsed if trigger and trigger.event and trigger.event.data.parsed is mapping else {} -%}
          {%- set cur = data.get('current') or {} -%}
          {%- set t = cur.get('temperature_2m') -%}
          {{ t if t is not none else states(this.entity_id) }}
        attributes:
          timezone: "{{ trigger.event.data.parsed.timezone if trigger else none }}"
          timezone_abbreviation: "{{ trigger.event.data.parsed.timezone_abbreviation if trigger else none }}"
          elevation: "{{ trigger.event.data.parsed.elevation if trigger else none }}"
          current_units: "{{ trigger.event.data.parsed.current_units if trigger else none }}"
          current: "{{ trigger.event.data.parsed.current if trigger else none }}"
          hourly_units: "{{ trigger.event.data.parsed.hourly_units if trigger else none }}"
          hourly: "{{ trigger.event.data.parsed.hourly if trigger else none }}"
          daily_units: "{{ trigger.event.data.parsed.daily_units if trigger else none }}"
          daily: "{{ trigger.event.data.parsed.daily if trigger else none }}"

  - sensor:
      - name: Nearby Temperature
        unique_id: nearby_current_temperature
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('temperature_2m') -}}"

      - name: Nearby UV Index
        unique_id: nearby_current_uv_index
        state_class: measurement
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('uv_index') -}}"

      - name: Nearby Apparent Temperature
        unique_id: nearby_current_apparent_temperature
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('apparent_temperature') -}}"

      - name: Nearby Humidity
        unique_id: nearby_current_humidity
        device_class: humidity
        unit_of_measurement: "%"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('relative_humidity_2m') -}}"

      - name: Nearby Dew Point
        unique_id: nearby_current_dew_point
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('dew_point_2m') -}}"

      - name: Nearby Pressure
        unique_id: nearby_current_pressure
        device_class: atmospheric_pressure
        unit_of_measurement: "hPa"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('surface_pressure') -}}"

      - name: Nearby Wind Speed
        unique_id: nearby_current_wind_speed
        device_class: wind_speed
        unit_of_measurement: "mph"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('wind_speed_10m') -}}"

      - name: Nearby Wind Gust
        unique_id: nearby_current_wind_gust
        device_class: wind_speed
        unit_of_measurement: "mph"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('wind_gusts_10m') -}}"

      - name: Nearby Wind Direction
        unique_id: nearby_current_wind_direction
        device_class: wind_direction
        unit_of_measurement: "°"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('wind_direction_10m') -}}"

      - name: Nearby Visibility
        unique_id: nearby_current_visibility
        device_class: distance
        unit_of_measurement: "m"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('visibility') -}}"

      - name: Nearby Cloud Cover
        unique_id: nearby_current_cloud_cover
        unit_of_measurement: "%"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('cloud_cover') -}}"

      - name: Nearby Weather Code
        unique_id: nearby_current_weather_code
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('weather_code') -}}"

      - name: Nearby Observation Time
        unique_id: nearby_current_observation_time
        device_class: timestamp
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_nearby','current') or {}).get('time') | as_datetime | as_local -}}"

      - name: Nearby Today Temp Max
        unique_id: nearby_daily0_temp_max
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('temperature_2m_max') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: Nearby Today Temp Min
        unique_id: nearby_daily0_temp_min
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('temperature_2m_min') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: Nearby Today Uv Index Max
        unique_id: nearby_daily0_uv_index_max
        state_class: measurement
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('uv_index_max') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: Nearby Tomorrow Uv Index Max
        unique_id: nearby_daily1_uv_index_max
        state_class: measurement
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('uv_index_max') or [] -%}
          {{- _l[1] if (_l | length) > 1 else none -}}

      - name: Nearby Day 2 Uv Index Max
        unique_id: nearby_daily2_uv_index_max
        state_class: measurement
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('uv_index_max') or [] -%}
          {{- _l[2] if (_l | length) > 2 else none -}}

      - name: Nearby Day 2 Weekday
        unique_id: nearby_daily2_weekday
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('time') or [] -%}
          {{- (_l[2] | as_datetime).strftime('%A') if (_l | length) > 2 else none -}}

      - name: Nearby Today Precip Sum
        unique_id: nearby_daily0_precip_sum
        device_class: precipitation
        unit_of_measurement: "in"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('precipitation_sum') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: Nearby Today Rain Sum
        unique_id: nearby_daily0_rain_sum
        device_class: precipitation
        unit_of_measurement: "in"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('rain_sum') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: Nearby Today Snowfall Sum
        unique_id: nearby_daily0_snowfall_sum
        device_class: precipitation
        unit_of_measurement: "in"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('snowfall_sum') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: Nearby Today Precip Prob Max
        unique_id: nearby_daily0_precip_prob_max
        unit_of_measurement: "%"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('precipitation_probability_max') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: Nearby Today Wind Speed Max
        unique_id: nearby_daily0_wind_speed_max
        device_class: wind_speed
        unit_of_measurement: "mph"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('windspeed_10m_max') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: Nearby Today Wind Dir Dom
        unique_id: nearby_daily0_wind_dir_dom
        device_class: wind_direction
        unit_of_measurement: "°"
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('winddirection_10m_dominant') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: Nearby Today Sunrise
        unique_id: nearby_daily0_sunrise
        device_class: timestamp
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('sunrise') or [] -%}
          {{- _l[0] | as_datetime | as_local if (_l | length) > 0 else none -}}

      - name: Nearby Today Sunset
        unique_id: nearby_daily0_sunset
        device_class: timestamp
        availability: "{{- has_value('sensor.openmeteo_nearby') and (state_attr('sensor.openmeteo_nearby','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_nearby','daily') or {}).get('sunset') or [] -%}
          {{- _l[0] | as_datetime | as_local if (_l | length) > 0 else none -}}

  - sensor:
      - name: Nearby UV Window JSON
        unique_id: nearby_uv_window_json
        icon: mdi:code-json
        availability: "{{- has_value('sensor.openmeteo_nearby') -}}"
        state: "{{- now () -}}"
        attributes:
          data: >-
            {%- from 'metrics/uv/protection_window.jinja' import uv_window -%}
            {{- uv_window('sensor.openmeteo_nearby', 3.5) | from_json(default={}) -}}

  - binary_sensor:
      - name: Nearby UV Protection
        unique_id: nearby_uv_protection
        availability: "{{- has_value('sensor.nearby_uv_window_json') -}}"
        state: >-
          {%- set window = state_attr('sensor.nearby_uv_window_json','data') -%}
          {%- set s = window.get('start') | as_datetime(default=None) -%}
          {%- set e = window.get('end') | as_datetime(default=None) -%}
          {{- s is not none and e is not none and s | as_local <= now() < e | as_local -}}
        attributes:
          start: >-
            {%- set window = state_attr('sensor.nearby_uv_window_json','data') -%}
            {%- set dt = window.get('start') | as_datetime(default=none) -%}
            {{- dt | as_local if dt is not none -}}
          end: >-
            {%- set window = state_attr('sensor.nearby_uv_window_json','data') -%}
            {%- set dt = window.get('end') | as_datetime(default=none) -%}
            {{- dt | as_local if dt is not none -}}
          duration: >-
            {%- set window = state_attr('sensor.nearby_uv_window_json','data') -%}
            {{- timedelta(minutes=window.get('duration_min') | int(0)) -}}
          active: >-
            {%- set window = state_attr('sensor.nearby_uv_window_json','data') -%}
            {{- window.get('active') | bool(none) -}}
          ever_above: >-
            {%- set window = state_attr('sensor.nearby_uv_window_json','data') -%}
            {{- window.get('ever_above') | bool(none) -}}

  - sensor:
      - name: Nearby UV Exposure JSON
        unique_id: nearby_uv_exposure_json
        icon: mdi:code-json
        availability: "{{- has_value('sensor.openmeteo_nearby') -}}"
        state: "{{- now () -}}"
        attributes:
          data: >-
            {%- from 'metrics/uv/exposure_st.jinja' import uv_safe_exposure_multi -%}
            {{- uv_safe_exposure_multi('sensor.openmeteo_nearby') | from_json(default={}) -}}

  - sensor:
      - name: Nearby Safe Exposure End ST1
        unique_id: nearby_safe_exposure_end_st1
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st1', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st1', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: Nearby Safe Exposure End ST2
        unique_id: nearby_safe_exposure_end_st2
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st2', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st2', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: Nearby Safe Exposure End ST3
        unique_id: nearby_safe_exposure_end_st3
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st3', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st3', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: Nearby Safe Exposure End ST4
        unique_id: nearby_safe_exposure_end_st4
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st4', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st4', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: Nearby Safe Exposure End ST5
        unique_id: nearby_safe_exposure_end_st5
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st5', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st5', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: Nearby Safe Exposure End ST6
        unique_id: nearby_safe_exposure_end_st6
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st6', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st6', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: Nearby Safe Exposure Minutes ST1
        unique_id: nearby_safe_exposure_minutes_st1
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st1', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st1', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: Nearby Safe Exposure Minutes ST2
        unique_id: nearby_safe_exposure_minutes_st2
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st2', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st2', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: Nearby Safe Exposure Minutes ST3
        unique_id: nearby_safe_exposure_minutes_st3
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st3', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st3', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: Nearby Safe Exposure Minutes ST4
        unique_id: nearby_safe_exposure_minutes_st4
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st4', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st4', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: Nearby Safe Exposure Minutes ST5
        unique_id: nearby_safe_exposure_minutes_st5
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st5', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st5', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: Nearby Safe Exposure Minutes ST6
        unique_id: nearby_safe_exposure_minutes_st6
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st6', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.nearby_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st6', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

automation:
  - id: openmeteo_nearby_refresh_via_rest_command
    alias: OpenMeteo Nearby, refresh via REST command
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/5"
    variables:
      nearby_valid: >-
        {%- from 'macros/rest_helpers.jinja' import nearby_is_valid -%}
        {{ nearby_is_valid() | bool }}
    action:
      - delay:
          seconds: "{{ range(0, 60) | random | int }}"
      - choose:
          - conditions: "{{ nearby_valid }}"
            sequence:
              - service: rest_command.openmeteo_nearby_fetch
                response_variable: resp
              - variables:
                  ok: "{{ resp is mapping and (resp.status | int(0)) == 200 }}"
                  parsed_obj: >-
                    {{ resp.content if resp is mapping and resp.content is mapping
                       else (resp.content | default('') | string | from_json(default={})) }}
              - event: openmeteo_nearby_update
                event_data:
                  available: "{{ ok }}"
                  parsed: "{{ parsed_obj | tojson }}"
        default:
          - event: openmeteo_nearby_update
            event_data:
              available: false
              parsed: {}
