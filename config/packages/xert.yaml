
# ===========================
#  Fitness: Rides (Zwift + Strava + Xert via RESTful sensors)
#  Requires: mushroom-card, apexcharts-card, Strava (Unofficial), Zwift integration.
# ===========================

###############################################################################
# Secrets you must add to /config/secrets.yaml
#
# xert_username: your@email
# xert_password: yourXertPassword
#
# Note: Xert requires client credentials in the Authorization header (xert_public:xert_public).
###############################################################################

input_number:
  xert_token_expires_epoch:
    name: "Xert Token Expires (epoch)"
    min: 0
    max: 2147483647
    step: 1

input_text:
  xert_access_token:
    name: "Xert Access Token"
    max: 255
  xert_refresh_token:
    name: "Xert Refresh Token"
    max: 255

###############################################################################
# Xert: rest_command for token fetch/refresh (called on demand)
###############################################################################
rest_command:
  xert_token_fetch:
    url: "https://www.xertonline.com/oauth/token"
    method: POST
    headers:
      Authorization: "Basic eGVydF9wdWJsaWM6eGVydF9wdWJsaWM="
    payload: !secret xert_token_password_payload
    content_type: "application/x-www-form-urlencoded"

  xert_token_refresh:
    url: "https://www.xertonline.com/oauth/token"
    method: POST
    headers:
      Authorization: "Basic eGVydF9wdWJsaWM6eGVydF9wdWJsaWM="
    payload: "grant_type=refresh_token&refresh_token={{ states('input_text.xert_refresh_token')|urlencode }}"
    content_type: "application/x-www-form-urlencoded"

  xert_training_info_fetch:
    url: "https://www.xertonline.com/oauth/training_info"
    method: GET
    timeout: 20
    headers:
      Authorization: "Bearer {{ states('input_text.xert_access_token') }}"
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache

  xert_activity_list_fetch:
    url: >-
      {% set from = states('sensor.xert_lookback_from_epoch') %}
      {% set to = states('sensor.xert_lookback_to_epoch') %}
      {{ 'https://www.xertonline.com/oauth/activity?from=' ~ from ~ '&to=' ~ to }}
    method: GET
    timeout: 20
    headers:
      Authorization: "Bearer {{ states('input_text.xert_access_token') }}"
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache

template:

  # ---- Xert Training Info Raw ----
  - trigger:
      - platform: event
        event_type: xert_training_info_update
    variables:
      root: >-
        {% set x = trigger.event.data.parsed %}
        {% if x is mapping %}
          {{ x }}
        {% else %}
          {{ x | default('') | from_json(default={}) }}
        {% endif %}
    sensor:
      - name: Xert Training Info Raw
        state: >-
          {{ root.success | default(false) }}
        attributes:
          signature: "{{ root.get('signature') }}"
          status: "{{ root.get('status') }}"
          tl: "{{ root.get('tl') }}"
          targetXSS: "{{ root.get('targetXSS') }}"
          wotd: "{{ root.get('wotd') }}"
          weight: "{{ root.get('weight') }}"
          source: "{{ root.get('source') }}"
        availability: "{{ trigger.event.data.available | default(false) }}"

  # ---- Xert Activity List Raw ----
  - trigger:
      - platform: event
        event_type: xert_activity_list_update
    sensor:
      - name: Xert Activity List Raw
        state: >-
          {%- set root = (trigger.event.data.parsed if trigger and trigger.event and trigger.event.data.parsed is mapping
                          else (trigger.event.data.parsed | default('') | from_json(default={}))) -%}
          {{ (root.success | default(false)) }}
        attributes:
          activities: >-
            {%- set d = root if root is mapping else {} -%}
            {{ d.get('activities') }}
        availability: "{{ trigger.event.data.available | default(false) }}"

###############################################################################
# Xert: Derived sensors
###############################################################################
  - sensor:
      - name: "Xert Training Status"
        state: "{{ state_attr('sensor.xert_training_info_raw','status') or 'Unknown' }}"
        icon: mdi:heart-pulse
      - name: "Xert FTP"
        unit_of_measurement: "W"
        state: "{{ (state_attr('sensor.xert_training_info_raw','signature') or {}).get('ftp', 0)|float(0)|round(0) }}"
      - name: "Xert LTP"
        unit_of_measurement: "W"
        state: "{{ (state_attr('sensor.xert_training_info_raw','signature') or {}).get('ltp', 0)|float(0)|round(0) }}"
      - name: "Xert Peak Power"
        unit_of_measurement: "W"
        state: "{{ (state_attr('sensor.xert_training_info_raw','signature') or {}).get('pp', 0)|float(0)|round(0) }}"
      - name: "Xert HIE"
        unit_of_measurement: "kJ"
        state: >
          {% set hie = (state_attr('sensor.xert_training_info_raw','signature') or {}).get('hie', 0)|float(0) %}
          {{ hie|round(2) }}
      - name: "Xert TL Low"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','tl') or {}).get('low', 0)|float(0)|round(1) }}"
      - name: "Xert TL High"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','tl') or {}).get('high', 0)|float(0)|round(1) }}"
      - name: "Xert TL Peak"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','tl') or {}).get('peak', 0)|float(0)|round(1) }}"
      - name: "Xert TL Total"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','tl') or {}).get('total', 0)|float(0)|round(1) }}"
      - name: "Xert Target XSS Total"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','targetXSS') or {}).get('total', 0)|float(0)|round(1) }}"
      - name: "Xert Target XSS Low"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','targetXSS') or {}).get('low', 0)|float(0)|round(1) }}"
      - name: "Xert Target XSS High"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','targetXSS') or {}).get('high', 0)|float(0)|round(1) }}"
      - name: "Xert Target XSS Peak"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','targetXSS') or {}).get('peak', 0)|float(0)|round(1) }}"

###############################################################################
# Xert: Lookback sensors
###############################################################################
  - trigger:
      - platform: homeassistant
        event: start
      - platform: time_pattern
        hours: "0"
        minutes: "0"
        seconds: "42"
    sensor:
      - name: "Xert Lookback From Epoch"
        state: "{{ (now().timestamp()|int(0) - 90*24*3600) }}"  # 90 days
      - name: "Xert Lookback To Epoch"
        state: "{{ now().timestamp()|int(0) }}"
      - name: "Xert Progression Max Acts"
        state: 50  # how many activities to graph (recent N)

  - sensor:
      # ---- POWER (W) ----
      - name: "Xert Last Avg Power W"
        unit_of_measurement: "W"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('avg_power') %}
          {{ (x if x is number else states('sensor.xert_last_avg_power_w')|float(0))|round(0) }}
      - name: "Xert Last Max Power W"
        unit_of_measurement: "W"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('max_power') %}
          {{ (x if x is number else states('sensor.xert_last_max_power_w')|float(0))|round(0) }}
      - name: "Xert Last Power Remainder W"
        unit_of_measurement: "W"
        state: >
          {% set mx = states('sensor.xert_last_max_power_w')|float(0) %}
          {% set av = states('sensor.xert_last_avg_power_w')|float(0) %}
          {{ (mx-av if mx>av else 0)|round(0) }}

      # ---- SPEED (mph) ----
      - name: "Xert Last Avg Speed mph"
        unit_of_measurement: "mph"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('avg_speed') %}
          {{ (x if x is number else states('sensor.xert_last_avg_speed_mph')|float(0))|round(0) }}
      - name: "Xert Last Max Speed mph"
        unit_of_measurement: "mph"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('max_speed') %}
          {{ (x if x is number else states('sensor.xert_last_max_speed_mph')|float(0))|round(0) }}
      - name: "Xert Last Speed Remainder mph"
        unit_of_measurement: "mph"
        state: >
          {% set mx = states('sensor.xert_last_max_speed_mph')|float(0) %}
          {% set av = states('sensor.xert_last_avg_speed_mph')|float(0) %}
          {{ (mx-av if mx>av else 0)|round(1) }}

      # ---- CADENCE (rpm) ----
      - name: "Xert Last Avg Cadence rpm"
        unit_of_measurement: "rpm"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('avg_cadence') %}
          {{ (x if x is number else states('sensor.xert_last_avg_cadence_rpm')|float(0))|round(0) }}
      - name: "Xert Last Max Cadence rpm"
        unit_of_measurement: "rpm"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('max_cadence') %}
          {{ (x if x is number else states('sensor.xert_last_max_cadence_rpm')|float(0))|round(0) }}
      - name: "Xert Last Cadence Remainder rpm"
        unit_of_measurement: "rpm"
        state: >
          {% set mx = states('sensor.xert_last_max_cadence_rpm')|float(0) %}
          {% set av = states('sensor.xert_last_avg_cadence_rpm')|float(0) %}
          {{ (mx-av if mx>av else 0)|round(0) }}

      # ---- HEART RATE (bpm) ----
      - name: "Xert Last Avg HR bpm"
        unit_of_measurement: "bpm"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('avg_heart_rate') %}
          {{ (x if x is number else states('sensor.xert_last_avg_hr_bpm')|float(0))|round(0) }}
      - name: "Xert Last Max HR bpm"
        unit_of_measurement: "bpm"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('max_heart_rate') %}
          {{ (x if x is number else states('sensor.xert_last_max_hr_bpm')|float(0))|round(0) }}
      - name: "Xert Last HR Remainder bpm"
        unit_of_measurement: "bpm"
        state: >
          {% set mx = states('sensor.xert_last_max_hr_bpm')|float(0) %}
          {% set av = states('sensor.xert_last_avg_hr_bpm')|float(0) %}
          {{ (mx-av if mx>av else 0)|round(0) }}

###############################################################################
# Automations: bootstrap, store tokens, proactive refresh, self heal
###############################################################################
automation:

  - alias: "Startup - delay external API storm"
    trigger:
      - platform: homeassistant
        event: start
    action:
      - delay: "00:02:00"
      - event: x_startup_ok

  - id: xert_bootstrap_token
    alias: "Xert: bootstrap token on startup"
    trigger:
      - platform: event
        event_type: x_startup_ok
    mode: restart
    action:
      - service: script.serialized_service_call
        data:
          service: rest_command.xert_token_fetch
          jitter_max: 20
          cooldown: 2
        response_variable: xert_init
      - variables:
          acc: "{{ (xert_init.get('content') or {}).get('access_token','') }}"
          ref: "{{ (xert_init.get('content') or {}).get('refresh_token','') }}"
          exp: "{{ (xert_init.get('content') or {}).get('expires_in', 0)|int(0) }}"
          crt: "{{ (xert_init.get('content') or {}).get('created_at', now().timestamp()|int(0))|int(0) }}"
          exp_epoch: "{{ crt + exp }}"
      - choose:
          - conditions: "{{ acc|length > 0 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_access_token
                data:
                  value: "{{ acc }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_refresh_token
                data:
                  value: "{{ ref }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.xert_token_expires_epoch
                data:
                  value: "{{ exp_epoch - 300 }}"   # refresh 5 min early
              - service: script.serialized_service_call
                data:
                  service: rest_command.xert_training_info_fetch
                  jitter_max: 20
                  cooldown: 2
                response_variable: resp_ti
              - variables:
                  ti_ok: "{{ resp_ti is mapping and (resp_ti.status|int(0)) == 200 and (resp_ti.content is mapping or resp_ti.content|string != '') }}"
                  ti_parsed: >-
                    {{ resp_ti.content if resp_ti is mapping and resp_ti.content is mapping
                       else (resp_ti.content|default('')|string|from_json(default={})) }}
              - event: xert_training_info_update
                event_data:
                  available: "{{ ti_ok }}"
                  parsed: "{{ ti_parsed | tojson }}"
              - service: script.serialized_service_call
                data:
                  service: rest_command.xert_activity_list_fetch
                  jitter_max: 20
                  cooldown: 2
                response_variable: resp_al
              - variables:
                  al_ok: "{{ resp_al is mapping and (resp_al.status|int(0)) == 200 and (resp_al.content is mapping or resp_al.content|string != '') }}"
                  al_parsed: >-
                    {{ resp_al.content if resp_al is mapping and resp_al.content is mapping
                       else (resp_al.content|default('')|string|from_json(default={})) }}
              - event: xert_activity_list_update
                event_data:
                  available: "{{ al_ok }}"
                  parsed: "{{ al_parsed | tojson }}"
              - wait_template: >-
                  {{ (state_attr('sensor.xert_activity_list_raw','activities') or []) | length > 0 }}
                timeout: "00:00:45"
                continue_on_timeout: true

  - id: xert_refresh_daemon
    alias: "Xert: refresh token proactively"
    trigger:
      - platform: time_pattern
        minutes: "/10"
    variables:
      now_epoch: "{{ now().timestamp()|int(0) }}"
      exp_epoch: "{{ states('input_number.xert_token_expires_epoch')|int(0) }}"
    condition: "{{ exp_epoch > 0 and now_epoch >= exp_epoch }}"
    action:
      - service: script.serialized_service_call
        data:
          service: rest_command.xert_token_refresh
          jitter_max: 20
          cooldown: 2
        response_variable: xert_ref
      - variables:
          acc: "{{ (xert_ref.get('content') or {}).get('access_token','') }}"
          ref: "{{ (xert_ref.get('content') or {}).get('refresh_token','') }}"
          exp: "{{ (xert_ref.get('content') or {}).get('expires_in', 0)|int(0) }}"
          crt: "{{ (xert_ref.get('content') or {}).get('created_at', now().timestamp()|int(0))|int(0) }}"
          exp_epoch: "{{ crt + exp }}"
      - choose:
          - conditions: "{{ acc|length > 0 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_access_token
                data:
                  value: "{{ acc }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_refresh_token
                data:
                  value: "{{ ref }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.xert_token_expires_epoch
                data:
                  value: "{{ exp_epoch - 300 }}"
              - service: script.serialized_service_call
                data:
                  service: rest_command.xert_training_info_fetch
                  jitter_max: 20
                  cooldown: 2
                response_variable: resp_ti
              - variables:
                  ti_ok: "{{ resp_ti is mapping and (resp_ti.status|int(0)) == 200 and (resp_ti.content is mapping or resp_ti.content|string != '') }}"
                  ti_parsed: >-
                    {{ resp_ti.content if resp_ti is mapping and resp_ti.content is mapping
                       else (resp_ti.content|default('')|string|from_json(default={})) }}
              - event: xert_training_info_update
                event_data:
                  available: "{{ ti_ok }}"
                  parsed: "{{ ti_parsed | tojson }}"
              - service: script.serialized_service_call
                data:
                  service: rest_command.xert_activity_list_fetch
                  jitter_max: 20
                  cooldown: 2
                response_variable: resp_al
              - variables:
                  al_ok: "{{ resp_al is mapping and (resp_al.status|int(0)) == 200 and (resp_al.content is mapping or resp_al.content|string != '') }}"
                  al_parsed: >-
                    {{ resp_al.content if resp_al is mapping and resp_al.content is mapping
                       else (resp_al.content|default('')|string|from_json(default={})) }}
              - event: xert_activity_list_update
                event_data:
                  available: "{{ al_ok }}"
                  parsed: "{{ al_parsed | tojson }}"

  - id: xert_self_heal_on_failure
    alias: "Xert: self-heal when training_info fails"
    trigger:
      - platform: state
        entity_id: sensor.xert_training_info_raw
        to: "False"
        for: "00:00:10"
    action:
      - service: script.serialized_service_call
        data:
          service: rest_command.xert_token_refresh
          jitter_max: 20
          cooldown: 2
        response_variable: xert_ref2
      - variables:
          acc: "{{ (xert_ref2.get('content') or {}).get('access_token','') }}"
          ref: "{{ (xert_ref2.get('content') or {}).get('refresh_token','') }}"
          exp: "{{ (xert_ref2.get('content') or {}).get('expires_in', 0)|int(0) }}"
          crt: "{{ (xert_ref2.get('content') or {}).get('created_at', now().timestamp()|int(0))|int(0) }}"
          exp_epoch: "{{ crt + exp }}"
      - choose:
          - conditions: "{{ acc|length > 0 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_access_token
                data:
                  value: "{{ acc }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_refresh_token
                data:
                  value: "{{ ref }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.xert_token_expires_epoch
                data:
                  value: "{{ exp_epoch - 300 }}"
      - service: script.serialized_service_call
        data:
          service: rest_command.xert_training_info_fetch
          jitter_max: 20
          cooldown: 2
        response_variable: resp_ti
      - variables:
          ti_ok: "{{ resp_ti is mapping and (resp_ti.status|int(0)) == 200 and (resp_ti.content is mapping or resp_ti.content|string != '') }}"
          ti_parsed: >-
            {{ resp_ti.content if resp_ti is mapping and resp_ti.content is mapping
               else (resp_ti.content|default('')|string|from_json(default={})) }}
      - event: xert_training_info_update
        event_data:
          available: "{{ ti_ok }}"
          parsed: "{{ ti_parsed | tojson }}"
      - service: script.serialized_service_call
        data:
          service: rest_command.xert_activity_list_fetch
          jitter_max: 20
          cooldown: 2
        response_variable: resp_al
      - variables:
          al_ok: "{{ resp_al is mapping and (resp_al.status|int(0)) == 200 and (resp_al.content is mapping or resp_al.content|string != '') }}"
          al_parsed: >-
            {{ resp_al.content if resp_al is mapping and resp_al.content is mapping
               else (resp_al.content|default('')|string|from_json(default={})) }}
      - event: xert_activity_list_update
        event_data:
          available: "{{ al_ok }}"
          parsed: "{{ al_parsed | tojson }}"

  - id: xert_training_info_refresh_via_rest_command
    alias: Xert Training Info Raw, refresh via REST command
    mode: single
    trigger:
      - platform: time_pattern
        minutes: "/15"
    action:
      - service: script.serialized_service_call
        data:
          service: rest_command.xert_training_info_fetch
          jitter_max: 20
          cooldown: 2
        response_variable: resp
      - variables:
          ok: "{{ resp is mapping and (resp.status | int(0)) == 200 and (resp.content is mapping or resp.content | string != '') }}"
          parsed_obj: >-
            {{ resp.content if resp is mapping and resp.content is mapping
               else (resp.content | default('') | string | from_json(default={})) }}
      - event: xert_training_info_update
        event_data:
          available: "{{ ok }}"
          parsed: "{{ parsed_obj | tojson }}"

  - id: xert_activity_list_refresh_via_rest_command
    alias: Xert Activity List Raw, refresh via REST command
    mode: restart
    trigger:
      - platform: state
        entity_id:
          - sensor.xert_lookback_from_epoch
          - sensor.xert_lookback_to_epoch
          - input_text.xert_access_token
    action:
      - service: script.serialized_service_call
        data:
          service: rest_command.xert_activity_list_fetch
          jitter_max: 20
          cooldown: 2
        response_variable: resp
      - variables:
          ok: "{{ resp is mapping and (resp.status | int(0)) == 200 and (resp.content is mapping or resp.content | string != '') }}"
          parsed_obj: >-
            {{ resp.content if resp is mapping and resp.content is mapping
               else (resp.content | default('') | string | from_json(default={})) }}
      - event: xert_activity_list_update
        event_data:
          available: "{{ ok }}"
          parsed: "{{ parsed_obj | tojson }}"

script:
  serialized_service_call:
    alias: Serialized service call (jitter + cooldown)
    mode: queued
    max: 100
    fields:
      service:
        description: "Service to call, e.g. rest_command.xert_training_info"
      service_data:
        description: "Data for the service"
        example: {}
      jitter_max:
        description: "Max random delay (seconds) before calling"
        example: 120
      cooldown:
        description: "Extra delay after call (seconds) to space out calls"
        example: 3
    sequence:
      - variables:
          jmax: "{{ jitter_max | default(0) | int }}"
          jitter: "{{ (range(0, jmax + 1) | random) if jmax > 0 else 0 }}"
          cool: "{{ cooldown | default(0) | int }}"
      - if:
          - condition: template
            value_template: "{{ jitter > 0 }}"
        then:
          - delay:
              seconds: "{{ jitter }}"
      - service: "{{ service }}"
        data: "{{ service_data | default({}) }}"
        response_variable: _svc_resp
      - if:
          - condition: template
            value_template: "{{ cool > 0 }}"
        then:
          - delay:
              seconds: "{{ cool }}"
      - stop: "done"
        response_variable: _svc_resp
