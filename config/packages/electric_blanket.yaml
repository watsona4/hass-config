# packages/electric_blanket_power_based.yaml
#
# switch.electric_blanket_plug = whatever you DO control (power feed to the control panel)
# sensor.electric_blanket_power = watts reported by that feed

input_number:
  electric_blanket_warmup_hours:
    name: "Electric Blanket Warmup Hours"
    min: 0.25
    max: 8
    step: 0.25
    mode: slider
    unit_of_measurement: h
    icon: mdi:timer-outline

# 1) Raw threshold sensor (true hysteresis via upper/lower)
binary_sensor:
  - platform: threshold
    name: Electric Blanket Drawing Power Raw
    entity_id: sensor.electric_blanket_power
    upper: 30

# 2) Debounced “truthy” sensor you actually use for automation/UI
template:
  - binary_sensor:
      - name: "Electric Blanket Drawing Power"
        unique_id: 9345ed8d-3bd0-4a46-8608-7f8c26677a74
        state: "{{ is_state('binary_sensor.electric_blanket_drawing_power_raw', 'on') }}"
        availability: "{{ has_value('sensor.electric_blanket_power') }}"
        delay_on: "00:00:20"
        delay_off: "00:01:00"
        icon: "{{ 'mdi:radiator' if this.state == 'on' else 'mdi:radiator-disabled' }}"

automation:
  - alias: Electric Blanket
    id: 38068c7d-4bf8-4966-b94e-9cc385b876aa
    mode: restart
    trigger:
      - platform: state
        entity_id: binary_sensor.electric_blanket_drawing_power
        to: "on"

    action:
      - variables:
          hours: "{{ states('input_number.electric_blanket_warmup_hours') | float(4) }}"
          seconds: "{{ (hours * 3600) | int }}"

      # Run until either:
      #  - blanket stops drawing power (manual panel off), OR
      #  - warmup time elapses (auto shutoff)
      - wait_for_trigger:
          - platform: state
            entity_id: binary_sensor.electric_blanket_drawing_power
            to: "off"
        timeout: "{{ seconds }}"
        continue_on_timeout: true

      # If we hit the timeout: power-cycle the feed so the control panel ends up OFF,
      # then restore power so it's ready for manual restart later.
      - if:
          - "{{ wait.trigger is none }}"
        then:
          - service: switch.turn_off
            target:
              entity_id: switch.electric_blanket_plug
          - delay: "00:00:10"
          - service: switch.turn_on
            target:
              entity_id: switch.electric_blanket_plug
