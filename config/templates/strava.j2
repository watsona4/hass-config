{% raw %}
# =============================================================================
# Strava (Native) â€” no custom integration required
# =============================================================================

input_number:
  strava_token_expires_epoch:
    name: "Strava Token Expires (epoch)"
    min: 0
    max: 2147483647
    step: 1
  strava_next_allowed_fetch_epoch:
    name: "Strava Next Allowed Fetch (epoch)"
    min: 0
    max: 2147483647
    step: 1

input_text:
  strava_client_id:
    name: "Strava Client ID"
    max: 64
    initial: !secret strava_client_id
  strava_client_secret:
    name: "Strava Client Secret"
    max: 128
    initial: !secret strava_client_secret
  strava_auth_code:
    name: "Strava OAuth Code"
    max: 255
  strava_access_token:
    name: "Strava Access Token"
    max: 255
  strava_refresh_token:
    name: "Strava Refresh Token"
    max: 255
  strava_latest_ride_id:
    name: "Strava Latest Ride ID"
    max: 32

rest_command:
  strava_token_fetch:
    url: "https://www.strava.com/oauth/token"
    method: POST
    content_type: "application/x-www-form-urlencoded"
    payload: "client_id={{ states('input_text.strava_client_id')|trim }}&client_secret={{ states('input_text.strava_client_secret')|trim }}&grant_type=authorization_code&code={{ strava_auth_code|urlencode }}"

  strava_token_refresh:
    url: "https://www.strava.com/oauth/token"
    method: POST
    content_type: "application/x-www-form-urlencoded"
    payload: "client_id={{ states('input_text.strava_client_id')|trim }}&client_secret={{ states('input_text.strava_client_secret')|trim }}&grant_type=refresh_token&refresh_token={{ states('input_text.strava_refresh_token')|urlencode }}"

  strava_activities_fetch:
    url: "https://www.strava.com/api/v3/athlete/activities?per_page=50&page=1"
    method: GET
    headers:
      Authorization: "Bearer {{ states('input_text.strava_access_token') }}"
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache

  strava_activity_detail_fetch:
    url: "https://www.strava.com/api/v3/activities/{{ activity_id }}?include_all_efforts=false"
    method: GET
    headers:
      Authorization: "Bearer {{ states('input_text.strava_access_token') }}"
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache

  strava_activity_photos_fetch:
    url: "https://www.strava.com/api/v3/activities/{{ activity_id }}/photos?photo_sources=true&size=2048"
    method: GET
    headers:
      Authorization: "Bearer {{ states('input_text.strava_access_token') }}"
      Accept: application/json
      User-Agent: HomeAssistant

shell_command:
  strava_download_photo: >
    bash -lc "set -euo pipefail; mkdir -p /config/www/strava; curl -sSL --fail
    -H 'Authorization: Bearer {{ states('input_text.strava_access_token') }}'
    '{{ url }}' -o '/config/www/strava/{{ filename }}'"

template:

  - trigger:
      - platform: event
        event_type: strava_activities_update
    variables:
      available: "{{ trigger.event.data.available | default(false) }}"
      root: "{{ trigger.event.data.parsed | default([]) }}"
    sensor:
      - name: Strava Activities Raw
        state: "{{ now().isoformat() }}"
        attributes:
          activities: "{{ root }}"
          count: "{{ root | count }}"
        availability: "{{ available }}"

  - trigger:
      - platform: event
        event_type: strava_activities_update
    variables:
      available: "{{ trigger.event.data.available | default(false) }}"
      root: "{{ trigger.event.data.parsed | default([]) }}"
      acts: >-
        {{ root
           | selectattr('start_date','defined')
           | sort(attribute='start_date', reverse=true)
           | list }}
      n: {% endraw %}{{ count }}{% raw %}
    sensor:
{% endraw %}{% for i in range(0, count) %}{% raw %}
      - name: "Strava {% endraw %}{{ i }}{% raw %}"
        unique_id: strava_{% endraw %}{{ i }}{% raw %}
        state: >-
          {% set a = acts[{% endraw %}{{ i }}{% raw %}] if acts|count > {% endraw %}{{ i }}{% raw %} else {} %}
          {{ a.get('start_date') if a else '' }}
        availability: "{{ available }}"
        attributes:
          id: >-
            {% set a = acts[{% endraw %}{{ i }}{% raw %}] if acts|count > {% endraw %}{{ i }}{% raw %} else {} %}
            {{ a.get('id') if a else none }}
          title: >-
            {% set a = acts[{% endraw %}{{ i }}{% raw %}] if acts|count > {% endraw %}{{ i }}{% raw %} else {} %}
            {{ a.get('name') if a else none }}
          sport_type: >-
            {% set a = acts[{% endraw %}{{ i }}{% raw %}] if acts|count > {% endraw %}{{ i }}{% raw %} else {} %}
            {{ a.get('sport_type') if a else none }}
          timezone: >-
            {% set a = acts[{% endraw %}{{ i }}{% raw %}] if acts|count > {% endraw %}{{ i }}{% raw %} else {} %}
            {{ a.get('timezone') if a else none }}
          start_date: >-
            {% set a = acts[{% endraw %}{{ i }}{% raw %}] if acts|count > {% endraw %}{{ i }}{% raw %} else {} %}
            {{ a.get('start_date') if a else none }}
          distance_m: >-
            {% set a = acts[{% endraw %}{{ i }}{% raw %}] if acts|count > {% endraw %}{{ i }}{% raw %} else {} %}
            {{ a.get('distance') if a else none }}
          distance_mi: >-
            {% set m = (acts[{% endraw %}{{ i }}{% raw %}].get('distance') if acts|count > {% endraw %}{{ i }}{% raw %} else none) %}
            {{ (m/1609.344)|round(2) if m is number else none }}
          elev_gain_m: >-
            {% set m = (acts[{% endraw %}{{ i }}{% raw %}].get('total_elevation_gain') if acts|count > {% endraw %}{{ i }}{% raw %} else none) %}
            {{ m if m is number else none }}
          elev_gain_ft: >-
            {% set m = (acts[{% endraw %}{{ i }}{% raw %}].get('total_elevation_gain') if acts|count > {% endraw %}{{ i }}{% raw %} else none) %}
            {{ (m*3.28084)|round(0) if m is number else none }}
          moving_time_s: >-
            {% set a = acts[{% endraw %}{{ i }}{% raw %}] if acts|count > {% endraw %}{{ i }}{% raw %} else {} %}
            {{ a.get('moving_time') if a else none }}
          elapsed_time_s: >-
            {% set a = acts[{% endraw %}{{ i }}{% raw %}] if acts|count > {% endraw %}{{ i }}{% raw %} else {} %}
            {{ a.get('elapsed_time') if a else none }}
          average_watts: >-
            {% set v = (acts[{% endraw %}{{ i }}{% raw %}].get('average_watts') if acts|count > {% endraw %}{{ i }}{% raw %} else none) %}
            {{ (v|float(0))|round(0) if v is not none else none }}
          average_heartrate: >-
            {% set v = (acts[{% endraw %}{{ i }}{% raw %}].get('average_heartrate') if acts|count > {% endraw %}{{ i }}{% raw %} else none) %}
            {{ (v|float(0))|round(0) if v is not none else none }}
          max_heartrate: >-
            {% set v = (acts[{% endraw %}{{ i }}{% raw %}].get('max_heartrate') if acts|count > {% endraw %}{{ i }}{% raw %} else none) %}
            {{ (v|float(0))|round(0) if v is not none else none }}
          average_cadence: >-
            {% set v = (acts[{% endraw %}{{ i }}{% raw %}].get('average_cadence') if acts|count > {% endraw %}{{ i }}{% raw %} else none) %}
            {{ (v|float(0))|round(0) if v is not none else none }}
          calories: >-
            {% set v = (acts[{% endraw %}{{ i }}{% raw %}].get('calories') if acts|count > {% endraw %}{{ i }}{% raw %} else none) %}
            {{ (v|float(0))|round(0) if v is not none else none }}
          slot_index: {% endraw %}{{ i }}{% raw %}
          updated: "{{ now().isoformat() }}"
{% endraw %}{% endfor %}{% raw %}
  - trigger:
      - platform: event
        event_type: strava_activities_update
    variables:
      available: "{{ trigger.event.data.available | default(false) }}"
      root: "{{ trigger.event.data.parsed | default([]) }}"
      acts: >-
        {{ root
           | selectattr('start_date','defined')
           | sort(attribute='start_date', reverse=true)
           | list }}
      latest: "{{ acts[0] if acts|count > 0 else {} }}"
    sensor:
      - name: "Strava Latest Ride"
        icon: mdi:bike
        availability: "{{ available }}"
        state: "{{ latest.get('start_date_local') or latest.get('start_date') or now().isoformat() }}"
        attributes:
          id: "{{ latest.get('id') }}"
          title: "{{ latest.get('name') }}"
          sport_type: "{{ latest.get('sport_type') }}"
          distance_mi: "{{ (latest.get('distance',0) | float(0) / 1609.344) | round(2) }}"
          moving_min: "{{ (latest.get('moving_time',0) | float(0) / 60) | round(1) }}"
          elapsed_min: "{{ (latest.get('elapsed_time',0) | float(0) / 60) | round(1) }}"
          elev_ft: "{{ (latest.get('total_elevation_gain',0) | float(0) * 3.28084) | round(0) }}"
          avg_watts: "{{ latest.get('average_watts') }}"
          max_watts: "{{ latest.get('max_watts') }}"
          avg_hr: "{{ latest.get('average_heartrate') }}"
          max_hr: "{{ latest.get('max_heartrate') }}"
          avg_cadence: "{{ latest.get('average_cadence') }}"
          weighted_watts: "{{ latest.get('weighted_average_watts') }}"
          suffer_score: "{{ latest.get('suffer_score') }}"
          timezone: "{{ latest.get('timezone') }}"
          gear_id: "{{ latest.get('gear_id') }}"
          total_photo_count: "{{ latest.get('total_photo_count') }}"
          map_id: "{{ (latest.get('map') or {}).get('id') }}"
          start_latlng: "{{ latest.get('start_latlng') }}"
          end_latlng: "{{ latest.get('end_latlng') }}"
      - name: "Strava Latest Ride Avg Power"
        device_class: power
        unit_of_measurement: "W"
        state_class: measurement
        state: "{{ latest.get('average_watts') }}"
      - name: "Strava Latest Ride Avg HR"
        state_class: measurement
        state: "{{ latest.get('average_heartrate') }}"

  - trigger:
      - platform: event
        event_type: strava_activities_update
    variables:
      available: "{{ trigger.event.data.available | default(false) }}"
      root: "{{ trigger.event.data.parsed | default([]) }}"
      nr: >-
        {{ root
           | rejectattr('sport_type','in',['Ride','VirtualRide'])
           | sort(attribute='start_date', reverse=true)
           | list }}
    sensor:
      - name: Strava Non-Ride Summary
        icon: mdi:format-list-text
        availability: "{{ available }}"
        state: "{{ now().isoformat() }}"
        attributes:
          types: >-
            {{ nr | map(attribute='sport_type') | select('defined') | reject('none') | reject('equalto','') | unique | list }}
          rows: >-
            {% set out = [] %}
            {% for a in nr[:50] %}
              {% set item = {
                'date': a.get('start_date_local') or a.get('start_date'),
                'title': a.get('name'),
                'type': a.get('sport_type'),
                'distance_mi': ((a.get('distance',0)|float(0)/1609.344)|round(2)),
                'moving_min': ((a.get('moving_time',0)|float(0)/60)|round(1))
              } %}
              {% set out = out + [item] %}
            {% endfor %}
            {{ out | tojson }}

  - trigger:
      - platform: event
        event_type: strava_latest_photos_update
    variables:
      chosen_url: "{{ trigger.event.data.chosen_url if trigger and trigger.event else none }}"
      local_main: "{{ trigger.event.data.local_main if trigger and trigger.event else none }}"
      local_thumb: "{{ trigger.event.data.local_thumb if trigger and trigger.event else none }}"
      available: "{{ trigger.event.data.available if trigger and trigger.event else false }}"
    sensor:
      - name: Strava Latest Ride Photos
        icon: mdi:image-multiple
        availability: "{{ available | default(false) }}"
        state: "{{ now().isoformat() }}"
        attributes:
          url: "{{ chosen_url }}"
          local_main: "{{ local_main }}"
          local_thumb: "{{ local_thumb }}"

  - trigger:
      - platform: event
        event_type: strava_activities_update
    sensor:
      - name: Strava Rate Limit (15m)
        state: "{{ (trigger.event.data.get('ratelimit') or {}).get('remaining15', 0) }}"
        unit_of_measurement: "calls"
        availability: "{{ trigger and trigger.event and (trigger.event.data.get('ratelimit') is sequence) }}"
        attributes:
          used: "{{ (trigger.event.data.get('ratelimit') or {}).get('used15', 0) }}"
          limit: "{{ (trigger.event.data.get('ratelimit') or {}).get('limit15', 100) }}"

automation:
  - id: strava_bootstrap_token_on_start
    alias: "Strava: bootstrap token on startup (if auth code set)"
    mode: restart
    trigger:
      - platform: homeassistant
        event: start
    condition:
      - condition: template
        value_template: "{{ has_value('input_text.strava_auth_code') }}"
    action:
      - delay:
          seconds: "{{ range(5, 15) | random | int }}"
      - service: rest_command.strava_token_fetch
        data:
          strava_auth_code: "{{ states('input_text.strava_auth_code') }}"
        response_variable: resp
      - variables:
          acc: "{{ (resp.get('content') or {}).get('access_token','') }}"
          ref: "{{ (resp.get('content') or {}).get('refresh_token','') }}"
          exp: "{{ (resp.get('content') or {}).get('expires_in',0)|int(0) }}"
          crt: "{{ (resp.get('content') or {}).get('created_at', now().timestamp()|int(0))|int(0) }}"
          exp_epoch: "{{ crt + exp }}"
      - choose:
          - conditions: "{{ acc|length > 0 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.strava_access_token
                data:
                  value: "{{ acc or '' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.strava_refresh_token
                data:
                  value: "{{ ref or '' }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.strava_token_expires_epoch
                data:
                  value: "{{ exp_epoch - 300 }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.strava_auth_code
                data:
                  value: "unknown"

  - id: strava_refresh_daemon
    alias: "Strava: refresh token proactively"
    trigger:
      - platform: time_pattern
        minutes: "/10"
    variables:
      now_epoch: "{{ now().timestamp()|int(0) }}"
      exp_epoch: "{{ states('input_number.strava_token_expires_epoch')|int(0) }}"
    condition: "{{ exp_epoch > 0 and now_epoch >= exp_epoch }}"
    action:
      - delay:
          seconds: "{{ range(5, 15) | random | int }}"
      - service: rest_command.strava_token_refresh
        response_variable: resp
      - variables:
          acc: "{{ (resp.get('content') or {}).get('access_token','') }}"
          ref: "{{ (resp.get('content') or {}).get('refresh_token','') }}"
          exp: "{{ (resp.get('content') or {}).get('expires_in',0)|int(0) }}"
          crt: "{{ (resp.get('content') or {}).get('created_at', now().timestamp()|int(0))|int(0) }}"
          exp_epoch: "{{ crt + exp }}"
      - choose:
          - conditions: "{{ acc|length > 0 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.strava_access_token
                data:
                  value: "{{ acc or '' }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.strava_refresh_token
                data:
                  value: "{{ ref or '' }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.strava_token_expires_epoch
                data:
                  value: "{{ exp_epoch - 300 }}"

  - id: strava_activities_refresh
    alias: "Strava: refresh recent activities"
    mode: single
    trigger:
      - platform: homeassistant
        event: start
      - platform: time_pattern
        minutes: "/15"
      - platform: state
        entity_id: input_text.strava_access_token
    variables:
      now_epoch: "{{ now().timestamp()|int(0) }}"
      next_allowed: "{{ states('input_number.strava_next_allowed_fetch_epoch')|int(0) }}"
    condition:
      - condition: template
        value_template: "{{ states('input_text.strava_access_token')|length > 0 }}"
      - condition: template
        value_template: "{{ now_epoch >= next_allowed }}"
    action:
      - delay:
          seconds: "{{ range(5, 15) | random | int }}"
      - service: rest_command.strava_activities_fetch
        response_variable: resp
      - variables:
          h: "{{ resp.headers if resp is mapping else {} }}"
          _usage15_raw: >-
            {{ (h.get('x-ratelimit-usage') or h.get('X-RateLimit-Usage') or '') | string | replace(' ','') }}
          usage15: >-
            {% set parts = _usage15_raw.split(',') if _usage15_raw is string else [] %}
            {{ (parts[0]|int(0)) if parts|length>0 else 0 }}
          _limit15_raw: >-
            {{ (h.get('x-ratelimit-limit') or h.get('X-RateLimit-Limit') or '') | string | replace(' ','') }}
          limit15: >-
            {% set parts = _limit15_raw.split(',') if _limit15_raw is string else [] %}
            {{ (parts[0]|int(100)) if parts|length>0 else 100 }}
          remaining15: "{{ (limit15|int(100)) - (usage15|int(0)) }}"
          ratelimit: >-
            {{ {'used15': usage15|int(0), 'limit15': limit15|int(100), 'remaining15': remaining15|int(0)} }}
          ok: >-
            {{ resp is mapping and (resp.status|int(0)) == 200
                and (resp.content is mapping or resp.content|string != '') }}
          parsed_obj: >-
            {{ resp.content if resp is mapping and (resp.content is mapping or resp.content is sequence)
                else (resp.content|default('')|string|from_json(default=[])) }}
      - choose:
          - conditions: "{{ ok }}"
            sequence:
              - event: strava_activities_update
                event_data:
                  available: true
                  parsed: "{{ parsed_obj }}"
                  ratelimit: "{{ ratelimit }}"
              - choose:
                  - conditions: "{{ remaining15 <= 2 }}"
                    sequence:
                      - service: input_number.set_value
                        target:
                          entity_id: input_number.strava_next_allowed_fetch_epoch
                        data:
                          value: "{{ now().timestamp()|int(0) + 16*60 }}"
          - conditions: "{{ not ok }}"
            sequence:
              - variables:
                  err_payload: >-
                    {% set raw = resp.content if resp is mapping and resp.content is mapping else (resp.content|default('')|string) %}
                    {% set obj = raw if raw is mapping else (raw|from_json(default={})) %}
                    {{ obj }}
              - event: strava_activities_update
                event_data:
                  available: false
                  parsed:
                    activities: "{{ err_payload }}"
                  ratelimit: "{{ ratelimit }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.strava_next_allowed_fetch_epoch
                data:
                  value: "{{ now().timestamp()|int(0) + 16*60 }}"

  - id: strava_activity_details_enrich
    alias: "Strava: enrich first N activities with /activities/{id}"
    mode: parallel
    max: 10
    trigger:
      - platform: event
        event_type: strava_activities_update
    condition:
      - condition: template
        value_template: "{{ states('input_text.strava_access_token')|length > 0 }}"
    action:
      - delay:
          seconds: "{{ range(5, 15) | random | int }}"
      - variables:
          available: "{{ trigger.event.data.available | default(false) }}"
          root: "{{ trigger.event.data.parsed | default([]) }}"
          acts: >-
            {{ root
            | selectattr('start_date','defined')
            | sort(attribute='start_date', reverse=true)
            | list }}
          n: {% endraw %}{{ count }}{% raw %}
          ids_top: >-
            {{ (acts | selectattr('id','defined') | map(attribute='id') | list)[:n] }}
      - repeat:
          for_each: "{{ ids_top }}"
          sequence:
            - delay:
                seconds: "{{ ((repeat.index - 1) * 2) + (range(0, 2)|random|int) }}"
            - service: rest_command.strava_activity_detail_fetch
              data:
                activity_id: "{{ repeat.item }}"
              response_variable: resp_d
            - variables:
                ok_d: "{{ resp_d is mapping and (resp_d.status|int(0)) == 200 and (resp_d.content is mapping or resp_d.content is sequence or resp_d.content|string != '') }}"
                parsed_d: >-
                  {% set c = resp_d.content if resp_d is mapping else none %}
                  {% if c is mapping or c is sequence %}
                    {{ c | tojson | from_json(default=[]) }}
                  {% else %}
                    {{ (resp_d.content | default('') | string | from_json(default=[])) }}
                  {% endif %}
            - event: strava_activity_detail_update
              event_data:
                available: "{{ ok_d }}"
                parsed: "{{ parsed_d | tojson }}"
                activity_id: "{{ repeat.item }}"
                index: "{{ repeat.index }}"

  - id: strava_fetch_latest_ride_photos
    alias: "Strava: fetch photos for latest cycling activity"
    mode: single
    trigger:
      - platform: event
        event_type: strava_activities_update
    variables:
      available: "{{ trigger.event.data.available | default(false) }}"
      root: "{{ trigger.event.data.parsed | default([]) }}"
      acts: >-
        {{ root
          | selectattr('start_date','defined')
          | sort(attribute='start_date', reverse=true)
          | list }}
      latest: "{{ acts[0] if acts | count > 0 else {} }}"
      latest_id: "{{ latest.get('id',0) }}"
    condition:
      - condition: template
        value_template: >-
          {{ latest_id != 0
             and (states('sensor.strava_rate_limit_15m')|int(0)) > 0 }}
    action:
      - delay:
          seconds: "{{ range(5, 15) | random | int }}"
      - service: input_text.set_value
        target:
          entity_id: input_text.strava_latest_ride_id
        data:
          value: "{{ latest_id }}"
      - service: rest_command.strava_activity_photos_fetch
        data:
          activity_id: "{{ latest_id }}"
        response_variable: resp_ph
      - variables:
          ph_ok: "{{ resp_ph is mapping and (resp_ph.status|int(0)) == 200 and (resp_ph.content is mapping or resp_ph.content|string != '') }}"
          photos: >-
            {% set raw = resp_ph.content if resp_ph is mapping and resp_ph.content is mapping else (resp_ph.content|default('')|string) %}
            {{ raw if raw is sequence else (raw|from_json(default=[])) }}
          # choose the "best" photo url:
          # Each item often has: { urls: { "2048": "...", "1200": "...", "600": "..." }, source } or a plain "url"
          choose_url: >-
            {% set ns = namespace(best=None) %}
            {% for p in photos %}
              {% set urls = p.get('urls') if p is mapping else {} %}
              {% set u = (urls.get('2048') or urls.get('1200') or urls.get('1000') or urls.get('600') or p.get('url')) %}
              {% if u %}
                {% set ns.best = u %}
                {% break %}
              {% endif %}
            {% endfor %}
            {{ ns.best }}
          # filenames we will write
          main_file: "latest_ride.jpg"
          thumb_file: "latest_ride_thumb.jpg"
      - choose:
          - conditions: "{{ ph_ok and choose_url|length > 0 }}"
            sequence:
              - service: shell_command.strava_download_photo
                data:
                  url: "{{ choose_url }}"
                  filename: "{{ main_file }}"
              # Optional: also save a "thumb" if Strava provides a smaller URL in the list
              - variables:
                  thumb_url: >-
                    {% set ns = namespace(u=none) %}
                    {% for p in photos %}
                      {% set urls = p.get('urls') if p is mapping else {} %}
                      {% set cand = (urls.get('600') or urls.get('400') or urls.get('240')) %}
                      {% if cand %}{% set ns.u = cand %}{% break %}{% endif %}
                    {% endfor %}
                    {{ ns.u }}
              - choose:
                  - conditions: "{{ thumb_url is string and thumb_url|length > 0 }}"
                    sequence:
                      - service: shell_command.strava_download_photo
                        data:
                          url: "{{ thumb_url }}"
                          filename: "{{ thumb_file }}"
      - event: strava_latest_photos_update
        event_data:
          available: "{{ ph_ok }}"
          chosen_url: "{{ choose_url }}"
          local_main: "/local/strava/{{ main_file }}"
          local_thumb: "/local/strava/{{ thumb_file }}"
{% endraw %}
