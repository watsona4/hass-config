rest_command:
{% for i in range(count) %}
  xert_activity_detail_fetch_{{ i }}:
    url: "{% raw %}{{ 'https://www.xertonline.com/oauth/activity/' ~ states('sensor.xert_activity_{% endraw %}{{ i }}{% raw %}_path') }}{%- endraw %}"
    method: GET
    timeout: 60
    headers:
      Authorization: "{% raw %}Bearer {{ states('input_text.xert_access_token') }}{% endraw %}"
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache
{% endfor %}
###############################################################################
# Xert: Event-driven base sensors (mirror original REST sensors)
###############################################################################
template:
  - trigger:
      - platform: event
        event_type: xert_activity_list_update
    variables:
      root: >-
        {% raw %}{%- set x = trigger.event.data.parsed -%}
        {%- if x is mapping -%}
          {{ x }}
        {%- else -%}
          {{ x | default('') | from_json(default={}) }}
        {%- endif -%}{% endraw %}
      acts: >-
        {% raw %}{%- set ac = root.get('activities') or [] -%}
        {{ (ac
            | selectattr('path','defined')
            | selectattr('start_date','defined')
            | selectattr('start_date','mapping')
            | sort(attribute='start_date.date', reverse=true)
            | map(attribute='path')
            | list) }}{% endraw %}
    sensor:
{% for i in range(count) %}
      - name: "Xert Activity {{ i }} Path"
        state: >-
          {% raw %}{%- set L = acts if acts is sequence else [] -%}
          {{ L[{% endraw %}{{ i }}{% raw %}] if (L | count) > {% endraw %}{{ i }}{% raw %} else 'unknown' }}{% endraw %}
        availability: "{% raw %}{{ (acts | count) > 0 }}{% endraw %}"
{% endfor %}
{% for i in range(count) %}
  - trigger:
      - platform: event
        event_type: xert_activity_detail_update_{{ i }}
    variables:
      root: >-
        {% raw %}{% set x = trigger.event.data.parsed %}
        {% if x is mapping %}
          {{ x }}
        {% else %}
          {{ x | default('') | from_json(default={}) }}
        {% endif %}{% endraw %}
    sensor:
      - name: Xert Activity {{ i }} Detail Raw
        state: >-
          {% raw %}{{ (root.success | default(false)) }}{% endraw %}
        attributes:
          summary: "{% raw %}{{ root.get('summary') }}{% endraw %}"
          name: "{% raw %}{{ root.get('name') }}{% endraw %}"
          description: "{% raw %}{{ root.get('description') }}{% endraw %}"
          progression: "{% raw %}{{ root.get('progression') }}{% endraw %}"
        availability: "{% raw %}{{ trigger.event.data.available | default(false) }}{% endraw %}"
{% endfor %}
###############################################################################
# Xert: Automations to run rest_commands & update sensors
# - Training Info: every 15 min (like scan_interval 900) with jitter
# - Activity List: on window/token change + startup (original was "manual")
# - Activity Detail i: on path/token change; staggered per-index
###############################################################################
automation:

  # ---- Per-activity Detail Raw (generated) ----
{% for i in range(count) %}
  - id: xert_activity_{{ i }}_detail_refresh_via_rest_command
    alias: Xert Activity {{ i }} Detail Raw, refresh via REST command
    mode: restart
    trigger:
      - platform: state
        entity_id:
          - sensor.xert_activity_{{ i }}_path
          - input_text.xert_access_token
      - platform: event
        event_type: xert_activity_list_update
    action:
      - wait_template: "{% raw %}{{ has_value('sensor.xert_activity_{% endraw %}{{ i }}{% raw %}_path') }}{% endraw %}"
        continue_on_timeout: false
        timeout: "00:00:10"
      - service: script.serialized_service_call
        data:
          service: rest_command.xert_activity_detail_fetch_{{ i }}
          jitter_max: 20
          cooldown: 2
        response_variable: resp
      - variables:
          ok: "{% raw %}{{ resp is mapping and (resp.status | int(0)) == 200 and (resp.content is mapping or resp.content | string != '') }}{% endraw %}"
          parsed_obj: "{% raw %}{{ resp.content if resp is mapping and resp.content is mapping else (resp.content | default('') | string | from_json(default={})) }}{% endraw %}"
      - event: xert_activity_detail_update_{{ i }}
        event_data:
          available: "{% raw %}{{ ok }}{% endraw %}"
          parsed: "{% raw %}{{ parsed_obj | tojson }}{% endraw %}"
{% endfor %}
