{% macro generate_weight_chart(title, weight_data, weight_proj, annotations, bodyfat_data='', bodyfat_proj='', weight_extents={}, weight_goals={}, show_bodyfat=true, bodyfat_extents={}, bodyfat_goals={}) %}

    {% set paletteByType = {
        'holiday':  { 'line': "#16a085", 'background': "rgba(22,160,133,0.85)", 'text': "#fff" },
        'event':    { 'line': "#8e44ad", 'background': "rgba(142,68,173,0.85)", 'text': "#fff" },
        'milestone':{ 'line': "#c0392b", 'background': "rgba(192,57,43,0.9)",   'text': "#fff" },
        'note':     { 'line': "#7f8c8d", 'background': "rgba(127,140,141,0.85)",'text': "#fff" },
    } %}

    {%- set cutoff = state_attr(weight_data, 'cutoff_utc') | as_datetime | as_local -%}
    {%- set ns = namespace(series=[], yaxis=[], x_annotations=[], y_annotations=[]) -%}

    {%- set ns.series = [{
        'entity': weight_proj,
        'name': 'Proj. Weight',
        'unit': 'lbs',
        'type': 'line',
        'yaxis_id': 'weight',
        'show': { 'in_header': false },
        'extend_to': false,
        'stroke_width': 2,
        'opacity': 0.45,
        'color': 'rgba(31,119,180,0.9)',
        'data_generator': 'const s = entity?.attributes?.series ?? [];return s.map(p => [new Date(p.t).getTime(), Number(p.y)]);',
    }, {
        'entity': weight_data,
        'name': 'Actual Weight',
        'unit': 'lbs',
        'type': 'line',
        'yaxis_id': 'weight',
        'extend_to': false,
        'stroke_width': 0,
        'color': '#1f77b4',
        'data_generator': 'const s = entity?.attributes?.series ?? [];return s.map(p => [new Date(p.t).getTime(), Number(p.y)]);',
    }] -%}

    {%- set ns.yaxis = [{
        'id': 'weight',
        'decimals': 0,
        'apex_config': {
            'title': { 'text': 'Weight (lb)' },
        },
    } | combine(weight_extents)] -%}

    {%- if show_bodyfat -%}

        {%- set ns.series = ns.series + [{
            'entity': bodyfat_proj,
            'name': 'Proj. Body Fat',
            'unit': '%',
            'type': 'line',
            'yaxis_id': 'bodyfat',
            'show': { 'in_header': false },
            'extend_to': false,
            'stroke_width': 2,
            'opacity': 0.45,
            'color': 'rgba(230,126,34,0.9)',
            'data_generator': 'const s = entity?.attributes?.series ?? [];return s.map(p => [new Date(p.t).getTime(), Number(p.y)]);',
        }, {
            'entity': bodyfat_data,
            'name': 'Actual Body Fat',
            'unit': '%',
            'type': 'line',
            'yaxis_id': 'bodyfat',
            'extend_to': false,
            'stroke_width': 0,
            'color': '#e67e22',
            'data_generator': 'const s = entity?.attributes?.series ?? [];return s.map(p => [new Date(p.t).getTime(), Number(p.y)]);',
        }] -%}

        {%- set ns.yaxis = ns.yaxis + [{
            'id': 'bodyfat',
            'decimals': 0,
            'opposite': true,
            'apex_config': {
                'title': { 'text': 'Body Fat (%)' },
            },
        } | combine(bodyfat_extents)] -%}

    {%- endif -%}

    {%- set ns.x_annotations = ns.x_annotations + [{
        'x': (as_timestamp(now()) * 1000) | int,
        'borderColor': '#999999',
        'strokeDashArray': 4,
        'label': {
            'borderColor': '#b3b3b3',
            'style': { 'background': "#f2f2f2", 'color': "#333", 'fontSize': "10px" },
            'text': 'Today',
        },
    }, {
        'x': now().isoformat(),
        'x2': (as_timestamp(now() + timedelta(days=90)) * 1000) | int,
        'fillColor': 'rgba(160,160,160,0.3)',
        'opacity': 0.12,
        'label': {
            'style': { 'color': '#333333', 'background': '#eaeaea' },
        },
    }] -%}

    {%- set ann = state_attr(annotations, 'series') -%}
    {%- if ann is iterable and ann | length > 0 -%}
        {%- for r in ann -%}
            {%- set ns.x_annotations = ns.x_annotations + [{
                'x': (as_timestamp(r.t) * 1000) | int,
                'strokeDashArray': 3,
                'borderWidth': 1,
                'borderColor': paletteByType.get(r.type).line,
                'label': {
                    'borderRadius': 2,
                    'borderColor': paletteByType.get(r.type).line,
                    'text': r.label,
                    'style': {
                        'fontSize': '10px',
                        'background': paletteByType.get(r.type).background,
                        'color': paletteByType.get(r.type).text,
                    },
                    'position': 'top',
                },
            }] -%}
        {%- endfor -%}
    {%- endif -%}

    {%- for g in weight_goals -%}
        {%- set ns.y_annotations = ns.y_annotations + [{
            'y': g.value,
            'yAxisIndex': 0,
            'borderColor': g.color,
            'strokeDashArray': 2,
            'label': {
                'text': g.label,
                'position': 'left',
                'textAnchor': 'start',
                'style': { 'background': g.color, 'color': '#fff' },
            },
        }] -%}
    {%- endfor -%}

    {%- for g in bodyfat_goals -%}
        {%- set ns.y_annotations = ns.y_annotations + [{
            'y': g.value,
            'yAxisIndex': 2,
            'borderColor': g.color,
            'strokeDashArray': 2,
            'label': {
                'text': g.label,
                'style': { 'background': g.color, 'color': '#fff' },
            },
        }] -%}
    {%- endfor -%}

    {{- {
        'type': 'custom:apexcharts-card',
        'header': {
            'title': title,
            'show': true, 
            'show_states': true,
            'colorize_states': true,
        },
        'graph_span': (((now() - cutoff).total_seconds() / 86_400) | int + 90) ~ 'd',
        'span': { 'end': 'day', 'offset': '+90d' },
        'now': { 'show': true, 'color': '#aaaaaa' },
        'series': ns.series,
        'yaxis': ns.yaxis,
        'apex_config': {
            'xaxis': { 'type': 'datetime', 'labels': { 'datetimeUTC': false } },
            'markers': { 'size': [0, 4, 0, 4], 'strokeWidth': 0 },
            'annotations': { 'xaxis': ns.x_annotations, 'yaxis': ns.y_annotations },
        },
    } | tojson -}}

{% endmacro %}
