{# macros/zepbound.jinja
   Helpers for ZepBound dosing:
   - _exp(x)
   - _rates(hl_days, hl_abs_h)
   - _amount_at(t_hours, resid_prev, dose, ke, ka)
   - zep_residual(t0_iso, resid_prev, dose, hl_days, hl_abs_h)
   - zep_next_ready(t0_iso, resid_prev, dose, hl_days, hl_abs_h, desired_peak)
     Returns JSON: {"target": <mg>, "peak": <mg>, "timestamp": "<ISO or 'unknown'>"}  (peak is enforced)
   - _t_peak_hours(resid_prev, dose, ke, ka)
   - zep_next_peak(t0_iso, resid_prev, dose, hl_days, hl_abs_h)
#}

{% macro _exp(x) -%}
    {{- 2.718281828459045 ** (x | float(0) ) -}}
{%- endmacro %}

{% macro _rates(hl_days, hl_abs_h) -%}
    {# returns a string "ke,ka" which callers immediately split/float #}
    {%- set ln2 = 0.6931471805599453 -%}
    {%- set ke = ln2 / ((hl_days | float(5)) * 24.0) -%}
    {%- set ka = ln2 / (hl_abs_h | float(5)) -%}
    {{- ke ~ ',' ~ ka -}}
{%- endmacro %}

{% macro _amount_at(t_hours, resid_prev, dose, ke, ka) -%}
    {%- set t = t_hours | float(0) -%}
    {%- if (ka - ke) | float | abs < 1e-9 -%}
        {{- (resid_prev | float(0) ) * (_exp(-ke * t) | float)
        + (dose | float(0)) * ke * t * (_exp(-ke * t) | float) -}}
    {%- else -%}
        {%- set term = (_exp(-ke * t) | float) - (_exp(-ka * t) | float) -%}
        {{- (resid_prev | float(0) ) * (_exp(-ke * t) | float)
        + (dose | float(0)) * (ka / (ka - ke)) * term -}}
    {%- endif -%}
{%- endmacro %}

{# Public: current residual, using last_residual and dose to reconstruct carryover #}
{% macro zep_residual(t0_iso, resid_prev, dose, hl_days, hl_abs_h) -%}
    {%- set t0 = as_timestamp(t0_iso) -%}
    {%- if t0 is none -%}
        0
    {%- else -%}
        {%- set dt_h = (as_timestamp(now()) - t0) / 3600.0 -%}
        {%- if dt_h < 0 -%}
            0
        {%- else -%}
            {%- set parts = _rates(hl_days, hl_abs_h).split(',') -%}
            {%- set ke = parts[0] | float -%}
            {%- set ka = parts[1] | float -%}
            {{- [_amount_at(dt_h, resid_prev, dose, ke, ka) | float, 0] | max | round(3) -}}
        {%- endif -%}
    {%- endif -%}
{%- endmacro %}

{# JSON-emitting scheduler (enforces desired_peak). Always returns:
   {"target": <effective residual mg>, "peak": <desired peak mg>, "timestamp": "<ISO or 'unknown'>"} #}
{% macro zep_next_ready(t0_iso, resid_prev, dose, hl_days, hl_abs_h, desired_peak) -%}
    {%- set t0 = as_datetime(t0_iso) -%}
    {%- if t0 is none -%}
        {{ dict(target=None, peak=None, timestamp='unknown') | tojson }}
    {%- else -%}
        {# minimum interval 1 day; never schedule in the past #}
        {%- set t0l = t0 | as_local -%}
        {%- set min_time = [t0l + timedelta(hours=24), now()] | max -%}

        {%- set parts = _rates(hl_days, hl_abs_h).split(',') -%}
        {%- set ke = parts[0] | float -%}
        {%- set ka = parts[1] | float -%}
        {%- set tau_p = (ka > ke) and ((ka/ke) | log) / (ka - ke) or 0.0 -%}
        {%- set K = (ka/(ka - ke)) * ( (_exp(-ke * tau_p) | float) - (_exp(-ka * tau_p) | float) ) -%}

        {# effective residual target implied by REQUIRED desired_peak #}
        {%- if desired_peak is none -%}
            {{ dict(target=None, peak=None, timestamp='unknown') | tojson }}
        {%- endif -%}
        {%- set T_eff = [ ((desired_peak | float(0)) - (dose | float(0)) * K) * (_exp(ke * tau_p) | float), 0 ] | max -%}

        {# A(t) wrapper #}
        {% macro A(t) -%}
            {{- _amount_at(t, resid_prev, dose, ke, ka) -}}
        {%- endmacro %}

        {%- set start_h = [ ((min_time - t0l).total_seconds() / 3600.0), ( (ka>ke) and ((ka/ke)|log)/(ka-ke) or 0.0 ), 0.0 ] | max -%}
        {%- set lo = start_h -%}
        {%- set hi = start_h + 24*30 -%}  {# 30 days window #}
        {%- set f_lo = A(lo) | float -%}
        {%- set f_hi = A(hi) | float -%}

        {# If already below target and still falling, no crossing ahead #}
        {%- if f_lo <= T_eff and f_hi <= T_eff -%}
            {{ dict(target=T_eff, peak=(desired_peak | float) , timestamp='unknown') | tojson }}
        {%- else -%}
            {%- set ns = namespace(mid=none, lo=lo, hi=hi) -%}
            {%- for _ in range(0, 24) -%}
                {%- set ns.mid = (ns.lo + ns.hi) / 2 -%}
                {%- set f_mid = A(ns.mid) | float -%}
                {%- if f_mid > T_eff -%}
                    {%- set ns.lo = ns.mid -%}
                {%- else -%}
                    {%- set ns.hi = ns.mid -%}
                {%- endif -%}
            {%- endfor -%}
            {%- set result_time = t0l + timedelta(hours=ns.mid) -%}
            {{ dict(target=T_eff, peak=(desired_peak | float) , timestamp=result_time.isoformat()) | tojson }}
        {%- endif -%}
    {%- endif -%}
{%- endmacro %}

{# --- Peak helpers: true Bateman peak value and time --- #}

{% macro _t_peak_hours(resid_prev, dose, ke, ka) -%}
    {# Returns t* in hours where A(t) is maximal.
       Closed form when ka > ke and dose > 0 and argument in (0, 1).
       Otherwise clamp to 0 (peak at injection). #}
    {%- if (dose | float(0)) <= 0 or (ka | float) <= (ke | float) -%}
        0
    {%- else -%}
        {%- set num = (ke / ka) * (1 + ((ka - ke) / ka) * ((resid_prev | float(0)) / (dose | float(0)))) -%}
        {%- if num <= 0 -%}
            0
        {%- else -%}
            {%- set ln = num | log -%}
            {%- set denom = (ka - ke) -%}
            {%- set tstar = -(ln / denom) -%}
            {{- [tstar, 0] | max -}}
        {%- endif -%}
    {%- endif -%}
{%- endmacro %}

{% macro zep_next_peak(t0_iso, resid_prev, dose, hl_days, hl_abs_h) -%}
    {%- set t0 = as_datetime(t0_iso) -%}
    {%- if t0 is none -%}
        {{- { 'value': 0, 'time': 'unknown' } | tojson -}}
    {%- else -%}
        {%- set parts = _rates(hl_days, hl_abs_h).split(',') -%}
        {%- set ke = parts[0] | float -%}
        {%- set ka = parts[1] | float -%}
        {%- set tstar = _t_peak_hours(resid_prev, dose, ke, ka) | float -%}
        {{- { 'value': _amount_at(tstar, resid_prev, dose, ke, ka) | float | round(3),
            'time': (t0 + timedelta(hours=tstar) ).isoformat()
            } | tojson -}}
    {%- endif -%}
{%- endmacro %}

{# --- Steady-state helpers for periodic dosing every T hours --- #}

{% macro _ss_cycle(resid_prev, dose, ke, ka, T_h) -%}
  {{ _amount_at(T_h, resid_prev, dose, ke, ka) }}
{%- endmacro %}

{# --- Steady-state eval (closed form) --- #}
{% macro zep_ss_eval(dose, T_h, hl_days, hl_abs_h) -%}
  {%- set parts = _rates(hl_days, hl_abs_h).split(',') -%}
  {%- set ns = namespace(
        ke = parts[0] | float,
        ka = parts[1] | float,
        d  = dose | float,
        T  = T_h | float
      ) -%}
  {%- set a    = _exp(-ns.ke * ns.T) | float -%}
  {%- set term = (_exp(-ns.ke * ns.T) | float) - (_exp(-ns.ka * ns.T) | float) -%}
  {%- set b    = ns.d * (ns.ka / (ns.ka - ns.ke)) * term -%}
  {%- set resid = (b / (1 - a)) | float -%}
  {%- set tau_p = (ns.ka > ns.ke) and ((ns.ka/ns.ke) | log) / (ns.ka - ns.ke) or 0.0 -%}
  {%- set peak  = _amount_at(tau_p, resid, ns.d, ns.ke, ns.ka) | float -%}
  {{ dict(trough=resid, peak=peak) | tojson }}
{%- endmacro %}

{# --- Interval finder with bisection; ok(T) returns 1/0, not "True"/"False" --- #}
{% macro zep_ss_find_interval(dose, min_resid, max_resid, hl_days, hl_abs_h) -%}
  {%- set weekly_h = 168.0 -%}
  {%- set T_min = 24.0 -%}
  {%- set T_max = 336.0 -%}
  {%- set minv = min_resid | float -%}
  {%- set maxv = max_resid | float -%}

  {%- macro ok(T) -%}
    {%- set s = zep_ss_eval(dose, T, hl_days, hl_abs_h) | from_json -%}
    {{ 1 if (s.trough | float >= minv and s.peak | float <= maxv) else 0 }}
  {%- endmacro %}

  {# prefer exactly weekly #}
  {%- set s_week = zep_ss_eval(dose, weekly_h, hl_days, hl_abs_h) | from_json -%}
  {%- if (s_week.trough | float) >= minv and (s_week.peak | float) <= maxv -%}
    {{ dict(T_h=weekly_h, trough=s_week.trough, peak=s_week.peak, weekly_ok=True) | tojson }}
  {%- else -%}
    {# search >= weekly #}
    {%- set ns = namespace(lo=weekly_h, hi=T_max, hit=None) -%}
    {%- if ok(ns.hi) | int == 1 -%}
      {%- for _ in range(0, 22) -%}
        {%- set mid = (ns.lo + ns.hi) / 2 -%}
        {%- if ok(mid) | int == 1 -%}
          {%- set ns.hi = mid -%}
        {%- else -%}
          {%- set ns.lo = mid -%}
        {%- endif -%}
      {%- endfor -%}
      {%- set s1 = zep_ss_eval(dose, ns.hi, hl_days, hl_abs_h) | from_json -%}
      {%- set ns.hit = dict(T_h=ns.hi, trough=s1.trough, peak=s1.peak, weekly_ok=True) -%}
    {%- endif -%}

    {%- if ns.hit is not none -%}
      {{ ns.hit | tojson }}
    {%- else -%}
      {# search [24h, weekly) #}
      {%- set ns2 = namespace(lo=T_min, hi=weekly_h, hit=None) -%}
      {%- if ok(ns2.hi) | int == 1 -%}
        {%- for _ in range(0, 22) -%}
          {%- set mid2 = (ns2.lo + ns2.hi) / 2 -%}
          {%- if ok(mid2) | int == 1 -%}
            {%- set ns2.hi = mid2 -%}
          {%- else -%}
            {%- set ns2.lo = mid2 -%}
          {%- endif -%}
        {%- endfor -%}
        {%- set s2 = zep_ss_eval(dose, ns2.hi, hl_days, hl_abs_h) | from_json -%}
        {%- set ns2.hit = dict(T_h=ns2.hi, trough=s2.trough, peak=s2.peak, weekly_ok=False) -%}
      {%- endif -%}
      {{ (ns2.hit or dict(T_h=None, trough=None, peak=None, weekly_ok=False)) | tojson }}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

{# --- Utilities for UI / sensors --- #}

{# Convert an ISO timestamp (or entity state string) to epoch ms, or 'unknown' #}
{% macro zep_epoch_ms(ts) -%}
  {%- set dt = ts | as_datetime(default=none) -%}
  {{ (as_timestamp(dt) * 1000) | int if dt is not none else 'unknown' }}
{%- endmacro %}

{# Build a forward projection series of residuals (no new injections)
   Returns JSON: [{"t":"<ISO>", "y": <mg>}, ...]
   Args:
     - t0_iso: last injection time
     - resid_prev: last residual at t0 just before dose (mg)
     - dose: last/weekly dose (mg)
     - hl_days: elimination half-life (days)
     - hl_abs_h: absorption half-life (hours)
     - horizon_days (default 30)
     - step_hours (default 6)
     - start_iso (optional): start time for projection; defaults to now()
 #}
{% macro zep_residual_projection(t0_iso, resid_prev, dose, hl_days, hl_abs_h,
                                 horizon_days=30, step_hours=6, start_iso=None) -%}
  {%- set t0 = as_timestamp(t0_iso) -%}
  {%- if t0 is none -%}
    []
  {%- else -%}
    {%- set parts = _rates(hl_days, hl_abs_h).split(',') -%}
    {%- set ke = parts[0] | float -%}
    {%- set ka = parts[1] | float -%}
    {%- set resid0 = resid_prev | float(0) -%}
    {%- set d = dose | float(0) -%}
    {%- set start = (start_iso is not none) and (as_timestamp(start_iso)) or as_timestamp(now()) -%}
    {%- set horizon_h = (horizon_days | int) * 24 -%}
    {%- set step_h = (step_hours | int) if (step_hours | int) > 0 else 6 -%}
    {%- set ns = namespace(out=[]) -%}
    {%- for h in range(0, horizon_h + 1, step_h) -%}
      {%- set t = start + h * 3600 -%}
      {%- set dt_h = (t - t0) / 3600.0 -%}
      {%- set y = 0 -%}
      {%- if dt_h >= 0 -%}
        {%- set y = _amount_at(dt_h, resid0, d, ke, ka) | float -%}
      {%- endif -%}
      {%- set ns.out = ns.out + [ dict(t=(as_datetime(t) | as_local).isoformat(), y=(y | round(3))) ] -%}
    {%- endfor -%}
    {{ ns.out | tojson }}
  {%- endif -%}
{%- endmacro %}
