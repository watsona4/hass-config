{# Severity definitions for precipitation measurements (HA device_class: precipitation) #}

{% import 'helpers.jinja' as H with context %}
{% from 'units/base.jinja' import u_convert_entity %}

{# Precipitation levels based on accumulation in mm #}
{% set lookup_unit = "mm" %}
{% set levels = {
    "default": [
        {
            "min_value": none,
            "default_desc": "Unavailable",
            "short_desc": "Disabled",
            "long_desc": "Sensor unavailable",
            "icon": "mdi:eye-off",
            "color": "disabled",
            "badge": "mdi:circle",
            "full_desc": "Sensor not currently available."
        },
        {
            "min_value": 0,
            "default_desc": "Dry",
            "short_desc": "Dry",
            "long_desc": "No measurable precipitation expected",
            "icon": "mdi:weather-sunny",
            "color": "#facc15",
            "full_desc": "Dry conditions expected through the day."
        },
        {
            "min_value": 1,
            "default_desc": "Light",
            "short_desc": "Light",
            "long_desc": "Spotty or brief precipitation",
            "icon": "mdi:weather-partly-rainy",
            "color": "#22c55e",
            "full_desc": "Intermittent or gentle precipitation likely."
        },
        {
            "min_value": 5,
            "default_desc": "Moderate",
            "short_desc": "Mod",
            "long_desc": "Widespread steady precipitation",
            "icon": "mdi:weather-rainy",
            "color": "#3b82f6",
            "full_desc": "A sustained period of precipitation is likely."
        },
        {
            "min_value": 15,
            "default_desc": "Heavy",
            "short_desc": "Heavy",
            "long_desc": "Prolonged or intense precipitation",
            "icon": "mdi:weather-pouring",
            "color": "#2563eb",
            "full_desc": "Strong, long-lasting precipitation likely."
        },
        {
            "min_value": 30,
            "default_desc": "Very Heavy",
            "short_desc": "V Heavy",
            "long_desc": "Very wet day with significant impacts",
            "icon": "mdi:weather-lightning-rainy",
            "color": "#1e3a8a",
            "full_desc": "High impact day with saturated surfaces likely."
        },
        {
            "min_value": 50,
            "default_desc": "Extreme",
            "short_desc": "Extreme",
            "long_desc": "Exceptional precipitation event",
            "icon": "mdi:weather-hurricane",
            "color": "#581c87",
            "full_desc": "Dangerous conditions possible; monitor warnings."
        }
    ]
} %}

{% macro get_dc_context() %}
    {{- {'lookup_unit': lookup_unit, 'levels': levels} | tojson -}}
{% endmacro %}

{% macro get_name(value, app, options) -%}
    {{- 'Precipitation • ' ~ H.get_default_desc(value, app, options) -}}
{%- endmacro %}

{% macro get_label(value, app, options) %}
  {#- use main formatting when no prob specified -#}
  {%- if not (options is mapping and 'prob' in options) -%}
    {{- '' -}}
  {%- else -%}
    {#- --- read layout/delimiters --- -#}
    {%- set delim = options.get('delim', ' • ') -%}
    {%- set vert_delim = options.get('vert_delim','\n') -%}
    {%- set sep = (vert_delim if options.get('layout','horizontal') == 'vertical' else delim) -%}

    {#- --- pull probability; support entity_id or numeric literal --- -#}
    {%- set psrc = options.prob -%}
    {%- set p_is_entity = (psrc is string) and ('.' in psrc) -%}
    {%- set p_raw = (states(psrc) | float(none)) if p_is_entity else (psrc | float(none)) -%}

    {#- coerce scale: if 0–1, treat as fraction; if 0–100, leave; else, best-effort -#}
    {%- set p_norm = (
          (p_raw * 100.0) if (p_raw is number and p_raw >= 0 and p_raw <= 1)
          else (p_raw if p_raw is number else none)
        ) -%}

    {#- pretty text for probability; if not numeric, fall back gracefully -#}
    {%- set ns = namespace(prob_text=None) -%}
    {%- if p_norm is number -%}
      {%- set ns.prob_text = (p_norm | round(0)) ~ '%' -%}
    {%- endif -%}

    {#- humanized precipitation amount using your existing helpers/units -#}
    {%- set amount_text = H.get_value(value, app, options) -%}

    {#- final label:
       - if prob is valid: "60% chance: 0.24 in" (or vertical sep)
       - if prob invalid/missing: just amount_text (still an override, but readable)
    -#}
    {%- if ns.prob_text -%}
      {{- ns.prob_text ~ ' chance' ~ (': ' if sep == delim else sep) ~ amount_text -}}
    {%- else -%}
      {{- amount_text -}}
    {%- endif -%}
  {%- endif -%}
{% endmacro %}

{% macro get_short_label(value, app, options) %}{{ get_label(value, app, options) }}{% endmacro %}
{% macro get_long_label(value, app, options) %}{{ get_label(value, app, options) }}{% endmacro %}
