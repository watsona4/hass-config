title: RaspberryPi
type: sections
max_columns: 3
cards: []

badges:
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: Status
      - entity: binary_sensor.raspberrypi4_status_alarm
      - app: alarm
      - options: 'summary=sensor.raspberrypi4_overall_status_summary'
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: CPU Load
      - entity: sensor.raspberrypi4_cpu_load_1m
      - app: cpu_load
      - options: 'cores=sensor.raspberrypi4_cpu_cores'
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: CPU
      - entity: sensor.raspberrypi4_cpu_utilization
      - app: cpu_utilization
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: CPU Temp
      - entity: sensor.raspberrypi4_cpu_temp_cpu_thermal_0
      - app: cpu
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: Memory
      - entity: sensor.raspberrypi4_memory_percent
      - app: memory_utilization

sections:
  - type: grid
    columns: 3
    grid_options:
      columns: full
    column_span: 3
    cards:
      - type: vertical-stack
        cards:

          # CPU & Memory Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: CPU & Memory
              - subtitle: Utilization and system load

          # CPU Load
          - type: custom:mushroom-template-card
            entity: sensor.raspberrypi4_cpu_load_1m
            primary: CPU Load (1m/5m/15m)
            secondary: >-
              {%- set m1 = states(entity)|float(0) -%}
              {%- set m5 = states('sensor.raspberrypi4_cpu_load_5m')|float(0) -%}
              {%- set m15 = states('sensor.raspberrypi4_cpu_load_15m')|float(0) -%}
              {%- set c = states('sensor.raspberrypi4_cpu_cores')|int(0) -%}
              {{- '1 min: ' ~ m1 ~ ' • 5 min: ' ~ m5 ~ ' • 15 min: ' ~ m15 ~ ' • ' ~ c ~ ' cores' -}}
            icon: >-
              {%- from 'main.jinja' import get_icon -%}
              {{- get_icon(entity, 'cpu_load') -}}
            icon_color: |-
              {%- from 'main.jinja' import get_color -%}
              {{- get_color(entity, 'cpu_load') -}}
            tap_action:
              action: more-info

          # Memory Usage
          - type: custom:mushroom-template-card
            entity: sensor.raspberrypi4_memory_percent
            primary: Memory
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity, u_humanize_value -%}
              {%- set mem_pct = u_humanize_entity(entity) -%}
              {%- set mem_used = u_humanize_entity('sensor.raspberrypi4_memory_used') -%}
              {%- set mem_total = u_humanize_entity('sensor.raspberrypi4_memory_total') -%}
              {%- set mt = states('sensor.raspberrypi4_memory_total') | float -%}
              {%- set mu = states('sensor.raspberrypi4_memory_used') | float -%}
              {%- set mem_unit = state_attr('sensor.raspberrypi4_memory_used','unit_of_measurement') -%}
              {%- set mem_free = u_humanize_value(mt - mu, mem_unit) -%}
              {{- 'Used: ' ~ mem_used ~ ' / ' ~ mem_total ~ ' • Free: ' ~ mem_free ~ ' • ' ~ mem_pct -}}
            icon: >-
              {%- from 'main.jinja' import get_icon -%}
              {{- get_icon(entity, 'memory_utilization') -}}
            icon_color: |-
              {%- from 'main.jinja' import get_color -%}
              {{- get_color(entity, 'memory_utilization') -}}
            tap_action:
              action: more-info

      - type: vertical-stack
        cards:

          # CPU Temperatures
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: CPU Temperatures
              - subtitle: Thermal status and cooling headroom

          # CPU Average Temp
          - type: custom:decluttering-card
            template: template_card
            variables:
              - name: CPU Average Temp
              - entity: sensor.raspberrypi4_cpu_temp_cpu_thermal_0
              - app: cpu

      - type: vertical-stack
        cards:

          # Network Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: Network
              - subtitle: Connectivity, latency, and throughput

          # Active Network Interfaces
          - type: custom:mushroom-template-card
            entity: sensor.raspberrypi4_network_active_name
            primary: 'Active NIC'
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity -%}
              {%- set nic = states(entity) -%}
              {%- set ip = states('sensor.raspberrypi4_network_active_ipv4') -%}
              {%- set up = u_humanize_entity('sensor.raspberrypi4_network_active_up') -%}
              {%- set down = u_humanize_entity('sensor.raspberrypi4_network_active_down') -%}
              {{- nic ~ ' • ' ~ ip ~ ' • Up: ' ~ up ~ ' • Down: ' ~ down -}}
            icon: mdi:lan-check
            icon_color: blue
            tap_action:
              action: more-info

      - type: vertical-stack
        cards:

          # Filesystem Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: Filesystems
              - subtitle: Storage capacity and usage

          # / Usage
          - type: custom:mushroom-template-card
            entity: sensor.raspberrypi4_fs_percent
            primary: /
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity -%}
              {%- set total = u_humanize_entity('sensor.raspberrypi4_fs_total') -%}
              {%- set used = u_humanize_entity('sensor.raspberrypi4_fs_used') -%}
              {%- set pct = u_humanize_entity(entity) -%}
              {{- 'Total: ' ~ total ~ ' • Used: ' ~ used ~ ' • ' ~ pct -}}
            icon: >-
              {%- from 'main.jinja' import get_icon -%}
              {{- get_icon(entity, 'disk_utilization') -}}
            icon_color: |-
              {%- from 'main.jinja' import get_color -%}
              {{- get_color(entity, 'disk_utilization') -}}
            tap_action:
              action: more-info

      - type: vertical-stack
        cards:

          # Disk Info Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: Disk I/O
              - subtitle: Read/write activity and performance

          # mmcblk0 I/O
          - type: custom:mushroom-template-card
            entity: sensor.raspberrypi_mmcblk0_data_rate
            primary: mmcblk0 I/O Rates
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity -%}
              {%- set read_bps = u_humanize_entity('sensor.raspberrypi4_disk_mmcblk0_read_rate') -%}
              {%- set write_bps = u_humanize_entity('sensor.raspberrypi4_disk_mmcblk0_write_rate') -%}
              {{- 'Read: ' ~ read_bps ~ ' • Write: ' ~ write_bps -}}
            icon: >-
              {%- from 'main.jinja' import get_icon -%}
              {{- get_icon(entity, 'drive_data_rate') -}}
            icon_color: |-
              {%- from 'main.jinja' import get_color -%}
              {{- get_color(entity, 'drive_data_rate') -}}
            multiline_secondary: true
            tap_action:
              action: more-info

      - type: vertical-stack
        cards:

          # Chrony/GPSD Monitor Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: Time Synchronization
              - subtitle: Chrony & GPSD status and quality

          # -------- Card 1: Chrony Status (summary) --------
          - type: custom:mushroom-template-card
            entity: sensor.raspberrypi4_chrony_stratum
            icon: mdi:clock-check-outline
            primary: Chrony Status
            secondary: >
              {% set stratum = states(entity) | int(99) %}
              {% set ref = states('sensor.raspberrypi4_chrony_reference') | string %}
              {% set leap = states('sensor.raspberrypi4_chrony_leap_status') | title %}
              {{ 'Stratum ' ~ stratum ~ ' • Ref: ' ~ ref if ref not in ['unknown','Unavailable',''] else 'Unknown' ~ ' • Leap: ' ~ leap }}
            icon_color: >
              {# overall health based on stratum and having PPS ref #}
              {% set stratum = states(entity) | int(99) %}
              {% set ref = states('sensor.raspberrypi4_chrony_reference') | string %}
              {% set leap = states('sensor.raspberrypi4_chrony_leap_status') | lower %}
              {% if leap != 'normal' %}
                red
              {% elif stratum <= 2 and 'PPS' in ref %}
                green
              {% elif stratum <= 4 %}
                amber
              {% else %}
                red
              {% endif %}
            tap_action:
              action: more-info

          # -------- Card 2: Chrony Timing Quality (combined metrics) --------
          - type: custom:mushroom-template-card
            icon: mdi:sine-wave
            entity: 
            primary: Chrony Timing Quality
            secondary: >
              {% from 'units/base.jinja' import u_humanize_entity %}
              {% set freq = u_humanize_entity('sensor.raspberrypi4_chrony_frequency') %}
              {% set last = u_humanize_entity('sensor.raspberrypi4_chrony_last_offset') %}
              {% set rms  = u_humanize_entity('sensor.raspberrypi4_chrony_rms_offset') %}
              {% set rdel = u_humanize_entity('sensor.raspberrypi4_chrony_root_delay') %}
              {% set rdis = u_humanize_entity('sensor.raspberrypi4_chrony_root_dispersion') %}
              {{ 'Drift: ' ~ freq ~ ' • Last: ' ~ last ~ ' • RMS: ' ~ rms ~ ' • Delay: ' ~ rdel ~ ' • Disp: ' ~ rdis }}
            icon_color: >
              {# decide color from worst of offset/dispersion thresholds #}
              {% set last = (states('sensor.raspberrypi4_chrony_last_offset')|float(0))*1e6 | abs %}
              {% set rms  = (states('sensor.raspberrypi4_chrony_rms_offset')|float(0))*1e6 | abs %}
              {% set rdel = (states('sensor.raspberrypi4_chrony_root_delay')|float(0))*1000 %}
              {% set rdis = (states('sensor.raspberrypi4_chrony_root_dispersion')|float(0))*1000 %}
              {% set worst =
                [ last/10,
                  rms/20,
                  rdel/10,
                  rdis/10 ]
                | max %}
              {% if worst <= 1 %}
                green
              {% elif worst <= 5 %}
                amber
              {% else %}
                red
              {% endif %}
            tap_action:
              action: more-info

          # -------- Card 3: GPSD (single combined card) --------
          - type: custom:mushroom-template-card
            entity: sensor.raspberrypi4_gps_mode
            icon: mdi:crosshairs-gps
            primary: GPSD Fix & Accuracy
            secondary: >
              {% set mode = states('sensor.raspberrypi4_gps_mode')|int(0) %}
              {% set ept_ms = (states('sensor.raspberrypi4_gps_ept')|float(0))*1000 %}
              {% set eph_m = states('sensor.raspberrypi4_gps_eph')|float(0) %}
              {% set sats = states('sensor.raspberrypi4_gps_sats') %}
              Mode: {{ '3D' if mode==3 else '2D' if mode==2 else 'No Fix' }} •
              Time error: {{ ept_ms|round(1) }} ms • Horiz error: {{ eph_m|round(3) }} m •
              Sats: {{ sats if sats not in ['unknown','Unavailable',''] else 'Unknown' }}
            icon_color: >
              {% set mode = states('sensor.raspberrypi4_gps_mode')|int(0) %}
              {% set ept_ms = (states('sensor.raspberrypi4_gps_ept')|float(99))*1000 %}
              {% set eph_m = states('sensor.raspberrypi4_gps_eph')|float(99) %}
              {% if mode == 3 and ept_ms < 20 and eph_m < 2 %}
                green
              {% elif mode >= 2 and ept_ms < 100 and eph_m < 5 %}
                amber
              {% else %}
                red
              {% endif %}
            tap_action:
              action: more-info

  - type: grid
    cards:

      # LibreHardwareMonitor CPU Section
      - type: custom:mushroom-title-card
        title: CPU Metrics
        subtitle: Core utilization, system load, and clock speeds

      # LibreHardwareMonitor Cards
      - type: custom:decluttering-card
        template: lhm_card_stack
        variables:
          - machine_match: raspberrypi4
          - root_match: CPU
          
  - type: grid
    cards:

      # LibreHardwareMonitor Network Section
      - type: custom:mushroom-title-card
        title: Network Connection Metrics
        subtitle: Interfaces, throughput, and latency monitoring

      # LibreHardwareMonitor Cards
      - type: custom:decluttering-card
        template: lhm_card_stack
        variables:
          - machine_match: raspberrypi4
          - root_match: Network
