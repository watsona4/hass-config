type: sections
max_columns: 3
title: Heart Health
path: heart
badges:
  - type: custom:mushroom-template-badge
    entity: sensor.health_bp_combined
    icon: mdi:heart-pulse
    color: >-
      {% set c = states('sensor.health_bp_category') %}
      {% if c == 'Normal' %}
        green
      {% elif c == 'Elevated' %}
        yellow
      {% elif c in ['High Stage 1','High Stage 2'] %}
        orange
      {% elif c == 'Hypertensive Crisis' %}
        red
      {% else %}
        grey
      {% endif %}
    content: "{{ states(entity) ~ ' (' ~ states('sensor.health_bp_category') ~ ')' }}"
  - type: custom:mushroom-template-badge
    entity: sensor.health_pulse_pressure
    icon: mdi:arrow-expand-vertical
    color: >-
      {% set v = states(entity) | float(0) %}
      {% if v < 30 %}
        blue
      {% elif v < 50 %}
        green
      {% elif v < 60 %}
        yellow
      {% elif v < 80 %}
        purple  
      {% else %}
        purple
      {% endif %}
    content: "{{ 'PP ' ~ states(entity) ~ ' mmHg' }}"
  - type: custom:mushroom-template-badge
    entity: sensor.health_mean_arterial_pressure
    icon: mdi:chart-bell-curve
    color: >-
      {% set cat = states('sensor.map_category') %}
      {% if cat == 'Normal' %}
        blue
      {% elif cat == 'Borderline Low' %} 
        amber 
      {% elif cat in ['Low','Very High'] %} 
        red 
      {% elif cat == 'High' %} 
        blue 
      {% else %}
        grey 
      {% endif %}
    content: "{{ 'MAP ' ~ states(entity) ~ ' mmHg (' ~ states('sensor.map_category') ~ ')' }}"
  - type: custom:mushroom-template-badge
    entity: sensor.recovery_status
    icon: >-
      {% if is_state(entity,'Good') %}
        mdi:heart 
      {% elif is_state(entity,'OK') %}
        mdi:heart-half-full 
      {% elif is_state(entity,'Strained') %}
        mdi:heart-broken
      {% else %}
        mdi:heart-outline
      {% endif %}
    color: >-
      {% if is_state(entity,'Good') %} 
        green 
      {% elif is_state(entity,'OK') %} 
        yellow 
      {% elif is_state(entity,'Strained') %} 
        red 
      {% else %} 
        grey
      {% endif %}
    content: "{{ 'Recovery: ' ~ states(entity) }}"
  - type: custom:mushroom-template-badge
    entity: sensor.pixel_9_pro_xl_respiratory_rate
    icon: mdi:lungs
    color: >-
      {% set c = states('sensor.respiratory_rate_category') %} 
      {% if c == 'Normal' %} 
        green 
      {% elif c == 'Low' %} 
        yellow 
      {% elif c == 'Elevated' %} 
        orange 
      {% elif c == 'High' %} 
        red 
      {% else %} 
        grey 
      {% endif %}
    content: "{{ 'RR ' ~ states(entity)  ~ ' rpm (' ~ states('sensor.respiratory_rate_category') ~ ')' }}"
  - type: custom:mushroom-template-badge
    entity: sensor.bp_phenotype
    icon: mdi:stethoscope
    color: >-
      {% set p = states(entity) %}
      {% if p in ['ISH','IDH','SDH'] %} 
        red 
      {% elif p == 'None' %} 
        green 
      {% else %}
        grey 
      {% endif %}
    content: "{{ 'Phenotype: ' ~ states(entity) }}"
  - type: custom:mushroom-template-badge
    entity: sensor.pixel_9_pro_xl_resting_heart_rate
    icon: mdi:trending-up
    color: >-
      {% set d = (states(entity) | float - states('sensor.resting_hr_7d_avg') | float) %}
      {% if d <= -2 %} 
        green 
      {% elif d <= 1 %}
        blue 
      {% elif d <= 3 %} 
        yellow 
      {% else %} 
        red 
      {% endif %}
    content: "{{ 'RHR Î” ' ~ (states(entity) | float - states('sensor.resting_hr_7d_avg') | float) | round(1) ~ ' bpm' }}"
sections:
  - type: grid
    column_span: 2
    cards:
      - type: custom:auto-entities
        grid_options:
          columns: full
        card:
          type: vertical-stack
        card_param: cards
        filter:
          template: >-
            {% from 'macros/health_charts.jinja' import generate_bp_chart, generate_hr_chart %}
            {{ [ generate_bp_chart() | from_json, generate_hr_chart() | from_json ] }}
  - type: grid
    column_span: 1
    cards:
      - type: custom:auto-entities
        card:
          type: entities
          title: Alerts
          state_color: true
        filter:
          include:
            - domain: binary_sensor
              state: 'on'
              name: /BP|Pulse|MAP|Respiratory|Health/
          exclude:
            - name: /SMART/
        sort:
          method: state
        show_empty: false
      - type: entities
        title: Today
        state_color: true
        entities:
          - entity: sensor.health_bp_category
            name: BP Category
          - entity: sensor.health_pulse_pressure
            name: Pulse Pressure
          - entity: sensor.map_category
            name: MAP Category
          - entity: sensor.recovery_status
            name: Recovery
          - entity: sensor.bp_phenotype
            name: Phenotype
      - type: custom:apexcharts-card
        header:
          title: BP Time in Range (30d)
          show: true
        apex_config:
          chart:
            type: bar
          xaxis:
            type: category
            categories:
              - Normal
              - Elevated
              - Stage 1+
              - Stage 2+
        yaxis:
          - id: default
            min: 0
            max: 100
            apex_config:
              tickAmount: 5
              labels:
                formatter: EVAL:function (v) { return v + "%"; }
        series:
          - name: Normal
            type: column
            color: "#7CB342"
            entity: sensor.health_bp_combined
            show:
              legend_value: false
              in_header: false
            data_generator: >
              const get = id => Number(hass.states[id]?.state) || 0; const N  =
              get('sensor.bp_normal_30d'); const E  = get('sensor.bp_elevated_30d');
              const S1 = get('sensor.bp_stage_1_30d'); const S2 =
              get('sensor.bp_stage_2_30d'); return [N, E, S1, S2];
      - type: custom:auto-entities
        grid_options:
          columns: full
        card:
          type: vertical-stack
        card_param: cards
        filter:
          template: >-
            {% from 'macros/health_charts.jinja' import generate_micro_trends %}
            {{ [ generate_micro_trends() | from_json ] }}
