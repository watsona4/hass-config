open_all_windows:
  alias: All Windows Open
  sequence:
  - target:
      entity_id:
      - input_boolean.all_windows
    data: {}
    action: input_boolean.turn_on
  - parallel:
    - data:
        switches:
        - binary_sensor.living_room_closed_brightness
        - binary_sensor.living_room_closed_tv
        - binary_sensor.west_windows_closed_temperature
        - binary_sensor.living_room_closed_button
        action: Open
        entities:
        - cover.living_room_right_window
        - cover.living_room_left_window
      action: script.window_position
    - data:
        switches:
        - binary_sensor.breakfast_room_closed_brightness
        - binary_sensor.west_windows_closed_temperature
        - binary_sensor.breakfast_room_closed_button
        action: Open
        entities:
        - cover.breakfast_room_window
      action: script.window_position
    - data:
        switches:
        - binary_sensor.west_windows_closed_temperature
        - binary_sensor.laundry_room_closed_brightness
        action: Open
        entities:
        - cover.laundry_room_window
      action: script.window_position
    - data:
        switches:
        - binary_sensor.kitchen_closed_brightness
        - binary_sensor.kitchen_closed_hub
        action: Open
        entities:
        - cover.kitchen_right_window
      action: script.window_position
    - data:
        action: Open
        entities:
        - cover.kitchen_left_window
      action: script.window_position
    - data:
        switches:
        - binary_sensor.front_hallway_closed_temperature
        action: Open
        entities:
        - cover.front_hallway_window
      action: script.window_position
    - if:
      - condition: state
        entity_id: input_boolean.study_occupied
        state: 'off'
      then:
      - parallel:
        - data:
            switches:
            - binary_sensor.study_south_closed_temperature
            - binary_sensor.study_south_closed_brightness
            action: Open
            entities:
            - cover.study_left_window
            - cover.study_right_window
          action: script.window_position
        - data:
            switches:
            - binary_sensor.study_west_closed_temperature
            - binary_sensor.study_west_closed_brightness
            action: Open
            entities:
            - cover.study_west_window
          action: script.window_position
    - data:
        switches:
        - binary_sensor.guest_south_closed_temperature
        - binary_sensor.guest_bedroom_closed_button
        - binary_sensor.guest_bedroom_closed_presence
        action: Open
        entities:
        - cover.guest_bedroom_south_window
      action: script.window_position
    - data:
        action: Open
        switches:
        - binary_sensor.master_bedroom_closed_button
        - binary_sensor.master_bedroom_closed_morning
        entities:
        - cover.master_bedroom_left_window
        - cover.master_bedroom_right_window
      action: script.window_position
    - data:
        switches:
        - binary_sensor.west_windows_closed_temperature
        - binary_sensor.guest_bedroom_closed_button
        - binary_sensor.guest_bedroom_closed_presence
        action: Open
        entities:
        - cover.guest_bedroom_left_window
        - cover.guest_bedroom_right_window
      action: script.window_position
    - data:
        switches:
        - binary_sensor.master_bathroom_closed_presence
        - binary_sensor.master_bathroom_closed_button
        action: Open
        entities:
        - cover.master_bathroom_left_window
        - cover.master_bathroom_right_window
      action: script.window_position
    - data:
        switches:
        - binary_sensor.kids_bathroom_closed_button
        - binary_sensor.kids_bathroom_closed_presence
        action: Open
        entities:
        - cover.kids_bathroom_window
      action: script.window_position
  mode: restart
  icon: mdi:blinds-open
close_all_windows:
  alias: All Windows Closed
  sequence:
  - target:
      entity_id:
      - input_boolean.all_windows
    data: {}
    action: input_boolean.turn_off
  - parallel:
    - data:
        action: Closed Down
        entities:
        - cover.living_room_right_window
        - cover.living_room_left_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.breakfast_room_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.laundry_room_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.kitchen_left_window
        - cover.kitchen_right_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.front_hallway_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.guest_bedroom_left_window
        - cover.guest_bedroom_right_window
        - cover.guest_bedroom_south_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.kids_bathroom_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.master_bathroom_left_window
        - cover.master_bathroom_right_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.master_bedroom_left_window
        - cover.master_bedroom_right_window
        reason: Nighttime
      action: script.window_position
    - if:
      - condition: state
        entity_id: input_boolean.study_occupied
        state: 'off'
      then:
      - data:
          action: Closed Down
          entities:
          - cover.study_left_window
          - cover.study_right_window
          - cover.study_west_window
          reason: Nighttime
        action: script.window_position
  mode: restart
  icon: mdi:blinds-horizontal-closed
turn_on_lights:
  alias: Turn On Exterior Lights
  sequence:
  - parallel:
    - sequence:
      - wait_template: '{{ has_value(''switch.back_porch_switch_0'') }}'
        timeout:
          minutes: 5
      - repeat:
          sequence:
          - target:
              entity_id:
              - switch.back_porch_switch_0
            data: {}
            action: switch.turn_on
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and not states(''switch.back_porch_switch_0'')|bool
              }}'
    - sequence:
      - wait_template: '{{ has_value(''switch.front_porch_switch_0'') }}'
        timeout:
          minutes: 5
      - repeat:
          sequence:
          - target:
              entity_id:
              - switch.front_porch_switch_0
            data: {}
            action: switch.turn_on
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and not states(''switch.front_porch_switch_0'')|bool
              }}'
    - sequence:
      - wait_template: '{{ has_value(''switch.kitchen_porch_switch_0'') }}'
        timeout:
          minutes: 5
      - repeat:
          sequence:
          - target:
              entity_id:
              - switch.kitchen_porch_switch_0
            data: {}
            action: switch.turn_on
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and not states(''switch.kitchen_porch_switch_0'')|bool
              }}'
    - sequence:
      - wait_template: '{{ has_value(''switch.garage_lights_switch_0'') }}'
        timeout:
          minutes: 5
      - repeat:
          sequence:
          - target:
              entity_id:
              - switch.garage_lights_switch_0
            data: {}
            action: switch.turn_on
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and not states(''switch.garage_lights_switch_0'')|bool
              }}'
  mode: single
  icon: mdi:lightbulb-on-outline
turn_off_lights:
  alias: Turn Off Exterior Lights
  sequence:
  - parallel:
    - sequence:
      - wait_template: '{{ has_value(''switch.back_porch_switch_0'') }}'
        timeout:
          minutes: 5
      - repeat:
          sequence:
          - target:
              entity_id:
              - switch.back_porch_switch_0
            data: {}
            action: switch.turn_off
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and is_state(''switch.back_porch_switch_0'',''on'')
              }}'
    - sequence:
      - wait_template: '{{ has_value(''switch.front_porch_switch_0'') }}'
        timeout:
          minutes: 5
      - repeat:
          sequence:
          - target:
              entity_id:
              - switch.front_porch_switch_0
            data: {}
            action: switch.turn_off
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and is_state(''switch.front_porch_switch_0'',''on'')
              }}'
    - sequence:
      - wait_template: '{{ has_value(''switch.garage_lights_switch_0'') }}'
        timeout:
          minutes: 5
      - repeat:
          sequence:
          - target:
              entity_id:
              - switch.garage_lights_switch_0
            data: {}
            action: switch.turn_off
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and is_state(''switch.garage_lights_switch_0'',''on'')
              }}'
    - sequence:
      - wait_template: '{{ has_value(''switch.kitchen_porch_switch_0'') }}'
        timeout:
          minutes: 5
      - repeat:
          sequence:
          - target:
              entity_id:
              - switch.kitchen_porch_switch_0
            data: {}
            action: switch.turn_off
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and is_state(''switch.kitchen_porch_switch_0'',''on'')
              }}'
  mode: restart
  icon: mdi:lightbulb-off-outline
announce_door:
  alias: Announce Door
  fields:
    players:
      selector:
        entity:
          multiple: true
      required: true
    name:
      selector:
        text:
      required: true
    door:
      selector:
        select:
          options:
          - Front Door
          - Kitchen Door
      name: door
      required: true
  sequence:
  - variables:
      players: '{{ expand(players) | selectattr(''state'', ''ne'', ''playing'') |
        map(attribute=''entity_id'') | list }}'
      old_volumes: '{{ expand(players) | map(attribute=''attributes.volume_level'')
        | list | replace(''Undefined'', 0.5) }}'
  - data:
      volume_level: 0.5
    target:
      entity_id: '{{players}}'
    action: media_player.volume_set
  - data:
      media_player_entity_id: '{{players}}'
      message: '{{name}} is at the {{door}}'
    target:
      entity_id: tts.piper
    action: tts.speak
  - repeat:
      count: '{{ players|count }}'
      sequence:
      - target:
          entity_id: '{{players[repeat.index-1]}}'
        data:
          volume_level: '{{old_volumes[repeat.index-1]}}'
        action: media_player.volume_set
  description: ''
  mode: single
window_position:
  alias: Window Position
  fields:
    entities:
      selector:
        entity:
          domain: cover
          multiple: true
      required: true
    switches:
      selector:
        entity:
          multiple: true
    action:
      selector:
        select:
          options:
          - Open
          - Closed Up
          - Closed Down
      required: true
    reason:
      selector:
        select:
          options:
          - Brightness
          - Temperature
          - Device
          - Button
          - Presence
          - Nighttime
  variables:
    switches: '{{ switches | default([]) }}'
    reason: '{{ reason | default('''') }}'
  sequence:
  - if:
    - condition: template
      value_template: '{{ expand(switches) | selectattr(''state'', ''eq'', ''on'')
        | list | length != 0 }}'
    then:
    - stop: Some conditional switches are on
  - repeat:
      for_each: '{{ entities }}'
      sequence:
      - action: script.turn_on
        target:
          entity_id: script.single_window
        data:
          variables:
            action: '{{ action }}'
            reason: '{{ reason }}'
            window: '{{ repeat.item }}'
  mode: parallel
  description: ''
  trace:
    stored_traces: 1000
  max: 100
kids_windows_open:
  alias: Kids Windows Open
  sequence:
  - target:
      entity_id:
      - input_boolean.kids_windows
    data: {}
    action: input_boolean.turn_on
  - parallel:
    - sequence:
      - wait_template: '{{ not is_state(''binary_sensor.eleanor_presence_delay'',''on'')
          }}

          '
      - data:
          switches:
          - binary_sensor.west_windows_closed_temperature
          - binary_sensor.eleanor_room_closed_button
          action: Open
          entities:
          - cover.eleanor_room_window
        action: script.window_position
    - sequence:
      - wait_template: '{{ not is_state(''binary_sensor.michael_presence_delay'',''on'')
          }}

          '
      - data:
          switches:
          - binary_sensor.west_windows_closed_temperature
          - binary_sensor.michael_room_closed_button
          action: Open
          entities:
          - cover.michael_room_window
        action: script.window_position
    - data:
        action: Open
        entities:
        - cover.back_hallway_window
      action: script.window_position
  mode: restart
  icon: mdi:blinds-open
  description: ''
notify_window:
  alias: Notify Window
  description: ''
  fields:
    window:
      selector:
        text:
      required: true
  sequence:
  - metadata: {}
    data:
      title: Windows
      message: Unable to open {{ window.split('.')[1] | replace('_', ' ') | title}}!
    action: notify.mobile_app_pixel_9_pro_xl
kids_windows_closed:
  alias: Kids Windows Closed
  sequence:
  - data: {}
    target:
      entity_id: input_boolean.kids_windows
    action: input_boolean.turn_off
  - parallel:
    - data:
        action: Closed Down
        entities:
        - cover.eleanor_room_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.michael_room_window
        reason: Nighttime
      action: script.window_position
    - data:
        action: Closed Down
        entities:
        - cover.back_hallway_window
        reason: Nighttime
      action: script.window_position
    - if:
      - condition: state
        entity_id: input_boolean.study_occupied
        state: 'on'
      then:
      - data:
          action: Closed Down
          entities:
          - cover.study_left_window
          - cover.study_right_window
          - cover.study_west_window
          reason: Nighttime
        action: script.window_position
  mode: restart
  icon: mdi:blinds-horizontal-closed
  description: ''
turn_off_interior_lights:
  alias: Turn Off Interior Lights
  sequence:
  - parallel:
    - sequence:
      - wait_template: "{% if has_value('binary_sensor.everything_presence_one_6dbad0_occupancy')
          %}\n  {{\n    not (states('binary_sensor.everything_presence_one_6dbad0_occupancy')
          | bool)\n    and (now() - states.binary_sensor.everything_presence_one_6dbad0_occupancy.last_changed).total_seconds()
          > 900\n  }}\n{% else %}\n  false\n{% endif %}"
        timeout: 00:30:00
        continue_on_timeout: true
        enabled: false
      - parallel:
        - repeat:
            sequence:
            - target:
                entity_id:
                - light.parlor_lamp
              data: {}
              action: light.turn_off
            - delay:
                seconds: 30
            while:
            - condition: template
              value_template: '{{ repeat.index < 10 and is_state(''light.parlor_lamp'',''on'')
                }}'
        - repeat:
            sequence:
            - target:
                entity_id:
                - switch.parlor_table_lamp
              data: {}
              action: switch.turn_off
            - delay:
                seconds: 30
            while:
            - condition: template
              value_template: '{{ repeat.index < 10 and is_state(''switch.parlor_table_lamp'',''on'')
                }}'
        - if:
          - condition: state
            entity_id: input_boolean.living_room_occupied
            state:
            - 'off'
          then:
          - repeat:
              sequence:
              - target:
                  entity_id:
                  - switch.living_room_end_table_lamp
                data: {}
                action: switch.turn_off
              - delay:
                  seconds: 30
              while:
              - condition: template
                value_template: '{{ repeat.index < 10 and is_state(''switch.living_room_end_table_lamp'',''on'')
                  }}'
    - if:
      - condition: state
        entity_id: input_boolean.guest_bedroom_occupied
        state: 'off'
      then:
      - repeat:
          sequence:
          - target:
              entity_id:
              - switch.guest_bedroom_lamp_socket_1
            data: {}
            action: switch.turn_off
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and is_state(''switch.guest_bedroom_lamp_socket_1'',''on'')
              }}'
    - if:
      - condition: state
        state: 'off'
        entity_id: input_boolean.study_occupied
      then:
      - wait_template: '{{ has_value(''light.study_lamp'') }}'
        timeout:
          minutes: 5
      - repeat:
          sequence:
          - target:
              entity_id:
              - light.study_lamp
            data: {}
            action: light.turn_off
          - delay:
              seconds: 30
          while:
          - condition: template
            value_template: '{{ repeat.index < 10 and is_state(''light.study_lamp'',''on'')
              }}'
  mode: restart
  icon: mdi:lightbulb-off-outline
  description: ''
turn_on_interior_lights:
  alias: Turn On Interior Lights
  sequence:
  - parallel:
    - target:
        entity_id:
        - light.parlor_lamp
      data:
        brightness_pct: 40
      action: light.turn_on
    - target:
        entity_id:
        - switch.parlor_table_lamp
      data: {}
      action: switch.turn_on
    - target:
        entity_id:
        - switch.living_room_end_table_lamp
      data: {}
      action: switch.turn_on
    - if:
      - condition: state
        entity_id: binary_sensor.evening
        state: 'off'
      then:
      - if:
        - condition: state
          entity_id: input_boolean.study_occupied
          state: 'off'
        then:
        - target:
            entity_id:
            - light.study_lamp
          data:
            brightness_pct: 40
          action: light.turn_on
      - if:
        - condition: state
          entity_id: input_boolean.guest_bedroom_occupied
          state: 'off'
        then:
        - target:
            entity_id:
            - switch.guest_bedroom_lamp_socket_1
          data: {}
          action: switch.turn_on
      else:
      - parallel:
        - sequence:
          - wait_template: "{% if has_value('binary_sensor.everything_presence_one_6dbad0_occupancy')
              %}\n  {{\n    not (states('binary_sensor.everything_presence_one_6dbad0_occupancy')
              | bool)\n    and (now() - states.binary_sensor.everything_presence_one_6dbad0_occupancy.last_changed).total_seconds()
              > 900\n  }}\n{% else %}\n  false\n{% endif %}"
            timeout: 00:30:00
            continue_on_timeout: true
          - target:
              entity_id:
              - switch.parlor_table_lamp
              - switch.living_room_end_table_lamp
            data: {}
            action: switch.turn_off
        - if:
          - condition: state
            entity_id: input_boolean.study_occupied
            state: 'off'
          then:
          - target:
              entity_id:
              - light.study_lamp
            data: {}
            action: light.turn_off
        - if:
          - condition: state
            entity_id: input_boolean.guest_bedroom_occupied
            state: 'off'
          then:
          - target:
              entity_id:
              - switch.guest_bedroom_lamp_socket_1
            data: {}
            action: switch.turn_off
  mode: single
  icon: mdi:lightbulb-on-outline
  description: ''
christmas_lights_on:
  alias: Christmas Lights On
  sequence:
  - action: switch.turn_on
    data: {}
    target:
      entity_id:
      - switch.family_christmas_tree_socket_1
      - switch.formal_christmas_tree_socket_1
      - switch.playroom_christmas_tree_socket_1
  - if:
    - condition: or
      conditions:
      - condition: state
        entity_id: media_player.parlor
        state: paused
      - condition: state
        entity_id: media_player.parlor
        state: 'off'
    - condition: state
      entity_id: binary_sensor.daytime
      state: 'on'
    then:
    - action: media_player.media_stop
      target:
        entity_id: media_player.parlor
    - delay: 00:00:02
    - action: media_player.volume_set
      data:
        volume_level: 0.15
      target:
        entity_id: media_player.parlor
    - action: media_player.play_media
      target:
        entity_id:
        - media_player.parlor
      data:
        media:
          media_content_id: FV:2/19
          media_content_type: favorite_item_id
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.christmas_music
      data: {}
  description: ''
christmas_lights_off:
  alias: Christmas Lights Off
  sequence:
  - action: switch.turn_off
    data: {}
    target:
      entity_id:
      - switch.family_christmas_tree_socket_1
      - switch.formal_christmas_tree_socket_1
      - switch.playroom_christmas_tree_socket_1
  - if:
    - condition: state
      entity_id: input_boolean.christmas_music
      state: 'on'
    then:
    - action: media_player.media_pause
      target:
        entity_id: media_player.parlor
    - action: input_boolean.turn_off
      target:
        entity_id: input_boolean.christmas_music
  description: ''
single_window:
  alias: Single Window
  fields:
    window:
      selector:
        entity:
          domain: cover
      required: true
    action:
      selector:
        select:
          options:
          - Open
          - Closed Up
          - Closed Down
      required: true
    reason:
      selector:
        select:
          options:
          - Brightness
          - Temperature
          - Device
          - Button
          - Presence
          - Nighttime
  variables:
    reason: '{{ reason | default('''') }}'
  sequence:
  - if:
    - condition: template
      value_template: '{{ (now() - states(''sensor.uptime'') | as_datetime).total_seconds()
        < 300 }}'
    then:
    - stop: Too soon since restart
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ not has_value(window) }}'
      sequence:
      - stop: Window entity disabled/missing
    - conditions:
      - condition: template
        value_template: '{{ states(window) in [''unavailable'',''unknown'',''none'','''']
          }}'
      sequence:
      - stop: Window entity unavailable
  - variables:
      curr_tilt: '{{ state_attr(window, ''current_tilt_position'') if state_attr(window,''current_tilt_position'')
        is number else None }}'
      position: "{% if curr_tilt is number %}\n  {{ 'Closed Down' if curr_tilt < 30
        else 'Closed Up' if curr_tilt > 70 else 'Open' }}\n{% else %}\n  unknown\n{%
        endif %}"
      tilt: '{{ 0 if action == ''Closed Down'' else 100 if action == ''Closed Up''
        else 50 }}'
      final: '{{ action.split('' '')[0] | lower }}'
  - if:
    - condition: template
      value_template: '{{ final == ''closed'' }}'
    then:
    - action: input_text.set_value
      target:
        entity_id: input_text.blind_{{ window.split('.')[1] }}_closed_reason
      data:
        value: '{{ reason }}'
  - if:
    - condition: template
      value_template: '{{ position != action and position != ''unknown'' }}'
    then:
    - wait_template: '{{ (states(window) | string) not in [''opening'',''closing'']
        }}'
      timeout: 00:01:00
    - action: cover.set_cover_tilt_position
      data:
        tilt_position: '{{ tilt }}'
      target:
        entity_id: '{{ window }}'
      continue_on_error: true
    - wait_template: '{{ states(window) == final }}'
      continue_on_timeout: true
      timeout: 00:05:00
    - if:
      - condition: template
        value_template: '{{ states(window) != final }}'
      then:
      - data:
          window: '{{ window }}'
        action: script.notify_window
  mode: parallel
  max: 100
timer_add_time:
  alias: 'Timer: Add time'
  description: Add a duration to a running/paused timer; starts it if idle.
  mode: single
  fields:
    timer_entity:
      name: Timer
      description: Timer entity to extend
      selector:
        entity:
          domain: timer
    add_time:
      name: Time to add
      description: Amount to add (hours/minutes/seconds)
      selector:
        duration: {}
  sequence:
  - variables:
      e: '{{ timer_entity }}'
      add_h: '{{ add_time.hours | default(0) | int }}'
      add_m: '{{ add_time.minutes | default(0) | int }}'
      add_s: '{{ add_time.seconds | default(0) | int }}'
      add_sec: '{{ (add_h*3600 + add_m*60 + add_s) | int }}'
      remaining_sec: "{% if is_state(e,'active') %}\n  {% set fin = state_attr(e,'finishes_at')
        %}\n  {% if fin %}\n    {{ (as_timestamp(fin) - as_timestamp(now())) | round(0)
        }}\n  {% else %}\n    {% set r = state_attr(e,'remaining') | default('0:00:00')
        %}\n    {% set p = r.split(':') %}\n    {{ (p[0]|int(0))*3600 + (p[1]|int(0))*60
        + (p[2].split('.')[0]|int(0)) }}\n  {% endif %}\n{% elif is_state(e,'paused')
        %}\n  {% set r = state_attr(e,'remaining') | default('0:00:00') %}\n  {% set
        p = r.split(':') %}\n  {{ (p[0]|int(0))*3600 + (p[1]|int(0))*60 + (p[2].split('.')[0]|int(0))
        }}\n{% else %}\n  0\n{% endif %}"
      new_total: '{{ [remaining_sec + add_sec, 0] | max | int }}'
  - condition: template
    value_template: '{{ add_sec > 0 }}'
  - action: timer.start
    target:
      entity_id: '{{ e }}'
    data:
      duration: '{{ new_total }}'
announce:
  alias: Announce
  fields:
    players:
      selector:
        entity:
          multiple: true
      required: true
    message:
      selector:
        text:
      required: true
  sequence:
  - if:
    - condition: state
      state: 'off'
      entity_id: schedule.daytime
    then:
    - stop: Don't announce at night
  - if:
    - condition: state
      entity_id: input_boolean.in_a_teams_meeting
      state: 'on'
    then:
    - stop: In a meeting
  - variables:
      player_ids: "{% set provided = players %} {% if provided is none %}\n  []\n{%
        else %}\n  {% set expanded = expand(provided) | list %}\n  {% if expanded
        | count > 0 %}\n    {{ expanded | map(attribute='entity_id') | list }}\n  {%
        else %}\n    {% if provided is string %}\n      {{ [provided] }}\n    {% else
        %}\n      {{ provided | list }}\n    {% endif %}\n  {% endif %}\n{% endif
        %}"
      playing_players: "{% set ns = namespace(active=[]) %} {% for player in player_ids
        %}\n  {% if is_state(player, 'playing') %}\n    {% set ns.active = ns.active
        + [player] %}\n  {% endif %}\n{% endfor %} {{ ns.active }}"
      old_volumes: "{% set ns = namespace(vols=[]) %} {% for player in player_ids
        %}\n  {% set vol = state_attr(player, 'volume_level') %}\n  {% if vol is none
        %}\n    {% set vol = 0.5 %}\n  {% endif %}\n  {% set ns.vols = ns.vols + [vol]
        %}\n{% endfor %} {{ ns.vols }}"
  - repeat:
      count: '{{ player_ids|count }}'
      sequence:
      - target:
          entity_id: '{{player_ids[repeat.index-1]}}'
        action: media_player.media_pause
        continue_on_error: true
  - data:
      volume_level: 0.5
    target:
      entity_id: '{{player_ids}}'
    action: media_player.volume_set
  - data:
      media_player_entity_id: '{{player_ids}}'
      message: '{{message}}'
    target:
      entity_id: tts.piper
    action: tts.speak
  - repeat:
      count: '{{ player_ids|count }}'
      sequence:
      - target:
          entity_id: '{{player_ids[repeat.index-1]}}'
        data:
          volume_level: '{{old_volumes[repeat.index-1]}}'
        action: media_player.volume_set
        enabled: true
  - if:
    - condition: template
      value_template: '{{ playing_players | count > 0 }}'
    then:
    - repeat:
        count: '{{ playing_players|count }}'
        sequence:
        - target:
            entity_id: '{{ playing_players[repeat.index-1] }}'
          action: media_player.media_play
          continue_on_error: true
  description: ''
  mode: queued
  max: 10
