template:
  - sensor:
{% for i in range(count) %}
    - name: "Xert Activity {{ i }} Path"
      state: >
        {% raw %}{% set acts = (state_attr('sensor.xert_activity_list_raw','activities') or [])
          | selectattr('path','defined')
          | selectattr('start_date','defined')
          | selectattr('start_date','mapping')
          | sort(attribute='start_date.date', reverse=True)
          | map(attribute='path') | list %}
        {{ acts[{% endraw %}{{ i }}{% raw %}] if acts|length > {% endraw %}{{ i }}{% raw %} else '' }}{% endraw %}
{% endfor %}


{%- raw -%}
###############################################################################
# Zwift: weekly summaries
###############################################################################

sensor:
  - platform: history_stats
    name: "Zwift Hours This Week"
    entity_id: binary_sensor.zwift_active
    state: "on"
    type: time
    start: "{{ now().replace(hour=0,minute=0,second=0) - timedelta(days=now().weekday()) }}"
    end: "{{ now() }}"
  - platform: history_stats
    name: "Zwift Rides This Week"
    entity_id: binary_sensor.zwift_active
    state: "on"
    type: count
    start: "{{ now().replace(hour=0,minute=0,second=0) - timedelta(days=now().weekday()) }}"
    end: "{{ now() }}"
  
  ###############################################################################
  # Xert: RESTful sensors for training status & progression (activity list + per-activity details)
  ###############################################################################
  
  - platform: rest
    name: Xert Training Info Raw
    resource_template: >-
      {{ 'https://www.xertonline.com/oauth/training_info' if states('input_text.xert_access_token')|length > 0 else 'http://127.0.0.1:65535/' }}
    method: GET
    scan_interval: 900
    timeout: 20
    headers:
      Authorization: "Bearer {{ states('input_text.xert_access_token') }}"
    value_template: "{{ value_json.success | default(false) }}"
    json_attributes:
      - signature
      - status
      - tl
      - targetXSS
      - wotd
      - weight
      - source
  
  # 1) Recent activity list (IDs) for the window
  - platform: rest
    name: Xert Activity List Raw
    resource_template: >-
      {{ 'https://www.xertonline.com/oauth/activity' if states('input_text.xert_access_token')|length > 0 else 'http://127.0.0.1:65535/' }}
    method: GET
    scan_interval: 999999999
    headers:
      Authorization: "Bearer {{ states('input_text.xert_access_token') }}"
    params:
      from: "{{ states('sensor.xert_lookback_from_epoch') }}"
      to: "{{ states('sensor.xert_lookback_to_epoch') }}"
    value_template: "{{ value_json.success | default(false) }}"
    json_attributes:
      - activities

  # 2) Per-activity detail fetchers for the most recent N items
  #    We dereference 'path' from list attributes by index.
{%- endraw %}

{%- for i in range(count) %}
  - platform: rest
    name: Xert Activity {{ i }} Detail Raw
    resource_template: >-
      {% raw %}{% set p = states('sensor.xert_activity_{% endraw %}{{ i }}{% raw %}_path') %}
      {% if p is not none and p not in ['', 'unknown', 'unavailable'] %}
        {{ 'https://www.xertonline.com/oauth/activity/' ~ p }}
      {% else %}
        {{ 'http://127.0.0.1:65535/' }}
      {% endif %}{% endraw %}
    method: GET
    scan_interval: 999999999
    timeout: 20
    headers:
      Authorization: "{% raw %}Bearer {{ states('input_text.xert_access_token') }}{% endraw %}"
    value_template: "{% raw %}{{ value_json.success | default(false) }}{% endraw %}"
    json_attributes:
      - summary
      - name
      - description
      - progression
{% endfor %}
