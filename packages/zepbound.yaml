###############################################################################
# Package: zepbound.yaml (trigger-based; no minute-by-minute now())
###############################################################################

homeassistant:
  customize:
    sensor.zep_residual_mg:
      friendly_name: Zepbound Residual (mg)
      icon: mdi:pill
    sensor.zep_target_residual_mg:
      friendly_name: Target Residual Before Shot (mg)
      icon: mdi:target
    sensor.zep_projected_peak_mg:
      friendly_name: Projected Peak After Next Shot (mg)
      icon: mdi:chart-bell-curve
    sensor.zep_next_ready_timestamp:
      friendly_name: Next Time Residual Meets Target
      icon: mdi:clock-outline
    binary_sensor.zep_ready_to_inject:
      friendly_name: "Zepbound: Ready To Inject"
      icon: mdi:needle
    sensor.zep_current_course_peak_mg:
      friendly_name: Current Course Upcoming Peak (mg)
      icon: mdi:chart-bell-curve
    sensor.zep_current_course_peak_time:
      friendly_name: Current Course Upcoming Peak Time
      icon: mdi:clock-outline

###############################################################################
# INPUTS / HELPERS
###############################################################################
input_number:
  zep_desired_peak_mg:
    name: Desired Peak (mg)
    min: 0
    max: 50
    step: 0.1
    mode: box
    unit_of_measurement: "mg"
    icon: mdi:target-variant

  zep_desired_dose_mg:
    name: Desired Dose (mg)
    min: 0
    max: 50
    step: 0.1
    mode: box
    unit_of_measurement: "mg"
    icon: mdi:needle

  zep_weekly_dose_mg:
    name: Weekly Dose (mg)
    min: 0
    max: 50
    step: 0.1
    mode: box
    unit_of_measurement: "mg"
    icon: mdi:needle

  zep_half_life_days:
    name: Half-life (days)
    min: 1
    max: 14
    step: 0.1
    mode: slider
    unit_of_measurement: "days"
    icon: mdi:timer-sand
    initial: 5.4

  zep_absorption_half_life_hours:
    name: Absorption Half-life (hours)
    min: 0.5
    max: 48
    step: 0.5
    mode: slider
    unit_of_measurement: "h"
    icon: mdi:clock-outline
    initial: 19

  zep_last_residual_mg:
    name: Last Residual Amount (mg)
    min: 0
    max: 50
    step: 0.01
    mode: box
    unit_of_measurement: "mg"
    icon: mdi:chart-bell-curve

  zep_residual_tolerance_mg:
    name: Residual Tolerance (mg)
    min: 0
    max: 5
    step: 0.05
    mode: slider
    unit_of_measurement: "mg"
    icon: mdi:approximately-equal
    initial: 0.25

input_datetime:
  zep_last_injection:
    name: Last Injection Time
    has_time: true
    has_date: true
  zep_snooze_until:
    name: Zepbound Snooze Until
    has_date: true
    has_time: true

###############################################################################
# TEMPLATE: trigger-based sensors to avoid continuous now()
###############################################################################
template:
  # Residual, recomputed every 5 minutes and when key inputs change.
  - trigger:
      - platform: time_pattern
        minutes: "/5"
      - platform: state
        entity_id:
          - input_datetime.zep_last_injection
          - input_number.zep_last_residual_mg
          - input_number.zep_half_life_days
      - platform: homeassistant
        event: start
    sensor:
      - name: zep_residual_mg
        unit_of_measurement: "mg"
        availability: >-
          {{ has_value('input_datetime.zep_last_injection')
             and has_value('input_number.zep_last_residual_mg')
             and (states('input_number.zep_half_life_days')|float(0) > 0)
             and (states('input_number.zep_absorption_half_life_hours')|float(0) > 0) }}
        state: >-
          {%- from 'macros/zepbound.jinja' import zep_residual -%}
          {{ zep_residual(
               states('input_datetime.zep_last_injection'),
               states('input_number.zep_last_residual_mg'),
               states('input_number.zep_weekly_dose_mg'),
               states('input_number.zep_half_life_days'),
               states('input_number.zep_absorption_half_life_hours')
             ) }}

  - trigger:
      - platform: time_pattern
        minutes: "/5"
      - platform: state
        entity_id:
          - input_datetime.zep_last_injection
          - input_number.zep_last_residual_mg
          - input_number.zep_half_life_days
          - input_number.zep_absorption_half_life_hours
          - input_number.zep_desired_peak_mg
          - input_number.zep_weekly_dose_mg
      - platform: homeassistant
        event: start
    variables:
      plan: >-
        {%- from 'macros/zepbound.jinja' import zep_next_ready -%}
        {{ zep_next_ready(
             states('input_datetime.zep_last_injection'),
             states('input_number.zep_last_residual_mg'),
             states('input_number.zep_weekly_dose_mg'),
             states('input_number.zep_half_life_days'),
             states('input_number.zep_absorption_half_life_hours'),
             states('input_number.zep_desired_peak_mg')
           ) | from_json(default={}) }}
    sensor:
      - name: zep_current_plan
        unique_id: zep_current_plan
        state: "{{ plan.timestamp if plan is mapping else 'unknown' }}"
        attributes:
          target: "{{ plan.target if plan is mapping else None }}"
          peak: "{{ plan.peak if plan is mapping else None }}"

  - trigger:
      - platform: time_pattern
        minutes: "/5"
      - platform: state
        entity_id:
          - input_datetime.zep_last_injection
          - input_number.zep_last_residual_mg
          - input_number.zep_half_life_days
          - input_number.zep_absorption_half_life_hours
          - input_number.zep_desired_peak_mg
          - input_number.zep_desired_dose_mg
      - platform: homeassistant
        event: start
    variables:
      plan: >-
        {%- from 'macros/zepbound.jinja' import zep_next_ready -%}
        {{ zep_next_ready(
             states('input_datetime.zep_last_injection'),
             states('input_number.zep_last_residual_mg'),
             states('input_number.zep_desired_dose_mg'),
             states('input_number.zep_half_life_days'),
             states('input_number.zep_absorption_half_life_hours'),
             states('input_number.zep_desired_peak_mg')
           ) | from_json(default={}) }}
    sensor:
      - name: zep_next_plan
        unique_id: zep_next_plan
        state: "{{ plan.timestamp if plan is mapping else 'unknown' }}"
        attributes:
          target: "{{ plan.target if plan is mapping else None }}"
          peak: "{{ plan.peak if plan is mapping else None }}"

  - sensor:
      - name: zep_target_residual_mg
        unit_of_measurement: "mg"
        availability: "{{ has_value('sensor.zep_current_plan') }}"
        state: >-
          {% set t = state_attr('sensor.zep_current_plan','target') %}
          {{ (t if t is not none else 0) | float | round(3) }}

      - name: zep_projected_peak_mg
        unit_of_measurement: "mg"
        availability: "{{ has_value('sensor.zep_current_plan') }}"
        state: >-
          {% set p = state_attr('sensor.zep_current_plan','peak') %}
          {{ (p if p is not none else 0) | float | round(3) }}

      - name: zep_next_ready_timestamp
        unique_id: zep_next_ready_timestamp
        device_class: timestamp
        availability: "{{ has_value('sensor.zep_current_plan') }}"
        state: >-
          {% set ts = states('sensor.zep_current_plan') %}
          {% set dt = ts | as_datetime(default=none) %}
          {{ dt and (dt | as_local).isoformat() or 'unknown' }}
        attributes:
          display: >-
            {%- from 'macros/humanize_future.jinja' import humanize_future -%}
            {% set ts = states('sensor.zep_current_plan') %}
            {{ humanize_future(ts) }}

  - sensor:
      - name: zep_next_target_residual_mg
        unit_of_measurement: "mg"
        availability: "{{ has_value('sensor.zep_next_plan') }}"
        state: >-
          {% set t = state_attr('sensor.zep_next_plan','target') %}
          {{ (t if t is not none else 0) | float | round(3) }}

      - name: zep_next_projected_peak_mg
        unit_of_measurement: "mg"
        availability: "{{ has_value('sensor.zep_next_plan') }}"
        state: >-
          {% set p = state_attr('sensor.zep_next_plan','peak') %}
          {{ (p if p is not none else 0) | float | round(3) }}

  - binary_sensor:
      - name: zep_ready_to_inject
        unique_id: zep_ready_to_inject
        availability: "{{ has_value('sensor.zep_current_plan') }}"
        state: >-
          {% set ts = states('sensor.zep_current_plan') %}
          {% set dt = ts | as_datetime(default=none) %}
          {{ dt is not none and now() >= (dt | as_local) }}
        attributes:
          planned_time: "{{ states('sensor.zep_current_plan') }}"
          target_residual_mg: "{{ state_attr('sensor.zep_current_plan','target') }}"
          enforced_peak_mg: "{{ state_attr('sensor.zep_current_plan','peak') }}"

  - trigger:
      - platform: time_pattern
        minutes: "/5"
      - platform: state
        entity_id:
          - input_datetime.zep_last_injection
          - input_number.zep_last_residual_mg
          - input_number.zep_half_life_days
          - input_number.zep_absorption_half_life_hours
          - input_number.zep_weekly_dose_mg
      - platform: homeassistant
        event: start
    variables:
      peak: >-
        {%- from 'macros/zepbound.jinja' import zep_next_peak -%}
        {{ zep_next_peak(
             states('input_datetime.zep_last_injection'),
             states('input_number.zep_last_residual_mg'),
             states('input_number.zep_weekly_dose_mg'),
             states('input_number.zep_half_life_days'),
             states('input_number.zep_absorption_half_life_hours')
           ) | from_json(default={}) }}
    sensor:
      - name: zep_current_peak
        unique_id: zep_current_peak
        state: "{{ peak.value if peak is mapping else none }}"
        attributes:
          time: "{{ peak.time if peak is mapping else none }}"
          rising: "{{ peak is mapping and (peak.time | as_datetime(default=none)) is not none and (peak.time | as_datetime(default=none) | as_local) > now() or none }}"

  - trigger:
      - platform: time_pattern
        minutes: "/5"
      - platform: state
        entity_id:
          - input_datetime.zep_last_injection
          - input_number.zep_last_residual_mg
          - input_number.zep_half_life_days
          - input_number.zep_absorption_half_life_hours
          - input_number.zep_desired_dose_mg
      - platform: homeassistant
        event: start
    variables:
      peak: >-
        {%- from 'macros/zepbound.jinja' import zep_next_peak -%}
        {{ zep_next_peak(
             states('input_datetime.zep_last_injection'),
             states('input_number.zep_last_residual_mg'),
             states('input_number.zep_desired_dose_mg'),
             states('input_number.zep_half_life_days'),
             states('input_number.zep_absorption_half_life_hours')
           ) | from_json(default={}) }}
    sensor:
      - name: zep_next_peak
        unique_id: zep_next_peak
        state: "{{ peak.value if peak is mapping else none }}"
        attributes:
          time: "{{ peak.time if peak is mapping else none }}"
          rising: "{{ peak is mapping and (peak.time | as_datetime(default=none)) is not none and (peak.time | as_datetime(default=none) | as_local) > now() or none }}"

  - sensor:
      - name: zep_current_course_peak_mg
        icon: mdi:chart-bell-curve
        unit_of_measurement: "mg"
        availability: "{{ has_value('sensor.zep_current_peak') }}"
        state: >-
          {% set rising = state_attr('sensor.zep_current_peak','rising') | bool(none) %}
          {% set peak_value_mg = states('sensor.zep_current_peak') | float(0) | round(3) %}
          {% if rising %}
            {{ peak_value_mg }}
          {% else %}
            {{ states(this.entity_id) if states(this.entity_id) is number else peak_value_mg }}
          {% endif %}
        attributes:
          peak_time: >-
            {% set rising = state_attr('sensor.zep_current_peak','rising') | bool(none) %}
            {% set peak_dt = state_attr('sensor.zep_current_peak','time') | as_datetime(default=none) %}
            {% if rising %}
              {{ (peak_dt | as_local).isoformat() }}
            {% else %}
              {{ state_attr(this.entity_id, 'peak_time') or (peak_dt and (peak_dt | as_local).isoformat()) or 'unknown' }}
            {% endif %}
          phase: "{{ 'rising' if (state_attr('sensor.zep_current_peak','rising') | bool(none)) else 'past' }}"
          details: >-
            {%- from 'macros/humanize_future.jinja' import humanize_future -%}
            {% set rising = state_attr('sensor.zep_current_peak','rising') | bool(none) %}
            {% set peak_dt = state_attr('sensor.zep_current_peak','time') | as_datetime(default=none) %}
            {% if rising %}
              {{ humanize_future(peak_dt) }}
            {% else %}
              Peaked {{ as_datetime(state_attr(this.entity_id,'peak_time')) | as_local | as_timestamp | timestamp_custom('%a %-m/%-d, %-I:%M %p') if state_attr(this.entity_id,'peak_time') not in ['unknown', None] else 'unknown' }}
            {% endif %}

      - name: zep_current_course_peak_time
        device_class: timestamp
        icon: mdi:clock-outline
        availability: "{{ has_value('sensor.zep_current_peak') }}"
        state: >-
          {% set rising = state_attr('sensor.zep_current_peak','rising') | bool(none) %}
          {% set peak_dt = state_attr('sensor.zep_current_peak','time') | as_datetime(default=none) %}
          {% if rising %}
            {{ (peak_dt | as_local).isoformat() }}
          {% else %}
            {# keep the last timestamp we had while rising #}
            {{ states(this.entity_id) if states(this.entity_id) not in ['unknown','unavailable','None'] else ((peak_dt | as_local).isoformat() if peak_dt is not none else 'unknown') }}
          {% endif %}
        attributes:
          phase: "{{ 'rising' if (state_attr('sensor.zep_current_peak','rising') | bool(none)) else 'past' }}"

      - name: zep_current_course_phase
        availability: "{{ has_value('sensor.zep_current_peak') }}"
        state: "{{ 'rising' if (state_attr('sensor.zep_current_peak','rising') | bool(none)) else 'past' }}"

  - sensor:
      - name: zep_next_course_peak_mg
        icon: mdi:chart-bell-curve
        unit_of_measurement: "mg"
        availability: "{{ has_value('sensor.zep_next_peak') }}"
        state: >-
          {% set rising = state_attr('sensor.zep_next_peak','rising') | bool(none) %}
          {% set peak_value_mg = states('sensor.zep_next_peak') | float(0) | round(3) %}
          {% if rising %}
            {{ peak_value_mg }}
          {% else %}
            {{ states(this.entity_id) if states(this.entity_id) is number else peak_value_mg }}
          {% endif %}
        attributes:
          peak_time: >-
            {% set rising = state_attr('sensor.zep_next_peak','rising') | bool(none) %}
            {% set peak_dt = state_attr('sensor.zep_next_peak','time') | as_datetime(default=none) %}
            {% if rising %}
              {{ (peak_dt | as_local).isoformat() }}
            {% else %}
              {{ state_attr(this.entity_id, 'peak_time') or (peak_dt and (peak_dt | as_local).isoformat()) or 'unknown' }}
            {% endif %}
          phase: "{{ 'rising' if (state_attr('sensor.zep_next_peak','rising') | bool(none)) else 'past' }}"
          details: >-
            {%- from 'macros/humanize_future.jinja' import humanize_future -%}
            {% set rising = state_attr('sensor.zep_next_peak','rising') | bool(none) %}
            {% set peak_dt = state_attr('sensor.zep_next_peak','time') | as_datetime(default=none) %}
            {% if rising %}
              {{ humanize_future(peak_dt) }}
            {% else %}
              Peaked {{ as_datetime(state_attr(this.entity_id,'peak_time')) | as_local | as_timestamp | timestamp_custom('%a %-m/%-d, %-I:%M %p') if state_attr(this.entity_id,'peak_time') not in ['unknown', None] else 'unknown' }}
            {% endif %}

      - name: zep_next_course_peak_time
        device_class: timestamp
        icon: mdi:clock-outline
        availability: "{{ has_value('sensor.zep_next_peak') }}"
        state: >-
          {% set rising = state_attr('sensor.zep_next_peak','rising') | bool(none) %}
          {% set peak_dt = state_attr('sensor.zep_next_peak','time') | as_datetime(default=none) %}
          {% if rising %}
            {{ (peak_dt | as_local).isoformat() }}
          {% else %}
            {# keep the last timestamp we had while rising #}
            {{ states(this.entity_id) if states(this.entity_id) not in ['unknown','unavailable','None'] else ((peak_dt | as_local).isoformat() if peak_dt is not none else 'unknown') }}
          {% endif %}
        attributes:
          phase: "{{ 'rising' if (state_attr('sensor.zep_next_peak','rising') | bool(none)) else 'past' }}"

###############################################################################
# SCRIPTS
###############################################################################
script:
  zep_ack_taken_now:
    alias: "Zepbound: Record Taken Now"
    mode: queued
    sequence:
      - variables:
          resid: "{{ states('sensor.zep_residual_mg') | float(0) }}"
          dose: "{{ states('input_number.zep_desired_dose_mg') | float(0) }}"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zep_last_injection
        data:
          datetime: "{{ now().isoformat() }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.zep_last_residual_mg
        data:
          value: "{{ resid | round(3) }}"
      - service: input_number.set_value
        target:
          entity_id: input_number.zep_weekly_dose_mg
        data:
          value: "{{ dose | round(3) }}"
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zep_snooze_until
        data:
          datetime: "{{ now().isoformat() }}"  # clear snooze

  zep_snooze_hours:
    alias: "Zepbound: Snooze Reminder (hours)"
    mode: restart
    fields:
      hours:
        description: Hours to snooze
        example: 12
    sequence:
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.zep_snooze_until
        data:
          datetime: "{{ (now() + timedelta(hours=(hours|int))).isoformat() }}"

###############################################################################
# AUTOMATIONS
###############################################################################
automation:
  # Hourly or on-ready transition; notify only when available and not snoozed.
  - id: zep_notify_ready_to_inject
    alias: "Zepbound: Notify When Ready to Inject"
    mode: single
    trigger:
      - platform: state
        entity_id: binary_sensor.zep_ready_to_inject
        to: "on"
      - platform: time_pattern
        hours: "/1"
    condition:
      - condition: state
        entity_id: binary_sensor.zep_ready_to_inject
        state: "on"
      - condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.daytime
            state: "on"
          - condition: state
            entity_id: binary_sensor.evening
            state: "on"
      # Snooze gate is checked only at trigger time, not every minute.
      - condition: template
        value_template: >-
          {% set s = states('input_datetime.zep_snooze_until') %}
          {{ not has_value('input_datetime.zep_snooze_until')
             or as_timestamp(now()) >= as_timestamp(s) }}
    action:
      - service: notify.mobile_app_pixel_9_pro_xl
        data:
          title: "Zepbound: Time for your shot"
          message: >-
            Residual {{ states('sensor.zep_residual_mg') }} mg at/below target
            {{ states('sensor.zep_target_residual_mg') }} mg. Dose:
            {{ states('input_number.zep_desired_dose_mg') }} mg. Projected peak:
            {{ states('sensor.zep_projected_peak_mg') }} mg.
          data:
            tag: zep_shot
            actions:
              - action: ZEP_TAKEN_NOW
                title: "Taken"
                destructive: true
              - action: ZEP_SNOOZE_12H
                title: "Snooze 12h"
              - action: ZEP_SNOOZE_24H
                title: "Snooze 24h"

  # Handle mobile app notification actions.
  - id: zep_handle_actions
    alias: "Zepbound: Handle Notification Actions"
    mode: parallel
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
    condition:
      - condition: template
        value_template: >-
          {{ trigger.event.data.action in ['ZEP_TAKEN_NOW','ZEP_SNOOZE_12H','ZEP_SNOOZE_24H'] }}
    action:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.action == 'ZEP_TAKEN_NOW' }}"
            sequence:
              - service: script.zep_ack_taken_now
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.action == 'ZEP_SNOOZE_12H' }}"
            sequence:
              - service: script.zep_snooze_hours
                data:
                  hours: 12
          - conditions:
              - condition: template
                value_template: "{{ trigger.event.data.action == 'ZEP_SNOOZE_24H' }}"
            sequence:
              - service: script.zep_snooze_hours
                data:
                  hours: 24
