# =====================================================================================
# OpenMeteo: consolidated package with per-location and selector
# Exposes:
#   - Weather entities for RV, Home, RV
#   - Individual current metrics as sensors per-location
#   - Individual daily (index 0 = today) metrics as sensors per-location
# Dependencies:
#   - sensors: sensor.openmeteo_rv, sensor.openmeteo_home, sensor.openmeteo_rv
#   - jinja: env/weather_codes.jinja (for condition mapping)
# Notes:
#   - All templates use has_value and safe indexing to avoid errors.
#   - Units: uses native units coming from your REST/OpenMeteo setup.
# =====================================================================================

sensor:
  - platform: rest
    name: OpenMeteo RV
    unique_id: openmeteo_rv
    state_class: measurement
    device_class: temperature
    unit_of_measurement: "°F"
    scan_interval: 300
    timeout: 60
    resource_template: >-
      {%- from 'macros/rest_helpers.jinja' import rv_is_valid -%}
      {{ 'https://api.open-meteo.com/v1/forecast' if (rv_is_valid() | bool) else 'http://127.0.0.1:65535/' }}
    params:
      latitude: >-
        {%- from 'macros/rest_helpers.jinja' import rv_lat -%}
        {{- rv_lat() -}}
      longitude: >-
        {%- from 'macros/rest_helpers.jinja' import rv_lon -%}
        {{- rv_lon() -}}
      elevation: >-
        {%- from 'macros/rest_helpers.jinja' import rv_alt -%}
        {{- rv_alt() -}}
      timezone: auto
      current: apparent_temperature,cloud_cover,dew_point_2m,is_day,relative_humidity_2m,surface_pressure,temperature_2m,uv_index,visibility,weather_code,wind_direction_10m,wind_gusts_10m,wind_speed_10m
      daily: precipitation_probability_max,precipitation_sum,rain_sum,snowfall_sum,sunrise,sunset,temperature_2m_max,temperature_2m_min,uv_index_max,weather_code,wind_gusts_10m_max,winddirection_10m_dominant,windspeed_10m_max
      hourly: apparent_temperature,cloud_cover,dew_point_2m,is_day,precipitation,precipitation_probability,relative_humidity_2m,surface_pressure,temperature_2m,uv_index,weather_code,wind_direction_10m,wind_gusts_10m,wind_speed_10m
      temperature_unit: fahrenheit
      wind_speed_unit: mph
      precipitation_unit: inch
      forecast_hours: 24
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache
    availability: >-
      {%- from 'macros/rest_helpers.jinja' import rv_is_valid -%}
      {{- rv_is_valid() | bool -}}
    value_template: >-
      {%- set data = value_json if value_json is mapping else {} -%}
      {%- set cur = data.get('current') or {} -%}
      {%- set t = cur.get('temperature_2m') -%}
      {{- t if t is not none else states(this.entity_id) -}}
    json_attributes:
      - timezone
      - timezone_abbreviation
      - elevation
      - current_units
      - current
      - hourly_units
      - hourly
      - daily_units
      - daily

weather:
  - platform: template
    name: OpenMeteo Weather RV
    unique_id: openmeteo_weather_rv
    condition_template: >
      {%- from 'metrics/weather/forecasts.jinja' import current_condition -%}
      {{- current_condition('sensor.openmeteo_rv') -}}
    apparent_temperature_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('apparent_temperature') -}}"
    cloud_coverage_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('cloud_cover') -}}"
    dew_point_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('dew_point_2m') -}}"
    humidity_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('relative_humidity_2m') -}}"
    pressure_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('surface_pressure') -}}"
    temperature_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('temperature_2m') -}}"
    visibility_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('visibility') -}}"
    wind_bearing_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('wind_direction_10m') -}}"
    wind_gust_speed_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('wind_gusts_10m') -}}"
    wind_speed_template: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('wind_speed_10m') -}}"
    precipitation_unit: "in"
    pressure_unit: "hPa"
    temperature_unit: "°F"
    visibility_unit: "m"
    wind_speed_unit: "mph"
    forecast_daily_template: >
      {%- from 'metrics/weather/forecasts.jinja' import forecast_daily -%}
      {{- forecast_daily('sensor.openmeteo_rv') | from_json -}}
    forecast_hourly_template: >
      {%- from 'metrics/weather/forecasts.jinja' import forecast_hourly -%}
      {{- forecast_hourly('sensor.openmeteo_rv') | from_json -}}

template:

  - sensor:
      - name: RV Temperature
        unique_id: rv_current_temperature
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('temperature_2m') -}}"

      - name: RV UV Index
        unique_id: rv_current_uv_index
        state_class: measurement
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('uv_index') -}}"

      - name: RV Apparent Temperature
        unique_id: rv_current_apparent_temperature
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('apparent_temperature') -}}"

      - name: RV Humidity
        unique_id: rv_current_humidity
        device_class: humidity
        unit_of_measurement: "%"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('relative_humidity_2m') -}}"

      - name: RV Dew Point
        unique_id: rv_current_dew_point
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('dew_point_2m') -}}"

      - name: RV Pressure
        unique_id: rv_current_pressure
        device_class: atmospheric_pressure
        unit_of_measurement: "hPa"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('surface_pressure') -}}"

      - name: RV Wind Speed
        unique_id: rv_current_wind_speed
        device_class: wind_speed
        unit_of_measurement: "mph"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('wind_speed_10m') -}}"

      - name: RV Wind Gust
        unique_id: rv_current_wind_gust
        device_class: wind_speed
        unit_of_measurement: "mph"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('wind_gusts_10m') -}}"

      - name: RV Wind Direction
        unique_id: rv_current_wind_direction
        device_class: wind_direction
        unit_of_measurement: "°"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('wind_direction_10m') -}}"

      - name: RV Visibility
        unique_id: rv_current_visibility
        device_class: distance
        unit_of_measurement: "m"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('visibility') -}}"

      - name: RV Cloud Cover
        unique_id: rv_current_cloud_cover
        unit_of_measurement: "%"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('cloud_cover') -}}"

      - name: RV Weather Code
        unique_id: rv_current_weather_code
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('weather_code') -}}"

      - name: RV Observation Time
        unique_id: rv_current_observation_time
        device_class: timestamp
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','current') is mapping) -}}"
        state: "{{- (state_attr('sensor.openmeteo_rv','current') or {}).get('time') | as_datetime | as_local -}}"

      - name: RV Today Temp Max
        unique_id: rv_daily0_temp_max
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('temperature_2m_max') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: RV Today Temp Min
        unique_id: rv_daily0_temp_min
        device_class: temperature
        unit_of_measurement: "°F"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('temperature_2m_min') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: RV Today Uv Index Max
        unique_id: rv_daily0_uv_index_max
        state_class: measurement
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('uv_index_max') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: RV Today Precip Sum
        unique_id: rv_daily0_precip_sum
        device_class: precipitation
        unit_of_measurement: "in"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('precipitation_sum') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: RV Today Rain Sum
        unique_id: rv_daily0_rain_sum
        device_class: precipitation
        unit_of_measurement: "in"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('rain_sum') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: RV Today Snowfall Sum
        unique_id: rv_daily0_snowfall_sum
        device_class: precipitation
        unit_of_measurement: "in"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('snowfall_sum') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: RV Today Precip Prob Max
        unique_id: rv_daily0_precip_prob_max
        unit_of_measurement: "%"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('precipitation_probability_max') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: RV Today Wind Speed Max
        unique_id: rv_daily0_wind_speed_max
        device_class: wind_speed
        unit_of_measurement: "mph"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('windspeed_10m_max') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: RV Today Wind Dir Dom
        unique_id: rv_daily0_wind_dir_dom
        device_class: wind_direction
        unit_of_measurement: "°"
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('winddirection_10m_dominant') or [] -%}
          {{- _l[0] if (_l | length) > 0 else none -}}

      - name: RV Today Sunrise
        unique_id: rv_daily0_sunrise
        device_class: timestamp
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('sunrise') or [] -%}
          {{- _l[0] | as_datetime | as_local if (_l | length) > 0 else none -}}

      - name: RV Today Sunset
        unique_id: rv_daily0_sunset
        device_class: timestamp
        availability: "{{- has_value('sensor.openmeteo_rv') and (state_attr('sensor.openmeteo_rv','daily') is mapping) -}}"
        state: >-
          {%- set _l = (state_attr('sensor.openmeteo_rv','daily') or {}).get('sunset') or [] -%}
          {{- _l[0] | as_datetime | as_local if (_l | length) > 0 else none -}}

  - sensor:
      - name: RV UV Window JSON
        unique_id: rv_uv_window_json
        icon: mdi:code-json
        availability: "{{- has_value('sensor.openmeteo_rv') -}}"
        state: "{{- now () -}}"
        attributes:
          data: >-
            {%- from 'metrics/uv/protection_window.jinja' import uv_window -%}
            {{- uv_window('sensor.openmeteo_rv', 3.5) | from_json -}}

  - binary_sensor:
      - name: RV UV Protection
        unique_id: rv_uv_protection
        availability: "{{- has_value('sensor.rv_uv_window_json') -}}"
        state: >-
          {%- set window = state_attr('sensor.rv_uv_window_json','data') -%}
          {%- set s = window.get('start') | as_datetime(default=None) -%}
          {%- set e = window.get('end') | as_datetime(default=None) -%}
          {{- s is not none and e is not none and s | as_local <= now() < e | as_local -}}
        attributes:
          start: >-
            {%- set window = state_attr('sensor.rv_uv_window_json','data') -%}
            {%- set dt = window.get('start') | as_datetime(default=none) -%}
            {{- dt | as_local if dt is not none -}}
          end: >-
            {%- set window = state_attr('sensor.rv_uv_window_json','data') -%}
            {%- set dt = window.get('end') | as_datetime(default=none) -%}
            {{- dt | as_local if dt is not none -}}
          duration: >-
            {%- set window = state_attr('sensor.rv_uv_window_json','data') -%}
            {{- timedelta(minutes=window.get('duration_min') | int(0)) -}}

  - sensor:
      - name: RV UV Exposure JSON
        unique_id: rv_uv_exposure_json
        icon: mdi:code-json
        availability: "{{- has_value('sensor.openmeteo_rv') -}}"
        state: "{{- now () -}}"
        attributes:
          data: >-
            {%- from 'metrics/uv/exposure_st.jinja' import uv_safe_exposure_multi -%}
            {{- uv_safe_exposure_multi('sensor.openmeteo_rv') | from_json -}}

  - sensor:
      - name: RV Safe Exposure End ST1
        unique_id: rv_safe_exposure_end_st1
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st1', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st1', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: RV Safe Exposure End ST2
        unique_id: rv_safe_exposure_end_st2
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st2', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st2', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: RV Safe Exposure End ST3
        unique_id: rv_safe_exposure_end_st3
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st3', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st3', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: RV Safe Exposure End ST4
        unique_id: rv_safe_exposure_end_st4
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st4', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st4', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: RV Safe Exposure End ST5
        unique_id: rv_safe_exposure_end_st5
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st5', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st5', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: RV Safe Exposure End ST6
        unique_id: rv_safe_exposure_end_st6
        device_class: timestamp
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st6', {})).get('end_ts')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set ts = (data.get('st6', {}) if data is mapping else {}).get('end_ts') -%}
          {%- set dt = ts | as_datetime(default=none) -%}
          {{- dt | as_local if dt is not none -}}

      - name: RV Safe Exposure Minutes ST1
        unique_id: rv_safe_exposure_minutes_st1
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st1', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st1', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: RV Safe Exposure Minutes ST2
        unique_id: rv_safe_exposure_minutes_st2
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st2', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st2', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: RV Safe Exposure Minutes ST3
        unique_id: rv_safe_exposure_minutes_st3
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st3', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st3', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: RV Safe Exposure Minutes ST4
        unique_id: rv_safe_exposure_minutes_st4
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st4', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st4', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: RV Safe Exposure Minutes ST5
        unique_id: rv_safe_exposure_minutes_st5
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st5', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st5', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}

      - name: RV Safe Exposure Minutes ST6
        unique_id: rv_safe_exposure_minutes_st6
        device_class: duration
        unit_of_measurement: "min"
        icon: mdi:timer-sand
        availability: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {{- data is mapping and ((data.get('st6', {})).get('mins')) is not none -}}
        state: >-
          {%- set data = state_attr('sensor.rv_uv_exposure_json','data') -%}
          {%- set mins = (data.get('st6', {}) if data is mapping else {}).get('mins') -%}
          {{- mins | int(none) -}}
