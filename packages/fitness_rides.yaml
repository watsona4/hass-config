
# ===========================
#  Fitness: Rides (Zwift + Strava + Xert via RESTful sensors)
#  Requires: mushroom-card, apexcharts-card, Strava (Unofficial), Zwift integration.
# ===========================

###############################################################################
# Secrets you must add to /config/secrets.yaml
#
# xert_username: your@email
# xert_password: yourXertPassword
#
# Note: Xert requires client credentials in the Authorization header (xert_public:xert_public).
###############################################################################

input_number:
  zwift_ride_minutes_total:
    name: "Zwift Ride Minutes Total"
    min: 0
    max: 100000
    step: 0.1
  xert_token_expires_epoch:
    name: "Xert Token Expires (epoch)"
    min: 0
    max: 2147483647
    step: 1

input_text:
  xert_access_token:
    name: "Xert Access Token"
    max: 255
  xert_refresh_token:
    name: "Xert Refresh Token"
    max: 255

group:
  strava_latest_sources:
    name: Strava latest sources
    entities:
      - sensor.strava_0_0
      - sensor.strava_1_0
      - sensor.strava_2_0
      - sensor.strava_3_0
      - sensor.strava_4_0
      - sensor.strava_5_0
      - sensor.strava_6_0
      - sensor.strava_7_0
      - sensor.strava_8_0
      - sensor.strava_9_0

###############################################################################
# Xert: rest_command for token fetch/refresh (called on demand)
###############################################################################
rest_command:
  xert_token_fetch:
    url: "https://www.xertonline.com/oauth/token"
    method: POST
    headers:
      Authorization: "Basic eGVydF9wdWJsaWM6eGVydF9wdWJsaWM="
    payload: !secret xert_token_password_payload
    content_type: "application/x-www-form-urlencoded"

  xert_token_refresh:
    url: "https://www.xertonline.com/oauth/token"
    method: POST
    headers:
      Authorization: "Basic eGVydF9wdWJsaWM6eGVydF9wdWJsaWM="
    payload: "grant_type=refresh_token&refresh_token={{ states('input_text.xert_refresh_token')|urlencode }}"
    content_type: "application/x-www-form-urlencoded"

###############################################################################
# Rolling minutes accumulator to chart weekly hours over months
###############################################################################

utility_meter:
  zwift_weekly_minutes:
    source: sensor.zwift_ride_minutes_total
    cycle: weekly

###############################################################################
# Zwift: active flag and summaries
###############################################################################
template:
  - binary_sensor:
      - name: "Zwift Active"
        state: >
          {% set spd = states('sensor.zwift_speed_1747373')|float(0) %}
          {% set online = states('sensor.zwift_online_1747373')|lower %}
          {{ spd > 0 or online in ['on','online','true','1'] }}
  - sensor:
      - name: "Zwift Ride Minutes Total"
        unit_of_measurement: "min"
        state: "{{ states('input_number.zwift_ride_minutes_total')|float(0) }}"

###############################################################################
# Strava: normalize â€œlatest rideâ€ sensors into readable units
###############################################################################
  - trigger:
      - platform: state
        entity_id: group.strava_latest_sources
      - platform: homeassistant
        event: start
    variables:
      latest_entity: >
        {% set rides = states.sensor
          | selectattr('entity_id', 'match', '^sensor\\.strava_\\d+_0$')
          | selectattr('attributes.sport_type', 'in', ['Ride','VirtualRide'])
          | list %}
        {% set latest = rides | sort(attribute='state', reverse=True) | first %}
        {{ latest.entity_id if latest else '' }}
      latest_idx: >
        {{ latest_entity.split('_')[1] if latest_entity else '0' }}
    sensor:
      - name: "Last Ride Index"
        state: "{{ latest_idx }}"
      - name: "Last Ride Title"
        state: >
          {{ state_attr('sensor.strava_' ~ latest_idx ~ '_0','title')
             or state_attr('sensor.strava_' ~ latest_idx ~ '_0','friendly_name')
             or 'Latest ride' }}
      - name: "Last Ride Distance mi"
        unit_of_measurement: "mi"
        state: "{{ states('sensor.strava_' ~ latest_idx ~ '_3')|float(0)|round(2) }}"
      - name: "Last Ride Elevation ft"
        unit_of_measurement: "ft"
        state: "{{ states('sensor.strava_' ~ latest_idx ~ '_5')|float(0)|round(0) }}"
      - name: "Last Ride Moving Time min"
        unit_of_measurement: "min"
        state: "{{ (states('sensor.strava_' ~ latest_idx ~ '_1')|float(0)/60)|round(1) }}"
      - name: "Last Ride Elapsed Time min"
        unit_of_measurement: "min"
        state: "{{ (states('sensor.strava_' ~ latest_idx ~ '_10')|float(0)/60)|round(1) }}"
      - name: "Last Ride Avg Power W"
        unit_of_measurement: "W"
        state: "{{ states('sensor.strava_' ~ latest_idx ~ '_6')|float(0)|round(0) }}"
      - name: "Last Ride Avg HR bpm"
        unit_of_measurement: "bpm"
        state: "{{ states('sensor.strava_' ~ latest_idx ~ '_8')|float(0)|round(0) }}"
      - name: "Last Ride Max HR bpm"
        unit_of_measurement: "bpm"
        state: "{{ states('sensor.strava_' ~ latest_idx ~ '_9')|float(0)|round(0) }}"
      - name: "Last Ride Avg Cadence"
        unit_of_measurement: "rpm"
        state: "{{ states('sensor.strava_' ~ latest_idx ~ '_13')|float(0)|round(0) }}"
      - name: "Last Ride Calories kCal"
        unit_of_measurement: "kCal"
        state: "{{ states('sensor.strava_' ~ latest_idx ~ '_7')|float(0)|round(0) }}"
      - name: Strava Non-Ride Summary
        state: "{{ now().isoformat() }}"
        attributes:
          types: >-
            {{ states.sensor
               | selectattr('entity_id','match','^sensor\\.strava_\\d+_0$')
               | rejectattr('attributes.sport_type','in',['Ride','VirtualRide'])
               | map(attribute='attributes.sport_type')
               | select('defined')
               | reject('none')
               | reject('equalto','')
               | unique | list }}
          rows: >-
            {% set ids = states.sensor
               | selectattr('entity_id','match','^sensor\\.strava_\\d+_0$')
               | rejectattr('attributes.sport_type','in',['Ride','VirtualRide'])
               | sort(attribute='state', reverse=True)
               | map(attribute='entity_id') | list %}
            {% set out = namespace(list=[]) %}
            {% for eid in ids %}
              {% set idx = eid.split('_')[1] %}
              {% set item = {
                'date': states(eid),
                'title': state_attr(eid,'title') or state_attr(eid,'friendly_name'),
                'type': state_attr(eid,'sport_type'),
                'distance_mi': (states('sensor.strava_' ~ idx ~ '_3')|float(0)|round(2)),
                'moving_min': ((states('sensor.strava_' ~ idx ~ '_1')|float(0)/60)|round(1)),
                'kcal': (states('sensor.strava_' ~ idx ~ '_7')|float(0)|round(1)),
              } %}
              {% set out.list = out.list + [item] %}
            {% endfor %}
            {{ out.list | tojson }}

  - trigger:
      - platform: state
        entity_id: group.strava_latest_sources
      - platform: homeassistant
        event: start
      - platform: time_pattern
        minutes: "/30"

    variables:

      ride_ids: >-
        {{ states.sensor
          | selectattr('entity_id','match','^sensor\\.strava_\\d+_0$')
          | selectattr('attributes.sport_type','in',['Ride','VirtualRide'])
          | map(attribute='entity_id')
          | list }}

      week_start_ts: >-
        {{ as_timestamp(
            now().replace(hour=0, minute=0, second=0, microsecond=0)
            - timedelta(days=now().weekday())
          ) }}
      week_end_ts: "{{ week_start_ts + 7*24*3600 }}"
      last_week_start_ts: "{{ week_start_ts - 7*24*3600 }}"
      last_week_end_ts: "{{ week_start_ts }}"
      start_7d_ts: "{{ as_timestamp(now()) - 7*24*3600 }}"
      start_28d_ts: "{{ as_timestamp(now()) - 28*24*3600 }}"

      week_totals: >-
        {% set ns = namespace(rides=0, sec=0.0, mi=0.0, ft=0.0) %}
        {% for eid in ride_ids %}
          {% set dt_ts = as_timestamp(states(eid)) %}
          {% if dt_ts is number and week_start_ts|float <= dt_ts < week_end_ts|float %}
            {% set idx = eid.split('_')[1] %}
            {% set ns.rides = ns.rides + 1 %}
            {% set ns.sec = ns.sec + states('sensor.strava_' ~ idx ~ '_1')|float(0) %}
            {% set ns.mi = ns.mi  + states('sensor.strava_' ~ idx ~ '_3')|float(0) %}
            {% set ns.ft = ns.ft  + states('sensor.strava_' ~ idx ~ '_5')|float(0) %}
          {% endif %}
        {% endfor %}
        {{ {'rides': ns.rides, 'sec': ns.sec, 'mi': ns.mi, 'ft': ns.ft} }}

      last_week_sec: >-
        {% set ns = namespace(sec=0.0) %}
        {% for eid in ride_ids %}
          {% set dt_ts = as_timestamp(states(eid)) %}
          {% if dt_ts is number and last_week_start_ts|float <= dt_ts < last_week_end_ts|float %}
            {% set idx = eid.split('_')[1] %}
            {% set ns.sec = ns.sec + states('sensor.strava_' ~ idx ~ '_1')|float(0) %}
          {% endif %}
        {% endfor %}
        {{ ns.sec }}

      load_7d_sec: >-
        {% set ns = namespace(sec=0.0) %}
        {% for eid in ride_ids %}
          {% set dt_ts = as_timestamp(states(eid)) %}
          {% if dt_ts is number and start_7d_ts|float <= dt_ts < as_timestamp(now()) %}
            {% set idx = eid.split('_')[1] %}
            {% set ns.sec = ns.sec + states('sensor.strava_' ~ idx ~ '_1')|float(0) %}
          {% endif %}
        {% endfor %}
        {{ ns.sec }}

      load_28d_sec: >-
        {% set ns = namespace(sec=0.0) %}
        {% for eid in ride_ids %}
          {% set dt_ts = as_timestamp(states(eid)) %}
          {% if dt_ts is number and start_28d_ts|float <= dt_ts < as_timestamp(now()) %}
            {% set idx = eid.split('_')[1] %}
            {% set ns.sec = ns.sec + states('sensor.strava_' ~ idx ~ '_1')|float(0) %}
          {% endif %}
        {% endfor %}
        {{ ns.sec }}

    sensor:
      - name: Ride Training Summary (This Week)
        icon: mdi:bike
        state: "{{ now().isoformat() }}"
        attributes:
          week_start: "{{ week_start_ts }}"
          week_end: "{{ week_end_ts }}"
          rides: "{{ week_totals.rides }}"
          week_hours: "{{ (week_totals.sec / 3600) | round(2) }}"
          week_miles: "{{ week_totals.mi | round(1) }}"
          week_elev_ft: "{{ week_totals.ft | round(0) }}"
          last_week_hours: "{{ (last_week_sec | float(0) / 3600) | round(2) }}"
          load_7d_hours: "{{ (load_7d_sec | float(0) / 3600) | round(2) }}"
          load_28d_hours: "{{ (load_28d_sec | float(0) / 3600) | round(2) }}"
      - name: Ride Week Hours
        state: "{{ (week_totals.sec / 3600) | round(2) }}"
        unit_of_measurement: "h"
        icon: mdi:chart-line
      - name: Ride Last Week Hours
        state: "{{ (last_week_sec | float(0) / 3600) | round(2) }}"
        unit_of_measurement: "h"
        icon: mdi:chart-line
      - name: Ride Load 7d Hours
        state: "{{ (load_7d_sec | float(0) / 3600) | round(2) }}"
        unit_of_measurement: "h"
        icon: mdi:chart-line
      - name: Ride Load 28d Hours
        state: "{{ (load_28d_sec | float(0) / 3600) | round(2) }}"
        unit_of_measurement: "h"
        icon: mdi:chart-line

###############################################################################
# Zwift: last-ride snapshots fallback
###############################################################################
  - trigger:
      - platform: state
        entity_id: binary_sensor.zwift_active
        from: "on"
        to: "off"
    sensor:
      - name: "Zwift Last Ride Distance km"
        unit_of_measurement: "km"
        state: "{{ states('sensor.zwift_distance_1747373')|float(0)|round(2) }}"
      - name: "Zwift Last Ride Avg Power W"
        unit_of_measurement: "W"
        state: "{{ states('sensor.zwift_power_1747373')|float(0)|round(0) }}"
      - name: "Zwift Last Ride Avg HR bpm"
        unit_of_measurement: "bpm"
        state: "{{ states('sensor.zwift_heart_rate_1747373')|float(0)|round(0) }}"

  - sensor:
      - name: "Unified Last Ride Distance mi"
        unit_of_measurement: "mi"
        state: >
          {# Prefer Strava miles; else Zwift km -> miles #}
          {% set s_mi = states('sensor.last_ride_distance_mi')|float(0) %}
          {% set z_km = states('sensor.zwift_last_ride_distance_km')|float(0) %}
          {{ (s_mi if s_mi>0 else (z_km*0.621371))|round(2) }}
      - name: "Unified Last Ride Avg Power W"
        unit_of_measurement: "W"
        state: >
          {% set s = states('sensor.last_ride_avg_power_w') %}
          {% set z = states('sensor.zwift_last_ride_avg_power_w') %}
          {{ s if s not in ['unknown','unavailable','0','0.0',''] else z }}
      - name: "Unified Last Ride Avg HR bpm"
        unit_of_measurement: "bpm"
        state: >
          {% set s = states('sensor.last_ride_avg_hr_bpm') %}
          {% set z = states('sensor.zwift_last_ride_avg_hr_bpm') %}
          {{ s if s not in ['unknown','unavailable','0','0.0',''] else z }}

###############################################################################
# Xert: Derived sensors
###############################################################################
  - sensor:
      - name: "Xert Training Status"
        state: "{{ state_attr('sensor.xert_training_info_raw','status') or 'Unknown' }}"
        icon: mdi:heart-pulse
      - name: "Xert FTP"
        unit_of_measurement: "W"
        state: "{{ (state_attr('sensor.xert_training_info_raw','signature') or {}).get('ftp', 0)|float(0)|round(0) }}"
      - name: "Xert LTP"
        unit_of_measurement: "W"
        state: "{{ (state_attr('sensor.xert_training_info_raw','signature') or {}).get('ltp', 0)|float(0)|round(0) }}"
      - name: "Xert Peak Power"
        unit_of_measurement: "W"
        state: "{{ (state_attr('sensor.xert_training_info_raw','signature') or {}).get('pp', 0)|float(0)|round(0) }}"
      - name: "Xert HIE"
        unit_of_measurement: "kJ"
        state: >
          {% set hie = (state_attr('sensor.xert_training_info_raw','signature') or {}).get('hie', 0)|float(0) %}
          {{ hie|round(2) }}
      - name: "Xert TL Low"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','tl') or {}).get('low', 0)|float(0)|round(1) }}"
      - name: "Xert TL High"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','tl') or {}).get('high', 0)|float(0)|round(1) }}"
      - name: "Xert TL Peak"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','tl') or {}).get('peak', 0)|float(0)|round(1) }}"
      - name: "Xert TL Total"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','tl') or {}).get('total', 0)|float(0)|round(1) }}"
      - name: "Xert Target XSS Total"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','targetXSS') or {}).get('total', 0)|float(0)|round(1) }}"
      - name: "Xert Target XSS Low"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','targetXSS') or {}).get('low', 0)|float(0)|round(1) }}"
      - name: "Xert Target XSS High"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','targetXSS') or {}).get('high', 0)|float(0)|round(1) }}"
      - name: "Xert Target XSS Peak"
        unit_of_measurement: "XSS"
        state: "{{ (state_attr('sensor.xert_training_info_raw','targetXSS') or {}).get('peak', 0)|float(0)|round(1) }}"

###############################################################################
# Xert: Lookback sensors
###############################################################################
  - sensor:
      - name: "Xert Lookback From Epoch"
        state: "{{ (now().timestamp()|int(0) - 90*24*3600) }}"  # 90 days
      - name: "Xert Lookback To Epoch"
        state: "{{ now().timestamp()|int(0) }}"
      - name: "Xert Progression Max Acts"
        state: 50  # how many activities to graph (recent N)

  - sensor:
      # ---- POWER (W) ----
      - name: "Xert Last Avg Power W"
        unit_of_measurement: "W"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('avg_power') %}
          {{ (x if x is number else states('sensor.xert_last_avg_power_w')|float(0))|round(0) }}
      - name: "Xert Last Max Power W"
        unit_of_measurement: "W"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('max_power') %}
          {{ (x if x is number else states('sensor.xert_last_max_power_w')|float(0))|round(0) }}
      - name: "Xert Last Power Remainder W"
        unit_of_measurement: "W"
        state: >
          {% set mx = states('sensor.xert_last_max_power_w')|float(0) %}
          {% set av = states('sensor.xert_last_avg_power_w')|float(0) %}
          {{ (mx-av if mx>av else 0)|round(0) }}

      # ---- SPEED (mph) ----
      - name: "Xert Last Avg Speed mph"
        unit_of_measurement: "mph"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('avg_speed') %}
          {{ (x if x is number else states('sensor.xert_last_avg_speed_mph')|float(0))|round(0) }}
      - name: "Xert Last Max Speed mph"
        unit_of_measurement: "mph"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('max_speed') %}
          {{ (x if x is number else states('sensor.xert_last_max_speed_mph')|float(0))|round(0) }}
      - name: "Xert Last Speed Remainder mph"
        unit_of_measurement: "mph"
        state: >
          {% set mx = states('sensor.xert_last_max_speed_mph')|float(0) %}
          {% set av = states('sensor.xert_last_avg_speed_mph')|float(0) %}
          {{ (mx-av if mx>av else 0)|round(1) }}

      # ---- CADENCE (rpm) ----
      - name: "Xert Last Avg Cadence rpm"
        unit_of_measurement: "rpm"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('avg_cadence') %}
          {{ (x if x is number else states('sensor.xert_last_avg_cadence_rpm')|float(0))|round(0) }}
      - name: "Xert Last Max Cadence rpm"
        unit_of_measurement: "rpm"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('max_cadence') %}
          {{ (x if x is number else states('sensor.xert_last_max_cadence_rpm')|float(0))|round(0) }}
      - name: "Xert Last Cadence Remainder rpm"
        unit_of_measurement: "rpm"
        state: >
          {% set mx = states('sensor.xert_last_max_cadence_rpm')|float(0) %}
          {% set av = states('sensor.xert_last_avg_cadence_rpm')|float(0) %}
          {{ (mx-av if mx>av else 0)|round(0) }}

      # ---- HEART RATE (bpm) ----
      - name: "Xert Last Avg HR bpm"
        unit_of_measurement: "bpm"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('avg_heart_rate') %}
          {{ (x if x is number else states('sensor.xert_last_avg_hr_bpm')|float(0))|round(0) }}
      - name: "Xert Last Max HR bpm"
        unit_of_measurement: "bpm"
        state: >
          {# Prefer Xert activity detail if present, else fallback to avg #}
          {% set sum = state_attr('sensor.xert_activity_0_detail_raw','summary') or {} %}
          {% set x = sum.get('session',{}).get('max_heart_rate') %}
          {{ (x if x is number else states('sensor.xert_last_max_hr_bpm')|float(0))|round(0) }}
      - name: "Xert Last HR Remainder bpm"
        unit_of_measurement: "bpm"
        state: >
          {% set mx = states('sensor.xert_last_max_hr_bpm')|float(0) %}
          {% set av = states('sensor.xert_last_avg_hr_bpm')|float(0) %}
          {{ (mx-av if mx>av else 0)|round(0) }}

###############################################################################
# Automations: bootstrap, store tokens, proactive refresh, self heal
###############################################################################
automation:
  - id: zwift_accumulate_minutes_on_ride_end
    alias: "Zwift: accumulate minutes on ride end"
    trigger:
      - platform: state
        entity_id: binary_sensor.zwift_active
        from: "on"
        to: "off"
    variables:
      minutes: "{{ states('sensor.last_ride_elapsed_time_min')|float(0) }}"
    action:
      - service: input_number.set_value
        target:
          entity_id: input_number.zwift_ride_minutes_total
        data:
          value: >
            {{ (states('input_number.zwift_ride_minutes_total')|float(0) + minutes)|float(0)|round(1) }}

  - id: xert_bootstrap_token
    alias: "Xert: bootstrap token on startup"
    trigger:
      platform: homeassistant
      event: start
    mode: restart
    action:
      - delay: "00:00:05"
      - service: rest_command.xert_token_fetch
        response_variable: xert_init
      - variables:
          acc: "{{ (xert_init.get('content') or {}).get('access_token','') }}"
          ref: "{{ (xert_init.get('content') or {}).get('refresh_token','') }}"
          exp: "{{ (xert_init.get('content') or {}).get('expires_in', 0)|int(0) }}"
          crt: "{{ (xert_init.get('content') or {}).get('created_at', now().timestamp()|int(0))|int(0) }}"
          exp_epoch: "{{ crt + exp }}"
      - choose:
          - conditions: "{{ acc|length > 0 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_access_token
                data:
                  value: "{{ acc }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_refresh_token
                data:
                  value: "{{ ref }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.xert_token_expires_epoch
                data:
                  value: "{{ exp_epoch - 300 }}"   # refresh 5 min early
              - service: homeassistant.update_entity
                target:
                  entity_id:
                    - sensor.xert_training_info_raw
                    - sensor.xert_activity_list_raw
              - wait_template: >-
                  {{ (state_attr('sensor.xert_activity_list_raw','activities') or []) | length > 0 }}
                timeout: "00:01:00"
                continue_on_timeout: true
              - service: homeassistant.update_entity
                target:
                  entity_id: >-
                    {# Build the list from entities that actually exist #}
                    {% set out = [] %}
                    {% for s in states.sensor
                        if s.entity_id.startswith('sensor.xert_activity_')
                        and s.entity_id.endswith('_detail_raw') %}
                      {% set out = out + [s.entity_id] %}
                    {% endfor %}
                    {{ out }}

  - id: xert_refresh_daemon
    alias: "Xert: refresh token proactively"
    trigger:
      - platform: time_pattern
        minutes: "/10"
    variables:
      now_epoch: "{{ now().timestamp()|int(0) }}"
      exp_epoch: "{{ states('input_number.xert_token_expires_epoch')|int(0) }}"
    condition: "{{ exp_epoch > 0 and now_epoch >= exp_epoch }}"
    action:
      - service: rest_command.xert_token_refresh
        response_variable: xert_ref
      - variables:
          acc: "{{ (xert_ref.get('content') or {}).get('access_token','') }}"
          ref: "{{ (xert_ref.get('content') or {}).get('refresh_token','') }}"
          exp: "{{ (xert_ref.get('content') or {}).get('expires_in', 0)|int(0) }}"
          crt: "{{ (xert_ref.get('content') or {}).get('created_at', now().timestamp()|int(0))|int(0) }}"
          exp_epoch: "{{ crt + exp }}"
      - choose:
          - conditions: "{{ acc|length > 0 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_access_token
                data:
                  value: "{{ acc }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_refresh_token
                data:
                  value: "{{ ref }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.xert_token_expires_epoch
                data:
                  value: "{{ exp_epoch - 300 }}"   # refresh 5 min early
              - service: homeassistant.update_entity
                target:
                  entity_id:
                    - sensor.xert_training_info_raw
                    - sensor.xert_activity_list_raw
              - wait_template: >
                  {{ (state_attr('sensor.xert_activity_list_raw','activities') or []) | length > 0 }}
                timeout: "00:01:00"
                continue_on_timeout: true
              - service: homeassistant.update_entity
                target:
                  entity_id: >-
                    {# Build the list from entities that actually exist #}
                    {% set out = [] %}
                    {% for s in states.sensor
                        if s.entity_id.startswith('sensor.xert_activity_')
                        and s.entity_id.endswith('_detail_raw') %}
                      {% set out = out + [s.entity_id] %}
                    {% endfor %}
                    {{ out }}

  - id: xert_self_heal_on_failure
    alias: "Xert: self-heal when training_info fails"
    trigger:
      - platform: state
        entity_id: sensor.xert_training_info_raw
        to: "False"
        for: "00:00:10"
    action:
      - service: rest_command.xert_token_refresh
        response_variable: xert_ref2
      - variables:
          acc: "{{ (xert_ref2.get('content') or {}).get('access_token','') }}"
          ref: "{{ (xert_ref2.get('content') or {}).get('refresh_token','') }}"
          exp: "{{ (xert_ref2.get('content') or {}).get('expires_in', 0)|int(0) }}"
          crt: "{{ (xert_ref2.get('content') or {}).get('created_at', now().timestamp()|int(0))|int(0) }}"
          exp_epoch: "{{ crt + exp }}"
      - choose:
          - conditions: "{{ acc|length > 0 }}"
            sequence:
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_access_token
                data:
                  value: "{{ acc }}"
              - service: input_text.set_value
                target:
                  entity_id: input_text.xert_refresh_token
                data:
                  value: "{{ ref }}"
              - service: input_number.set_value
                target:
                  entity_id: input_number.xert_token_expires_epoch
                data:
                  value: "{{ exp_epoch - 300 }}"   # refresh 5 min early
      - delay: "00:00:05"
      - service: homeassistant.update_entity
        target:
          entity_id:
            - sensor.xert_training_info_raw
            - sensor.xert_activity_list_raw
      - wait_template: >-
          {{ (state_attr('sensor.xert_activity_list_raw','activities') or []) | length > 0 }}
        timeout: "00:01:00"
        continue_on_timeout: true
      - service: homeassistant.update_entity
        target:
          entity_id: >-
            {# Build the list from entities that actually exist #}
            {% set out = [] %}
            {% for s in states.sensor
                 if s.entity_id.startswith('sensor.xert_activity_')
                 and s.entity_id.endswith('_detail_raw') %}
              {% set out = out + [s.entity_id] %}
            {% endfor %}
            {{ out }}

  - id: xert_hourly_data_pull
    alias: "Xert: hourly data update"
    trigger:
      - platform: time_pattern
        minutes: "/15"
    condition:
      - condition: template
        value_template: "{{ states('input_text.xert_access_token') | length > 0 }}"
    action:
      - service: homeassistant.update_entity
        target:
          entity_id:
            - sensor.xert_training_info_raw
            - sensor.xert_activity_list_raw
      - delay: "00:00:15"
      - service: homeassistant.update_entity
        target:
          entity_id: >-
            {# Build the list from entities that actually exist #}
            {% set out = [] %}
            {% for s in states.sensor
                 if s.entity_id.startswith('sensor.xert_activity_')
                 and s.entity_id.endswith('_detail_raw') %}
              {% set out = out + [s.entity_id] %}
            {% endfor %}
            {{ out }}
