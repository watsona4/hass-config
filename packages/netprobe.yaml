# ============================ Netprobe ingest ============================
# Assumes your script publishes the JSON you pasted to these topics:
#   netprobe/home   and   netprobe/rv
# Edit the topics if yours differ.

mqtt:
  sensor:
    # ---------------- Home raw payload holder ----------------
    - name: Netprobe Home Raw
      unique_id: netprobe_home_raw
      state_topic: site/home/devices/netprobe
      value_template: "{{ value_json.timestamp }}"
      json_attributes_topic: site/home/devices/netprobe
      json_attributes_template: "{{ value_json | tojson }}"
      icon: mdi:lan
      expire_after: 2400
      device:
        identifiers: ["netprobe_home_device"]
        name: Netprobe Home WAN
        manufacturer: Netprobe
        model: iperf3 bash client
        sw_version: "1.0"

    # ---------------- RV raw payload holder ----------------
    - name: Netprobe RV Raw
      unique_id: netprobe_rv_raw
      state_topic: site/rv/devices/netprobe
      value_template: "{{ value_json.timestamp }}"
      json_attributes_topic: site/rv/devices/netprobe
      json_attributes_template: "{{ value_json | tojson }}"
      icon: mdi:van-utility
      expire_after: 4200
      device:
        identifiers: ["netprobe_rv_device"]
        name: Netprobe RV WAN
        manufacturer: Netprobe
        model: iperf3 bash client
        sw_version: "1.0"

# Optional: link capacity knobs for utilization math
input_number:
  home_down_capacity_mbps:
    name: Home Down Capacity
    min: 1
    max: 10000
    step: 1
    initial: 1000
    unit_of_measurement: Mbps
    icon: mdi:download
  home_up_capacity_mbps:
    name: Home Up Capacity
    min: 1
    max: 10000
    step: 1
    initial: 50
    unit_of_measurement: Mbps
    icon: mdi:upload
  rv_down_capacity_mbps:
    name: RV Down Capacity
    min: 1
    max: 10000
    step: 1
    initial: 25
    unit_of_measurement: Mbps
    icon: mdi:download
  rv_up_capacity_mbps:
    name: RV Up Capacity
    min: 1
    max: 10000
    step: 1
    initial: 25
    unit_of_measurement: Mbps
    icon: mdi:upload

# ============================ Template sensors ===========================
template:
  - sensor:
      # ---------------- Derived helper macros as inline Jinja ----------------
      # None needed here; we keep templates simple and direct.

      # ============================ HOME ============================
      - name: Home Download Rate
        unique_id: home_download_rate
        unit_of_measurement: "Mbps"
        device_class: data_rate
        state_class: measurement
        icon: mdi:download
        state: "{{ state_attr('sensor.netprobe_home_raw','download_mbps') | float(0) }}"

      - name: Home Upload Rate
        unique_id: home_upload_rate
        unit_of_measurement: "Mbps"
        device_class: data_rate
        state_class: measurement
        icon: mdi:upload
        state: "{{ state_attr('sensor.netprobe_home_raw','upload_mbps') | float(0) }}"

      - name: Home Latency P50
        unique_id: home_latency_p50
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:timer-sand
        state: "{{ state_attr('sensor.netprobe_home_raw','latency_p50_ms') | float(0) }}"

      - name: Home Latency TCP
        unique_id: home_latency_tcp
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:lan-pending
        state: "{{ state_attr('sensor.netprobe_home_raw','latency_tcp_ms') | float(0) }}"

      - name: Home Latency ICMP
        unique_id: home_latency_icmp
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:lan-pending
        state: "{{ state_attr('sensor.netprobe_home_raw','latency_icmp_ms') | float(0) }}"

      - name: Home TCP-ICMP Latency Delta
        unique_id: home_latency_tcp_icmp_delta
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:arrow-expand-vertical
        state: >-
          {% set t = state_attr('sensor.netprobe_home_raw','latency_tcp_ms') | float('nan') %}
          {% set i = state_attr('sensor.netprobe_home_raw','latency_icmp_ms') | float('nan') %}
          {{ (t - i) if t == t and i == i else None }}

      - name: Home Jitter UL
        unique_id: home_jitter_ul
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:waves-arrow-right
        state: "{{ state_attr('sensor.netprobe_home_raw','jitter_ul_ms') | float(0) }}"

      - name: Home Jitter DL
        unique_id: home_jitter_dl
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:waves-arrow-left
        state: "{{ state_attr('sensor.netprobe_home_raw','jitter_dl_ms') | float(0) }}"

      - name: Home Jitter Max
        unique_id: home_jitter_max
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:waves
        state: >-
          {% set u = state_attr('sensor.netprobe_home_raw','jitter_ul_ms') | float('nan') %}
          {% set d = state_attr('sensor.netprobe_home_raw','jitter_dl_ms') | float('nan') %}
          {% if u == u and d == d %}{{ [u, d] | max }}
          {% elif u == u %}{{ u }}
          {% elif d == d %}{{ d }}
          {% else %}{{ None }}{% endif %}

      - name: Home Packet Loss UL
        unique_id: home_loss_ul_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:arrow-up-bold-box
        state: "{{ state_attr('sensor.netprobe_home_raw','loss_ul_percent') | float(0) }}"

      - name: Home Packet Loss DL
        unique_id: home_loss_dl_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:arrow-down-bold-box
        state: "{{ state_attr('sensor.netprobe_home_raw','loss_dl_percent') | float(0) }}"

      - name: Home Packets UL
        unique_id: home_packets_ul
        unit_of_measurement: "packets"
        state_class: measurement
        icon: mdi:arrow-up-bold-box
        state: "{{ state_attr('sensor.netprobe_home_raw','packets_ul') | int(0) }}"

      - name: Home Packets DL
        unique_id: home_packets_dl
        unit_of_measurement: "packets"
        state_class: measurement
        icon: mdi:arrow-down-bold-box
        state: "{{ state_attr('sensor.netprobe_home_raw','packets_dl') | int(0) }}"

      - name: Home Packet Loss Combined
        unique_id: home_loss_combined_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:package-variant-closed-remove
        state: >-
          {% set lul = state_attr('sensor.netprobe_home_raw','loss_ul_packets') | int(0) %}
          {% set ldl = state_attr('sensor.netprobe_home_raw','loss_dl_packets') | int(0) %}
          {% set pul = state_attr('sensor.netprobe_home_raw','packets_ul') | int(0) %}
          {% set pdl = state_attr('sensor.netprobe_home_raw','packets_dl') | int(0) %}
          {% set tot = pul + pdl %}
          {% if tot > 0 %}
            {{ 100 * (lul + ldl) / tot }}
          {% else %}
            {% set a = state_attr('sensor.netprobe_home_raw','loss_ul_percent') | float('nan') %}
            {% set b = state_attr('sensor.netprobe_home_raw','loss_dl_percent') | float('nan') %}
            {% if a == a and b == b %}{{ (a + b) / 2 }}
            {% elif a == a %}{{ a }}
            {% elif b == b %}{{ b }}
            {% else %}{{ None }}{% endif %}
          {% endif %}

      - name: Home Ping Success Rate
        unique_id: home_ping_success_rate_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:check-network
        state: >-
          {% set loss = states('sensor.home_packet_loss_combined') | float('nan') %}
          {% if loss == loss %}{{ [100 - loss, 0] | max }}
          {% else %}{{ None }}{% endif %}

      - name: Home Download Utilization
        unique_id: home_download_utilization_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:download-network
        state: >-
          {% set r = states('sensor.home_download_rate') | float(0) %}
          {% set c = states('input_number.home_down_capacity_mbps') | float(0) %}
          {{ 100 * r / c if c > 0 else None }}

      - name: Home Upload Utilization
        unique_id: home_upload_utilization_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:upload-network
        state: >-
          {% set r = states('sensor.home_upload_rate') | float(0) %}
          {% set c = states('input_number.home_up_capacity_mbps') | float(0) %}
          {{ 100 * r / c if c > 0 else None }}

      - name: Home Link Saturation
        unique_id: home_link_saturation_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:swap-vertical-bold
        state: >-
          {% set d = states('sensor.home_download_utilization') | float('nan') %}
          {% set u = states('sensor.home_upload_utilization') | float('nan') %}
          {% if d == d and u == u %}{{ [d, u] | max }}
          {% elif d == d %}{{ d }}
          {% elif u == u %}{{ u }}
          {% else %}{{ None }}{% endif %}

      - name: Home UDP Bitrate Target
        unique_id: home_udp_bitrate_target_mbps
        unit_of_measurement: "Mbps"
        device_class: data_rate
        state_class: measurement
        icon: mdi:sine-wave
        state: >-
          {% set s = state_attr('sensor.netprobe_home_raw','schedule') %}
          {% set raw = s.udp_bitrate if s is mapping else None %}
          {% if raw %}
            {% set m = raw | string %}
            {% if m.endswith('M') %}{{ (m[:-1] | float(0)) }}
            {% elif m.endswith('K') %}{{ (m[:-1] | float(0)) / 1000 }}
            {% elif m.endswith('G') %}{{ (m[:-1] | float(0)) * 1000 }}
            {% else %}{{ (m | float(0)) / 1_000_000 }}{% endif %}
          {% else %}{{ None }}{% endif %}

      - name: Home Hiccup
        unique_id: home_hiccup
        icon: mdi:alert
        state: >-
          {% set v = state_attr('sensor.netprobe_home_raw','hiccup') %}
          {% if v in [True, 'true', 'True'] %}on{% else %}off{% endif %}

      - name: Home Hiccup Reason
        unique_id: home_hiccup_reason
        icon: mdi:alert-circle
        state: "{{ state_attr('sensor.netprobe_home_raw','hiccup_reason') }}"

      - name: Home Speedtest Error Code
        unique_id: home_speedtest_error
        icon: mdi:alert-decagram
        state: "{{ state_attr('sensor.netprobe_home_raw','error') }}"

      - name: Home Download Mode
        unique_id: home_dl_mode
        icon: mdi:calendar-clock
        state: >-
          {% set s = state_attr('sensor.netprobe_home_raw','schedule') %}
          {{ s.dl_mode if s is mapping else None }}

      - name: Home Upload Mode
        unique_id: home_ul_mode
        icon: mdi:calendar-clock
        state: >-
          {% set s = state_attr('sensor.netprobe_home_raw','schedule') %}
          {{ s.ul_mode if s is mapping else None }}

      # ============================ RV ============================
      - name: RV Download Rate
        unique_id: rv_download_rate
        unit_of_measurement: "Mbps"
        device_class: data_rate
        state_class: measurement
        icon: mdi:download
        state: "{{ state_attr('sensor.netprobe_rv_raw','download_mbps') | float(0) }}"

      - name: RV Upload Rate
        unique_id: rv_upload_rate
        unit_of_measurement: "Mbps"
        device_class: data_rate
        state_class: measurement
        icon: mdi:upload
        state: "{{ state_attr('sensor.netprobe_rv_raw','upload_mbps') | float(0) }}"

      - name: RV Latency P50
        unique_id: rv_latency_p50
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:timer-sand
        state: "{{ state_attr('sensor.netprobe_rv_raw','latency_p50_ms') | float(0) }}"

      - name: RV Latency TCP
        unique_id: rv_latency_tcp
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:lan-pending
        state: "{{ state_attr('sensor.netprobe_rv_raw','latency_tcp_ms') | float(0) }}"

      - name: RV Latency ICMP
        unique_id: rv_latency_icmp
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:lan-pending
        state: "{{ state_attr('sensor.netprobe_rv_raw','latency_icmp_ms') | float(0) }}"

      - name: RV TCP-ICMP Latency Delta
        unique_id: rv_latency_tcp_icmp_delta
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:arrow-expand-vertical
        state: >-
          {% set t = state_attr('sensor.netprobe_rv_raw','latency_tcp_ms') | float('nan') %}
          {% set i = state_attr('sensor.netprobe_rv_raw','latency_icmp_ms') | float('nan') %}
          {{ (t - i) if t == t and i == i else None }}

      - name: RV Jitter UL
        unique_id: rv_jitter_ul
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:waves-arrow-right
        state: "{{ state_attr('sensor.netprobe_rv_raw','jitter_ul_ms') | float(0) }}"

      - name: RV Jitter DL
        unique_id: rv_jitter_dl
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:waves-arrow-left
        state: "{{ state_attr('sensor.netprobe_rv_raw','jitter_dl_ms') | float(0) }}"

      - name: RV Jitter Max
        unique_id: rv_jitter_max
        unit_of_measurement: "ms"
        device_class: duration
        state_class: measurement
        icon: mdi:waves
        state: >-
          {% set u = state_attr('sensor.netprobe_rv_raw','jitter_ul_ms') | float('nan') %}
          {% set d = state_attr('sensor.netprobe_rv_raw','jitter_dl_ms') | float('nan') %}
          {% if u == u and d == d %}{{ [u, d] | max }}
          {% elif u == u %}{{ u }}
          {% elif d == d %}{{ d }}
          {% else %}{{ None }}{% endif %}

      - name: RV Packet Loss UL
        unique_id: rv_loss_ul_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:arrow-up-bold-box
        state: "{{ state_attr('sensor.netprobe_rv_raw','loss_ul_percent') | float(0) }}"

      - name: RV Packet Loss DL
        unique_id: rv_loss_dl_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:arrow-down-bold-box
        state: "{{ state_attr('sensor.netprobe_rv_raw','loss_dl_percent') | float(0) }}"

      - name: RV Packets UL
        unique_id: rv_packets_ul
        unit_of_measurement: "packets"
        state_class: measurement
        icon: mdi:arrow-up-bold-box
        state: "{{ state_attr('sensor.netprobe_rv_raw','packets_ul') | int(0) }}"

      - name: RV Packets DL
        unique_id: rv_packets_dl
        unit_of_measurement: "packets"
        state_class: measurement
        icon: mdi:arrow-down-bold-box
        state: "{{ state_attr('sensor.netprobe_rv_raw','packets_dl') | int(0) }}"

      - name: RV Packet Loss Combined
        unique_id: rv_loss_combined_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:package-variant-closed-remove
        state: >-
          {% set lul = state_attr('sensor.netprobe_rv_raw','loss_ul_packets') | int(0) %}
          {% set ldl = state_attr('sensor.netprobe_rv_raw','loss_dl_packets') | int(0) %}
          {% set pul = state_attr('sensor.netprobe_rv_raw','packets_ul') | int(0) %}
          {% set pdl = state_attr('sensor.netprobe_rv_raw','packets_dl') | int(0) %}
          {% set tot = pul + pdl %}
          {% if tot > 0 %}
            {{ 100 * (lul + ldl) / tot }}
          {% else %}
            {% set a = state_attr('sensor.netprobe_rv_raw','loss_ul_percent') | float('nan') %}
            {% set b = state_attr('sensor.netprobe_rv_raw','loss_dl_percent') | float('nan') %}
            {% if a == a and b == b %}{{ (a + b) / 2 }}
            {% elif a == a %}{{ a }}
            {% elif b == b %}{{ b }}
            {% else %}{{ None }}{% endif %}
          {% endif %}

      - name: RV Ping Success Rate
        unique_id: rv_ping_success_rate_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:check-network-outline
        state: >-
          {% set loss = states('sensor.rv_packet_loss_combined') | float('nan') %}
          {% if loss == loss %}{{ [100 - loss, 0] | max }}
          {% else %}{{ None }}{% endif %}

      - name: RV Download Utilization
        unique_id: rv_download_utilization_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:download-network-outline
        state: >-
          {% set r = states('sensor.rv_download_rate') | float(0) %}
          {% set c = states('input_number.rv_down_capacity_mbps') | float(0) %}
          {{ 100 * r / c if c > 0 else None }}

      - name: RV Upload Utilization
        unique_id: rv_upload_utilization_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:upload-network-outline
        state: >-
          {% set r = states('sensor.rv_upload_rate') | float(0) %}
          {% set c = states('input_number.rv_up_capacity_mbps') | float(0) %}
          {{ 100 * r / c if c > 0 else None }}

      - name: RV Link Saturation
        unique_id: rv_link_saturation_pct
        unit_of_measurement: "%"
        state_class: measurement
        icon: mdi:swap-vertical
        state: >-
          {% set d = states('sensor.rv_download_utilization') | float('nan') %}
          {% set u = states('sensor.rv_upload_utilization') | float('nan') %}
          {% if d == d and u == u %}{{ [d, u] | max }}
          {% elif d == d %}{{ d }}
          {% elif u == u %}{{ u }}
          {% else %}{{ None }}{% endif %}

      - name: RV UDP Bitrate Target
        unique_id: rv_udp_bitrate_target_mbps
        unit_of_measurement: "Mbps"
        device_class: data_rate
        state_class: measurement
        icon: mdi:sine-wave
        state: >-
          {% set s = state_attr('sensor.netprobe_rv_raw','schedule') %}
          {% set raw = s.udp_bitrate if s is mapping else None %}
          {% if raw %}
            {% set m = raw | string %}
            {% if m.endswith('M') %}{{ (m[:-1] | float(0)) }}
            {% elif m.endswith('K') %}{{ (m[:-1] | float(0)) / 1000 }}
            {% elif m.endswith('G') %}{{ (m[:-1] | float(0)) * 1000 }}
            {% else %}{{ (m | float(0)) / 1_000_000 }}{% endif %}
          {% else %}{{ None }}{% endif %}

      - name: RV Hiccup
        unique_id: rv_hiccup
        icon: mdi:alert
        state: >-
          {% set v = state_attr('sensor.netprobe_rv_raw','hiccup') %}
          {% if v in [True, 'true', 'True'] %}on{% else %}off{% endif %}

      - name: RV Hiccup Reason
        unique_id: rv_hiccup_reason
        icon: mdi:alert-circle
        state: "{{ state_attr('sensor.netprobe_rv_raw','hiccup_reason') }}"

      - name: RV Speedtest Error Code
        unique_id: rv_speedtest_error
        icon: mdi:alert-decagram
        state: "{{ state_attr('sensor.netprobe_rv_raw','error') }}"

      - name: RV Download Mode
        unique_id: rv_dl_mode
        icon: mdi:calendar-clock
        state: >-
          {% set s = state_attr('sensor.netprobe_rv_raw','schedule') %}
          {{ s.dl_mode if s is mapping else None }}

      - name: RV Upload Mode
        unique_id: rv_ul_mode
        icon: mdi:calendar-clock
        state: >-
          {% set s = state_attr('sensor.netprobe_rv_raw','schedule') %}
          {{ s.ul_mode if s is mapping else None }}
