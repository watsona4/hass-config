# =====================================================================
# Google Pollen â€“ REST sensors + derived template sensors (Nearby/Home/RV)
# Shared macros: env/pollen_core.jinja
# =====================================================================

# ---------- REST sensors ----------
sensor:
  # Nearby
  - platform: rest
    name: Google Pollen Nearby
    unique_id: google_pollen_nearby
    scan_interval: 600
    timeout: 8
    resource_template: >-
      {%- from 'macros/rest_helpers.jinja' import nearby_is_valid -%}
      {{- 'https://pollen.googleapis.com/v1/forecast:lookup' if (nearby_is_valid() | bool) else 'http://127.0.0.1:65535/' -}}
    method: GET
    params:
      location.latitude: >-
        {%- from 'macros/rest_helpers.jinja' import nearby_lat -%}
        {{- nearby_lat() -}}
      location.longitude: >-
        {%- from 'macros/rest_helpers.jinja' import nearby_lon -%}
        {{- nearby_lon() -}}
      days: 5
      languageCode: en
      key: !secret google_pollen_api_key
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache
    availability: >-
      {%- from 'macros/rest_helpers.jinja' import nearby_is_valid -%}
      {{- nearby_is_valid() | bool -}}
    value_template: >-
      {%- if value_json is mapping and value_json.error is not defined -%}
        {%- set di = value_json.get('dailyInfo') or [] -%}
        {{- states(this.entity_id) if (di | count) == 0 else now().isoformat() -}}
      {%- else -%}
        {{- states(this.entity_id) -}}
      {%- endif -%}
    json_attributes:
      - dailyInfo
      - plantInfo

  # Home
  - platform: rest
    name: Google Pollen Home
    unique_id: google_pollen_home
    scan_interval: 600
    timeout: 8
    resource_template: >-
      {%- from 'macros/rest_helpers.jinja' import home_is_valid -%}
      {{- 'https://pollen.googleapis.com/v1/forecast:lookup' if (home_is_valid() | bool) else 'http://127.0.0.1:65535/' -}}
    method: GET
    params:
      location.latitude: >-
        {%- from 'macros/rest_helpers.jinja' import home_lat -%}
        {{- home_lat() -}}
      location.longitude: >-
        {%- from 'macros/rest_helpers.jinja' import home_lon -%}
        {{- home_lon() -}}
      days: 5
      languageCode: en
      key: !secret google_pollen_api_key
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache
    availability: >-
      {%- from 'macros/rest_helpers.jinja' import home_is_valid -%}
      {{- home_is_valid() | bool -}}
    value_template: >-
      {%- if value_json is mapping and value_json.error is not defined -%}
        {%- set di = value_json.get('dailyInfo') or [] -%}
        {{- states(this.entity_id) if (di | count) == 0 else now().isoformat() -}}
      {%- else -%}
        {{- states(this.entity_id) -}}
      {%- endif -%}
    json_attributes:
      - dailyInfo
      - plantInfo

  # RV
  - platform: rest
    name: Google Pollen RV
    unique_id: google_pollen_rv
    scan_interval: 600
    timeout: 8
    resource_template: >-
      {%- from 'macros/rest_helpers.jinja' import rv_is_valid -%}
      {{- 'https://pollen.googleapis.com/v1/forecast:lookup' if (rv_is_valid() | bool) else 'http://127.0.0.1:65535/' -}}
    method: GET
    params:
      location.latitude: >-
        {%- from 'macros/rest_helpers.jinja' import rv_lat -%}
        {{- rv_lat() -}}
      location.longitude: >-
        {%- from 'macros/rest_helpers.jinja' import rv_lon -%}
        {{- rv_lon() -}}
      days: 5
      languageCode: en
      key: !secret google_pollen_api_key
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache
    availability: >-
      {%- from 'macros/rest_helpers.jinja' import rv_is_valid -%}
      {{- rv_is_valid() | bool -}}
    value_template: >-
      {%- if value_json is mapping and value_json.error is not defined -%}
        {%- set di = value_json.get('dailyInfo') or [] -%}
        {{- states(this.entity_id) if (di | count) == 0 else now().isoformat() -}}
      {%- else -%}
        {{- states(this.entity_id) -}}
      {%- endif -%}
    json_attributes:
      - dailyInfo
      - plantInfo

# ---------- Template sensors (shared structure, per location) ----------
template:

  # ================= NEARBY =================
  - trigger:
      - platform: state
        entity_id: sensor.google_pollen_nearby
    variables:
      src: sensor.google_pollen_nearby
      ctx: >-
        {%- from 'metrics/pollen/pollen.jinja' import build_ctx -%}
        {{- build_ctx(src) | from_json(default={}) -}}
      d0: >-
        {%- set di = ctx.di if ctx is mapping and 'di' in ctx else [] -%}
        {{ (di[0] if di is sequence and (di | count) > 0 else {}) }}
      types: >-
        {{ (d0.get('pollenTypeInfo') or []) }}
      ranked: >-
        {{ (types
            | selectattr('indexInfo','defined')
            | sort(attribute='indexInfo.value', reverse=true)
            | list) }}
      top: >-
        {{ (ranked[0] if ranked | count > 0 else {}) }}
    sensor:
      - name: Google Pollen Nearby Today
        unique_id: google_pollen_nearby_today
        icon: mdi:flower-pollen
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: >-
          {{- top.get('displayName') or top.get('code') or 'unknown' -}}
        attributes:
          date: >-
            {%- set dt = d0.get('date') or {} -%}
            {{- "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none -}}
          dominant_value: >-
            {{- (top.get('indexInfo') or {}).get('value') -}}
          dominant_category: >-
            {{- (top.get('indexInfo') or {}).get('category') or 'unknown' -}}
          dominant_hex: >-
            {%- set c = (top.get('indexInfo') or {}).get('color') or {} -%}
            {%- set r = (c.get('red') or 0) * 255 -%}
            {%- set g = (c.get('green') or 0) * 255 -%}
            {%- set b = (c.get('blue') or 0) * 255 -%}
            {{- '#%02X%02X%02X'|format(r|round(0)|int(0), g|round(0)|int(0), b|round(0)|int(0)) -}}
          grass_value: >-
            {%- set xlist = (types | selectattr('code','eq','GRASS') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (xlist|count>0) else none -}}
          tree_value: >-
            {%- set xlist = (types | selectattr('code','eq','TREE') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (xlist|count>0) else none -}}
          weed_value: >-
            {%- set xlist = (types | selectattr('code','eq','WEED') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (xlist|count>0) else none -}}
          recommendations: >-
            {%- if ranked | count > 0 -%}
              {{ (ranked[0].get('healthRecommendations') or []) | unique | list }}
            {%- else -%}
              {{ [] }}
            {%- endif -%}

      - name: Pollen Species Nearby Today
        unique_id: pollen_species_nearby_today
        icon: mdi:leaf
        availability: "{{- has_value(src) and ((ctx.plants | count) > 0) -}}"
        state: "{{- ctx.pick.name or 'unknown' -}}"
        attributes:
          code: "{{- ctx.pick.code -}}"
          type: "{{- ctx.pick.type -}}"
          in_season: "{{- ctx.pick.in_season -}}"
          category: "{{- ctx.pick.category or 'unknown' -}}"
          value: "{{- ctx.pick.value -}}"
          entity_picture: "{{- ctx.pick.picture or none -}}"

      - name: Pollen Forecast Nearby Day 0
        unique_id: pollen_forecast_nearby_day_0
        icon: mdi:calendar-today
        availability: >-
          {{ (ctx.days | count) > 0 and (ctx.days[0].get('exists') if (ctx.days | count) > 0 else false) }}
        state: >-
          {{ (ctx.days[0].get('state') if (ctx.days | count) > 0 else none) or 'unknown' }}
        attributes:
          date: "{{- (ctx.days[0].get('date') if (ctx.days | count) > 0 else none) -}}"
          dominant_type: "{{- (ctx.days[0].get('dominant_type') if (ctx.days | count) > 0 else none) -}}"
          dominant_value: "{{- (ctx.days[0].get('dominant_value') if (ctx.days | count) > 0 else none) -}}"
          dominant_category: "{{- (ctx.days[0].get('dominant_category') if (ctx.days | count) > 0 else none) -}}"
          dominant_hex: "{{- (ctx.days[0].get('dominant_hex') if (ctx.days | count) > 0 else none) -}}"
          species_name: "{{- (ctx.days[0].get('species_name') if (ctx.days | count) > 0 else none) -}}"
          species_value: "{{- (ctx.days[0].get('species_value') if (ctx.days | count) > 0 else none) -}}"
          species_category: "{{- (ctx.days[0].get('species_category') if (ctx.days | count) > 0 else none) -}}"
          species_type: "{{- (ctx.days[0].get('species_type') if (ctx.days | count) > 0 else none) -}}"
          species_picture: "{{- (ctx.days[0].get('species_picture') if (ctx.days | count) > 0 else none) -}}"

      - name: Pollen Forecast Nearby Day 1
        unique_id: pollen_forecast_nearby_day_1
        icon: mdi:calendar
        availability: >-
          {{ (ctx.days | count) > 1 and (ctx.days[1].get('exists') if (ctx.days | count) > 1 else false) }}
        state: >-
          {{ (ctx.days[1].get('state') if (ctx.days | count) > 1 else none) or 'unknown' }}
        attributes:
          date: "{{- (ctx.days[1].get('date') if (ctx.days | count) > 1 else none) -}}"
          dominant_type: "{{- (ctx.days[1].get('dominant_type') if (ctx.days | count) > 1 else none) -}}"
          dominant_value: "{{- (ctx.days[1].get('dominant_value') if (ctx.days | count) > 1 else none) -}}"
          dominant_category: "{{- (ctx.days[1].get('dominant_category') if (ctx.days | count) > 1 else none) -}}"
          dominant_hex: "{{- (ctx.days[1].get('dominant_hex') if (ctx.days | count) > 1 else none) -}}"
          species_name: "{{- (ctx.days[1].get('species_name') if (ctx.days | count) > 1 else none) -}}"
          species_value: "{{- (ctx.days[1].get('species_value') if (ctx.days | count) > 1 else none) -}}"
          species_category: "{{- (ctx.days[1].get('species_category') if (ctx.days | count) > 1 else none) -}}"
          species_type: "{{- (ctx.days[1].get('species_type') if (ctx.days | count) > 1 else none) -}}"
          species_picture: "{{- (ctx.days[1].get('species_picture') if (ctx.days | count) > 1 else none) -}}"

      - name: Pollen Forecast Nearby Day 2
        unique_id: pollen_forecast_nearby_day_2
        icon: mdi:calendar
        availability: >-
          {{ (ctx.days | count) > 2 and (ctx.days[2].get('exists') if (ctx.days | count) > 2 else false) }}
        state: >-
          {{ (ctx.days[2].get('state') if (ctx.days | count) > 2 else none) or 'unknown' }}
        attributes:
          date: "{{- (ctx.days[2].get('date') if (ctx.days | count) > 2 else none) -}}"
          dominant_type: "{{- (ctx.days[2].get('dominant_type') if (ctx.days | count) > 2 else none) -}}"
          dominant_value: "{{- (ctx.days[2].get('dominant_value') if (ctx.days | count) > 2 else none) -}}"
          dominant_category: "{{- (ctx.days[2].get('dominant_category') if (ctx.days | count) > 2 else none) -}}"
          dominant_hex: "{{- (ctx.days[2].get('dominant_hex') if (ctx.days | count) > 2 else none) -}}"
          species_name: "{{- (ctx.days[2].get('species_name') if (ctx.days | count) > 2 else none) -}}"
          species_value: "{{- (ctx.days[2].get('species_value') if (ctx.days | count) > 2 else none) -}}"
          species_category: "{{- (ctx.days[2].get('species_category') if (ctx.days | count) > 2 else none) -}}"
          species_type: "{{- (ctx.days[2].get('species_type') if (ctx.days | count) > 2 else none) -}}"
          species_picture: "{{- (ctx.days[2].get('species_picture') if (ctx.days | count) > 2 else none) -}}"

      - name: Pollen Species List Nearby Today
        unique_id: pollen_species_list_nearby_today
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: "{{- (ctx.di | count) > 0 -}}"
        attributes:
          species: >-
            {%- set plants = (ctx.d or {}).get('plantInfo') or [] -%}
            {%- set ns = namespace(out=[]) -%}
            {%- for p in plants -%}
              {%- set desc = p.get('plantDescription') or {} -%}
              {%- set item = {
                'code': p.get('code'),
                'name': p.get('displayName'),
                'type': desc.get('type'),
                'in_season': p.get('inSeason'),
                'value': ((p.get('indexInfo') or {}).get('value')),
                'category': ((p.get('indexInfo') or {}).get('category')),
                'picture': desc.get('picture') or desc.get('pictureCloseup')
              } -%}
              {%- set ns.out = ns.out + [item] -%}
            {%- endfor -%}
            {{- ns.out -}}

      - name: Pollen Peak Index Nearby Today
        unique_id: pollen_peak_index_nearby_today
        icon: mdi:meter-gas
        availability: "{{- has_value(src) and ((((ctx.d or {}).get('pollenTypeInfo') or []) | count) > 0) -}}"
        state: >-
          {%- set types = (ctx.d or {}).get('pollenTypeInfo') or [] -%}
          {%- set vals = (
                types
                | selectattr('indexInfo','defined')
                | selectattr('indexInfo.value','defined')
                | map(attribute='indexInfo.value')
                | list
            ) -%}
          {{ (vals|max) if (vals|count) > 0 else none }}

  # ================= HOME =================
  - trigger:
      - platform: state
        entity_id: sensor.google_pollen_home
    variables:
      src: sensor.google_pollen_home
      ctx: >-
        {%- from 'metrics/pollen/pollen.jinja' import build_ctx -%}
        {{- build_ctx(src) | from_json(default={}) -}}
      d0: >-
        {%- set di = ctx.di if ctx is mapping and 'di' in ctx else [] -%}
        {{ (di[0] if di is sequence and (di | count) > 0 else {}) }}
      types: >-
        {{ (d0.get('pollenTypeInfo') or []) }}
      ranked: >-
        {{ (types
            | selectattr('indexInfo','defined')
            | sort(attribute='indexInfo.value', reverse=true)
            | list) }}
      top: >-
        {{ (ranked[0] if ranked | count > 0 else {}) }}
    sensor:
      - name: Google Pollen Home Today
        unique_id: google_pollen_home_today
        icon: mdi:flower-pollen
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: >-
          {{- top.get('displayName') or top.get('code') or 'unknown' -}}
        attributes:
          date: >-
            {%- set dt = d0.get('date') or {} -%}
            {{- "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none -}}
          dominant_value: >-
            {{- (top.get('indexInfo') or {}).get('value') -}}
          dominant_category: >-
            {{- (top.get('indexInfo') or {}).get('category') or 'unknown' -}}
          dominant_hex: >-
            {%- set c = (top.get('indexInfo') or {}).get('color') or {} -%}
            {%- set r = (c.get('red') or 0) * 255 -%}
            {%- set g = (c.get('green') or 0) * 255 -%}
            {%- set b = (c.get('blue') or 0) * 255 -%}
            {{- '#%02X%02X%02X'|format(r|round(0)|int(0), g|round(0)|int(0), b|round(0)|int(0)) -}}
          grass_value: >-
            {%- set xlist = (types | selectattr('code','eq','GRASS') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (xlist|count>0) else none -}}
          tree_value: >-
            {%- set xlist = (types | selectattr('code','eq','TREE') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (xlist|count>0) else none -}}
          weed_value: >-
            {%- set xlist = (types | selectattr('code','eq','WEED') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (xlist|count>0) else none -}}
          recommendations: >-
            {%- if ranked | count > 0 -%}
              {{ (ranked[0].get('healthRecommendations') or []) | unique | list }}
            {%- else -%}
              {{ [] }}
            {%- endif -%}

      - name: Pollen Species Home Today
        unique_id: pollen_species_home_today
        icon: mdi:leaf
        availability: "{{- has_value(src) and ((ctx.plants | count) > 0) -}}"
        state: "{{- ctx.pick.name or 'unknown' -}}"
        attributes:
          code: "{{- ctx.pick.code -}}"
          type: "{{- ctx.pick.type -}}"
          in_season: "{{- ctx.pick.in_season -}}"
          category: "{{- ctx.pick.category or 'unknown' -}}"
          value: "{{- ctx.pick.value -}}"
          entity_picture: "{{- ctx.pick.picture or none -}}"

      - name: Pollen Forecast Home Day 0
        unique_id: pollen_forecast_home_day_0
        icon: mdi:calendar-today
        availability: >-
          {{ (ctx.days | count) > 0 and (ctx.days[0].get('exists') if (ctx.days | count) > 0 else false) }}
        state: >-
          {{ (ctx.days[0].get('state') if (ctx.days | count) > 0 else none) or 'unknown' }}
        attributes:
          date: "{{- (ctx.days[0].get('date') if (ctx.days | count) > 0 else none) -}}"
          dominant_type: "{{- (ctx.days[0].get('dominant_type') if (ctx.days | count) > 0 else none) -}}"
          dominant_value: "{{- (ctx.days[0].get('dominant_value') if (ctx.days | count) > 0 else none) -}}"
          dominant_category: "{{- (ctx.days[0].get('dominant_category') if (ctx.days | count) > 0 else none) -}}"
          dominant_hex: "{{- (ctx.days[0].get('dominant_hex') if (ctx.days | count) > 0 else none) -}}"
          species_name: "{{- (ctx.days[0].get('species_name') if (ctx.days | count) > 0 else none) -}}"
          species_value: "{{- (ctx.days[0].get('species_value') if (ctx.days | count) > 0 else none) -}}"
          species_category: "{{- (ctx.days[0].get('species_category') if (ctx.days | count) > 0 else none) -}}"
          species_type: "{{- (ctx.days[0].get('species_type') if (ctx.days | count) > 0 else none) -}}"
          species_picture: "{{- (ctx.days[0].get('species_picture') if (ctx.days | count) > 0 else none) -}}"

      - name: Pollen Forecast Home Day 1
        unique_id: pollen_forecast_home_day_1
        icon: mdi:calendar
        availability: >-
          {{ (ctx.days | count) > 1 and (ctx.days[1].get('exists') if (ctx.days | count) > 1 else false) }}
        state: >-
          {{ (ctx.days[1].get('state') if (ctx.days | count) > 1 else none) or 'unknown' }}
        attributes:
          date: "{{- (ctx.days[1].get('date') if (ctx.days | count) > 1 else none) -}}"
          dominant_type: "{{- (ctx.days[1].get('dominant_type') if (ctx.days | count) > 1 else none) -}}"
          dominant_value: "{{- (ctx.days[1].get('dominant_value') if (ctx.days | count) > 1 else none) -}}"
          dominant_category: "{{- (ctx.days[1].get('dominant_category') if (ctx.days | count) > 1 else none) -}}"
          dominant_hex: "{{- (ctx.days[1].get('dominant_hex') if (ctx.days | count) > 1 else none) -}}"
          species_name: "{{- (ctx.days[1].get('species_name') if (ctx.days | count) > 1 else none) -}}"
          species_value: "{{- (ctx.days[1].get('species_value') if (ctx.days | count) > 1 else none) -}}"
          species_category: "{{- (ctx.days[1].get('species_category') if (ctx.days | count) > 1 else none) -}}"
          species_type: "{{- (ctx.days[1].get('species_type') if (ctx.days | count) > 1 else none) -}}"
          species_picture: "{{- (ctx.days[1].get('species_picture') if (ctx.days | count) > 1 else none) -}}"

      - name: Pollen Forecast Home Day 2
        unique_id: pollen_forecast_home_day_2
        icon: mdi:calendar
        availability: >-
          {{ (ctx.days | count) > 2 and (ctx.days[2].get('exists') if (ctx.days | count) > 2 else false) }}
        state: >-
          {{ (ctx.days[2].get('state') if (ctx.days | count) > 2 else none) or 'unknown' }}
        attributes:
          date: "{{- (ctx.days[2].get('date') if (ctx.days | count) > 2 else none) -}}"
          dominant_type: "{{- (ctx.days[2].get('dominant_type') if (ctx.days | count) > 2 else none) -}}"
          dominant_value: "{{- (ctx.days[2].get('dominant_value') if (ctx.days | count) > 2 else none) -}}"
          dominant_category: "{{- (ctx.days[2].get('dominant_category') if (ctx.days | count) > 2 else none) -}}"
          dominant_hex: "{{- (ctx.days[2].get('dominant_hex') if (ctx.days | count) > 2 else none) -}}"
          species_name: "{{- (ctx.days[2].get('species_name') if (ctx.days | count) > 2 else none) -}}"
          species_value: "{{- (ctx.days[2].get('species_value') if (ctx.days | count) > 2 else none) -}}"
          species_category: "{{- (ctx.days[2].get('species_category') if (ctx.days | count) > 2 else none) -}}"
          species_type: "{{- (ctx.days[2].get('species_type') if (ctx.days | count) > 2 else none) -}}"
          species_picture: "{{- (ctx.days[2].get('species_picture') if (ctx.days | count) > 2 else none) -}}"

      - name: Pollen Species List Home Today
        unique_id: pollen_species_list_home_today
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: "{{- (ctx.di | count) > 0 -}}"
        attributes:
          species: >-
            {%- set plants = (ctx.d or {}).get('plantInfo') or [] -%}
            {%- set ns = namespace(out=[]) -%}
            {%- for p in plants -%}
              {%- set desc = p.get('plantDescription') or {} -%}
              {%- set item = {
                'code': p.get('code'),
                'name': p.get('displayName'),
                'type': desc.get('type'),
                'in_season': p.get('inSeason'),
                'value': ((p.get('indexInfo') or {}).get('value')),
                'category': ((p.get('indexInfo') or {}).get('category')),
                'picture': desc.get('picture') or desc.get('pictureCloseup')
              } -%}
              {%- set ns.out = ns.out + [item] -%}
            {%- endfor -%}
            {{- ns.out -}}

      - name: Pollen Peak Index Home Today
        unique_id: pollen_peak_index_home_today
        icon: mdi:meter-gas
        availability: "{{- has_value(src) and ((((ctx.d or {}).get('pollenTypeInfo') or []) | count) > 0) -}}"
        state: >-
          {%- set types = (ctx.d or {}).get('pollenTypeInfo') or [] -%}
          {%- set vals = (
                types
                | selectattr('indexInfo','defined')
                | selectattr('indexInfo.value','defined')
                | map(attribute='indexInfo.value')
                | list
            ) -%}
          {{ (vals|max) if (vals|count) > 0 else none }}

  # ================= RV =================
  - trigger:
      - platform: state
        entity_id: sensor.google_pollen_rv
    variables:
      src: sensor.google_pollen_rv
      ctx: >-
        {%- from 'metrics/pollen/pollen.jinja' import build_ctx -%}
        {{- build_ctx(src) | from_json(default={}) -}}
      d0: >-
        {%- set di = ctx.di if ctx is mapping and 'di' in ctx else [] -%}
        {{ (di[0] if di is sequence and (di | count) > 0 else {}) }}
      types: >-
        {{ (d0.get('pollenTypeInfo') or []) }}
      ranked: >-
        {{ (types
            | selectattr('indexInfo','defined')
            | sort(attribute='indexInfo.value', reverse=true)
            | list) }}
      top: >-
        {{ (ranked[0] if ranked | count > 0 else {}) }}
    sensor:
      - name: Google Pollen RV Today
        unique_id: google_pollen_rv_today
        icon: mdi:flower-pollen
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: >-
          {{- top.get('displayName') or top.get('code') or 'unknown' -}}
        attributes:
          date: >-
            {%- set dt = d0.get('date') or {} -%}
            {{- "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none -}}
          dominant_value: >-
            {{- (top.get('indexInfo') or {}).get('value') -}}
          dominant_category: >-
            {{- (top.get('indexInfo') or {}).get('category') or 'unknown' -}}
          dominant_hex: >-
            {%- set c = (top.get('indexInfo') or {}).get('color') or {} -%}
            {%- set r = (c.get('red') or 0) * 255 -%}
            {%- set g = (c.get('green') or 0) * 255 -%}
            {%- set b = (c.get('blue') or 0) * 255 -%}
            {{- '#%02X%02X%02X'|format(r|round(0)|int(0), g|round(0)|int(0), b|round(0)|int(0)) -}}
          grass_value: >-
            {%- set xlist = (types | selectattr('code','eq','GRASS') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (xlist|count>0) else none -}}
          tree_value: >-
            {%- set xlist = (types | selectattr('code','eq','TREE') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (xlist|count>0) else none -}}
          weed_value: >-
            {%- set xlist = (types | selectattr('code','eq','WEED') | list) -%}
            {{- ((xlist[0].get('indexInfo') or {}).get('value')) if (xlist|count>0) else none -}}
          recommendations: >-
            {%- if ranked | count > 0 -%}
              {{ (ranked[0].get('healthRecommendations') or []) | unique | list }}
            {%- else -%}
              {{ [] }}
            {%- endif -%}

      - name: Pollen Species RV Today
        unique_id: pollen_species_rv_today
        icon: mdi:leaf
        availability: "{{- has_value(src) and ((ctx.plants | count) > 0) -}}"
        state: "{{- ctx.pick.name or 'unknown' -}}"
        attributes:
          code: "{{- ctx.pick.code -}}"
          type: "{{- ctx.pick.type -}}"
          in_season: "{{- ctx.pick.in_season -}}"
          category: "{{- ctx.pick.category or 'unknown' -}}"
          value: "{{- ctx.pick.value -}}"
          entity_picture: "{{- ctx.pick.picture or none -}}"

      - name: Pollen Forecast RV Day 0
        unique_id: pollen_forecast_rv_day_0
        icon: mdi:calendar-today
        availability: >-
          {{ (ctx.days | count) > 0 and (ctx.days[0].get('exists') if (ctx.days | count) > 0 else false) }}
        state: >-
          {{ (ctx.days[0].get('state') if (ctx.days | count) > 0 else none) or 'unknown' }}
        attributes:
          date: "{{- (ctx.days[0].get('date') if (ctx.days | count) > 0 else none) -}}"
          dominant_type: "{{- (ctx.days[0].get('dominant_type') if (ctx.days | count) > 0 else none) -}}"
          dominant_value: "{{- (ctx.days[0].get('dominant_value') if (ctx.days | count) > 0 else none) -}}"
          dominant_category: "{{- (ctx.days[0].get('dominant_category') if (ctx.days | count) > 0 else none) -}}"
          dominant_hex: "{{- (ctx.days[0].get('dominant_hex') if (ctx.days | count) > 0 else none) -}}"
          species_name: "{{- (ctx.days[0].get('species_name') if (ctx.days | count) > 0 else none) -}}"
          species_value: "{{- (ctx.days[0].get('species_value') if (ctx.days | count) > 0 else none) -}}"
          species_category: "{{- (ctx.days[0].get('species_category') if (ctx.days | count) > 0 else none) -}}"
          species_type: "{{- (ctx.days[0].get('species_type') if (ctx.days | count) > 0 else none) -}}"
          species_picture: "{{- (ctx.days[0].get('species_picture') if (ctx.days | count) > 0 else none) -}}"

      - name: Pollen Forecast RV Day 1
        unique_id: pollen_forecast_rv_day_1
        icon: mdi:calendar
        availability: >-
          {{ (ctx.days | count) > 1 and (ctx.days[1].get('exists') if (ctx.days | count) > 1 else false) }}
        state: >-
          {{ (ctx.days[1].get('state') if (ctx.days | count) > 1 else none) or 'unknown' }}
        attributes:
          date: "{{- (ctx.days[1].get('date') if (ctx.days | count) > 1 else none) -}}"
          dominant_type: "{{- (ctx.days[1].get('dominant_type') if (ctx.days | count) > 1 else none) -}}"
          dominant_value: "{{- (ctx.days[1].get('dominant_value') if (ctx.days | count) > 1 else none) -}}"
          dominant_category: "{{- (ctx.days[1].get('dominant_category') if (ctx.days | count) > 1 else none) -}}"
          dominant_hex: "{{- (ctx.days[1].get('dominant_hex') if (ctx.days | count) > 1 else none) -}}"
          species_name: "{{- (ctx.days[1].get('species_name') if (ctx.days | count) > 1 else none) -}}"
          species_value: "{{- (ctx.days[1].get('species_value') if (ctx.days | count) > 1 else none) -}}"
          species_category: "{{- (ctx.days[1].get('species_category') if (ctx.days | count) > 1 else none) -}}"
          species_type: "{{- (ctx.days[1].get('species_type') if (ctx.days | count) > 1 else none) -}}"
          species_picture: "{{- (ctx.days[1].get('species_picture') if (ctx.days | count) > 1 else none) -}}"

      - name: Pollen Forecast RV Day 2
        unique_id: pollen_forecast_rv_day_2
        icon: mdi:calendar
        availability: >-
          {{ (ctx.days | count) > 2 and (ctx.days[2].get('exists') if (ctx.days | count) > 2 else false) }}
        state: >-
          {{ (ctx.days[2].get('state') if (ctx.days | count) > 2 else none) or 'unknown' }}
        attributes:
          date: "{{- (ctx.days[2].get('date') if (ctx.days | count) > 2 else none) -}}"
          dominant_type: "{{- (ctx.days[2].get('dominant_type') if (ctx.days | count) > 2 else none) -}}"
          dominant_value: "{{- (ctx.days[2].get('dominant_value') if (ctx.days | count) > 2 else none) -}}"
          dominant_category: "{{- (ctx.days[2].get('dominant_category') if (ctx.days | count) > 2 else none) -}}"
          dominant_hex: "{{- (ctx.days[2].get('dominant_hex') if (ctx.days | count) > 2 else none) -}}"
          species_name: "{{- (ctx.days[2].get('species_name') if (ctx.days | count) > 2 else none) -}}"
          species_value: "{{- (ctx.days[2].get('species_value') if (ctx.days | count) > 2 else none) -}}"
          species_category: "{{- (ctx.days[2].get('species_category') if (ctx.days | count) > 2 else none) -}}"
          species_type: "{{- (ctx.days[2].get('species_type') if (ctx.days | count) > 2 else none) -}}"
          species_picture: "{{- (ctx.days[2].get('species_picture') if (ctx.days | count) > 2 else none) -}}"

      - name: Pollen Species List RV Today
        unique_id: pollen_species_list_rv_today
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: "{{- (ctx.di | count) > 0 -}}"
        attributes:
          species: >-
            {%- set plants = (ctx.d or {}).get('plantInfo') or [] -%}
            {%- set ns = namespace(out=[]) -%}
            {%- for p in plants -%}
              {%- set desc = p.get('plantDescription') or {} -%}
              {%- set item = {
                'code': p.get('code'),
                'name': p.get('displayName'),
                'type': desc.get('type'),
                'in_season': p.get('inSeason'),
                'value': ((p.get('indexInfo') or {}).get('value')),
                'category': ((p.get('indexInfo') or {}).get('category')),
                'picture': desc.get('picture') or desc.get('pictureCloseup')
              } -%}
              {%- set ns.out = ns.out + [item] -%}
            {%- endfor -%}
            {{- ns.out -}}

      - name: Pollen Peak Index RV Today
        unique_id: pollen_peak_index_rv_today
        icon: mdi:meter-gas
        availability: "{{- has_value(src) and ((((ctx.d or {}).get('pollenTypeInfo') or []) | count) > 0) -}}"
        state: >-
          {%- set types = (ctx.d or {}).get('pollenTypeInfo') or [] -%}
          {%- set vals = (
                types
                | selectattr('indexInfo','defined')
                | selectattr('indexInfo.value','defined')
                | map(attribute='indexInfo.value')
                | list
            ) -%}
          {{ (vals|max) if (vals|count) > 0 else none }}
