# =====================================================================
# Google Pollen â€“ REST sensors + derived template sensors (Nearby/Home/RV)
# Shared macros: env/pollen_core.jinja
# =====================================================================

# ---------- REST sensors ----------
sensor:
  # Nearby
  - platform: rest
    name: Google Pollen Nearby
    unique_id: google_pollen_nearby
    scan_interval: 600
    timeout: 8
    resource_template: >-
      {%- set plat = states('sensor.aaron_latitude') | float(0) -%}
      {%- set hlat = states('sensor.home_latitude')  | float(0) -%}
      {%- set plon = states('sensor.aaron_longitude') | float(0) -%}
      {%- set hlon = states('sensor.home_longitude')  | float(0) -%}
      {%- set lat = plat if plat != 0 else hlat -%}
      {%- set lon = plon if plon != 0 else hlon -%}
      {{- 'https://pollen.googleapis.com/v1/forecast:lookup' if lat!=0 and lon!=0 else 'http://127.0.0.1:65535/' -}}
    method: GET
    params:
      location.latitude: >-
        {%- set plat = states('sensor.aaron_latitude') | float(0) -%}
        {%- set hlat = states('sensor.home_latitude')  | float(0) -%}
        {{- plat if plat != 0 else hlat -}}
      location.longitude: >-
        {%- set plon = states('sensor.aaron_longitude') | float(0) -%}
        {%- set hlon = states('sensor.home_longitude')  | float(0) -%}
        {{- plon if plon != 0 else hlon -}}
      days: 5
      languageCode: en
      key: !secret google_pollen_api_key
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache
    availability: >-
      {%- set plat = states('sensor.aaron_latitude')  | float(0) -%}
      {%- set plon = states('sensor.aaron_longitude') | float(0) -%}
      {%- set hlat = states('sensor.home_latitude')   | float(0) -%}
      {%- set hlon = states('sensor.home_longitude')  | float(0) -%}
      {%- set lat = plat if plat != 0 else hlat -%}
      {%- set lon = plon if plon != 0 else hlon -%}
      {{- not (lat == 0 and lon == 0) -}}
    value_template: >-
      {%- if value_json is mapping and value_json.error is not defined -%}
        {%- set di = value_json.get('dailyInfo') or [] -%}
        {{- states(this.entity_id) if (di | count) == 0 else now().isoformat() -}}
      {%- else -%}
        {{- states(this.entity_id) -}}
      {%- endif -%}
    json_attributes:
      - dailyInfo
      - plantInfo

  # Home
  - platform: rest
    name: Google Pollen Home
    unique_id: google_pollen_home
    scan_interval: 600
    timeout: 8
    resource_template: >-
      {%- set lat = states('sensor.home_latitude')  | float(0) -%}
      {%- set lon = states('sensor.home_longitude') | float(0) -%}
      {{- 'https://pollen.googleapis.com/v1/forecast:lookup' if lat!=0 and lon!=0 else 'http://127.0.0.1:65535/' -}}
    method: GET
    params:
      location.latitude: "{{- states('sensor.home_latitude') | float(0) -}}"
      location.longitude: "{{- states('sensor.home_longitude') | float(0) -}}"
      days: 5
      languageCode: en
      key: !secret google_pollen_api_key
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache
    availability: >-
      {%- set lat = states('sensor.home_latitude')  | float(0) -%}
      {%- set lon = states('sensor.home_longitude') | float(0) -%}
      {{- not (lat == 0 and lon == 0) -}}
    value_template: >-
      {%- if value_json is mapping and value_json.error is not defined -%}
        {%- set di = value_json.get('dailyInfo') or [] -%}
        {{- states(this.entity_id) if (di | count) == 0 else now().isoformat() -}}
      {%- else -%}
        {{- states(this.entity_id) -}}
      {%- endif -%}
    json_attributes:
      - dailyInfo
      - plantInfo

  # RV
  - platform: rest
    name: Google Pollen RV
    unique_id: google_pollen_rv
    scan_interval: 600
    timeout: 8
    resource_template: >-
      {%- set rlat = states('sensor.rv_latitude')   | float(0) -%}
      {%- set alat = states('sensor.aaron_latitude')| float(0) -%}
      {%- set hlat = states('sensor.home_latitude') | float(0) -%}
      {%- set rlon = states('sensor.rv_longitude')    | float(0) -%}
      {%- set alon = states('sensor.aaron_longitude') | float(0) -%}
      {%- set hlon = states('sensor.home_longitude')  | float(0) -%}
      {%- set lat = rlat if rlat != 0 else (alat if alat != 0 else hlat) -%}
      {%- set lon = rlon if rlon != 0 else (alon if alon != 0 else hlon) -%}
      {{- 'https://pollen.googleapis.com/v1/forecast:lookup' if lat!=0 and lon!=0 else 'http://127.0.0.1:65535/' -}}
    method: GET
    params:
      location.latitude: >-
        {%- set rlat = states('sensor.rv_latitude')   | float(0) -%}
        {%- set alat = states('sensor.aaron_latitude')| float(0) -%}
        {%- set hlat = states('sensor.home_latitude') | float(0) -%}
        {{- rlat if rlat != 0 else (alat if alat != 0 else hlat) -}}
      location.longitude: >-
        {%- set rlon = states('sensor.rv_longitude')    | float(0) -%}
        {%- set alon = states('sensor.aaron_longitude') | float(0) -%}
        {%- set hlon = states('sensor.home_longitude')  | float(0) -%}
        {{- rlon if rlon != 0 else (alon if alon != 0 else hlon) -}}
      days: 5
      languageCode: en
      key: !secret google_pollen_api_key
    headers:
      Accept: application/json
      User-Agent: HomeAssistant
      Cache-Control: no-cache
    availability: >-
      {%- set rlat = states('sensor.rv_latitude')   | float(0) -%}
      {%- set rlon = states('sensor.rv_longitude')  | float(0) -%}
      {%- set alat = states('sensor.aaron_latitude')| float(0) -%}
      {%- set alon = states('sensor.aaron_longitude')| float(0) -%}
      {%- set hlat = states('sensor.home_latitude') | float(0) -%}
      {%- set hlon = states('sensor.home_longitude')| float(0) -%}
      {%- set lat = rlat if rlat != 0 else (alat if alat != 0 else hlat) -%}
      {%- set lon = rlon if rlon != 0 else (alon if alon != 0 else hlon) -%}
      {{- not (lat == 0 and lon == 0) -}}
    value_template: >-
      {%- if value_json is mapping and value_json.error is not defined -%}
        {%- set di = value_json.get('dailyInfo') or [] -%}
        {{- states(this.entity_id) if (di | count) == 0 else now().isoformat() -}}
      {%- else -%}
        {{- states(this.entity_id) -}}
      {%- endif -%}
    json_attributes:
      - dailyInfo
      - plantInfo

# ---------- Template sensors (shared structure, per location) ----------
template:

  # ================= NEARBY =================
  - trigger:
      - platform: state
        entity_id: sensor.google_pollen_nearby
    variables:
      src: sensor.google_pollen_nearby
      ctx: >-
        {%- from 'metrics/pollen/pollen.jinja' import build_ctx -%}
        {{- build_ctx(src) | from_json -}}
    sensor:
      - name: Google Pollen Nearby Today
        unique_id: google_pollen_nearby_today
        icon: mdi:flower-pollen
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: >-
          {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
          {%- set types = d0.get('pollenTypeInfo') or [] -%}
          {%- set top = (types | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
          {{- top.get('displayName') or top.get('code') or 'unknown' -}}
        attributes:
          date: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set dt = d0.get('date') or {} -%}
            {{- "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none -}}
          dominant_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set t = ((d0.get('pollenTypeInfo') or []) | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
            {{- (t.get('indexInfo') or {}).get('value') -}}
          dominant_category: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set t = ((d0.get('pollenTypeInfo') or []) | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
            {{- (t.get('indexInfo') or {}).get('category') or 'unknown' -}}
          dominant_hex: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set t = ((d0.get('pollenTypeInfo') or []) | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
            {%- set c = (t.get('indexInfo') or {}).get('color') or {} -%}
            {%- set r = (c.get('red') or 0) * 255 -%}
            {%- set g = (c.get('green') or 0) * 255 -%}
            {%- set b = (c.get('blue') or 0) * 255 -%}
            {{- '#%02X%02X%02X'|format(r|round(0)|int, g|round(0)|int, b|round(0)|int) -}}
          grass_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','GRASS') | list | first) or {}) -%}
            {{- (x.get('indexInfo') or {}).get('value') -}}
          tree_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','TREE') | list | first) or {}) -%}
            {{- (x.get('indexInfo') or {}).get('value') -}}
          weed_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','WEED') | list | first) or {}) -%}
            {{- (x.get('indexInfo') or {}).get('value') -}}
          recommendations: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set types = d0.get('pollenTypeInfo') or [] -%}
            {%- set ranked = types | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) -%}
            {%- set dom = (ranked | first) or {} -%}
            {{- (dom.get('healthRecommendations') or []) | unique | list -}}

      - name: Pollen Species Nearby Today
        unique_id: pollen_species_nearby_today
        icon: mdi:leaf
        availability: "{{- has_value(src) and ((ctx.plants | count) > 0) -}}"
        state: "{{- ctx.pick.name or 'unknown' -}}"
        attributes:
          code: "{{- ctx.pick.code -}}"
          type: "{{- ctx.pick.type -}}"
          in_season: "{{- ctx.pick.in_season -}}"
          category: "{{- ctx.pick.category or 'unknown' -}}"
          value: "{{- ctx.pick.value -}}"
          entity_picture: "{{- ctx.pick.picture or none -}}"

      - name: Pollen Forecast Nearby Day 0
        unique_id: pollen_forecast_nearby_day_0
        icon: mdi:calendar-today
        availability: "{{- ((ctx.days | count) > 0) and ((ctx.days[0] | default({})).get('exists')) -}}"
        state: "{{- (ctx.days[0] | default({})).get('state') or 'unknown' -}}"
        attributes:
          date: "{{- (ctx.days[0] | default({})).get('date') -}}"
          dominant_type: "{{- (ctx.days[0] | default({})).get('dominant_type') -}}"
          dominant_value: "{{- (ctx.days[0] | default({})).get('dominant_value') -}}"
          dominant_category: "{{- (ctx.days[0] | default({})).get('dominant_category') -}}"
          dominant_hex: "{{- (ctx.days[0] | default({})).get('dominant_hex') -}}"
          species_name: "{{- (ctx.days[0] | default({})).get('species_name') -}}"
          species_value: "{{- (ctx.days[0] | default({})).get('species_value') -}}"
          species_category: "{{- (ctx.days[0] | default({})).get('species_category') -}}"
          species_type: "{{- (ctx.days[0] | default({})).get('species_type') -}}"
          species_picture: "{{- (ctx.days[0] | default({})).get('species_picture') -}}"

      - name: Pollen Forecast Nearby Day 1
        unique_id: pollen_forecast_nearby_day_1
        icon: mdi:calendar
        availability: "{{- ((ctx.days | count) > 1) and ((ctx.days[1] | default({})).get('exists')) -}}"
        state: "{{- (ctx.days[1] | default({})).get('state') or 'unknown' -}}"
        attributes:
          date: "{{- (ctx.days[1] | default({})).get('date') -}}"
          dominant_type: "{{- (ctx.days[1] | default({})).get('dominant_type') -}}"
          dominant_value: "{{- (ctx.days[1] | default({})).get('dominant_value') -}}"
          dominant_category: "{{- (ctx.days[1] | default({})).get('dominant_category') -}}"
          dominant_hex: "{{- (ctx.days[1] | default({})).get('dominant_hex') -}}"
          species_name: "{{- (ctx.days[1] | default({})).get('species_name') -}}"
          species_value: "{{- (ctx.days[1] | default({})).get('species_value') -}}"
          species_category: "{{- (ctx.days[1] | default({})).get('species_category') -}}"
          species_type: "{{- (ctx.days[1] | default({})).get('species_type') -}}"
          species_picture: "{{- (ctx.days[1] | default({})).get('species_picture') -}}"

      - name: Pollen Forecast Nearby Day 2
        unique_id: pollen_forecast_nearby_day_2
        icon: mdi:calendar
        availability: "{{- ((ctx.days | count) > 2) and ((ctx.days[2] | default({})).get('exists')) -}}"
        state: "{{- (ctx.days[2] | default({})).get('state') or 'unknown' -}}"
        attributes:
          date: "{{- (ctx.days[2] | default({})).get('date') -}}"
          dominant_type: "{{- (ctx.days[2] | default({})).get('dominant_type') -}}"
          dominant_value: "{{- (ctx.days[2] | default({})).get('dominant_value') -}}"
          dominant_category: "{{- (ctx.days[2] | default({})).get('dominant_category') -}}"
          dominant_hex: "{{- (ctx.days[2] | default({})).get('dominant_hex') -}}"
          species_name: "{{- (ctx.days[2] | default({})).get('species_name') -}}"
          species_value: "{{- (ctx.days[2] | default({})).get('species_value') -}}"
          species_category: "{{- (ctx.days[2] | default({})).get('species_category') -}}"
          species_type: "{{- (ctx.days[2] | default({})).get('species_type') -}}"
          species_picture: "{{- (ctx.days[2] | default({})).get('species_picture') -}}"

      - name: Pollen Species List Nearby Today
        unique_id: pollen_species_list_nearby_today
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: "{{- (ctx.di | count) > 0 -}}"
        attributes:
          species: >-
            {%- set plants = ctx.d.get('plantInfo') or [] -%}
            {%- set ns = namespace(out=[]) -%}
            {%- for p in plants -%}
              {%- set desc = p.get('plantDescription') or {} -%}
              {%- set item = {
                'code': p.get('code'),
                'name': p.get('displayName'),
                'type': desc.get('type'),
                'in_season': p.get('inSeason'),
                'value': ((p.get('indexInfo') or {}).get('value')),
                'category': ((p.get('indexInfo') or {}).get('category')),
                'picture': desc.get('picture') or desc.get('pictureCloseup')
              } -%}
              {%- set ns.out = ns.out + [item] -%}
            {%- endfor -%}
            {{- ns.out -}}

      - name: Pollen Peak Index Nearby Today
        unique_id: pollen_peak_index_nearby_today
        icon: mdi:meter-gas
        availability: "{{- has_value(src) and (((ctx.d.get('pollenTypeInfo') or []) | count) > 0) -}}"
        state: >-
          {%- set types = ctx.d.get('pollenTypeInfo') or [] -%}
          {%- if (types | count) == 0 -%}
            {{- none -}}
          {%- else -%} 
            {{- (types | selectattr('indexInfo','defined') | map(attribute='indexInfo.value') | list | max) -}}
          {%- endif -%}

  # ================= HOME =================
  - trigger:
      - platform: state
        entity_id: sensor.google_pollen_home
    variables:
      src: sensor.google_pollen_home
      ctx: >-
        {%- from 'metrics/pollen/pollen.jinja' import build_ctx -%}
        {{- build_ctx(src) | from_json -}}
    sensor:
      - name: Google Pollen Home Today
        unique_id: google_pollen_home_today
        icon: mdi:flower-pollen
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: >-
          {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
          {%- set types = d0.get('pollenTypeInfo') or [] -%}
          {%- set top = (types | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
          {{- top.get('displayName') or top.get('code') or 'unknown' -}}
        attributes:
          date: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set dt = d0.get('date') or {} -%}
            {{- "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none -}}
          dominant_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set t = ((d0.get('pollenTypeInfo') or []) | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
            {{- (t.get('indexInfo') or {}).get('value') -}}
          dominant_category: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set t = ((d0.get('pollenTypeInfo') or []) | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
            {{- (t.get('indexInfo') or {}).get('category') or 'unknown' -}}
          dominant_hex: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set t = ((d0.get('pollenTypeInfo') or []) | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
            {%- set c = (t.get('indexInfo') or {}).get('color') or {} -%}
            {%- set r = (c.get('red') or 0) * 255 -%}
            {%- set g = (c.get('green') or 0) * 255 -%}
            {%- set b = (c.get('blue') or 0) * 255 -%}
            {{- '#%02X%02X%02X'|format(r|round(0)|int, g|round(0)|int, b|round(0)|int) -}}
          grass_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','GRASS') | list | first) or {}) -%}
            {{- (x.get('indexInfo') or {}).get('value') -}}
          tree_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','TREE') | list | first) or {}) -%}
            {{- (x.get('indexInfo') or {}).get('value') -}}
          weed_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','WEED') | list | first) or {}) -%}
            {{- (x.get('indexInfo') or {}).get('value') -}}
          recommendations: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set types = d0.get('pollenTypeInfo') or [] -%}
            {%- set ranked = types | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) -%}
            {%- set dom = (ranked | first) or {} -%}
            {{- (dom.get('healthRecommendations') or []) | unique | list -}}

      - name: Pollen Species Home Today
        unique_id: pollen_species_home_today
        icon: mdi:leaf
        availability: "{{- has_value(src) and ((ctx.plants | count) > 0) -}}"
        state: "{{- ctx.pick.name or 'unknown' -}}"
        attributes:
          code: "{{- ctx.pick.code -}}"
          type: "{{- ctx.pick.type -}}"
          in_season: "{{- ctx.pick.in_season -}}"
          category: "{{- ctx.pick.category or 'unknown' -}}"
          value: "{{- ctx.pick.value -}}"
          entity_picture: "{{- ctx.pick.picture or none -}}"

      - name: Pollen Forecast Home Day 0
        unique_id: pollen_forecast_home_day_0
        icon: mdi:calendar-today
        availability: "{{- ((ctx.days | count) > 0) and ((ctx.days[0] | default({})).get('exists')) -}}"
        state: "{{- (ctx.days[0] | default({})).get('state') or 'unknown' -}}"
        attributes:
          date: "{{- (ctx.days[0] | default({})).get('date') -}}"
          dominant_type: "{{- (ctx.days[0] | default({})).get('dominant_type') -}}"
          dominant_value: "{{- (ctx.days[0] | default({})).get('dominant_value') -}}"
          dominant_category: "{{- (ctx.days[0] | default({})).get('dominant_category') -}}"
          dominant_hex: "{{- (ctx.days[0] | default({})).get('dominant_hex') -}}"
          species_name: "{{- (ctx.days[0] | default({})).get('species_name') -}}"
          species_value: "{{- (ctx.days[0] | default({})).get('species_value') -}}"
          species_category: "{{- (ctx.days[0] | default({})).get('species_category') -}}"
          species_type: "{{- (ctx.days[0] | default({})).get('species_type') -}}"
          species_picture: "{{- (ctx.days[0] | default({})).get('species_picture') -}}"

      - name: Pollen Forecast Home Day 1
        unique_id: pollen_forecast_home_day_1
        icon: mdi:calendar
        availability: "{{- ((ctx.days | count) > 1) and ((ctx.days[1] | default({})).get('exists')) -}}"
        state: "{{- (ctx.days[1] | default({})).get('state') or 'unknown' -}}"
        attributes:
          date: "{{- (ctx.days[1] | default({})).get('date') -}}"
          dominant_type: "{{- (ctx.days[1] | default({})).get('dominant_type') -}}"
          dominant_value: "{{- (ctx.days[1] | default({})).get('dominant_value') -}}"
          dominant_category: "{{- (ctx.days[1] | default({})).get('dominant_category') -}}"
          dominant_hex: "{{- (ctx.days[1] | default({})).get('dominant_hex') -}}"
          species_name: "{{- (ctx.days[1] | default({})).get('species_name') -}}"
          species_value: "{{- (ctx.days[1] | default({})).get('species_value') -}}"
          species_category: "{{- (ctx.days[1] | default({})).get('species_category') -}}"
          species_type: "{{- (ctx.days[1] | default({})).get('species_type') -}}"
          species_picture: "{{- (ctx.days[1] | default({})).get('species_picture') -}}"

      - name: Pollen Forecast Home Day 2
        unique_id: pollen_forecast_home_day_2
        icon: mdi:calendar
        availability: "{{- ((ctx.days | count) > 2) and ((ctx.days[2] | default({})).get('exists')) -}}"
        state: "{{- (ctx.days[2] | default({})).get('state') or 'unknown' -}}"
        attributes:
          date: "{{- (ctx.days[2] | default({})).get('date') -}}"
          dominant_type: "{{- (ctx.days[2] | default({})).get('dominant_type') -}}"
          dominant_value: "{{- (ctx.days[2] | default({})).get('dominant_value') -}}"
          dominant_category: "{{- (ctx.days[2] | default({})).get('dominant_category') -}}"
          dominant_hex: "{{- (ctx.days[2] | default({})).get('dominant_hex') -}}"
          species_name: "{{- (ctx.days[2] | default({})).get('species_name') -}}"
          species_value: "{{- (ctx.days[2] | default({})).get('species_value') -}}"
          species_category: "{{- (ctx.days[2] | default({})).get('species_category') -}}"
          species_type: "{{- (ctx.days[2] | default({})).get('species_type') -}}"
          species_picture: "{{- (ctx.days[2] | default({})).get('species_picture') -}}"

      - name: Pollen Species List Home Today
        unique_id: pollen_species_list_home_today
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: "{{- (ctx.di | count) > 0 -}}"
        attributes:
          species: >-
            {%- set plants = ctx.d.get('plantInfo') or [] -%}
            {%- set ns = namespace(out=[]) -%}
            {%- for p in plants -%}
              {%- set desc = p.get('plantDescription') or {} -%}
              {%- set item = {
                'code': p.get('code'),
                'name': p.get('displayName'),
                'type': desc.get('type'),
                'in_season': p.get('inSeason'),
                'value': ((p.get('indexInfo') or {}).get('value')),
                'category': ((p.get('indexInfo') or {}).get('category')),
                'picture': desc.get('picture') or desc.get('pictureCloseup')
              } -%}
              {%- set ns.out = ns.out + [item] -%}
            {%- endfor -%}
            {{- ns.out -}}

      - name: Pollen Peak Index Home Today
        unique_id: pollen_peak_index_home_today
        icon: mdi:meter-gas
        availability: "{{- has_value(src) and (((ctx.d.get('pollenTypeInfo') or []) | count) > 0) -}}"
        state: >-
          {%- set types = ctx.d.get('pollenTypeInfo') or [] -%}
          {%- if (types | count) == 0 -%}
            {{- none -}}
          {%- else -%}
            {{- (types | selectattr('indexInfo','defined') | map(attribute='indexInfo.value') | list | max) -}}
          {%- endif -%}

  # ================= RV =================
  - trigger:
      - platform: state
        entity_id: sensor.google_pollen_rv
    variables:
      src: sensor.google_pollen_rv
      ctx: >-
        {%- from 'metrics/pollen/pollen.jinja' import build_ctx -%}
        {{- build_ctx(src) | from_json -}}
    sensor:
      - name: Google Pollen RV Today
        unique_id: google_pollen_rv_today
        icon: mdi:flower-pollen
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: >-
          {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
          {%- set types = d0.get('pollenTypeInfo') or [] -%}
          {%- set top = (types | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
          {{- top.get('displayName') or top.get('code') or 'unknown' -}}
        attributes:
          date: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set dt = d0.get('date') or {} -%}
            {{- "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none -}}
          dominant_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set t = ((d0.get('pollenTypeInfo') or []) | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
            {{- (t.get('indexInfo') or {}).get('value') -}}
          dominant_category: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set t = ((d0.get('pollenTypeInfo') or []) | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
            {{- (t.get('indexInfo') or {}).get('category') or 'unknown' -}}
          dominant_hex: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set t = ((d0.get('pollenTypeInfo') or []) | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) | first) or {} -%}
            {%- set c = (t.get('indexInfo') or {}).get('color') or {} -%}
            {%- set r = (c.get('red') or 0) * 255 -%}
            {%- set g = (c.get('green') or 0) * 255 -%}
            {%- set b = (c.get('blue') or 0) * 255 -%}
            {{- '#%02X%02X%02X'|format(r|round(0)|int, g|round(0)|int, b|round(0)|int) -}}
          grass_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','GRASS') | list | first) or {}) -%}
            {{- (x.get('indexInfo') or {}).get('value') -}}
          tree_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','TREE') | list | first) or {}) -%}
            {{- (x.get('indexInfo') or {}).get('value') -}}
          weed_value: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','WEED') | list | first) or {}) -%}
            {{- (x.get('indexInfo') or {}).get('value') -}}
          recommendations: >-
            {%- set d0 = (ctx.di[0] if ctx.di is sequence and (ctx.di | count) > 0 else {}) -%}
            {%- set types = d0.get('pollenTypeInfo') or [] -%}
            {%- set ranked = types | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) -%}
            {%- set dom = (ranked | first) or {} -%}
            {{- (dom.get('healthRecommendations') or []) | unique | list -}}

      - name: Pollen Species RV Today
        unique_id: pollen_species_rv_today
        icon: mdi:leaf
        availability: "{{- has_value(src) and ((ctx.plants | count) > 0) -}}"
        state: "{{- ctx.pick.name or 'unknown' -}}"
        attributes:
          code: "{{- ctx.pick.code -}}"
          type: "{{- ctx.pick.type -}}"
          in_season: "{{- ctx.pick.in_season -}}"
          category: "{{- ctx.pick.category or 'unknown' -}}"
          value: "{{- ctx.pick.value -}}"
          entity_picture: "{{- ctx.pick.picture or none -}}"

      - name: Pollen Forecast RV Day 0
        unique_id: pollen_forecast_rv_day_0
        icon: mdi:calendar-today
        availability: "{{- ((ctx.days | count) > 0) and ((ctx.days[0] | default({})).get('exists')) -}}"
        state: "{{- (ctx.days[0] | default({})).get('state') or 'unknown' -}}"
        attributes:
          date: "{{- (ctx.days[0] | default({})).get('date') -}}"
          dominant_type: "{{- (ctx.days[0] | default({})).get('dominant_type') -}}"
          dominant_value: "{{- (ctx.days[0] | default({})).get('dominant_value') -}}"
          dominant_category: "{{- (ctx.days[0] | default({})).get('dominant_category') -}}"
          dominant_hex: "{{- (ctx.days[0] | default({})).get('dominant_hex') -}}"
          species_name: "{{- (ctx.days[0] | default({})).get('species_name') -}}"
          species_value: "{{- (ctx.days[0] | default({})).get('species_value') -}}"
          species_category: "{{- (ctx.days[0] | default({})).get('species_category') -}}"
          species_type: "{{- (ctx.days[0] | default({})).get('species_type') -}}"
          species_picture: "{{- (ctx.days[0] | default({})).get('species_picture') -}}"

      - name: Pollen Forecast RV Day 1
        unique_id: pollen_forecast_rv_day_1
        icon: mdi:calendar
        availability: "{{- ((ctx.days | count) > 1) and ((ctx.days[1] | default({})).get('exists')) -}}"
        state: "{{- (ctx.days[1] | default({})).get('state') or 'unknown' -}}"
        attributes:
          date: "{{- (ctx.days[1] | default({})).get('date') -}}"
          dominant_type: "{{- (ctx.days[1] | default({})).get('dominant_type') -}}"
          dominant_value: "{{- (ctx.days[1] | default({})).get('dominant_value') -}}"
          dominant_category: "{{- (ctx.days[1] | default({})).get('dominant_category') -}}"
          dominant_hex: "{{- (ctx.days[1] | default({})).get('dominant_hex') -}}"
          species_name: "{{- (ctx.days[1] | default({})).get('species_name') -}}"
          species_value: "{{- (ctx.days[1] | default({})).get('species_value') -}}"
          species_category: "{{- (ctx.days[1] | default({})).get('species_category') -}}"
          species_type: "{{- (ctx.days[1] | default({})).get('species_type') -}}"
          species_picture: "{{- (ctx.days[1] | default({})).get('species_picture') -}}"

      - name: Pollen Forecast RV Day 2
        unique_id: pollen_forecast_rv_day_2
        icon: mdi:calendar
        availability: "{{- ((ctx.days | count) > 2) and ((ctx.days[2] | default({})).get('exists')) -}}"
        state: "{{- (ctx.days[2] | default({})).get('state') or 'unknown' -}}"
        attributes:
          date: "{{- (ctx.days[2] | default({})).get('date') -}}"
          dominant_type: "{{- (ctx.days[2] | default({})).get('dominant_type') -}}"
          dominant_value: "{{- (ctx.days[2] | default({})).get('dominant_value') -}}"
          dominant_category: "{{- (ctx.days[2] | default({})).get('dominant_category') -}}"
          dominant_hex: "{{- (ctx.days[2] | default({})).get('dominant_hex') -}}"
          species_name: "{{- (ctx.days[2] | default({})).get('species_name') -}}"
          species_value: "{{- (ctx.days[2] | default({})).get('species_value') -}}"
          species_category: "{{- (ctx.days[2] | default({})).get('species_category') -}}"
          species_type: "{{- (ctx.days[2] | default({})).get('species_type') -}}"
          species_picture: "{{- (ctx.days[2] | default({})).get('species_picture') -}}"

      - name: Pollen Species List RV Today
        unique_id: pollen_species_list_rv_today
        availability: "{{- has_value(src) and ((ctx.di | count) > 0) -}}"
        state: "{{- (ctx.di | count) > 0 -}}"
        attributes:
          species: >-
            {%- set plants = ctx.d.get('plantInfo') or [] -%}
            {%- set ns = namespace(out=[]) -%}
            {%- for p in plants -%}
              {%- set desc = p.get('plantDescription') or {} -%}
              {%- set item = {
                'code': p.get('code'),
                'name': p.get('displayName'),
                'type': desc.get('type'),
                'in_season': p.get('inSeason'),
                'value': ((p.get('indexInfo') or {}).get('value')),
                'category': ((p.get('indexInfo') or {}).get('category')),
                'picture': desc.get('picture') or desc.get('pictureCloseup')
              } -%}
              {%- set ns.out = ns.out + [item] -%}
            {%- endfor -%}
            {{- ns.out -}}

      - name: Pollen Peak Index RV Today
        unique_id: pollen_peak_index_rv_today
        icon: mdi:meter-gas
        availability: "{{- has_value(src) and (((ctx.d.get('pollenTypeInfo') or []) | count) > 0) -}}"
        state: >-
          {%- set types = ctx.d.get('pollenTypeInfo') or [] -%}
          {%- if (types | count) == 0 -%}
            {{- none -}}
          {%- else -%}
            {{- (types | selectattr('indexInfo','defined') | map(attribute='indexInfo.value') | list | max) -}}
          {%- endif -%}
