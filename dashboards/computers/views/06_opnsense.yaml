title: OPNSense Router
type: sections
max_columns: 3
cards: []

badges:
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: Status
      - entity: binary_sensor.opnsense_status_alarm
      - app: alarm
      - options: 'summary=sensor.opnsense_overall_status_summary'
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: CPU Load
      - entity: sensor.opnsense_cpu_load_1m
      - app: cpu_load
      - options: 'cores=sensor.opnsense_cpu_cores'
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: CPU
      - entity: sensor.opnsense_cpu_utilization
      - app: cpu_utilization
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: CPU Temp
      - entity: sensor.opnsense_cpu_temp_avg
      - app: cpu
  - type: custom:decluttering-card
    template: template_badge
    variables:
      - name: Memory
      - entity: sensor.opnsense_memory_percent
      - app: memory_utilization

sections:
  - type: grid
    columns: 3
    grid_options:
      columns: full
    column_span: 3
    cards:
      - type: vertical-stack
        cards:

          # CPU & Memory Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: CPU & Memory
              - subtitle: Utilization and system load

          # CPU Load
          - type: custom:mushroom-template-card
            entity: sensor.opnsense_cpu_load_1m
            primary: CPU Load (1m/5m/15m)
            secondary: >-
              {%- set m1 = states(entity)|float(0) -%}
              {%- set m5 = states('sensor.opnsense_cpu_load_5m')|float(0) -%}
              {%- set m15 = states('sensor.opnsense_cpu_load_15m')|float(0) -%}
              {%- set c = states('sensor.opnsense_cpu_cores')|int(0) -%}
              {{- '1 min: ' ~ m1 ~ ' • 5 min: ' ~ m5 ~ ' • 15 min: ' ~ m15 ~ ' • ' ~ c ~ ' cores' -}}
            icon: >-
              {%- from 'main.jinja' import get_icon -%}
              {{- get_icon(entity, 'cpu_load') -}}
            icon_color: |-
              {%- from 'main.jinja' import get_color -%}
              {{- get_color(entity, 'cpu_load') -}}
            tap_action:
              action: more-info

          # Memory Usage
          - type: custom:mushroom-template-card
            entity: sensor.opnsense_memory_percent
            primary: Memory
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity -%}
              {%- set mem_pct = u_humanize_entity(entity) -%}
              {%- set mem_used = u_humanize_entity('sensor.opnsense_memory_used') -%}
              {%- set mem_total = u_humanize_entity('sensor.opnsense_memory_total') -%}
              {%- set mem_free = u_humanize_entity('sensor.opnsense_memory_free') -%}
              {{- 'Used: ' ~ mem_used ~ ' / ' ~ mem_total ~ ' • Free: ' ~ mem_free ~ ' • ' ~ mem_pct -}}
            icon: >-
              {%- from 'main.jinja' import get_icon -%}
              {{- get_icon(entity, 'memory_utilization') -}}
            icon_color: |-
              {%- from 'main.jinja' import get_color -%}
              {{- get_color(entity, 'memory_utilization') -}}
            tap_action:
              action: more-info

      - type: vertical-stack
        cards:

          # CPU Temperatures
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: CPU Temperatures
              - subtitle: Thermal status and cooling headroom

          # CPU Average Temp
          - type: custom:decluttering-card
            template: template_card
            variables:
              - name: CPU Average Temp
              - entity: sensor.opnsense_cpu_temp_avg
              - app: cpu

          # CPU Temp Core 0
          - type: custom:decluttering-card
            template: template_card
            variables:
              - name: CPU Temp Core 0
              - entity: sensor.opnsense_cpu_temp_core0
              - app: cpu

          # CPU Temp Core 1
          - type: custom:decluttering-card
            template: template_card
            variables:
              - name: CPU Temp Core 1
              - entity: sensor.opnsense_cpu_temp_core1
              - app: cpu

          # CPU Temp Core 2
          - type: custom:decluttering-card
            template: template_card
            variables:
              - name: CPU Temp Core 2
              - entity: sensor.opnsense_cpu_temp_core2
              - app: cpu

          # CPU Temp Core 3
          - type: custom:decluttering-card
            template: template_card
            variables:
              - name: CPU Temp Core 3
              - entity: sensor.opnsense_cpu_temp_core3
              - app: cpu

      - type: vertical-stack
        cards:

          # Network Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: Network
              - subtitle: Connectivity, latency, and throughput

          # Active Network Interfaces
          - type: custom:mushroom-template-card
            entity: sensor.opnsense_net_active_1_name
            primary: 'Active NIC #1'
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity -%}
              {%- set nic = states(entity) -%}
              {%- set ip = states('sensor.opnsense_net_active_1_ipv4') -%}
              {%- set up = u_humanize_entity('sensor.opnsense_net_active_1_up') -%}
              {%- set down = u_humanize_entity('sensor.opnsense_net_active_1_down') -%}
              {{- nic ~ ' • ' ~ ip ~ ' • Up: ' ~ up ~ ' • Down: ' ~ down -}}
            icon: mdi:lan-check
            icon_color: blue
            tap_action:
              action: more-info
          - type: custom:mushroom-template-card
            entity: sensor.opnsense_net_active_2_name
            primary: 'Active NIC #2'
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity -%}
              {%- set nic = states(entity) -%}
              {%- set ip = states('sensor.opnsense_net_active_2_ipv4') -%}
              {%- set up = u_humanize_entity('sensor.opnsense_net_active_2_up') -%}
              {%- set down = u_humanize_entity('sensor.opnsense_net_active_2_down') -%}
              {{- nic ~ ' • ' ~ ip ~ ' • Up: ' ~ up ~ ' • Down: ' ~ down -}}
            icon: mdi:lan-check
            icon_color: blue
            tap_action:
              action: more-info

      - type: vertical-stack
        cards:

          # Filesystem Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: Filesystems
              - subtitle: Storage capacity and usage

          # / Usage
          - type: custom:mushroom-template-card
            entity: sensor.opnsense_fs_percent
            primary: /
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity -%}
              {%- set total = u_humanize_entity('sensor.opnsense_fs_total') -%}
              {%- set used = u_humanize_entity('sensor.opnsense_fs_used') -%}
              {%- set pct = u_humanize_entity(entity) -%}
              {{- 'Total: ' ~ total ~ ' • Used: ' ~ used ~ ' • ' ~ pct -}}
            icon: >-
              {%- from 'main.jinja' import get_icon -%}
              {{- get_icon(entity, 'disk_utilization') -}}
            icon_color: |-
              {%- from 'main.jinja' import get_color -%}
              {{- get_color(entity, 'disk_utilization') -}}
            tap_action:
              action: more-info

      - type: vertical-stack
        cards:

          # Disk Info Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: Disk I/O
              - subtitle: Read/write activity and performance

          # ada0 I/O
          - type: custom:mushroom-template-card
            entity: sensor.opnsense_ada0_data_rate
            primary: ada0 I/O Rates
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity -%}
              {%- set read_bps = u_humanize_entity('sensor.opnsense_disk_ada0_read_rate') -%}
              {%- set write_bps = u_humanize_entity('sensor.opnsense_disk_ada0_write_rate') -%}
              {{- 'Read: ' ~ read_bps ~ ' • Write: ' ~ write_bps -}}
            icon: >-
              {%- from 'main.jinja' import get_icon -%}
              {{- get_icon(entity, 'drive_data_rate') -}}
            icon_color: |-
              {%- from 'main.jinja' import get_color -%}
              {{- get_color(entity, 'drive_data_rate') -}}
            multiline_secondary: true
            tap_action:
              action: more-info

      - type: vertical-stack
        cards:

          # SMART Monitor Section
          - type: custom:decluttering-card
            template: title_card
            variables:
              - title: SMART Monitors
              - subtitle: Drive health and diagnostics

          # SMART Info for /dev/ada0
          - type: custom:mushroom-template-card
            entity: binary_sensor.opnsense_smart_dev_ada0_health
            primary: Health / Temp / Life (/dev/ada0)
            secondary: >-
              {%- from 'units/base.jinja' import u_humanize_entity -%}
              {%- set ok = is_state(entity,'on') %} 
              {%- set temp = u_humanize_entity('sensor.opnsense_smart_dev_ada0_temp') -%}
              {%- set has_life_pct = has_value('sensor.opnsense_smart_dev_ada0_used') -%}
              {%- set poh = u_humanize_entity('sensor.opnsense_smart_dev_ada0_poh') -%}
              {%- set read = u_humanize_entity('sensor.opnsense_smart_dev_ada0_tbr') -%}
              {%- set written = u_humanize_entity('sensor.opnsense_smart_dev_ada0_tbw') -%}
              {%- set health_str = 'Healthy' if ok else 'Fail' -%}
              {%- set ns = namespace(life_pct_str='') -%}
              {%- if has_life_pct -%}
                {%- set life_pct = u_humanize_entity('sensor.opnsense_smart_dev_ada0_used') -%}
                {%- set ns.life_pct_str = ' • Used ' ~ life_pct -%}
              {%- endif -%}
              {{- health_str ~ ' • ' ~ temp ~ ns.life_pct_str ~ ' • POH ' ~ poh ~ '\nBytes Read: ' ~ read ~ ' • Bytes Written: ' ~ written -}}
            multiline_secondary: true
            icon: >-
              {{- 'mdi:heart-pulse' if is_state(entity,'on') else 'mdi:heart-broken' -}}
            icon_color: >-
              {{- 'green' if is_state(entity,'on') else 'red' -}}
            tap_action:
              action: more-info

  - type: grid
    cards:

      # LibreHardwareMonitor CPU Section
      - type: custom:mushroom-title-card
        title: CPU Metrics
        subtitle: Core utilization, system load, and clock speeds

      # LibreHardwareMonitor Cards
      - type: custom:decluttering-card
        template: lhm_card_stack
        variables:
          - machine_match: opnsense
          - root_match: CPU
          
  - type: grid
    cards:

      # LibreHardwareMonitor Network Section
      - type: custom:mushroom-title-card
        title: Network Connection Metrics
        subtitle: Interfaces, throughput, and latency monitoring

      # LibreHardwareMonitor Cards
      - type: custom:decluttering-card
        template: lhm_card_stack
        variables:
          - machine_match: opnsense
          - root_match: Network
