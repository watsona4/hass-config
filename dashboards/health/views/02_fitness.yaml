title: Fitness
path: fitness
type: sections
badges:
  - type: custom:mushroom-template-badge
    entity: sensor.xert_training_status
    icon: mdi:heart-pulse
    label: Xert Status
    content: "{{ states(entity) }}"
    color: >
      {% set s = states(entity)|lower %}
      {{ 'green' if 'fresh' in s else 'orange' if 'tired' in s else 'red' if 'very tired' in s else 'disabled' }}
  - type: custom:mushroom-template-badge
    entity: sensor.xert_ftp
    icon: mdi:gauge
    label: Xert FTP
    content: >-
      {% from 'units/base.jinja' import u_humanize_value %}
      {% set p = states(entity) | float(0) %}
      {% set w = state_attr('sensor.xert_training_info_raw','weight') | float(1) %}
      {{ u_humanize_value(p, 'W') ~ ' = ' ~ u_humanize_value(p / w, 'W/kg') }}
    color: blue
  - type: custom:mushroom-template-badge
    entity: sensor.zwift_hours_this_week
    icon: mdi:clock-outline
    label: Zwift Time This Week
    content: >-
      {% from 'units/base.jinja' import u_humanize_entity %}
      {{ u_humanize_entity(entity) }}
    color: teal
  - type: custom:mushroom-template-badge
    entity: sensor.zwift_last_ride_distance
    icon: mdi:map-marker-distance
    label: Last Ride Distance
    content: >-
      {% from 'units/base.jinja' import u_humanize_entity %}
      {{ u_humanize_entity(entity) }}
    color: green
  - type: custom:mushroom-template-badge
    entity: sensor.zwift_last_ride_avg_power
    icon: mdi:lightning-bolt
    label: Last Ride Power
    content: >-
      {% from 'units/base.jinja' import u_humanize_entity %}
      {{ u_humanize_entity(entity) }}
    color: amber
  - type: custom:mushroom-template-badge
    entity: sensor.zwift_last_ride_avg_hr
    icon: mdi:heart
    label: Last Ride Avg HR
    content: >-
      {% from 'units/base.jinja' import u_humanize_entity %}
      {{ u_humanize_entity(entity) }}
    color: red
sections:
  - type: grid
    cards:
      - type: heading
        heading: ðŸš´ Latest Ride
      - type: custom:mushroom-template-card
        entity: sensor.zwift_activity_data
        primary: "{{ (state_attr(entity,'activities') | first).get('name','Unknown') }}"
        secondary: >-
          {% from 'units/base.jinja' import u_convert_humanize_value %}
          {% set d = (state_attr(entity,'activities') | first).get('distanceInMeters',0) %}
          {% set t = (state_attr(entity,'activities') | first).get('movingTimeInMs',0) %}
          {% set p = (state_attr(entity,'activities') | first).get('avgWatts',0) %}
          {{ u_convert_humanize_value(d,'m','mi') ~ ' Â· ' ~ u_convert_humanize_value(t,'ms','min') ~ ' Â· ' ~ u_convert_humanize_value(p,'w','w') }}
        icon: mdi:bike
        color: green
        grid_options:
          columns: full
      - type: picture-entity
        entity: sensor.zwift_activity_data
        image: /local/strava/latest_ride.jpg
        show_state: false
        show_name: false
        camera_view: auto
        fit_mode: cover
      - type: grid
        columns: 3
        square: false
        cards:
          - type: custom:mushroom-template-card
            entity: sensor.zwift_last_ride_avg_hr
            primary: Avg HR
            secondary: >-
              {% from 'units/base.jinja' import u_humanize_entity %}
              {{ u_humanize_entity(entity) }}
            icon: mdi:heart
            color: red
            vertical: true
          - type: custom:mushroom-template-card
            entity: sensor.zwift_last_ride_max_hr
            primary: Max HR
            secondary: >-
              {% from 'units/base.jinja' import u_humanize_entity %}
              {{ u_humanize_entity(entity) }} bpm
            icon: mdi:heart-pulse
            color: red
            vertical: true
          - type: custom:mushroom-template-card
            entity: sensor.zwift_activity_data
            primary: Calories
            secondary: >-
              {% from 'units/base.jinja' import u_humanize_value %}
              {{ u_humanize_value((state_attr(entity,'activities') | first).get('calories')) }}
            icon: mdi:fire
            color: amber
            vertical: true
      - type: custom:apexcharts-card
        header:
          show: true
          title: Activity metrics (avg vs max)
        apex_config:
          chart:
            type: bar
            height: 220
            stacked: true
          legend:
            show: false
          animations:
            enabled: false
          xaxis:
            type: category
            categories:
              - Power
              - Speed
              - Cadence
              - Heart Rate
            labels:
              style:
                fontWeight: 600
          yaxis:
            decimalsInFloat: 0
          tooltip:
            enabled: true
            shared: true
            intersect: false
            followCursor: true
        series:
          - name: Avg
            entity: sensor.xert_last_avg_power_w
            type: column
            data_generator: |
              return [
                Number(hass.states['sensor.xert_last_avg_power_w']?.state) || 0,
                Number(hass.states['sensor.xert_last_avg_speed_mph']?.state) || 0,
                Number(hass.states['sensor.xert_last_avg_cadence_rpm']?.state) || 0,
                Number(hass.states['sensor.xert_last_avg_hr_bpm']?.state) || 0,
              ];
          - name: Remainder
            entity: sensor.xert_last_power_remainder_w
            type: column
            data_generator: |
              return [
                Number(hass.states['sensor.xert_last_power_remainder_w']?.state) || 0,
                Number(hass.states['sensor.xert_last_speed_remainder_mph']?.state) || 0,
                Number(hass.states['sensor.xert_last_cadence_remainder_rpm']?.state) || 0,
                Number(hass.states['sensor.xert_last_hr_remainder_bpm']?.state) || 0,
              ];
  - type: grid
    cards:
      - type: heading
        heading: ðŸ’ª Xert Training Metrics
      - type: grid
        columns: 1
        square: false
        cards:
          - type: custom:mushroom-template-card
            entity: sensor.xert_ftp
            primary: >-
              {% from 'units/base.jinja' import u_humanize_entity %}
              {{ u_humanize_entity(entity) }}
            secondary: Functional Threshold Power
            icon: mdi:gauge
            color: blue
            multiline_secondary: true
        grid_options:
          columns: full
      - type: grid
        columns: 3
        square: false
        cards:
          - type: custom:mushroom-template-card
            entity: sensor.xert_ltp
            primary: >-
              {% from 'units/base.jinja' import u_humanize_entity %}
              {{ u_humanize_entity(entity) }}
            secondary: Lower Threshold Power
            icon: mdi:sine-wave
            color: teal
            vertical: true
            multiline_secondary: true
          - type: custom:mushroom-template-card
            entity: sensor.xert_peak_power
            primary: >-
              {% from 'units/base.jinja' import u_humanize_entity %}
              {{ u_humanize_entity(entity) }}
            secondary: Peak Power
            icon: mdi:lightning-bolt
            color: yellow
            vertical: true
            multiline_secondary: true
          - type: custom:mushroom-template-card
            entity: sensor.xert_hie
            primary: >-
              {% from 'units/base.jinja' import u_humanize_entity %}
              {{ u_humanize_entity(entity) }}
            icon: mdi:chart-bell-curve
            color: amber
            vertical: true
            multiline_secondary: true
      - type: grid
        columns: 2
        square: false
        cards:
          - type: custom:mushroom-template-card
            primary: Training Loads
            secondary: >-
              {{- 'Low:\t' ~ states('sensor.xert_tl_low') ~ ' XSS' -}}
              {{- '\nHigh:\t' ~ states('sensor.xert_tl_high') ~ ' XSS' -}}
              {{- '\nPeak:\t' ~ states('sensor.xert_tl_peak') ~ ' XSS' -}}
              {{- '\nTotal:\t' ~ states('sensor.xert_tl_total') ~ ' XSS' -}}
            icon: mdi:chart-line
            color: blue
            features_position: bottom
            multiline_secondary: true
            card_mod:
              style: |
                :host {
                  font-size: 32px;
                }
          - type: custom:mushroom-template-card
            primary: Training Targets
            secondary: >-
              {{- 'Low:\t' ~ states('sensor.xert_target_xss_low') ~ ' XSS' -}}
              {{- '\nHigh:\t' ~ states('sensor.xert_target_xss_high') ~ ' XSS' -}}
              {{- '\nPeak:\t' ~ states('sensor.xert_target_xss_peak') ~ ' XSS' -}}
              {{- '\nTotal:\t' ~ states('sensor.xert_target_xss_total') ~ ' XSS' -}}
            icon: mdi:target
            color: purple
            features_position: bottom
            multiline_secondary: true
      - type: custom:apexcharts-card
        header:
          show: true
          title: Load Trend (Hours)
        graph_span: 28d
        now:
          show: true
        series:
          - entity: sensor.ride_training_summary_this_week
            name: 7d Load
            type: line
            data_generator: >
              // Use the attribute as a single daily point to make a clean sparkline
              const v = Number(entity.attributes.load_7d_hours || 0);
              return [[Date.now(), v]];
        apex_config:
          yaxis:
            decimalsInFloat: 1
          markers:
            size: 3
  - type: grid
    cards:
      - type: heading
        heading: ðŸ“ˆ Effort Trend
      - type: custom:apexcharts-card
        header:
          show: true
          title: Ride Time Over Weeks
        graph_span: 12w
        span:
          end: day
        apex_config:
          chart:
            type: area
          stroke:
            width: 2
          fill:
            type: gradient
            gradient:
              shadeIntensity: 0.3
              opacityFrom: 0.5
              opacityTo: 0.1
          yaxis:
            - id: min
              decimalsInFloat: 0
              title:
                text: Cumulative Time (min)
        series:
          - entity: sensor.zwift_weekly_minutes
            name: Minutes
            type: column
            group_by:
              duration: 1w
              func: avg
      - type: custom:apexcharts-card
        header:
          show: true
          title: Power vs HR Trend (Recent Rides)
        graph_span: 30d
        apex_config:
          stroke:
            width: 2
        yaxis:
          - id: power
            apex_config:
              title:
                text: Power (W)
          - id: hr
            opposite: true
            apex_config:
              title:
                text: HR (bpm)
        series:
          - entity: sensor.zwift_last_ride_avg_power
            name: Avg Power
            type: line
            yaxis_id: power
            color: "#f4b400"
          - entity: sensor.zwift_last_ride_avg_hr
            name: Avg HR
            type: line
            yaxis_id: hr
            color: "#db4437"
  - type: grid
    column_span: 2
    cards:
      - type: iframe
        url: /local/ride/index.html
        title: Zwift - Latest Ride
        grid_options:
          columns: full
          rows: 8
  - type: grid
    cards:
      - type: iframe
        url: /local/ride/map.html
        aspect_ratio: 100%
        title: Zwift - Latest Route
        grid_options:
          columns: full
          rows: 8
  - type: grid
    cards:
      - type: custom:apexcharts-card
        header:
          show: true
          show_states: true
          colorize_states: true
          title: XPMC-style Progression (recent activities)
        graph_span: 90d
        span:
          end: day
        now:
          show: true
        apex_config:
          chart:
            type: line
        yaxis:
          - id: power
            opposite: true
            min: 0
            max: 350
            decimals: 0
            apex_config:
              stepSize: 50
              title:
                text: Threshold Power (W)
          - id: form
            min: -50
            max: 20
            decimals: 0
            apex_config:
              stepSize: 10
              title:
                text: Form
          - id: xss
            min: 0
            max: 240
            decimals: 0
            apex_config:
              stepSize: 20
              title:
                text: Strain Score
          - id: load
            opposite: true
            min: 0
            max: 20
            decimals: 0
            apex_config:
              stepSize: 2
              title:
                text: Training/Recovery Load
        series:
          - entity: sensor.xert_activity_list_raw
            name: FTP
            yaxis_id: power
            type: line
            data_generator: |
              const ids = Array.from({ length: 50 }, (_, i) => `sensor.xert_activity_${i}_detail_raw`);
              const pull = (id) => {
                const a = hass.states[id]?.attributes;
                const d = a?.summary?.start_date?.date || a?.summary?.date || a?.progression?.date;
                const ftp = a?.summary?.sig?.ftp;
                if (!d || ftp == null) return null;
                return [new Date(d), Math.round(ftp)];
              };
              return ids
                .map(pull)
                .filter(Boolean)
                .sort((a, b) => a[0] - b[0]);
          - entity: sensor.xert_activity_list_raw
            name: TL (total)
            yaxis_id: load
            type: area
            data_generator: |
              const ids = Array.from({ length: 50 }, (_, i) => `sensor.xert_activity_${i}_detail_raw`);
              const sum = (o) => (o?.ftp || 0) + (o?.hie || 0) + (o?.pp || 0);
              const pull = (id) => {
                const a = hass.states[id]?.attributes;
                const d = a?.progression?.date || a?.summary?.start_date?.date;
                const tl = sum(a?.summary?.progression?.tl || {});
                if (!d) return null;
                return [new Date(d), Math.round(tl * 10) / 10];
              };
              return ids
                .map(pull)
                .filter(Boolean)
                .sort((a, b) => a[0] - b[0]);
          - entity: sensor.xert_activity_list_raw
            name: RL (total)
            yaxis_id: load
            type: line
            data_generator: |
              const ids = Array.from({ length: 50 }, (_, i) => `sensor.xert_activity_${i}_detail_raw`);
              const sum = (o) => (o?.ftp || 0) + (o?.hie || 0) + (o?.pp || 0);
              const pull = (id) => {
                const a = hass.states[id]?.attributes;
                const d = a?.progression?.date || a?.summary?.start_date?.date;
                const rl = sum(a?.summary?.progression?.rl || {});
                if (!d) return null;
                return [new Date(d), Math.round(rl * 10) / 10];
              };
              return ids
                .map(pull)
                .filter(Boolean)
                .sort((a, b) => a[0] - b[0]);
          - entity: sensor.xert_activity_list_raw
            name: Form
            yaxis_id: form
            type: line
            data_generator: |
              const ids = Array.from({ length: 50 }, (_, i) => `sensor.xert_activity_${i}_detail_raw`);
              const pull = (id) => {
                const a = hass.states[id]?.attributes;
                const d = a?.progression?.date || a?.summary?.start_date?.date;
                const form = a?.summary?.progression?.form;
                if (!d || form == null) return null;
                return [new Date(d), Math.round(form * 10) / 10];
              };
              return ids
                .map(pull)
                .filter(Boolean)
                .sort((a, b) => a[0] - b[0]);
          - entity: sensor.xert_activity_list_raw
            name: XSS
            yaxis_id: xss
            type: column
            data_generator: |
              const ids = Array.from({ length: 50 }, (_, i) => `sensor.xert_activity_${i}_detail_raw`);
              const pull = (id) => {
                const a = hass.states[id]?.attributes;
                const d = a?.summary?.start_date?.date || a?.progression?.date;
                const xss = a?.summary?.xss;
                if (!d || xss == null) return null;
                return [new Date(d), Math.round(xss)];
              };
              return ids
                .map(pull)
                .filter(Boolean)
                .sort((a, b) => a[0] - b[0]);
        grid_options:
          columns: full
    column_span: 3
