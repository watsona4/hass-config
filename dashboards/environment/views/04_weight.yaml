type: sections
max_columns: 3
title: Weight
path: weight
sections:
  - type: grid
    column_span: 2
    cards:
      - type: custom:auto-entities
        card:
          type: vertical-stack
        grid_options:
          columns: full
        card_param: cards
        filter:
          template: >-
            {% from 'macros/weight_charts.jinja' import
            generate_weight_chart %}

            {{ [
              generate_weight_chart(
                title = 'Aaron Weight & Body Fat — actuals & projection',
                weight_data = 'sensor.aaron_weight_dataset',
                weight_proj = 'sensor.aaron_weight_projection',
                weight_extents = { 'min': 180, 'max': 330 },
                weight_goals = [
                  { 'value': 220, 'label': 'Max weight', 'color': '#1f77b4' },
                  { 'value': 200, 'label': 'Ideal weight', 'color': '#27ae60' },
                ],
                bodyfat_data = 'sensor.aaron_bodyfat_dataset',
                bodyfat_proj = 'sensor.aaron_bodyfat_projection',
                bodyfat_extents = { 'min': 25, 'max': 55 },
                bodyfat_goals = [
                  { 'value': 28, 'label': 'Body fat goal 28%', 'color': '#e67e22' },
                ],
                annotations = 'sensor.aaron_weight_annotations',
                show_bodyfat = true,
              ) | from_json,
            ] }}
      - type: horizontal-stack
        cards:
          - type: custom:flex-table-card
            title: Aaron Weight Milestones
            entities:
              - entity: sensor.aaron_weight_milestones_rows
            columns:
              - name: Weight
                data: rows.weight
                modify: x.toFixed(0) + ' lb'
              - name: Days
                data: rows.days
                modify: x.toFixed(1)
              - name: Date
                data: rows.date
                modify: >-
                  new Date(x).toLocaleDateString(undefined, {weekday:
                  'short', year: 'numeric', month: 'short', day: 'numeric'})
          - type: custom:flex-table-card
            title: Aaron Body Fat Milestones
            entities:
              - entity: sensor.aaron_body_fat_milestones_rows
            columns:
              - name: Body Fat
                data: rows.body_fat
                modify: x.toFixed(0) + '%'
              - name: Days
                data: rows.days
                modify: x.toFixed(1)
              - name: Date
                data: rows.date
                modify: >-
                  new Date(x).toLocaleDateString(undefined, {weekday:
                  'short', year: 'numeric', month: 'short', day: 'numeric'})
        grid_options:
          columns: full
      - type: custom:auto-entities
        card:
          type: vertical-stack
        grid_options:
          columns: full
        card_param: cards
        filter:
          template: >-
            {% from 'macros/weight_charts.jinja' import
            generate_weight_chart %}

            {{ [
              generate_weight_chart(
                title = 'Ashley Weight & Body Fat — actuals & projection',
                weight_data = 'sensor.ashley_weight_dataset',
                weight_proj = 'sensor.ashley_weight_projection',
                weight_extents = { 'min': 140, 'max': 230 },
                weight_goals = [
                  { 'value': 150, 'label': 'Target weight', 'color': '#27ae60' },
                ],
                annotations = 'sensor.ashley_weight_annotations',
                show_bodyfat = false,
              ) | from_json,
            ] }}
      - type: horizontal-stack
        cards:
          - type: custom:flex-table-card
            title: Ashley Weight Milestones
            entities:
              - entity: sensor.ashley_weight_milestones_rows
            columns:
              - name: Weight
                data: rows.weight
                modify: x.toFixed(0) + ' lb'
              - name: Days
                data: rows.days
                modify: x.toFixed(1)
              - name: Date
                data: rows.date
                modify: >-
                  new Date(x).toLocaleDateString(undefined, {weekday:
                  'short', year: 'numeric', month: 'short', day: 'numeric'})
        grid_options:
          columns: full
  - type: grid
    cards:
      - type: vertical-stack
        cards:
          - type: heading
            icon: mdi:weight-lifter
            heading: Aaron Weight & Body Fat Metrics
            heading_style: title
          - type: custom:mushroom-template-card
            entity: sensor.aaron_weight_params
            primary: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {{
              'Weight change: ' ~ '%+.1f'|format(v) }} lb/wk
            secondary: >
              {% set tgt = state_attr(entity,'winf') %} {% if tgt is number
              %}
                Toward {{ tgt|round(0) }} lb (asymptotic)
              {% else %}
                Weekly change
              {% endif %}
            icon: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {{
              'mdi:trending-down' if v < 0 else 'mdi:trending-up' if v > 0
              else 'mdi:minus' }}
            badge_icon: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {%
              set a = (v|abs) %} {{ 'mdi:run-fast' if a >= 4.0 else
              'mdi:walk' if a >= 2.0 else 'mdi:sleep' }}
            badge_color: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {%
              set a = (v|abs) %} {{ 'red' if a >= 4.0 else 'amber' if a >=
              2.0 else 'green' }}
            color: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {{
              'green' if v < 0 else 'red' if v > 0 else 'grey' }}
            features_position: bottom
          - type: custom:mushroom-template-card
            entity: sensor.aaron_bodyfat_params
            primary: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {{
              'Body fat change: ' ~ '%+.2f'|format(v) }} %/wk
            secondary: >
              {% set tgt = state_attr(entity,'winf') %} {% if tgt is number
              %}
                Toward {{ tgt|round(0) }}% (asymptotic)
              {% else %}
                Weekly change (as of today)
              {% endif %}
            icon: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {{
              'mdi:trending-down' if v < 0 else 'mdi:trending-up' if v > 0
              else 'mdi:minus' }}
            badge_icon: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {%
              set a = (v|abs) %} {{ 'mdi:run-fast' if a >= 1.0 else
              'mdi:walk' if a >= 0.5 else 'mdi:sleep' }}
            badge_color: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {%
              set a = (v|abs) %} {{ 'red' if a >= 1.0 else 'amber' if a >=
              0.5 else 'green' }}
            color: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {{
              'green' if v < 0 else 'red' if v > 0 else 'grey' }}
            features_position: bottom
          - type: custom:mushroom-template-card
            entity: sensor.aaron_weight_params
            icon: mdi:calendar-clock
            primary: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau1 =
              (P.tau1 | float(0)) %} {% set tau2 = (P.tau2 | float(0)) %} {%
              set t0s = state_attr(entity,'t0') %} {% set t0  =
              as_datetime(t0s) if t0s else none %} {% set nowts =
              as_timestamp(now()) %} {% if t0 %}
                {% set base = as_timestamp(t0) + tau1 * 86400 %}
                {% set add_weeks = 0 if nowts <= base else (((nowts - base) / (7*86400)) | round(0, 'floor') + 1) %}
                {% set next_peak = base + add_weeks * 7 * 86400 %}
                {% set wday = next_peak | timestamp_custom('%a', true) %}
                {% set wtime = next_peak | timestamp_custom('%-I:%M %p', true) %}
                Weight weekly peak: {{ wday }} • {{ wtime }}
              {% else %}
                Weight weekly peak: unavailable
              {% endif %}
            secondary: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau2 =
              (P.tau2 | float(0)) %} {% set t0s = state_attr(entity,'t0') %}
              {% set t0  = as_datetime(t0s) if t0s else none %} {% if t0 %}
                {% set daily = as_timestamp(t0) + tau2 * 86400 %}
                Daily peak: {{ daily | timestamp_custom('%-I:%M %p', true) }}
              {% else %}
                Daily peak: unavailable
              {% endif %}
            badge_icon: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau1 =
              (P.tau1 | float(0)) %} {% set t0s = state_attr(entity,'t0') %}
              {% set t0  = as_datetime(t0s) if t0s else none %} {% set nowts
              = as_timestamp(now()) %} {% if t0 %}
                {% set base = as_timestamp(t0) + tau1 * 86400 %}
                {% set add_weeks = 0 if nowts <= base else (((nowts - base) / (7*86400)) | round(0, 'floor') + 1) %}
                {% set next_peak = base + add_weeks * 7 * 86400 %}
                {% set n = (((next_peak - nowts) / 86400) | round(0)) | int %}
                {% if n >= 10 %} mdi:numeric-9-plus-circle {% else %} mdi:numeric-{{ n }}-circle {% endif %}
              {% else %} mdi:help-circle {% endif %}
            badge_color: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau1 =
              (P.tau1 | float(0)) %} {% set t0s = state_attr(entity,'t0') %}
              {% set t0  = as_datetime(t0s) if t0s else none %} {% set nowts
              = as_timestamp(now()) %} {% if t0 %}
                {% set base = as_timestamp(t0) + tau1 * 86400 %}
                {% set add_weeks = 0 if nowts <= base else (((nowts - base) / (7*86400)) | round(0, 'floor') + 1) %}
                {% set next_peak = base + add_weeks * 7 * 86400 %}
                {% set days_until = (next_peak - nowts) / 86400 %}
                {% if days_until <= 1 %} green
                {% elif days_until <= 3 %} amber
                {% else %} indigo
                {% endif %}
              {% else %} grey {% endif %}
            color: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau2 =
              (P.tau2 | float(0)) %} {% set t0s = state_attr(entity,'t0') %}
              {% set t0  = as_datetime(t0s) if t0s else none %} {% if t0 %}
                {% set h24 = (((as_timestamp(t0) + tau2 * 86400) | timestamp_custom('%H', true)) | int) %}
                {% if h24 < 5 or h24 >= 22 %} purple
                {% elif h24 < 12 %} amber
                {% elif h24 < 17 %} indigo
                {% else %} deep-orange
                {% endif %}
              {% else %} grey {% endif %}
            features_position: bottom
          - type: custom:mushroom-template-card
            entity: sensor.aaron_bodyfat_params
            icon: mdi:clock-star-four-points
            primary: >
              {% set P = state_attr('sensor.aaron_bodyfat_params','params')
              or {} %} {% set tau1 = (P.tau1 | float(0)) %} {% set tau2 =
              (P.tau2 | float(0)) %} {% set t0s =
              state_attr('sensor.aaron_bodyfat_params','t0') %} {% set t0  =
              as_datetime(t0s) if t0s else none %} {% set nowts =
              as_timestamp(now()) %} {% if t0 %}
                {% set base = as_timestamp(t0) + tau1 * 86400 %}
                {% set add_weeks = 0 if nowts <= base else (((nowts - base) / (7*86400)) | round(0, 'floor') + 1) %}
                {% set next_peak = base + add_weeks * 7 * 86400 %}
                {% set wday = next_peak | timestamp_custom('%a', true) %}
                {% set wtime = next_peak | timestamp_custom('%-I:%M %p', true) %}
                Body fat weekly peak: {{ wday }} • {{ wtime }}
              {% else %}
                Body fat weekly peak: unavailable
              {% endif %}
            secondary: >
              {% set P = state_attr('sensor.aaron_bodyfat_params','params')
              or {} %} {% set tau2 = (P.tau2 | float(0)) %} {% set t0s =
              state_attr('sensor.aaron_bodyfat_params','t0') %} {% set t0  =
              as_datetime(t0s) if t0s else none %} {% if t0 %}
                {% set daily = as_timestamp(t0) + tau2 * 86400 %}
                Daily peak: {{ daily | timestamp_custom('%-I:%M %p', true) }}
              {% else %}
                Daily peak: unavailable
              {% endif %}
            badge_icon: >
              {% set P = state_attr('sensor.aaron_bodyfat_params','params')
              or {} %} {% set tau1 = (P.tau1 | float(0)) %} {% set t0s =
              state_attr('sensor.aaron_bodyfat_params','t0') %} {% set t0  =
              as_datetime(t0s) if t0s else none %} {% set nowts =
              as_timestamp(now()) %} {% if t0 %}
                {% set base = as_timestamp(t0) + tau1 * 86400 %}
                {% set add_weeks = 0 if nowts <= base else (((nowts - base) / (7*86400)) | round(0, 'floor') + 1) %}
                {% set next_peak = base + add_weeks * 7 * 86400 %}
                {% set n = (((next_peak - nowts) / 86400) | round(0)) | int %}
                {% if n >= 10 %} mdi:numeric-9-plus-circle {% else %} mdi:numeric-{{ n }}-circle {% endif %}
              {% else %} mdi:help-circle {% endif %}
            badge_color: >
              {% set P = state_attr('sensor.aaron_bodyfat_params','params')
              or {} %} {% set tau1 = (P.tau1 | float(0)) %} {% set t0s =
              state_attr('sensor.aaron_bodyfat_params','t0') %} {% set t0  =
              as_datetime(t0s) if t0s else none %} {% set nowts =
              as_timestamp(now()) %} {% if t0 %}
                {% set base = as_timestamp(t0) + tau1 * 86400 %}
                {% set add_weeks = 0 if nowts <= base else (((nowts - base) / (7*86400)) | round(0, 'floor') + 1) %}
                {% set next_peak = base + add_weeks * 7 * 86400 %}
                {% set days_until = (next_peak - nowts) / 86400 %}
                {% if days_until <= 1 %} green
                {% elif days_until <= 3 %} amber
                {% else %} indigo
                {% endif %}
              {% else %} grey {% endif %}
            color: >
              {% set P = state_attr('sensor.aaron_bodyfat_params','params')
              or {} %} {% set tau2 = (P.tau2 | float(0)) %} {% set t0s =
              state_attr('sensor.aaron_bodyfat_params','t0') %} {% set t0  =
              as_datetime(t0s) if t0s else none %} {% if t0 %}
                {% set h24 = (((as_timestamp(t0) + tau2 * 86400) | timestamp_custom('%H', true)) | int) %}
                {% if h24 < 5 or h24 >= 22 %} purple
                {% elif h24 < 12 %} amber
                {% elif h24 < 17 %} indigo
                {% else %} deep-orange
                {% endif %}
              {% else %} grey {% endif %}
            features_position: bottom
          - type: heading
            icon: mdi:run-fast
            heading: Ashley Weight Metrics
            heading_style: title
          - type: custom:mushroom-template-card
            entity: sensor.ashley_weight_params
            primary: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {{
              'Weight change: ' ~ '%+.1f'|format(v) }} lb/wk
            secondary: >
              {% set tgt = state_attr(entity,'winf') %} {% if tgt is number
              %}
                Toward {{ tgt|round(0) }} lb (asymptotic)
              {% else %}
                Weekly change (as of today)
              {% endif %}
            icon: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {{
              'mdi:trending-down' if v < 0 else 'mdi:trending-up' if v > 0
              else 'mdi:minus' }}
            badge_icon: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {%
              set a = (v|abs) %} {{ 'mdi:run-fast' if a >= 4.0 else
              'mdi:walk' if a >= 2.0 else 'mdi:sleep' }}
            badge_color: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {%
              set a = (v|abs) %} {{ 'red' if a >= 4.0 else 'amber' if a >=
              2.0 else 'green' }}
            color: >
              {% set v = state_attr(entity,'weekly_change')|float(0) %} {{
              'green' if v < 0 else 'red' if v > 0 else 'grey' }}
            features_position: bottom
          - type: custom:mushroom-template-card
            entity: sensor.ashley_weight_params
            icon: mdi:calendar-clock
            primary: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau1 =
              (P.tau1 | float(0)) %} {% set tau2 = (P.tau2 | float(0)) %} {%
              set t0s = state_attr(entity,'t0') %} {% set t0  =
              as_datetime(t0s) if t0s else none %} {% set nowts =
              as_timestamp(now()) %} {% if t0 %}
                {% set base = as_timestamp(t0) + tau1 * 86400 %}
                {% set add_weeks = 0 if nowts <= base else (((nowts - base) / (7*86400)) | round(0, 'floor') + 1) %}
                {% set next_peak = base + add_weeks * 7 * 86400 %}
                {% set wday = next_peak | timestamp_custom('%a', true) %}
                {% set wtime = next_peak | timestamp_custom('%-I:%M %p', true) %}
                Weight weekly peak: {{ wday }} • {{ wtime }}
              {% else %}
                Weight weekly peak: unavailable
              {% endif %}
            secondary: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau2 =
              (P.tau2 | float(0)) %} {% set t0s = state_attr(entity,'t0') %}
              {% set t0  = as_datetime(t0s) if t0s else none %} {% if t0 %}
                {% set daily = as_timestamp(t0) + tau2 * 86400 %}
                Daily peak: {{ daily | timestamp_custom('%-I:%M %p', true) }}
              {% else %}
                Daily peak: unavailable
              {% endif %}
            badge_icon: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau1 =
              (P.tau1 | float(0)) %} {% set t0s = state_attr(entity,'t0') %}
              {% set t0  = as_datetime(t0s) if t0s else none %} {% set nowts
              = as_timestamp(now()) %} {% if t0 %}
                {% set base = as_timestamp(t0) + tau1 * 86400 %}
                {% set add_weeks = 0 if nowts <= base else (((nowts - base) / (7*86400)) | round(0, 'floor') + 1) %}
                {% set next_peak = base + add_weeks * 7 * 86400 %}
                {% set n = (((next_peak - nowts) / 86400) | round(0)) | int %}
                {% if n >= 10 %} mdi:numeric-9-plus-circle {% else %} mdi:numeric-{{ n }}-circle {% endif %}
              {% else %} mdi:help-circle {% endif %}
            badge_color: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau1 =
              (P.tau1 | float(0)) %} {% set t0s = state_attr(entity,'t0') %}
              {% set t0  = as_datetime(t0s) if t0s else none %} {% set nowts
              = as_timestamp(now()) %} {% if t0 %}
                {% set base = as_timestamp(t0) + tau1 * 86400 %}
                {% set add_weeks = 0 if nowts <= base else (((nowts - base) / (7*86400)) | round(0, 'floor') + 1) %}
                {% set next_peak = base + add_weeks * 7 * 86400 %}
                {% set days_until = (next_peak - nowts) / 86400 %}
                {% if days_until <= 1 %} green
                {% elif days_until <= 3 %} amber
                {% else %} indigo
                {% endif %}
              {% else %} grey {% endif %}
            color: >
              {% set P = state_attr(entity,'params') or {} %} {% set tau2 =
              (P.tau2 | float(0)) %} {% set t0s = state_attr(entity,'t0') %}
              {% set t0  = as_datetime(t0s) if t0s else none %} {% if t0 %}
                {% set h24 = (((as_timestamp(t0) + tau2 * 86400) | timestamp_custom('%H', true)) | int) %}
                {% if h24 < 5 or h24 >= 22 %} purple
                {% elif h24 < 12 %} amber
                {% elif h24 < 17 %} indigo
                {% else %} deep-orange
                {% endif %}
              {% else %} grey {% endif %}
            features_position: bottom
      - type: custom:flex-table-card
        title: Upcoming holidays & events
        entities:
          - sensor.weight_events_joined
        columns:
          - name: Date
            data: events.date
            modify: new Date(x).toLocaleDateString()
          - name: Event
            data: events.name
          - name: Aaron Weight (lb)
            data: events.weight
            align: right
            modify: 'x == null ? ''—'' : Number(x).toFixed(0)'
          - name: Aaron Body Fat (%)
            data: events.bodyfat
            align: right
            modify: 'x == null ? ''—'' : Number(x).toFixed(1)'
          - name: Ashley Weight (lb)
            data: events.ashley_weight
            align: right
            modify: 'x == null ? ''—'' : Number(x).toFixed(0)'
