# ================= Google Pollen - Nearby (derived templates) =================
- trigger:
    - platform: state
      entity_id: sensor.google_pollen_nearby
  variables:
    src: sensor.google_pollen_nearby
    di: "{{ state_attr(src, 'dailyInfo') | default([], true) }}"
    d: "{{ (di | first) | default({}, true) }}"
    plants: "{{ d.get('plantInfo') or [] }}"
    pick: >-
      {% set best = namespace(p=None, v=-1) %}
      {% for p in plants %}
        {% set v = (p.get('indexInfo') or {}).get('value') %}
        {% if v is not none and v > best.v %}{% set best.p = p %}{% set best.v = v %}{% endif %}
      {% endfor %}
      {% if best.p is none %}
        {% for p in plants %}
          {% set desc = p.get('plantDescription') or {} %}
          {% if desc.get('picture') or desc.get('pictureCloseup') %}
            {% set best.p = p %}{% break %}
          {% endif %}
        {% endfor %}
      {% endif %}
      {% set p = best.p or (plants | first) or {} %}
      {% set desc = p.get('plantDescription') or {} %}
      {% set ii = p.get('indexInfo') or {} %}
      {{
        {
          'name': p.get('displayName') or p.get('code'),
          'code': p.get('code'),
          'type': desc.get('type'),
          'in_season': p.get('inSeason'),
          'value': ii.get('value'),
          'category': ii.get('category'),
          'picture': desc.get('picture') or desc.get('pictureCloseup')
        }
      }}
    days: >-
      {% set ns = namespace(out=[]) %}
      {% for d in di[:3] %}
        {% set types = d.get('pollenTypeInfo') or [] %}
        {% set best = namespace(t=None, v=-1) %}
        {% for t in types %}
          {% set ii = t.get('indexInfo') or {} %}
          {% set v = ii.get('value') %}
          {% if v is not none and v > best.v %}{% set best.t = t %}{% set best.v = v %}{% endif %}
        {% endfor %}
        {% set top = best.t or {} %}
        {% set ii = top.get('indexInfo') or {} %}
        {% set col = ii.get('color') or {} %}
        {% set r = (col.get('red')   or 0) * 255 %}
        {% set g = (col.get('green') or 0) * 255 %}
        {% set b = (col.get('blue')  or 0) * 255 %}
        {% set hex = '#%02X%02X%02X'|format(r|round(0)|int, g|round(0)|int, b|round(0)|int) %}
        {% set plants = d.get('plantInfo') or [] %}
        {% set sbest = namespace(p=None, v=-1) %}
        {% for p in plants %}
          {% set pii = p.get('indexInfo') or {} %}
          {% set pv = pii.get('value') %}
          {% if pv is not none and pv > sbest.v %}{% set sbest.p = p %}{% set sbest.v = pv %}{% endif %}
        {% endfor %}
        {% if sbest.p is none %}
          {% for p in plants %}
            {% set desc = p.get('plantDescription') or {} %}
            {% if desc.get('picture') or desc.get('pictureCloseup') %}
              {% set sbest.p = p %}{% break %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% set sp = sbest.p or (plants | first) or {} %}
        {% set spdesc = sp.get('plantDescription') or {} %}
        {% set spii = sp.get('indexInfo') or {} %}
        {% set dt = d.get('date') or {} %}
        {% set date = "%04d-%02d-%02d"|format(dt.get('year',0), dt.get('month',0), dt.get('day',0)) if dt else none %}
        {% set item = {
          'exists': true,
          'date': date,
          'state': ii.get('category') or 'unknown',
          'dominant_type': top.get('displayName') or top.get('code'),
          'dominant_value': ii.get('value'),
          'dominant_category': ii.get('category'),
          'dominant_hex': hex,
          'species_name': sp.get('displayName') or sp.get('code'),
          'species_value': spii.get('value'),
          'species_category': spii.get('category'),
          'species_type': spdesc.get('type'),
          'species_picture': spdesc.get('picture') or spdesc.get('pictureCloseup')
        } %}
        {% set ns.out = ns.out + [item] %}
      {% endfor %}
      {{ ns.out }}
  sensor:
    - name: Google Pollen Nearby Today
      unique_id: google_pollen_nearby_today
      icon: mdi:flower-pollen
      availability: "{{ has_value(src) and (di | count) > 0 }}"
      state: >-
        {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
        {% set types = d0.get('pollenTypeInfo') or [] %}
        {% set pick = (types | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
        {{ pick.get('displayName') or pick.get('code') or 'unknown' }}
      attributes:
        date: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set dt = d0.get('date') or {} %}
          {{ "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none }}
        dominant_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set t = ((d0.get('pollenTypeInfo') or []) | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
          {{ (t.get('indexInfo') or {}).get('value') }}
        dominant_category: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set t = ((d0.get('pollenTypeInfo') or []) | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
          {{ (t.get('indexInfo') or {}).get('category') or 'unknown' }}
        dominant_hex: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set t = ((d0.get('pollenTypeInfo') or []) | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
          {% set c = (t.get('indexInfo') or {}).get('color') or {} %}
          {% set r = (c.get('red') or 0) * 255 %}
          {% set g = (c.get('green') or 0) * 255 %}
          {% set b = (c.get('blue') or 0) * 255 %}
          {{ '#%02X%02X%02X'|format(r|round(0)|int, g|round(0)|int, b|round(0)|int) }}
        grass_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','GRASS') | list | first) or {}) %}
          {{ (x.get('indexInfo') or {}).get('value') }}
        tree_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','TREE') | list | first) or {}) %}
          {{ (x.get('indexInfo') or {}).get('value') }}
        weed_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','WEED') | list | first) or {}) %}
          {{ (x.get('indexInfo') or {}).get('value') }}
        recommendations: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set types = d0.get('pollenTypeInfo') or [] %}
          {% set ranked = types | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) %}
          {% set dom = (ranked | first) or {} %}
          {{ (dom.get('healthRecommendations') or []) | unique | list }}

    - name: Pollen Species Nearby Today
      unique_id: pollen_species_nearby_today
      icon: mdi:leaf
      availability: "{{ has_value(src) and (plants | count) > 0 }}"
      state: "{{ pick.name or 'unknown' }}"
      attributes:
        code: "{{ pick.code }}"
        type: "{{ pick.type }}"
        in_season: "{{ pick.in_season }}"
        category: "{{ pick.category or 'unknown' }}"
        value: "{{ pick.value }}"
        entity_picture: "{{ pick.picture or none }}"

    - name: Pollen Forecast Nearby Day 0
      unique_id: pollen_forecast_nearby_day_0
      icon: mdi:calendar-today
      availability: "{{ (days | count) > 0 and (days[0] | default({})).get('exists') }}"
      state: "{{ (days[0] | default({})).get('state') or 'unknown' }}"
      attributes:
        date: "{{ (days[0] | default({})).get('date') }}"
        dominant_type: "{{ (days[0] | default({})).get('dominant_type') }}"
        dominant_value: "{{ (days[0] | default({})).get('dominant_value') }}"
        dominant_category: "{{ (days[0] | default({})).get('dominant_category') }}"
        dominant_hex: "{{ (days[0] | default({})).get('dominant_hex') }}"
        species_name: "{{ (days[0] | default({})).get('species_name') }}"
        species_value: "{{ (days[0] | default({})).get('species_value') }}"
        species_category: "{{ (days[0] | default({})).get('species_category') }}"
        species_type: "{{ (days[0] | default({})).get('species_type') }}"
        species_picture: "{{ (days[0] | default({})).get('species_picture') }}"

    - name: Pollen Forecast Nearby Day 1
      unique_id: pollen_forecast_nearby_day_1
      icon: mdi:calendar
      availability: "{{ (days | count) > 1 and (days[1] | default({})).get('exists') }}"
      state: "{{ (days[1] | default({})).get('state') or 'unknown' }}"
      attributes:
        date: "{{ (days[1] | default({})).get('date') }}"
        dominant_type: "{{ (days[1] | default({})).get('dominant_type') }}"
        dominant_value: "{{ (days[1] | default({})).get('dominant_value') }}"
        dominant_category: "{{ (days[1] | default({})).get('dominant_category') }}"
        dominant_hex: "{{ (days[1] | default({})).get('dominant_hex') }}"
        species_name: "{{ (days[1] | default({})).get('species_name') }}"
        species_value: "{{ (days[1] | default({})).get('species_value') }}"
        species_category: "{{ (days[1] | default({})).get('species_category') }}"
        species_type: "{{ (days[1] | default({})).get('species_type') }}"
        species_picture: "{{ (days[1] | default({})).get('species_picture') }}"

    - name: Pollen Forecast Nearby Day 2
      unique_id: pollen_forecast_nearby_day_2
      icon: mdi:calendar
      availability: "{{ (days | count) > 2 and (days[2] | default({})).get('exists') }}"
      state: "{{ (days[2] | default({})).get('state') or 'unknown' }}"
      attributes:
        date: "{{ (days[2] | default({})).get('date') }}"
        dominant_type: "{{ (days[2] | default({})).get('dominant_type') }}"
        dominant_value: "{{ (days[2] | default({})).get('dominant_value') }}"
        dominant_category: "{{ (days[2] | default({})).get('dominant_category') }}"
        dominant_hex: "{{ (days[2] | default({})).get('dominant_hex') }}"
        species_name: "{{ (days[2] | default({})).get('species_name') }}"
        species_value: "{{ (days[2] | default({})).get('species_value') }}"
        species_category: "{{ (days[2] | default({})).get('species_category') }}"
        species_type: "{{ (days[2] | default({})).get('species_type') }}"
        species_picture: "{{ (days[2] | default({})).get('species_picture') }}"

    - name: Pollen Species List Nearby Today
      unique_id: pollen_species_list_nearby_today
      availability: "{{ has_value(src) and (di | count) > 0 }}"
      state: "{{ (di | count) > 0 }}"
      attributes:
        species: >-
          {% set plants = d.get('plantInfo') or [] %}
          {% set ns = namespace(out=[]) %}
          {% for p in plants %}
            {% set desc = p.get('plantDescription') or {} %}
            {% set pic = desc.get('picture') or desc.get('pictureCloseup') %}
            {% set item = {
              'code': p.get('code'),
              'name': p.get('displayName'),
              'type': desc.get('type'),
              'in_season': p.get('inSeason'),
              'value': ((p.get('indexInfo') or {}).get('value')),
              'category': ((p.get('indexInfo') or {}).get('category')),
              'picture': pic
            } %}
            {% set ns.out = ns.out + [item] %}
          {% endfor %}
          {{ ns.out }}

    - name: Pollen Peak Index Nearby Today
      unique_id: pollen_peak_index_nearby_today
      icon: mdi:meter-gas
      availability: >-
        {{ has_value(src) and (d.get('pollenTypeInfo') or []) | count > 0 }}
      state: >-
        {% set types = d.get('pollenTypeInfo') or [] %}
        {% if types | count == 0 %} {{ none }}
        {% else %} {{ (types | map(attribute='indexInfo.value') | list | max) }}
        {% endif %}


# ================= Google Pollen - Home (derived templates) =================
- trigger:
    - platform: state
      entity_id: sensor.google_pollen_home
  variables:
    src: sensor.google_pollen_home
    di: "{{ state_attr(src,'dailyInfo') | default([], true) }}"
    d: "{{ (di | first) | default({}, true) }}"
    plants: "{{ d.get('plantInfo') or [] }}"
    pick: >-
      {% set best = namespace(p=None, v=-1) %}
      {% for p in plants %}
        {% set v = (p.get('indexInfo') or {}).get('value') %}
        {% if v is not none and v > best.v %}{% set best.p = p %}{% set best.v = v %}{% endif %}
      {% endfor %}
      {% if best.p is none %}
        {% for p in plants %}
          {% set desc = p.get('plantDescription') or {} %}
          {% if desc.get('picture') or desc.get('pictureCloseup') %}
            {% set best.p = p %}{% break %}
          {% endif %}
        {% endfor %}
      {% endif %}
      {% set p = best.p or (plants | first) or {} %}
      {% set desc = p.get('plantDescription') or {} %}
      {% set ii = p.get('indexInfo') or {} %}
      {{
        {
          'name': p.get('displayName') or p.get('code'),
          'code': p.get('code'),
          'type': desc.get('type'),
          'in_season': p.get('inSeason'),
          'value': ii.get('value'),
          'category': ii.get('category'),
          'picture': desc.get('picture') or desc.get('pictureCloseup')
        }
      }}
    days: >-
      {% set ns = namespace(out=[]) %}
      {% for d in di[:3] %}
        {% set types = d.get('pollenTypeInfo') or [] %}
        {% set best = namespace(t=None, v=-1) %}
        {% for t in types %}
          {% set ii = t.get('indexInfo') or {} %}
          {% set v = ii.get('value') %}
          {% if v is not none and v > best.v %}{% set best.t = t %}{% set best.v = v %}{% endif %}
        {% endfor %}
        {% set top = best.t or {} %}
        {% set ii = top.get('indexInfo') or {} %}
        {% set col = ii.get('color') or {} %}
        {% set r = (col.get('red')   or 0) * 255 %}
        {% set g = (col.get('green') or 0) * 255 %}
        {% set b = (col.get('blue')  or 0) * 255 %}
        {% set hex = '#%02X%02X%02X'|format(r|round(0)|int, g|round(0)|int, b|round(0)|int) %}
        {% set plants = d.get('plantInfo') or [] %}
        {% set sbest = namespace(p=None, v=-1) %}
        {% for p in plants %}
          {% set pii = p.get('indexInfo') or {} %}
          {% set pv = pii.get('value') %}
          {% if pv is not none and pv > sbest.v %}{% set sbest.p = p %}{% set sbest.v = pv %}{% endif %}
        {% endfor %}
        {% if sbest.p is none %}
          {% for p in plants %}
            {% set desc = p.get('plantDescription') or {} %}
            {% if desc.get('picture') or desc.get('pictureCloseup') %}
              {% set sbest.p = p %}{% break %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% set sp = sbest.p or (plants | first) or {} %}
        {% set spdesc = sp.get('plantDescription') or {} %}
        {% set spii = sp.get('indexInfo') or {} %}
        {% set dt = d.get('date') or {} %}
        {% set date = "%04d-%02d-%02d"|format(dt.get('year',0), dt.get('month',0), dt.get('day',0)) if dt else none %}
        {% set item = {
          'exists': true,
          'date': date,
          'state': ii.get('category') or 'unknown',
          'dominant_type': top.get('displayName') or top.get('code'),
          'dominant_value': ii.get('value'),
          'dominant_category': ii.get('category'),
          'dominant_hex': hex,
          'species_name': sp.get('displayName') or sp.get('code'),
          'species_value': spii.get('value'),
          'species_category': spii.get('category'),
          'species_type': spdesc.get('type'),
          'species_picture': spdesc.get('picture') or spdesc.get('pictureCloseup')
        } %}
        {% set ns.out = ns.out + [item] %}
      {% endfor %}
      {{ ns.out }}
  sensor:
    - name: Google Pollen Home Today
      unique_id: google_pollen_home_today
      icon: mdi:flower-pollen
      availability: "{{ has_value(src) and (di | count) > 0 }}"
      state: >-
        {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
        {% set types = d0.get('pollenTypeInfo') or [] %}
        {% set pick = (types | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
        {{ pick.get('displayName') or pick.get('code') or 'unknown' }}
      attributes:
        date: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set dt = d0.get('date') or {} %}
          {{ "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none }}
        dominant_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set t = ((d0.get('pollenTypeInfo') or []) | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
          {{ (t.get('indexInfo') or {}).get('value') }}
        dominant_category: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set t = ((d0.get('pollenTypeInfo') or []) | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
          {{ (t.get('indexInfo') or {}).get('category') or 'unknown' }}
        dominant_hex: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set t = ((d0.get('pollenTypeInfo') or []) | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
          {% set c = (t.get('indexInfo') or {}).get('color') or {} %}
          {% set r = (c.get('red') or 0) * 255 %}
          {% set g = (c.get('green') or 0) * 255 %}
          {% set b = (c.get('blue') or 0) * 255 %}
          {{ '#%02X%02X%02X'|format(r|round(0)|int, g|round(0)|int, b|round(0)|int) }}
        grass_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','GRASS') | list | first) or {}) %}
          {{ (x.get('indexInfo') or {}).get('value') }}
        tree_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','TREE') | list | first) or {}) %}
          {{ (x.get('indexInfo') or {}).get('value') }}
        weed_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','WEED') | list | first) or {}) %}
          {{ (x.get('indexInfo') or {}).get('value') }}
        recommendations: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set types = d0.get('pollenTypeInfo') or [] %}
          {% set ranked = types | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) %}
          {% set dom = (ranked | first) or {} %}
          {{ (dom.get('healthRecommendations') or []) | unique | list }}

    - name: Pollen Species Home Today
      unique_id: pollen_species_home_today
      icon: mdi:leaf
      availability: "{{ has_value(src) and (plants | count) > 0 }}"
      state: "{{ pick.name or 'unknown' }}"
      attributes:
        code: "{{ pick.code }}"
        type: "{{ pick.type }}"
        in_season: "{{ pick.in_season }}"
        category: "{{ pick.category or 'unknown' }}"
        value: "{{ pick.value }}"
        entity_picture: "{{ pick.picture or none }}"

    - name: Pollen Forecast Home Day 0
      unique_id: pollen_forecast_home_day_0
      icon: mdi:calendar-today
      availability: "{{ (days | count) > 0 and (days[0] | default({})).get('exists') }}"
      state: "{{ (days[0] | default({})).get('state') or 'unknown' }}"
      attributes:
        date: "{{ (days[0] | default({})).get('date') }}"
        dominant_type: "{{ (days[0] | default({})).get('dominant_type') }}"
        dominant_value: "{{ (days[0] | default({})).get('dominant_value') }}"
        dominant_category: "{{ (days[0] | default({})).get('dominant_category') }}"
        dominant_hex: "{{ (days[0] | default({})).get('dominant_hex') }}"
        species_name: "{{ (days[0] | default({})).get('species_name') }}"
        species_value: "{{ (days[0] | default({})).get('species_value') }}"
        species_category: "{{ (days[0] | default({})).get('species_category') }}"
        species_type: "{{ (days[0] | default({})).get('species_type') }}"
        species_picture: "{{ (days[0] | default({})).get('species_picture') }}"

    - name: Pollen Forecast Home Day 1
      unique_id: pollen_forecast_home_day_1
      icon: mdi:calendar
      availability: "{{ (days | count) > 1 and (days[1] | default({})).get('exists') }}"
      state: "{{ (days[1] | default({})).get('state') or 'unknown' }}"
      attributes:
        date: "{{ (days[1] | default({})).get('date') }}"
        dominant_type: "{{ (days[1] | default({})).get('dominant_type') }}"
        dominant_value: "{{ (days[1] | default({})).get('dominant_value') }}"
        dominant_category: "{{ (days[1] | default({})).get('dominant_category') }}"
        dominant_hex: "{{ (days[1] | default({})).get('dominant_hex') }}"
        species_name: "{{ (days[1] | default({})).get('species_name') }}"
        species_value: "{{ (days[1] | default({})).get('species_value') }}"
        species_category: "{{ (days[1] | default({})).get('species_category') }}"
        species_type: "{{ (days[1] | default({})).get('species_type') }}"
        species_picture: "{{ (days[1] | default({})).get('species_picture') }}"

    - name: Pollen Forecast Home Day 2
      unique_id: pollen_forecast_home_day_2
      icon: mdi:calendar
      availability: "{{ (days | count) > 2 and (days[2] | default({})).get('exists') }}"
      state: "{{ (days[2] | default({})).get('state') or 'unknown' }}"
      attributes:
        date: "{{ (days[2] | default({})).get('date') }}"
        dominant_type: "{{ (days[2] | default({})).get('dominant_type') }}"
        dominant_value: "{{ (days[2] | default({})).get('dominant_value') }}"
        dominant_category: "{{ (days[2] | default({})).get('dominant_category') }}"
        dominant_hex: "{{ (days[2] | default({})).get('dominant_hex') }}"
        species_name: "{{ (days[2] | default({})).get('species_name') }}"
        species_value: "{{ (days[2] | default({})).get('species_value') }}"
        species_category: "{{ (days[2] | default({})).get('species_category') }}"
        species_type: "{{ (days[2] | default({})).get('species_type') }}"
        species_picture: "{{ (days[2] | default({})).get('species_picture') }}"

    - name: Pollen Species List Home Today
      unique_id: pollen_species_list_home_today
      availability: "{{ has_value(src) and (di | count) > 0 }}"
      state: "{{ (di | count) > 0 }}"
      attributes:
        species: >-
          {% set plants = d.get('plantInfo') or [] %}
          {% set ns = namespace(out=[]) %}
          {% for p in plants %}
            {% set desc = p.get('plantDescription') or {} %}
            {% set pic = desc.get('picture') or desc.get('pictureCloseup') %}
            {% set item = {
              'code': p.get('code'),
              'name': p.get('displayName'),
              'type': desc.get('type'),
              'in_season': p.get('inSeason'),
              'value': ((p.get('indexInfo') or {}).get('value')),
              'category': ((p.get('indexInfo') or {}).get('category')),
              'picture': pic
            } %}
            {% set ns.out = ns.out + [item] %}
          {% endfor %}
          {{ ns.out }}

    - name: Pollen Peak Index Home Today
      unique_id: pollen_peak_index_home_today
      icon: mdi:meter-gas
      availability: "{{ has_value(src) and (d.get('pollenTypeInfo') or []) | count > 0 }}"
      state: >-
        {% set types = d.get('pollenTypeInfo') or [] %}
        {% if types | count == 0 %} {{ none }}
        {% else %} {{ (types | map(attribute='indexInfo.value') | list | max) }}
        {% endif %}


# ================= Google Pollen - RV (derived templates) =================
- trigger:
    - platform: state
      entity_id: sensor.google_pollen_rv
  variables:
    src: sensor.google_pollen_rv
    di: "{{ state_attr(src,'dailyInfo') | default([], true) }}"
    d: "{{ (di | first) | default({}, true) }}"
    plants: "{{ d.get('plantInfo') or [] }}"
    pick: >-
      {% set best = namespace(p=None, v=-1) %}
      {% for p in plants %}
        {% set v = (p.get('indexInfo') or {}).get('value') %}
        {% if v is not none and v > best.v %}{% set best.p = p %}{% set best.v = v %}{% endif %}
      {% endfor %}
      {% if best.p is none %}
        {% for p in plants %}
          {% set desc = p.get('plantDescription') or {} %}
          {% if desc.get('picture') or desc.get('pictureCloseup') %}
            {% set best.p = p %}{% break %}
          {% endif %}
        {% endfor %}
      {% endif %}
      {% set p = best.p or (plants | first) or {} %}
      {% set desc = p.get('plantDescription') or {} %}
      {% set ii = p.get('indexInfo') or {} %}
      {{
        {
          'name': p.get('displayName') or p.get('code'),
          'code': p.get('code'),
          'type': desc.get('type'),
          'in_season': p.get('inSeason'),
          'value': ii.get('value'),
          'category': ii.get('category'),
          'picture': desc.get('picture') or desc.get('pictureCloseup')
        }
      }}
    days: >-
      {% set ns = namespace(out=[]) %}
      {% for d in di[:3] %}
        {% set types = d.get('pollenTypeInfo') or [] %}
        {% set best = namespace(t=None, v=-1) %}
        {% for t in types %}
          {% set ii = t.get('indexInfo') or {} %}
          {% set v = ii.get('value') %}
          {% if v is not none and v > best.v %}{% set best.t = t %}{% set best.v = v %}{% endif %}
        {% endfor %}
        {% set top = best.t or {} %}
        {% set ii = top.get('indexInfo') or {} %}
        {% set col = ii.get('color') or {} %}
        {% set r = (col.get('red')   or 0) * 255 %}
        {% set g = (col.get('green') or 0) * 255 %}
        {% set b = (col.get('blue')  or 0) * 255 %}
        {% set hex = '#%02X%02X%02X'|format(r|round(0)|int, g|round(0)|int, b|round(0)|int) %}
        {% set plants = d.get('plantInfo') or [] %}
        {% set sbest = namespace(p=None, v=-1) %}
        {% for p in plants %}
          {% set pii = p.get('indexInfo') or {} %}
          {% set pv = pii.get('value') %}
          {% if pv is not none and pv > sbest.v %}{% set sbest.p = p %}{% set sbest.v = pv %}{% endif %}
        {% endfor %}
        {% if sbest.p is none %}
          {% for p in plants %}
            {% set desc = p.get('plantDescription') or {} %}
            {% if desc.get('picture') or desc.get('pictureCloseup') %}
              {% set sbest.p = p %}{% break %}
            {% endif %}
          {% endfor %}
        {% endif %}
        {% set sp = sbest.p or (plants | first) or {} %}
        {% set spdesc = sp.get('plantDescription') or {} %}
        {% set spii = sp.get('indexInfo') or {} %}
        {% set dt = d.get('date') or {} %}
        {% set date = "%04d-%02d-%02d"|format(dt.get('year',0), dt.get('month',0), dt.get('day',0)) if dt else none %}
        {% set item = {
          'exists': true,
          'date': date,
          'state': ii.get('category') or 'unknown',
          'dominant_type': top.get('displayName') or top.get('code'),
          'dominant_value': ii.get('value'),
          'dominant_category': ii.get('category'),
          'dominant_hex': hex,
          'species_name': sp.get('displayName') or sp.get('code'),
          'species_value': spii.get('value'),
          'species_category': spii.get('category'),
          'species_type': spdesc.get('type'),
          'species_picture': spdesc.get('picture') or spdesc.get('pictureCloseup')
        } %}
        {% set ns.out = ns.out + [item] %}
      {% endfor %}
      {{ ns.out }}
  sensor:
    - name: Google Pollen RV Today
      unique_id: google_pollen_rv_today
      icon: mdi:flower-pollen
      availability: "{{ has_value(src) and (di | count) > 0 }}"
      state: >-
        {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
        {% set types = d0.get('pollenTypeInfo') or [] %}
        {% set pick = (types | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
        {{ pick.get('displayName') or pick.get('code') or 'unknown' }}
      attributes:
        date: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set dt = d0.get('date') or {} %}
          {{ "%04d-%02d-%02d"|format(dt.get('year',0),dt.get('month',0),dt.get('day',0)) if dt else none }}
        dominant_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set t = ((d0.get('pollenTypeInfo') or []) | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
          {{ (t.get('indexInfo') or {}).get('value') }}
        dominant_category: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set t = ((d0.get('pollenTypeInfo') or []) | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
          {{ (t.get('indexInfo') or {}).get('category') or 'unknown' }}
        dominant_hex: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set t = ((d0.get('pollenTypeInfo') or []) | sort(attribute='indexInfo.value', reverse=true) | first) or {} %}
          {% set c = (t.get('indexInfo') or {}).get('color') or {} %}
          {% set r = (c.get('red') or 0) * 255 %}
          {% set g = (c.get('green') or 0) * 255 %}
          {% set b = (c.get('blue') or 0) * 255 %}
          {{ '#%02X%02X%02X'|format(r|round(0)|int, g|round(0)|int, b|round(0)|int) }}
        grass_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','GRASS') | list | first) or {}) %}
          {{ (x.get('indexInfo') or {}).get('value') }}
        tree_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','TREE') | list | first) or {}) %}
          {{ (x.get('indexInfo') or {}).get('value') }}
        weed_value: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set x = (((d0.get('pollenTypeInfo') or []) | selectattr('code','eq','WEED') | list | first) or {}) %}
          {{ (x.get('indexInfo') or {}).get('value') }}
        recommendations: >-
          {% set d0 = (di[0] if di is sequence and (di | count) > 0 else {}) %}
          {% set types = d0.get('pollenTypeInfo') or [] %}
          {% set ranked = types | selectattr('indexInfo','defined') | sort(attribute='indexInfo.value', reverse=true) %}
          {% set dom = (ranked | first) or {} %}
          {{ (dom.get('healthRecommendations') or []) | unique | list }}

    - name: Pollen Species RV Today
      unique_id: pollen_species_rv_today
      icon: mdi:leaf
      availability: "{{ has_value(src) and (plants | count) > 0 }}"
      state: "{{ pick.name or 'unknown' }}"
      attributes:
        code: "{{ pick.code }}"
        type: "{{ pick.type }}"
        in_season: "{{ pick.in_season }}"
        category: "{{ pick.category or 'unknown' }}"
        value: "{{ pick.value }}"
        entity_picture: "{{ pick.picture or none }}"

    - name: Pollen Forecast RV Day 0
      unique_id: pollen_forecast_rv_day_0
      icon: mdi:calendar-today
      availability: "{{ (days | count) > 0 and (days[0] | default({})).get('exists') }}"
      state: "{{ (days[0] | default({})).get('state') or 'unknown' }}"
      attributes:
        date: "{{ (days[0] | default({})).get('date') }}"
        dominant_type: "{{ (days[0] | default({})).get('dominant_type') }}"
        dominant_value: "{{ (days[0] | default({})).get('dominant_value') }}"
        dominant_category: "{{ (days[0] | default({})).get('dominant_category') }}"
        dominant_hex: "{{ (days[0] | default({})).get('dominant_hex') }}"
        species_name: "{{ (days[0] | default({})).get('species_name') }}"
        species_value: "{{ (days[0] | default({})).get('species_value') }}"
        species_category: "{{ (days[0] | default({})).get('species_category') }}"
        species_type: "{{ (days[0] | default({})).get('species_type') }}"
        species_picture: "{{ (days[0] | default({})).get('species_picture') }}"

    - name: Pollen Forecast RV Day 1
      unique_id: pollen_forecast_rv_day_1
      icon: mdi:calendar
      availability: "{{ (days | count) > 1 and (days[1] | default({})).get('exists') }}"
      state: "{{ (days[1] | default({})).get('state') or 'unknown' }}"
      attributes:
        date: "{{ (days[1] | default({})).get('date') }}"
        dominant_type: "{{ (days[1] | default({})).get('dominant_type') }}"
        dominant_value: "{{ (days[1] | default({})).get('dominant_value') }}"
        dominant_category: "{{ (days[1] | default({})).get('dominant_category') }}"
        dominant_hex: "{{ (days[1] | default({})).get('dominant_hex') }}"
        species_name: "{{ (days[1] | default({})).get('species_name') }}"
        species_value: "{{ (days[1] | default({})).get('species_value') }}"
        species_category: "{{ (days[1] | default({})).get('species_category') }}"
        species_type: "{{ (days[1] | default({})).get('species_type') }}"
        species_picture: "{{ (days[1] | default({})).get('species_picture') }}"

    - name: Pollen Forecast RV Day 2
      unique_id: pollen_forecast_rv_day_2
      icon: mdi:calendar
      availability: "{{ (days | count) > 2 and (days[2] | default({})).get('exists') }}"
      state: "{{ (days[2] | default({})).get('state') or 'unknown' }}"
      attributes:
        date: "{{ (days[2] | default({})).get('date') }}"
        dominant_type: "{{ (days[2] | default({})).get('dominant_type') }}"
        dominant_value: "{{ (days[2] | default({})).get('dominant_value') }}"
        dominant_category: "{{ (days[2] | default({})).get('dominant_category') }}"
        dominant_hex: "{{ (days[2] | default({})).get('dominant_hex') }}"
        species_name: "{{ (days[2] | default({})).get('species_name') }}"
        species_value: "{{ (days[2] | default({})).get('species_value') }}"
        species_category: "{{ (days[2] | default({})).get('species_category') }}"
        species_type: "{{ (days[2] | default({})).get('species_type') }}"
        species_picture: "{{ (days[2] | default({})).get('species_picture') }}"

    - name: Pollen Species List RV Today
      unique_id: pollen_species_list_rv_today
      availability: "{{ has_value(src) and (di | count) > 0 }}"
      state: "{{ (di | count) > 0 }}"
      attributes:
        species: >-
          {% set plants = d.get('plantInfo') or [] %}
          {% set ns = namespace(out=[]) %}
          {% for p in plants %}
            {% set desc = p.get('plantDescription') or {} %}
            {% set pic = desc.get('picture') or desc.get('pictureCloseup') %}
            {% set item = {
              'code': p.get('code'),
              'name': p.get('displayName'),
              'type': desc.get('type'),
              'in_season': p.get('inSeason'),
              'value': ((p.get('indexInfo') or {}).get('value')),
              'category': ((p.get('indexInfo') or {}).get('category')),
              'picture': pic
            } %}
            {% set ns.out = ns.out + [item] %}
          {% endfor %}
          {{ ns.out }}

    - name: Pollen Peak Index RV Today
      unique_id: pollen_peak_index_rv_today
      icon: mdi:meter-gas
      availability: "{{ has_value(src) and (d.get('pollenTypeInfo') or []) | count > 0 }}"
      state: >-
        {% set types = d.get('pollenTypeInfo') or [] %}
        {% if types | count == 0 %} {{ none }}
        {% else %} {{ (types | map(attribute='indexInfo.value') | list | max) }}
        {% endif %}
